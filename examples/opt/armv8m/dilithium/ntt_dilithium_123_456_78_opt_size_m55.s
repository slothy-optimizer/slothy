///
/// Copyright (c) 2022 Arm Limited
/// Copyright (c) 2022 Hanno Becker
/// Copyright (c) 2023 Amin Abdulrahman, Matthias Kannwischer
/// SPDX-License-Identifier: MIT
///
/// Permission is hereby granted, free of charge, to any person obtaining a copy
/// of this software and associated documentation files (the "Software"), to deal
/// in the Software without restriction, including without limitation the rights
/// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
/// copies of the Software, and to permit persons to whom the Software is
/// furnished to do so, subject to the following conditions:
///
/// The above copyright notice and this permission notice shall be included in all
/// copies or substantial portions of the Software.
///
/// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
/// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
/// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
/// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
/// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
/// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
/// SOFTWARE.
///

.data
.p2align 4
roots:
#include "ntt_dilithium_123_456_78_twiddles.s"
.text

// Barrett multiplication
.macro mulmod dst, src, const, const_twisted
        vmul.s32       \dst,  \src, \const
        vqrdmulh.s32   \src,  \src, \const_twisted
        vmla.s32       \dst,  \src, modulus
.endm

.macro ct_butterfly a, b, root, root_twisted
        mulmod tmp, \b, \root, \root_twisted
        vsub.u32       \b,    \a, tmp
        vadd.u32       \a,    \a, tmp
.endm

.macro qsave loc, a       // @slothy:no-unfold
        vstrw.32 \a, [sp, #\loc\()]
.endm
.macro qrestore a, loc    // @slothy:no-unfold
        vldrw.32 \a, [sp, #\loc\()]
.endm
.macro restored a, b, loc // @slothy:no-unfold
        ldrd \a, \b, [sp, #\loc\()]
.endm
.macro saved loc, a, b    // @slothy:no-unfold
        strd \a, \b, [sp, #\loc\()]
.endm
.macro restore a, loc     // @slothy:no-unfold
        ldr \a, [sp, #\loc\()]
.endm
.macro save loc, a        // @slothy:no-unfold
        str \a, [sp, #\loc\()]
.endm

// Aligns stack =0 mod 16
.macro align_stack_do // @slothy:no-unfold
        mov r11, sp
        and r12, r11, #0xC   // 8 of ==8 mod 16, 0 otherwise
        sub sp, sp, r12      // Align stack to 16 byte
        sub sp, sp, #16
        str r12, [sp]
.endm

// Reverts initial stack correction
.macro align_stack_undo // @slothy:no-unfold
        ldr r12, [sp]
        add sp, sp, #16
        add sp, sp, r12
.endm

#define STACK_SIZE (5*16+8)    // +8 is for alignment
#define QSTACK4 (0*16)
#define QSTACK5 (1*16)
#define QSTACK6 (2*16)

#define ROOT0_STACK (3*16)
#define ROOT1_STACK (3*16 + 8)
#define ROOT4_STACK (4*16)
#define RPTR_STACK  (4*16 + 8)

.align 4
roots_addr: .word roots
.syntax unified
.type ntt_dilithium_123_456_78_opt_size_m55, %function
.global ntt_dilithium_123_456_78_opt_size_m55
ntt_dilithium_123_456_78_opt_size_m55:

        push {r4-r11,lr}
        // Save MVE vector registers
        vpush {d8-d15}

        align_stack_do
        sub sp, sp, #STACK_SIZE

        modulus .req r12
        r_ptr   .req r11

        .equ modulus_const, -8380417
        movw modulus, #:lower16:modulus_const
        movt modulus, #:upper16:modulus_const
        ldr  r_ptr, roots_addr

        in           .req r0
        in_low       .req in
        in_high      .req r1

        add in_high, in, #(4*128)

        root2    .req r2
        root2_tw .req r3
        root3    .req r4
        root3_tw .req r5
        root5    .req r6
        root5_tw .req r7
        root6    .req r8
        root6_tw .req r9

        data0 .req q0
        data1 .req q1
        data2 .req q2
        data3 .req q3
        data4 .req q1
        data5 .req q2
        data6 .req q3
        data7 .req q4

        tmp .req q7

        // Layers 1-3

        rtmp    .req root6
        rtmp_tw .req root6_tw

        ldrd rtmp, rtmp_tw, [r_ptr], #(7*8)
        saved ROOT0_STACK, rtmp, rtmp_tw
        ldrd rtmp, rtmp_tw, [r_ptr, #(1*8 - 7*8)]
        saved ROOT1_STACK, rtmp, rtmp_tw
        ldrd root2, root2_tw, [r_ptr, #(2*8 - 7*8)]
        ldrd root3, root3_tw, [r_ptr, #(3*8 - 7*8)]
        ldrd rtmp, rtmp_tw, [r_ptr, #(4*8 - 7*8)]
        saved ROOT4_STACK, rtmp, rtmp_tw
        ldrd root5, root5_tw, [r_ptr, #(5*8 - 7*8)]
        ldrd root6, root6_tw, [r_ptr, #(6*8 - 7*8)]
        save RPTR_STACK, r_ptr

        .unreq rtmp
        .unreq rtmp_tw
        rtmp    .req r10
        rtmp_tw .req r11

        mov lr, #8
        .p2align 2
.p2align 2
layer123_loop:
                                              // Instructions:    85
                                              // Expected cycles: 85
                                              // Expected IPC:    1.00
                                              //
                                              // Cycle bound:     85.0
                                              // IPC bound:       1.00
                                              //
                                              // Wall time:     55.63s
                                              // User time:     55.63s
                                              //
                                              // --------------------------------- cycle (expected) --------------------------------->
                                              // 0                        25                       50                       75
                                              // |------------------------|------------------------|------------------------|---------
        restored r11, r10, ROOT0_STACK        // *....................................................................................
        vldrw.32 q4, [r1, #256]               // .*...................................................................................
        vmul.S32 q6, q4, r11                  // ..*..................................................................................
        vldrw.32 q3, [r1]                     // ...*.................................................................................
        vmul.S32 q1, q3, r11                  // ....*................................................................................
        vldrw.32 q5, [r1, #384]               // .....*...............................................................................
        vqrdmulh.S32 q7, q3, r10              // ......*..............................................................................
        vldrw.32 q2, [r0]                     // .......*.............................................................................
        vmla.S32 q1, q7, r12                  // ........*............................................................................
        vldrw.32 q3, [r1, #128]               // .........*...........................................................................
        vmul.S32 q0, q5, r11                  // ..........*..........................................................................
        vsub.U32 q7, q2, q1                   // ...........*.........................................................................
        vqrdmulh.S32 q4, q4, r10              // ............*........................................................................
        vadd.U32 q2, q2, q1                   // .............*.......................................................................
        vqrdmulh.S32 q1, q5, r10              // ..............*......................................................................
        vldrw.32 q5, [r0, #384]               // ...............*.....................................................................
        vmla.S32 q0, q1, r12                  // ................*....................................................................
        qsave QSTACK4, q7                     // .................*...................................................................
        vmul.S32 q1, q3, r11                  // ..................*..................................................................
        vsub.U32 q7, q5, q0                   // ...................*.................................................................
        vqrdmulh.S32 q3, q3, r10              // ....................*................................................................
        restored r10, r11, ROOT1_STACK        // .....................*...............................................................
        vmla.S32 q6, q4, r12                  // ......................*..............................................................
        vldrw.32 q4, [r0, #256]               // .......................*.............................................................
        vmla.S32 q1, q3, r12                  // ........................*............................................................
        vadd.U32 q0, q5, q0                   // .........................*...........................................................
        vmul.S32 q3, q0, r10                  // ..........................*..........................................................
        vadd.U32 q5, q4, q6                   // ...........................*.........................................................
        vqrdmulh.S32 q0, q0, r11              // ............................*........................................................
        vsub.U32 q6, q4, q6                   // .............................*.......................................................
        vmla.S32 q3, q0, r12                  // ..............................*......................................................
        vldrw.32 q4, [r0, #128]               // ...............................*.....................................................
        vqrdmulh.S32 q0, q5, r11              // ................................*....................................................
        qsave QSTACK6, q6                     // .................................*...................................................
        vmul.S32 q5, q5, r10                  // ..................................*..................................................
        vadd.U32 q6, q4, q1                   // ...................................*.................................................
        vmla.S32 q5, q0, r12                  // ....................................*................................................
        restored r11, r10, ROOT4_STACK        // .....................................*...............................................
        vsub.U32 q1, q4, q1                   // ......................................*..............................................
        vmul.S32 q0, q7, r11                  // .......................................*.............................................
        qsave QSTACK5, q1                     // ........................................*............................................
        vqrdmulh.S32 q4, q7, r10              // .........................................*...........................................
        vsub.U32 q1, q6, q3                   // ..........................................*..........................................
        vqrdmulh.S32 q7, q1, r5               // ...........................................*.........................................
        vadd.U32 q3, q6, q3                   // ............................................*........................................
        vmul.S32 q1, q1, r4                   // .............................................*.......................................
        vsub.U32 q6, q2, q5                   // ..............................................*......................................
        vmla.S32 q1, q7, r12                  // ...............................................*.....................................
        qrestore q7, QSTACK6                  // ................................................*....................................
        vmla.S32 q0, q4, r12                  // .................................................*...................................
        vsub.U32 q4, q6, q1                   // ..................................................*..................................
        vstrw.32 q4, [r0, #(384-16)]          // ...................................................*.................................
        vqrdmulh.S32 q4, q3, r3               // ....................................................*................................
        vadd.U32 q1, q6, q1                   // .....................................................*...............................
        vstrw.32 q1, [r0, #(256-16)]          // ......................................................*..............................
        vmul.S32 q1, q3, r2                   // .......................................................*.............................
        vadd.U32 q2, q2, q5                   // ........................................................*............................
        vmla.S32 q1, q4, r12                  // .........................................................*...........................
        qrestore q3, QSTACK5                  // ..........................................................*..........................
        vmul.S32 q6, q7, r11                  // ...........................................................*.........................
        vsub.U32 q4, q3, q0                   // ............................................................*........................
        vqrdmulh.S32 q7, q7, r10              // .............................................................*.......................
        vadd.U32 q5, q2, q1                   // ..............................................................*......................
        vmla.S32 q6, q7, r12                  // ...............................................................*.....................
        vstrw.32 q5, [r0], #16                // ................................................................*....................
        vqrdmulh.S32 q5, q4, r9               // .................................................................*...................
        vsub.U32 q2, q2, q1                   // ..................................................................*..................
        vmul.S32 q1, q4, r8                   // ...................................................................*.................
        vadd.U32 q3, q3, q0                   // ....................................................................*................
        vmla.S32 q1, q5, r12                  // .....................................................................*...............
        qrestore q7, QSTACK4                  // ......................................................................*..............
        vqrdmulh.S32 q4, q3, r7               // .......................................................................*.............
        vsub.U32 q0, q7, q6                   // ........................................................................*............
        vstrw.32 q2, [r0, #(128-16)]          // .........................................................................*...........
        vsub.U32 q5, q0, q1                   // ..........................................................................*..........
        vstrw.32 q5, [r1, #(384-16)]          // ...........................................................................*.........
        vmul.S32 q2, q3, r6                   // ............................................................................*........
        vadd.U32 q1, q0, q1                   // .............................................................................*.......
        vmla.S32 q2, q4, r12                  // ..............................................................................*......
        vadd.U32 q6, q7, q6                   // ...............................................................................*.....
        vstrw.32 q1, [r1, #(256-16)]          // ................................................................................*....
        vsub.U32 q5, q6, q2                   // .................................................................................*...
        vstrw.32 q5, [r1, #(128-16)]          // ..................................................................................*..
        vadd.U32 q3, q6, q2                   // ...................................................................................*.
        vstrw.32 q3, [r1], #16                // ....................................................................................*

                                               // --------------------------------- cycle (expected) --------------------------------->
                                               // 0                        25                       50                       75
                                               // |------------------------|------------------------|------------------------|---------
        // vldrw.32 q0, [r0]                   // .......*.............................................................................
        // vldrw.32 q1, [r1]                   // ...*.................................................................................
        // restored r10, r11, ROOT0_STACK      // *....................................................................................
        // vmul.s32       q7,  q1, r10         // ....*................................................................................
        // vqrdmulh.s32   q1,  q1, r11         // ......*..............................................................................
        // vmla.s32       q7,  q1, r12         // ........*............................................................................
        // vsub.u32       q1,    q0, q7        // ...........*.........................................................................
        // vadd.u32       q0,    q0, q7        // .............*.......................................................................
        // qsave QSTACK4, q1                   // .................*...................................................................
        // vldrw.32 q1, [r0,  #128]            // ...............................*.....................................................
        // vldrw.32 q2, [r1, #128]             // .........*...........................................................................
        // vmul.s32       q7,  q2, r10         // ..................*..................................................................
        // vqrdmulh.s32   q2,  q2, r11         // ....................*................................................................
        // vmla.s32       q7,  q2, r12         // ........................*............................................................
        // vsub.u32       q2,    q1, q7        // ......................................*..............................................
        // vadd.u32       q1,    q1, q7        // ...................................*.................................................
        // qsave QSTACK5, q2                   // ........................................*............................................
        // vldrw.32 q2, [r0, #256]             // .......................*.............................................................
        // vldrw.32 q3, [r1, #256]             // .*...................................................................................
        // vmul.s32       q7,  q3, r10         // ..*..................................................................................
        // vqrdmulh.s32   q3,  q3, r11         // ............*........................................................................
        // vmla.s32       q7,  q3, r12         // ......................*..............................................................
        // vsub.u32       q3,    q2, q7        // .............................*.......................................................
        // vadd.u32       q2,    q2, q7        // ...........................*.........................................................
        // qsave QSTACK6, q3                   // .................................*...................................................
        // vldrw.32 q3, [r0,  #384]            // ...............*.....................................................................
        // vldrw.32 q4, [r1, #384]             // .....*...............................................................................
        // vmul.s32       q7,  q4, r10         // ..........*..........................................................................
        // vqrdmulh.s32   q4,  q4, r11         // ..............*......................................................................
        // vmla.s32       q7,  q4, r12         // ................*....................................................................
        // vsub.u32       q4,    q3, q7        // ...................*.................................................................
        // vadd.u32       q3,    q3, q7        // .........................*...........................................................
        // restored r10, r11, ROOT1_STACK      // .....................*...............................................................
        // vmul.s32       q7,  q2, r10         // ..................................*..................................................
        // vqrdmulh.s32   q2,  q2, r11         // ................................*....................................................
        // vmla.s32       q7,  q2, r12         // ....................................*................................................
        // vsub.u32       q2,    q0, q7        // ..............................................*......................................
        // vadd.u32       q0,    q0, q7        // ........................................................*............................
        // vmul.s32       q7,  q3, r10         // ..........................*..........................................................
        // vqrdmulh.s32   q3,  q3, r11         // ............................*........................................................
        // vmla.s32       q7,  q3, r12         // ..............................*......................................................
        // vsub.u32       q3,    q1, q7        // ..........................................*..........................................
        // vadd.u32       q1,    q1, q7        // ............................................*........................................
        // vmul.s32       q7,  q1, r2          // .......................................................*.............................
        // vqrdmulh.s32   q1,  q1, r3          // ....................................................*................................
        // vmla.s32       q7,  q1, r12         // .........................................................*...........................
        // vsub.u32       q1,    q0, q7        // ..................................................................*..................
        // vadd.u32       q0,    q0, q7        // ..............................................................*......................
        // vmul.s32       q7,  q3, r4          // .............................................*.......................................
        // vqrdmulh.s32   q3,  q3, r5          // ...........................................*.........................................
        // vmla.s32       q7,  q3, r12         // ...............................................*.....................................
        // vsub.u32       q3,    q2, q7        // ..................................................*..................................
        // vadd.u32       q2,    q2, q7        // .....................................................*...............................
        // vstrw.32 q0, [r0], #16              // ................................................................*....................
        // vstrw.32 q1, [r0, #(128-16)]        // .........................................................................*...........
        // vstrw.32 q2, [r0, #(256-16)]        // ......................................................*..............................
        // vstrw.32 q3, [r0, #(384-16)]        // ...................................................*.................................
        // qrestore q1, QSTACK4                // ......................................................................*..............
        // qrestore q2, QSTACK5                // ..........................................................*..........................
        // qrestore q3, QSTACK6                // ................................................*....................................
        // restored r10, r11, ROOT4_STACK      // .....................................*...............................................
        // vmul.s32       q7,  q3, r10         // ...........................................................*.........................
        // vqrdmulh.s32   q3,  q3, r11         // .............................................................*.......................
        // vmla.s32       q7,  q3, r12         // ...............................................................*.....................
        // vsub.u32       q3,    q1, q7        // ........................................................................*............
        // vadd.u32       q1,    q1, q7        // ...............................................................................*.....
        // vmul.s32       q7,  q4, r10         // .......................................*.............................................
        // vqrdmulh.s32   q4,  q4, r11         // .........................................*...........................................
        // vmla.s32       q7,  q4, r12         // .................................................*...................................
        // vsub.u32       q4,    q2, q7        // ............................................................*........................
        // vadd.u32       q2,    q2, q7        // ....................................................................*................
        // vmul.s32       q7,  q2, r6          // ............................................................................*........
        // vqrdmulh.s32   q2,  q2, r7          // .......................................................................*.............
        // vmla.s32       q7,  q2, r12         // ..............................................................................*......
        // vsub.u32       q2,    q1, q7        // .................................................................................*...
        // vadd.u32       q1,    q1, q7        // ...................................................................................*.
        // vmul.s32       q7,  q4, r8          // ...................................................................*.................
        // vqrdmulh.s32   q4,  q4, r9          // .................................................................*...................
        // vmla.s32       q7,  q4, r12         // .....................................................................*...............
        // vsub.u32       q4,    q3, q7        // ..........................................................................*..........
        // vadd.u32       q3,    q3, q7        // .............................................................................*.......
        // vstrw.32 q1, [r1], #16              // ....................................................................................*
        // vstrw.32 q2, [r1, #(128-16)]        // ..................................................................................*..
        // vstrw.32 q3, [r1, #(256-16)]        // ................................................................................*....
        // vstrw.32 q4, [r1, #(384-16)]        // ...........................................................................*.........

        le lr, layer123_loop
        .unreq in_high
        .unreq in_low

        sub in, in, #(128)
        restore r_ptr, RPTR_STACK

        // Layers 4,5,6

        .unreq rtmp
        .unreq rtmp_tw
        rtmp    .req r3
        rtmp_tw .req r4

        mov lr, #8
        .p2align 2
.p2align 2
layer456_loop:
                                                 // Instructions:    89
                                                 // Expected cycles: 89
                                                 // Expected IPC:    1.00
                                                 //
                                                 // Cycle bound:     89.0
                                                 // IPC bound:       1.00
                                                 //
                                                 // Wall time:     8.60s
                                                 // User time:     8.60s
                                                 //
                                                 // ----------------------------------- cycle (expected) ----------------------------------->
                                                 // 0                        25                       50                       75
                                                 // |------------------------|------------------------|------------------------|-------------
        ldrd r6, r1, [r11], #(7*8)               // *........................................................................................
        vldrw.32 q0, [r0, #96]                   // .*.......................................................................................
        vmul.S32 q4, q0, r6                      // ..*......................................................................................
        vldrw.32 q3, [r0, #64]                   // ...*.....................................................................................
        vqrdmulh.S32 q5, q0, r1                  // ....*....................................................................................
        vldrw.32 q2, [r0, #32]                   // .....*...................................................................................
        vmla.S32 q4, q5, r12                     // ......*..................................................................................
        ldrd r2, r8, [r11, #((-7 + 1)*8)]        // .......*.................................................................................
        vmul.S32 q1, q3, r6                      // ........*................................................................................
        vadd.U32 q6, q2, q4                      // .........*...............................................................................
        vmul.S32 q7, q6, r2                      // ..........*..............................................................................
        vsub.U32 q4, q2, q4                      // ...........*.............................................................................
        vqrdmulh.S32 q6, q6, r8                  // ............*............................................................................
        ldrd r9, r4, [r11, #((-7 + 4)*8)]        // .............*...........................................................................
        vmla.S32 q7, q6, r12                     // ..............*..........................................................................
        vldrw.32 q0, [r0]                        // ...............*.........................................................................
        vqrdmulh.S32 q5, q3, r1                  // ................*........................................................................
        vldrw.32 q3, [r0, #112]                  // .................*.......................................................................
        vmla.S32 q1, q5, r12                     // ..................*......................................................................
        qsave QSTACK6, q4                        // ...................*.....................................................................
        vmul.S32 q6, q3, r6                      // ....................*....................................................................
        vadd.U32 q5, q0, q1                      // .....................*...................................................................
        vqrdmulh.S32 q2, q3, r1                  // ......................*..................................................................
        vsub.U32 q1, q0, q1                      // .......................*.................................................................
        vmla.S32 q6, q2, r12                     // ........................*................................................................
        vldrw.32 q3, [r0, #48]                   // .........................*...............................................................
        vadd.U32 q4, q3, q6                      // ..........................*..............................................................
        vqrdmulh.S32 q0, q4, r8                  // ...........................*.............................................................
        vsub.U32 q6, q3, q6                      // ............................*............................................................
        vqrdmulh.S32 q2, q6, r4                  // .............................*...........................................................
        qsave QSTACK4, q1                        // ..............................*..........................................................
        vmul.S32 q1, q4, r2                      // ...............................*.........................................................
        vsub.U32 q4, q5, q7                      // ................................*........................................................
        vmla.S32 q1, q0, r12                     // .................................*.......................................................
        vadd.U32 q5, q5, q7                      // ..................................*......................................................
        vmul.S32 q0, q6, r9                      // ...................................*.....................................................
        vldrw.32 q3, [r0, #80]                   // ....................................*....................................................
        vqrdmulh.S32 q7, q3, r1                  // .....................................*...................................................
        vldrw.32 q6, [r0, #16]                   // ......................................*..................................................
        vmul.S32 q3, q3, r6                      // .......................................*.................................................
        ldrd r6, r8, [r11, #((-7 + 2)*8)]        // ........................................*................................................
        vmla.S32 q3, q7, r12                     // .........................................*...............................................
        ldrd r2, r1, [r11, #((-7 + 3)*8)]        // ..........................................*..............................................
        vsub.U32 q7, q6, q3                      // ...........................................*.............................................
        vmla.S32 q0, q2, r12                     // ............................................*............................................
        vadd.U32 q3, q6, q3                      // .............................................*...........................................
        qsave QSTACK5, q7                        // ..............................................*..........................................
        vadd.U32 q7, q3, q1                      // ...............................................*.........................................
        vqrdmulh.S32 q2, q7, r8                  // ................................................*........................................
        ldrd r7, r8, [r11, #((-7 + 5)*8)]        // .................................................*.......................................
        vmul.S32 q6, q7, r6                      // ..................................................*......................................
        qrestore q7, QSTACK6                     // ...................................................*.....................................
        vmla.S32 q6, q2, r12                     // ....................................................*....................................
        vsub.U32 q2, q3, q1                      // .....................................................*...................................
        vqrdmulh.S32 q1, q2, r1                  // ......................................................*..................................
        vadd.U32 q3, q5, q6                      // .......................................................*.................................
        vmul.S32 q2, q2, r2                      // ........................................................*................................
        vstrw.32 q3, [r0], #128                  // .........................................................*...............................
        vmla.S32 q2, q1, r12                     // ..........................................................*..............................
        vsub.U32 q5, q5, q6                      // ...........................................................*.............................
        vmul.S32 q6, q7, r9                      // ............................................................*............................
        qrestore q3, QSTACK5                     // .............................................................*...........................
        vqrdmulh.S32 q1, q7, r4                  // ..............................................................*..........................
        vstrw.32 q5, [r0, #(-128+16)]            // ...............................................................*.........................
        vmla.S32 q6, q1, r12                     // ................................................................*........................
        vadd.U32 q1, q3, q0                      // .................................................................*.......................
        ldrd r3, r5, [r11, #((-7 + 6)*8)]        // ..................................................................*......................
        vsub.U32 q7, q3, q0                      // ...................................................................*.....................
        vqrdmulh.S32 q0, q1, r8                  // ....................................................................*....................
        vadd.U32 q3, q4, q2                      // .....................................................................*...................
        vstrw.32 q3, [r0, #(-128+32)]            // ......................................................................*..................
        vmul.S32 q3, q1, r7                      // .......................................................................*.................
        vsub.U32 q4, q4, q2                      // ........................................................................*................
        vmla.S32 q3, q0, r12                     // .........................................................................*...............
        qrestore q1, QSTACK4                     // ..........................................................................*..............
        vmul.S32 q2, q7, r3                      // ...........................................................................*.............
        vstrw.32 q4, [r0, #(-128+48)]            // ............................................................................*............
        vsub.U32 q4, q1, q6                      // .............................................................................*...........
        vqrdmulh.S32 q7, q7, r5                  // ..............................................................................*..........
        vadd.U32 q1, q1, q6                      // ...............................................................................*.........
        vmla.S32 q2, q7, r12                     // ................................................................................*........
        vsub.U32 q0, q1, q3                      // .................................................................................*.......
        vstrw.32 q0, [r0, #(-128+80)]            // ..................................................................................*......
        vadd.U32 q6, q4, q2                      // ...................................................................................*.....
        vstrw.32 q6, [r0, #(-128+96)]            // ....................................................................................*....
        vadd.U32 q6, q1, q3                      // .....................................................................................*...
        vstrw.32 q6, [r0, #(-128+64)]            // ......................................................................................*..
        vsub.U32 q7, q4, q2                      // .......................................................................................*.
        vstrw.32 q7, [r0, #(-128+112)]           // ........................................................................................*

                                                  // ----------------------------------- cycle (expected) ----------------------------------->
                                                  // 0                        25                       50                       75
                                                  // |------------------------|------------------------|------------------------|-------------
        // ldrd r3, r4, [r11], #(7*8)             // *........................................................................................
        // vldrw.32 q0, [r0]                      // ...............*.........................................................................
        // vldrw.32 q1, [r0, #64]                 // ...*.....................................................................................
        // vmul.s32       q7,  q1, r3             // ........*................................................................................
        // vqrdmulh.s32   q1,  q1, r4             // ................*........................................................................
        // vmla.s32       q7,  q1, r12            // ..................*......................................................................
        // vsub.u32       q1,    q0, q7           // .......................*.................................................................
        // vadd.u32       q0,    q0, q7           // .....................*...................................................................
        // qsave QSTACK4, q1                      // ..............................*..........................................................
        // vldrw.32 q1, [r0, #16]                 // ......................................*..................................................
        // vldrw.32 q2, [r0, #80]                 // ....................................*....................................................
        // vmul.s32       q7,  q2, r3             // .......................................*.................................................
        // vqrdmulh.s32   q2,  q2, r4             // .....................................*...................................................
        // vmla.s32       q7,  q2, r12            // .........................................*...............................................
        // vsub.u32       q2,    q1, q7           // ...........................................*.............................................
        // vadd.u32       q1,    q1, q7           // .............................................*...........................................
        // qsave QSTACK5, q2                      // ..............................................*..........................................
        // vldrw.32 q2, [r0, #32]                 // .....*...................................................................................
        // vldrw.32 q3, [r0, #96]                 // .*.......................................................................................
        // vmul.s32       q7,  q3, r3             // ..*......................................................................................
        // vqrdmulh.s32   q3,  q3, r4             // ....*....................................................................................
        // vmla.s32       q7,  q3, r12            // ......*..................................................................................
        // vsub.u32       q3,    q2, q7           // ...........*.............................................................................
        // vadd.u32       q2,    q2, q7           // .........*...............................................................................
        // qsave QSTACK6, q3                      // ...................*.....................................................................
        // vldrw.32 q3, [r0, #48]                 // .........................*...............................................................
        // vldrw.32 q4, [r0, #112]                // .................*.......................................................................
        // vmul.s32       q7,  q4, r3             // ....................*....................................................................
        // vqrdmulh.s32   q4,  q4, r4             // ......................*..................................................................
        // vmla.s32       q7,  q4, r12            // ........................*................................................................
        // vsub.u32       q4,    q3, q7           // ............................*............................................................
        // vadd.u32       q3,    q3, q7           // ..........................*..............................................................
        // ldrd r3, r4, [r11, #((-7 + 1)*8)]      // .......*.................................................................................
        // vmul.s32       q7,  q2, r3             // ..........*..............................................................................
        // vqrdmulh.s32   q2,  q2, r4             // ............*............................................................................
        // vmla.s32       q7,  q2, r12            // ..............*..........................................................................
        // vsub.u32       q2,    q0, q7           // ................................*........................................................
        // vadd.u32       q0,    q0, q7           // ..................................*......................................................
        // vmul.s32       q7,  q3, r3             // ...............................*.........................................................
        // vqrdmulh.s32   q3,  q3, r4             // ...........................*.............................................................
        // vmla.s32       q7,  q3, r12            // .................................*.......................................................
        // vsub.u32       q3,    q1, q7           // .....................................................*...................................
        // vadd.u32       q1,    q1, q7           // ...............................................*.........................................
        // ldrd r3, r4, [r11, #((-7 + 2)*8)]      // ........................................*................................................
        // vmul.s32       q7,  q1, r3             // ..................................................*......................................
        // vqrdmulh.s32   q1,  q1, r4             // ................................................*........................................
        // vmla.s32       q7,  q1, r12            // ....................................................*....................................
        // vsub.u32       q1,    q0, q7           // ...........................................................*.............................
        // vadd.u32       q0,    q0, q7           // .......................................................*.................................
        // ldrd r3, r4, [r11, #((-7 + 3)*8)]      // ..........................................*..............................................
        // vmul.s32       q7,  q3, r3             // ........................................................*................................
        // vqrdmulh.s32   q3,  q3, r4             // ......................................................*..................................
        // vmla.s32       q7,  q3, r12            // ..........................................................*..............................
        // vsub.u32       q3,    q2, q7           // ........................................................................*................
        // vadd.u32       q2,    q2, q7           // .....................................................................*...................
        // vstrw.32 q0, [r0], #128                // .........................................................*...............................
        // vstrw.32 q1, [r0, #(-128+16)]          // ...............................................................*.........................
        // vstrw.32 q2, [r0, #(-128+32)]          // ......................................................................*..................
        // vstrw.32 q3, [r0, #(-128+48)]          // ............................................................................*............
        // qrestore q1, QSTACK4                   // ..........................................................................*..............
        // qrestore q2, QSTACK5                   // .............................................................*...........................
        // qrestore q3, QSTACK6                   // ...................................................*.....................................
        // ldrd r3, r4, [r11, #((-7 + 4)*8)]      // .............*...........................................................................
        // vmul.s32       q7,  q3, r3             // ............................................................*............................
        // vqrdmulh.s32   q3,  q3, r4             // ..............................................................*..........................
        // vmla.s32       q7,  q3, r12            // ................................................................*........................
        // vsub.u32       q3,    q1, q7           // .............................................................................*...........
        // vadd.u32       q1,    q1, q7           // ...............................................................................*.........
        // vmul.s32       q7,  q4, r3             // ...................................*.....................................................
        // vqrdmulh.s32   q4,  q4, r4             // .............................*...........................................................
        // vmla.s32       q7,  q4, r12            // ............................................*............................................
        // vsub.u32       q4,    q2, q7           // ...................................................................*.....................
        // vadd.u32       q2,    q2, q7           // .................................................................*.......................
        // ldrd r3, r4, [r11, #((-7 + 5)*8)]      // .................................................*.......................................
        // vmul.s32       q7,  q2, r3             // .......................................................................*.................
        // vqrdmulh.s32   q2,  q2, r4             // ....................................................................*....................
        // vmla.s32       q7,  q2, r12            // .........................................................................*...............
        // vsub.u32       q2,    q1, q7           // .................................................................................*.......
        // vadd.u32       q1,    q1, q7           // .....................................................................................*...
        // ldrd r3, r4, [r11, #((-7 + 6)*8)]      // ..................................................................*......................
        // vmul.s32       q7,  q4, r3             // ...........................................................................*.............
        // vqrdmulh.s32   q4,  q4, r4             // ..............................................................................*..........
        // vmla.s32       q7,  q4, r12            // ................................................................................*........
        // vsub.u32       q4,    q3, q7           // .......................................................................................*.
        // vadd.u32       q3,    q3, q7           // ...................................................................................*.....
        // vstrw.32 q1, [r0, #(-128+64)]          // ......................................................................................*..
        // vstrw.32 q2, [r0, #(-128+80)]          // ..................................................................................*......
        // vstrw.32 q3, [r0, #(-128+96)]          // ....................................................................................*....
        // vstrw.32 q4, [r0, #(-128+112)]         // ........................................................................................*

        le lr, layer456_loop

        sub in, in, #(4*256)

        .unreq rtmp
        .unreq rtmp_tw
        .unreq root2
        .unreq root2_tw

        // Layers 7,8

        root0         .req q5
        root0_tw .req q6
        root1         .req q5
        root1_tw .req q6
        root2         .req q5
        root2_tw .req q6

        mov lr, #16
        .p2align 2
                                                // Instructions:    6
                                                // Expected cycles: 10
                                                // Expected IPC:    0.60
                                                //
                                                // Cycle bound:     10.0
                                                // IPC bound:       0.60
                                                //
                                                // Wall time:     0.02s
                                                // User time:     0.02s
                                                //
                                                // ----- cycle (expected) ------>
                                                // 0                        25
                                                // |------------------------|----
        vld40.32 {q1, q2, q3, q4}, [r0]         // *.............................
        vld41.32 {q1, q2, q3, q4}, [r0]         // ..*...........................
        vld42.32 {q1, q2, q3, q4}, [r0]         // ....*.........................
        vld43.32 {q1, q2, q3, q4}, [r0]!        // ......*.......................
        vldrw.32 q0, [r11], #+96                // ........*.....................
        vmul.S32 q7, q4, q0                     // .........*....................

                                                 // ------ cycle (expected) ------>
                                                 // 0                        25
                                                 // |------------------------|-----
        // vld40.32 {q1, q2, q3, q4}, [r0]       // *..............................
        // vld41.32 {q1, q2, q3, q4}, [r0]       // ..*............................
        // vld42.32 {q1, q2, q3, q4}, [r0]       // ....*..........................
        // vldrw.32 q0, [r11], #+96              // ........*......................
        // vld43.32 {q1, q2, q3, q4}, [r0]!      // ......*........................
        // vmul.S32 q7, q4, q0                   // .........*.....................

        sub lr, lr, #1
.p2align 2
layer78_loop:
                                                // Instructions:    34
                                                // Expected cycles: 34
                                                // Expected IPC:    1.00
                                                //
                                                // Cycle bound:     40.0
                                                // IPC bound:       0.85
                                                //
                                                // Wall time:     17.94s
                                                // User time:     17.94s
                                                //
                                                // ------- cycle (expected) -------->
                                                // 0                        25
                                                // |------------------------|--------
        vmul.S32 q6, q3, q0                     // *.................................
        vldrw.32 q0, [r11, #(+16-96)]           // .*................................
        vqrdmulh.S32 q4, q4, q0                 // ..*...............................
        vldrw.32 q5, [r11, #(64-96)]            // ...*..............................
        vmla.S32 q7, q4, r12                    // ....*.............................
        vldrw.32 q4, [r11, #(48 - 96)]          // .....*............................
        vqrdmulh.S32 q0, q3, q0                 // ......*...........................
        vadd.U32 q3, q2, q7                     // .......*..........................
        vqrdmulh.S32 q4, q3, q4                 // ........*.........................
        vsub.U32 q7, q2, q7                     // .........*........................
        vmla.S32 q6, q0, r12                    // ..........*.......................
        vldrw.32 q0, [r11, #(32 - 96)]          // ...........*......................
        vmul.S32 q3, q3, q0                     // ............*.....................
        vadd.U32 q2, q1, q6                     // .............*....................
        vmla.S32 q3, q4, r12                    // ..............*...................
        vldrw.32 q0, [r11, #(80-96)]            // ...............*..................
        vadd.U32 q4, q2, q3                     // ................*.................
        vstrw.32 q4, [r0, #( 0 - 64)]           // .................*................
        vsub.U32 q4, q2, q3                     // ..................*...............
        vstrw.32 q4, [r0, #(16 - 64)]           // ...................*..............
        vsub.U32 q6, q1, q6                     // ....................*.............
        vld40.32 {q1, q2, q3, q4}, [r0]         // .....................e............
        vqrdmulh.S32 q0, q7, q0                 // ......................*...........
        vld41.32 {q1, q2, q3, q4}, [r0]         // .......................e..........
        vmul.S32 q5, q7, q5                     // ........................*.........
        vld42.32 {q1, q2, q3, q4}, [r0]         // .........................e........
        vmla.S32 q5, q0, r12                    // ..........................*.......
        vldrw.32 q0, [r11], #+96                // ...........................e......
        vsub.U32 q7, q6, q5                     // ............................*.....
        vld43.32 {q1, q2, q3, q4}, [r0]!        // .............................e....
        vadd.U32 q5, q6, q5                     // ..............................*...
        vstrw.32 q7, [r0, #(48 - 64)]           // ...............................*..
        vmul.S32 q7, q4, q0                     // ................................e.
        vstrw.32 q5, [r0, #(32 - 64)]           // .................................*

                                                       // -------------- cycle (expected) -------------->
                                                       // 0                        25
                                                       // |------------------------|---------------------
        // vld40.32 {q0, q1, q2, q3}, [r0]             // e............'....................~............
        // vld41.32 {q0, q1, q2, q3}, [r0]             // ..e..........'......................~..........
        // vld42.32 {q0, q1, q2, q3}, [r0]             // ....e........'........................~........
        // vld43.32 {q0, q1, q2, q3}, [r0]!            // ........e....'............................~....
        // vldrw.32 q5,    [r11], #+96                 // ......e......'..........................~......
        // vldrw.32 q6, [r11, #(+16-96)]               // .............'*................................
        // vmul.s32       q7,  q2, q5                  // .............*.................................
        // vqrdmulh.s32   q2,  q2, q6                  // .............'.....*...........................
        // vmla.s32       q7,  q2, r12                 // .............'.........*.......................
        // vsub.u32       q2,    q0, q7                // .............'...................*.............
        // vadd.u32       q0,    q0, q7                // .............'............*....................
        // vmul.s32       q7,  q3, q5                  // ...........e.'...............................~.
        // vqrdmulh.s32   q3,  q3, q6                  // .............'.*...............................
        // vmla.s32       q7,  q3, r12                 // .............'...*.............................
        // vsub.u32       q3,    q1, q7                // .............'........*........................
        // vadd.u32       q1,    q1, q7                // .............'......*..........................
        // vldrw.32 q5,         [r11, #(32 - 96)]      // .............'..........*......................
        // vldrw.32 q6, [r11, #(48 - 96)]              // .............'....*............................
        // vmul.s32       q7,  q1, q5                  // .............'...........*.....................
        // vqrdmulh.s32   q1,  q1, q6                  // .............'.......*.........................
        // vmla.s32       q7,  q1, r12                 // .............'.............*...................
        // vsub.u32       q1,    q0, q7                // .............'.................*...............
        // vadd.u32       q0,    q0, q7                // .............'...............*.................
        // vldrw.32 q5,         [r11, #(64-96)]        // .............'..*..............................
        // vldrw.32 q6, [r11, #(80-96)]                // .............'..............*..................
        // vmul.s32       q7,  q3, q5                  // ...~.........'.......................*.........
        // vqrdmulh.s32   q3,  q3, q6                  // .~...........'.....................*...........
        // vmla.s32       q7,  q3, r12                 // .....~.......'.........................*.......
        // vsub.u32       q3,    q2, q7                // .......~.....'...........................*.....
        // vadd.u32       q2,    q2, q7                // .........~...'.............................*...
        // vstrw.32 q0, [r0, #( 0 - 64)]               // .............'................*................
        // vstrw.32 q1, [r0, #(16 - 64)]               // .............'..................*..............
        // vstrw.32 q2, [r0, #(32 - 64)]               // ............~'................................*
        // vstrw.32 q3, [r0, #(48 - 64)]               // ..........~..'..............................*..

        le lr, layer78_loop
                                              // Instructions:    28
                                              // Expected cycles: 28
                                              // Expected IPC:    1.00
                                              //
                                              // Cycle bound:     28.0
                                              // IPC bound:       1.00
                                              //
                                              // Wall time:     0.55s
                                              // User time:     0.55s
                                              //
                                              // ----- cycle (expected) ------>
                                              // 0                        25
                                              // |------------------------|----
        vmul.S32 q6, q3, q0                   // *.............................
        vldrw.32 q5, [r11, #(+16-96)]         // .*............................
        vqrdmulh.S32 q0, q3, q5               // ..*...........................
        vldrw.32 q3, [r11, #(32 - 96)]        // ...*..........................
        vqrdmulh.S32 q5, q4, q5               // ....*.........................
        vldrw.32 q4, [r11, #(80-96)]          // .....*........................
        vmla.S32 q7, q5, r12                  // ......*.......................
        vldrw.32 q5, [r11, #(64-96)]          // .......*......................
        vmla.S32 q6, q0, r12                  // ........*.....................
        vsub.U32 q0, q2, q7                   // .........*....................
        vmul.S32 q5, q0, q5                   // ..........*...................
        vadd.U32 q7, q2, q7                   // ...........*..................
        vqrdmulh.S32 q2, q0, q4               // ............*.................
        vsub.U32 q0, q1, q6                   // .............*................
        vmla.S32 q5, q2, r12                  // ..............*...............
        vldrw.32 q2, [r11, #(48 - 96)]        // ...............*..............
        vsub.U32 q4, q0, q5                   // ................*.............
        vmul.S32 q3, q7, q3                   // .................*............
        vadd.U32 q0, q0, q5                   // ..................*...........
        vqrdmulh.S32 q5, q7, q2               // ...................*..........
        vadd.U32 q6, q1, q6                   // ....................*.........
        vstrw.32 q0, [r0, #(32 - 64)]         // .....................*........
        vmla.S32 q3, q5, r12                  // ......................*.......
        vstrw.32 q4, [r0, #(48 - 64)]         // .......................*......
        vadd.U32 q5, q6, q3                   // ........................*.....
        vstrw.32 q5, [r0, #( 0 - 64)]         // .........................*....
        vsub.U32 q1, q6, q3                   // ..........................*...
        vstrw.32 q1, [r0, #(16 - 64)]         // ...........................*..

                                               // ------ cycle (expected) ------>
                                               // 0                        25
                                               // |------------------------|-----
        // vmul.S32 q6, q3, q0                 // *..............................
        // vldrw.32 q0, [r11, #(+16-96)]       // .*.............................
        // vqrdmulh.S32 q4, q4, q0             // ....*..........................
        // vldrw.32 q5, [r11, #(64-96)]        // .......*.......................
        // vmla.S32 q7, q4, r12                // ......*........................
        // vldrw.32 q4, [r11, #(48 - 96)]      // ...............*...............
        // vqrdmulh.S32 q0, q3, q0             // ..*............................
        // vadd.U32 q3, q2, q7                 // ...........*...................
        // vqrdmulh.S32 q4, q3, q4             // ...................*...........
        // vsub.U32 q7, q2, q7                 // .........*.....................
        // vmla.S32 q6, q0, r12                // ........*......................
        // vldrw.32 q0, [r11, #(32 - 96)]      // ...*...........................
        // vmul.S32 q3, q3, q0                 // .................*.............
        // vadd.U32 q2, q1, q6                 // ....................*..........
        // vmla.S32 q3, q4, r12                // ......................*........
        // vldrw.32 q0, [r11, #(80-96)]        // .....*.........................
        // vadd.U32 q4, q2, q3                 // ........................*......
        // vstrw.32 q4, [r0, #( 0 - 64)]       // .........................*.....
        // vsub.U32 q4, q2, q3                 // ..........................*....
        // vstrw.32 q4, [r0, #(16 - 64)]       // ...........................*...
        // vsub.U32 q6, q1, q6                 // .............*.................
        // vqrdmulh.S32 q0, q7, q0             // ............*..................
        // vmul.S32 q5, q7, q5                 // ..........*....................
        // vmla.S32 q5, q0, r12                // ..............*................
        // vsub.U32 q7, q6, q5                 // ................*..............
        // vadd.U32 q5, q6, q5                 // ..................*............
        // vstrw.32 q7, [r0, #(48 - 64)]       // .......................*.......
        // vstrw.32 q5, [r0, #(32 - 64)]       // .....................*.........


        add sp, sp, #STACK_SIZE
        align_stack_undo

        // Restore MVE vector registers
        vpop {d8-d15}
        // Restore GPRs
        pop {r4-r11,lr}
        bx lr
