///
/// Copyright (c) 2022 Arm Limited
/// Copyright (c) 2022 Hanno Becker
/// Copyright (c) 2023 Amin Abdulrahman, Matthias Kannwischer
/// SPDX-License-Identifier: MIT
///
/// Permission is hereby granted, free of charge, to any person obtaining a copy
/// of this software and associated documentation files (the "Software"), to deal
/// in the Software without restriction, including without limitation the rights
/// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
/// copies of the Software, and to permit persons to whom the Software is
/// furnished to do so, subject to the following conditions:
///
/// The above copyright notice and this permission notice shall be included in all
/// copies or substantial portions of the Software.
///
/// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
/// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
/// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
/// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
/// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
/// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
/// SOFTWARE.
///

.data
.p2align 4
roots:
#include "ntt_dilithium_123_456_78_twiddles.s"
.text

// Barrett multiplication
.macro mulmod dst, src, const, const_twisted
        vmul.s32       \dst,  \src, \const
        vqrdmulh.s32   \src,  \src, \const_twisted
        vmla.s32       \dst,  \src, modulus
.endm

.macro ct_butterfly a, b, root, root_twisted
        mulmod tmp, \b, \root, \root_twisted
        vsub.u32       \b,    \a, tmp
        vadd.u32       \a,    \a, tmp
.endm

.macro qsave loc, a       // slothy:no-unfold
        vstrw.32 \a, [sp, #\loc\()]
.endm
.macro qrestore a, loc    // slothy:no-unfold
        vldrw.32 \a, [sp, #\loc\()]
.endm
.macro restored a, b, loc // slothy:no-unfold
        ldrd \a, \b, [sp, #\loc\()]
.endm
.macro saved loc, a, b    // slothy:no-unfold
        strd \a, \b, [sp, #\loc\()]
.endm
.macro restore a, loc     // slothy:no-unfold
        ldr \a, [sp, #\loc\()]
.endm
.macro save loc, a        // slothy:no-unfold
        str \a, [sp, #\loc\()]
.endm

// Aligns stack =0 mod 16
.macro align_stack_do // slothy:no-unfold
        mov r11, sp
        and r12, r11, #0xC   // 8 of ==8 mod 16, 0 otherwise
        sub sp, sp, r12      // Align stack to 16 byte
        sub sp, sp, #16
        str r12, [sp]
.endm

// Reverts initial stack correction
.macro align_stack_undo // slothy:no-unfold
        ldr r12, [sp]
        add sp, sp, #16
        add sp, sp, r12
.endm

#define STACK_SIZE (5*16+8)    // +8 is for alignment
#define QSTACK4 (0*16)
#define QSTACK5 (1*16)
#define QSTACK6 (2*16)

#define ROOT0_STACK (3*16)
#define ROOT1_STACK (3*16 + 8)
#define ROOT4_STACK (4*16)
#define RPTR_STACK  (4*16 + 8)

.align 4
roots_addr: .word roots
.syntax unified
.type ntt_dilithium_123_456_78_opt_speed_m55, %function
.global ntt_dilithium_123_456_78_opt_speed_m55
ntt_dilithium_123_456_78_opt_speed_m55:

        push {r4-r11,lr}
        // Save MVE vector registers
        vpush {d8-d15}

        align_stack_do
        sub sp, sp, #STACK_SIZE

        modulus .req r12
        r_ptr   .req r11

        .equ modulus_const, -8380417
        movw modulus, #:lower16:modulus_const
        movt modulus, #:upper16:modulus_const
        ldr  r_ptr, roots_addr

        in           .req r0
        in_low       .req in
        in_high      .req r1

        add in_high, in, #(4*128)

        root2    .req r2
        root2_tw .req r3
        root3    .req r4
        root3_tw .req r5
        root5    .req r6
        root5_tw .req r7
        root6    .req r8
        root6_tw .req r9

        data0 .req q0
        data1 .req q1
        data2 .req q2
        data3 .req q3
        data4 .req q1
        data5 .req q2
        data6 .req q3
        data7 .req q4

        tmp .req q7

        // Layers 1-3

        rtmp    .req root6
        rtmp_tw .req root6_tw

        ldrd rtmp, rtmp_tw, [r_ptr], #(7*8)
        saved ROOT0_STACK, rtmp, rtmp_tw
        ldrd rtmp, rtmp_tw, [r_ptr, #(1*8 - 7*8)]
        saved ROOT1_STACK, rtmp, rtmp_tw
        ldrd root2, root2_tw, [r_ptr, #(2*8 - 7*8)]
        ldrd root3, root3_tw, [r_ptr, #(3*8 - 7*8)]
        ldrd rtmp, rtmp_tw, [r_ptr, #(4*8 - 7*8)]
        saved ROOT4_STACK, rtmp, rtmp_tw
        ldrd root5, root5_tw, [r_ptr, #(5*8 - 7*8)]
        ldrd root6, root6_tw, [r_ptr, #(6*8 - 7*8)]
        save RPTR_STACK, r_ptr

        .unreq rtmp
        .unreq rtmp_tw
        rtmp    .req r10
        rtmp_tw .req r11

        mov lr, #8
        .p2align 2
        restored r11, r10, ROOT0_STACK
        vldrw.32 q7, [r1, #128]
        vmul.s32 q3, q7, r11
        vldrw.32 q0, [r0, #128]
        vqrdmulh.s32 q5, q7, r10
        vldrw.32 q2, [r1, #384]
        vmla.s32 q3, q5, r12
        vldrw.32 q4, [r1, #256]
        vqrdmulh.s32 q1, q2, r10
        vsub.u32 q6, q0, q3
        vmul.s32 q5, q4, r11
        vldrw.32 q7, [r1]
        vmul.s32 q2, q2, r11
        qsave QSTACK5, q6
        vmla.s32 q2, q1, r12
        vadd.u32 q1, q0, q3
        vqrdmulh.s32 q4, q4, r10
        vldrw.32 q6, [r0, #384]
        vmla.s32 q5, q4, r12
        vsub.u32 q0, q6, q2
        vqrdmulh.s32 q4, q7, r10
        vadd.u32 q2, q6, q2
        vldrw.32 q3, [r0, #256]
        vmul.s32 q7, q7, r11
        restored r10, r11, ROOT1_STACK
        vmla.s32 q7, q4, r12
        vadd.u32 q6, q3, q5
        vqrdmulh.s32 q4, q6, r11
        vsub.u32 q3, q3, q5
        vmul.s32 q5, q6, r10
        vldrw.32 q6, [r0]
        vmla.s32 q5, q4, r12
        qsave QSTACK6, q3
        vqrdmulh.s32 q4, q2, r11
        vsub.u32 q3, q6, q7
        vmul.s32 q2, q2, r10
        qsave QSTACK4, q3
        vmla.s32 q2, q4, r12
        vadd.u32 q4, q6, q7
        restored r11, r10, ROOT4_STACK
        vsub.u32 q6, q1, q2
        vmul.s32 q3, q6, r4
        sub lr, lr, #1
.p2align 2
layer123_loop:
        vadd.u32 q1, q1, q2                    // ....*................................................................................
        vqrdmulh.s32 q7, q6, r5                // .*...................................................................................
        vsub.u32 q2, q4, q5                    // *....................................................................................
        vmla.s32 q3, q7, r12                   // ...*.................................................................................
        vadd.u32 q6, q4, q5                    // ..*..................................................................................
        vqrdmulh.s32 q7, q1, r3                // .......*.............................................................................
        qrestore q5, QSTACK6                   // ............*........................................................................
        vmul.s32 q1, q1, r2                    // ...........*.........................................................................
        vadd.u32 q4, q2, q3                    // ..........*..........................................................................
        vmla.s32 q1, q7, r12                   // .............*.......................................................................
        vstrw.u32 q4, [r0, #256]               // ................*....................................................................
        vadd.u32 q7, q6, q1                    // .........................*...........................................................
        vmul.s32 q4, q5, r11                   // ...................*.................................................................
        vsub.u32 q3, q2, q3                    // ......*..............................................................................
        vqrdmulh.s32 q2, q5, r10               // .................*...................................................................
        vstrw.u32 q3, [r0, #384]               // ........*............................................................................
        vmla.s32 q4, q2, r12                   // .......................*.............................................................
        vsub.u32 q5, q6, q1                    // ......................*..............................................................
        vmul.s32 q3, q0, r11                   // .....*...............................................................................
        qrestore q6, QSTACK4                   // ...........................*.........................................................
        vadd.u32 q2, q6, q4                    // ............................*........................................................
        vstrw.u32 q5, [r0, #128]               // ........................*............................................................
        vsub.u32 q4, q6, q4                    // ..............................*......................................................
        vqrdmulh.s32 q0, q0, r10               // .........*...........................................................................
        qrestore q1, QSTACK5                   // ..............*......................................................................
        vmla.s32 q3, q0, r12                   // ...............*.....................................................................
        vstrw.u32 q7, [r0] , #16               // ...............................*.....................................................
        vsub.u32 q6, q1, q3                    // ..................*..................................................................
        vmul.s32 q0, q6, r8                    // .....................*...............................................................
        vadd.u32 q7, q1, q3                    // ....................*................................................................
        vqrdmulh.s32 q3, q6, r9                // ..........................*..........................................................
        restored r11, r10, ROOT0_STACK         // ...........................................*.........................................
        vmla.s32 q0, q3, r12                   // .............................*.......................................................
        vldrw.32 q1, [r1, #272]                // ..................................................*..................................
        vqrdmulh.s32 q5, q7, r7                // ...................................*.................................................
        vadd.u32 q3, q4, q0                    // ..................................*..................................................
        vmul.s32 q6, q7, r6                    // .................................*...................................................
        vldrw.32 q7, [r1, #400]                // ................................................*....................................
        vmla.s32 q6, q5, r12                   // .....................................*...............................................
        vstrw.u32 q3, [r1, #256]               // ......................................*..............................................
        vadd.u32 q3, q2, q6                    // .......................................*.............................................
        vqrdmulh.s32 q5, q1, r10               // ...........................................................*.........................
        vsub.u32 q6, q2, q6                    // .........................................*...........................................
        vmul.s32 q2, q7, r11                   // .......................................................*.............................
        vstrw.u32 q3, [r1] , #16               // ........................................*............................................
        vmul.s32 q1, q1, r11                   // .....................................................*...............................
        vstrw.u32 q6, [r1, #112]               // ..........................................*..........................................
        vqrdmulh.s32 q3, q7, r10               // ...................................................*.................................
        vsub.u32 q0, q4, q0                    // ................................*....................................................
        vldrw.32 q6, [r0, #384]                // ............................................................*........................
        vmla.s32 q2, q3, r12                   // .........................................................*...........................
        vstrw.u32 q0, [r1, #368]               // ....................................*................................................
        vmla.s32 q1, q5, r12                   // .............................................................*.......................
        vadd.u32 q4, q6, q2                    // ................................................................*....................
        vldrw.32 q0, [r1]                      // ......................................................*..............................
        vmul.s32 q7, q0, r11                   // ..................................................................*..................
        vldrw.32 q3, [r0, #256]                // .................................................................*...................
        vsub.u32 q5, q3, q1                    // .......................................................................*.............
        qsave QSTACK6, q5                      // ...........................................................................*.........
        vqrdmulh.s32 q5, q0, r10               // ...............................................................*.....................
        vsub.u32 q0, q6, q2                    // ..............................................................*......................
        vmla.s32 q7, q5, r12                   // ....................................................................*................
        vldrw.32 q2, [r1, #128]                // ............................................*........................................
        vmul.s32 q6, q2, r11                   // .............................................*.......................................
        vadd.u32 q5, q3, q1                    // .....................................................................*...............
        vqrdmulh.s32 q2, q2, r10               // ...............................................*.....................................
        restored r11, r10, ROOT1_STACK         // ...................................................................*.................
        vmla.s32 q6, q2, r12                   // .................................................*...................................
        vldrw.32 q3, [r0]                      // .........................................................................*...........
        vsub.u32 q1, q3, q7                    // .............................................................................*.......
        vmul.s32 q2, q4, r11                   // ..............................................................................*......
        qsave QSTACK4, q1                      // ...............................................................................*.....
        vqrdmulh.s32 q1, q4, r10               // ............................................................................*........
        vadd.u32 q4, q3, q7                    // .................................................................................*...
        vmla.s32 q2, q1, r12                   // ................................................................................*....
        vldrw.32 q1, [r0, #128]                // ..............................................*......................................
        vsub.u32 q7, q1, q6                    // ....................................................*................................
        vqrdmulh.s32 q3, q5, r10               // ......................................................................*..............
        qsave QSTACK5, q7                      // ........................................................*............................
        vmul.s32 q5, q5, r11                   // ........................................................................*............
        vadd.u32 q1, q1, q6                    // ..........................................................*..........................
        vmla.s32 q5, q3, r12                   // ..........................................................................*..........
        vsub.u32 q6, q1, q2                    // ...................................................................................*.
        vmul.s32 q3, q6, r4                    // ....................................................................................*
        restored r11, r10, ROOT4_STACK         // ..................................................................................*..
        
        // original source code
        // vsub.u32 q7, q4, q5                 // ..*.................................................................................. 
        // vqrdmulh.s32 q6, q6, r5             // .*................................................................................... 
        // vadd.u32 q4, q4, q5                 // ....*................................................................................ 
        // vmla.s32 q3, q6, r12                // ...*................................................................................. 
        // vadd.u32 q5, q1, q2                 // *.................................................................................... 
        // vmul.s32 q6, q0, r11                // ..................*.................................................................. 
        // vsub.u32 q2, q7, q3                 // .............*....................................................................... 
        // vqrdmulh.s32 q1, q5, r3             // .....*............................................................................... 
        // vstrw.u32 q2, [r0, #384]            // ...............*..................................................................... 
        // vqrdmulh.s32 q0, q0, r10            // .......................*............................................................. 
        // vadd.u32 q7, q7, q3                 // ........*............................................................................ 
        // vmul.s32 q2, q5, r2                 // .......*............................................................................. 
        // qrestore q3, QSTACK6                // ......*.............................................................................. 
        // vmla.s32 q2, q1, r12                // .........*........................................................................... 
        // qrestore q1, QSTACK5                // ........................*............................................................ 
        // vmla.s32 q6, q0, r12                // .........................*........................................................... 
        // vstrw.u32 q7, [r0, #256]            // ..........*.......................................................................... 
        // vqrdmulh.s32 q0, q3, r10            // ..............*...................................................................... 
        // vsub.u32 q7, q1, q6                 // ...........................*......................................................... 
        // vmul.s32 q3, q3, r11                // ............*........................................................................ 
        // vadd.u32 q6, q1, q6                 // .............................*....................................................... 
        // vmul.s32 q5, q7, r8                 // ............................*........................................................ 
        // vsub.u32 q1, q4, q2                 // .................*................................................................... 
        // vmla.s32 q3, q0, r12                // ................*.................................................................... 
        // vstrw.u32 q1, [r0, #128]            // .....................*............................................................... 
        // vadd.u32 q0, q4, q2                 // ...........*......................................................................... 
        // vqrdmulh.s32 q2, q7, r9             // ..............................*...................................................... 
        // qrestore q7, QSTACK4                // ...................*................................................................. 
        // vadd.u32 q1, q7, q3                 // ....................*................................................................ 
        // vmla.s32 q5, q2, r12                // ................................*.................................................... 
        // vsub.u32 q3, q7, q3                 // ......................*.............................................................. 
        // vstrw.u32 q0, [r0] , #16            // ..........................*.......................................................... 
        // vsub.u32 q7, q3, q5                 // ................................................*.................................... 
        // vmul.s32 q2, q6, r6                 // ....................................*................................................ 
        // vadd.u32 q0, q3, q5                 // ...................................*................................................. 
        // vqrdmulh.s32 q3, q6, r7             // ..................................*.................................................. 
        // vstrw.u32 q7, [r1, #384]            // ...................................................*................................. 
        // vmla.s32 q2, q3, r12                // ......................................*.............................................. 
        // vstrw.u32 q0, [r1, #256]            // .......................................*............................................. 
        // vadd.u32 q6, q1, q2                 // ........................................*............................................ 
        // vstrw.u32 q6, [r1] , #16            // ............................................*........................................ 
        // vsub.u32 q2, q1, q2                 // ..........................................*.......................................... 
        // vstrw.u32 q2, [r1, #112]            // ..............................................*...................................... 
        // restored r11, r10, ROOT0_STACK      // ...............................*..................................................... 
        // vldrw.32 q7, [r1, #128]             // ..............................................................*...................... 
        // vmul.s32 q3, q7, r11                // ...............................................................*..................... 
        // vldrw.32 q0, [r0, #128]             // ...........................................................................*......... 
        // vqrdmulh.s32 q5, q7, r10            // .................................................................*................... 
        // vldrw.32 q2, [r1, #384]             // .....................................*............................................... 
        // vmla.s32 q3, q5, r12                // ...................................................................*................. 
        // vldrw.32 q4, [r1, #256]             // .................................*................................................... 
        // vqrdmulh.s32 q1, q2, r10            // ...............................................*..................................... 
        // vsub.u32 q6, q0, q3                 // ............................................................................*........ 
        // vmul.s32 q5, q4, r11                // .............................................*....................................... 
        // vldrw.32 q7, [r1]                   // ......................................................*.............................. 
        // vmul.s32 q2, q2, r11                // ...........................................*......................................... 
        // qsave QSTACK5, q6                   // ..............................................................................*...... 
        // vmla.s32 q2, q1, r12                // ..................................................*.................................. 
        // vadd.u32 q1, q0, q3                 // ................................................................................*.... 
        // vqrdmulh.s32 q4, q4, r10            // .........................................*........................................... 
        // vldrw.32 q6, [r0, #384]             // .................................................*................................... 
        // vmla.s32 q5, q4, r12                // ....................................................*................................ 
        // vsub.u32 q0, q6, q2                 // ............................................................*........................ 
        // vqrdmulh.s32 q4, q7, r10            // ...........................................................*......................... 
        // vadd.u32 q2, q6, q2                 // .....................................................*............................... 
        // vldrw.32 q3, [r0, #256]             // ........................................................*............................ 
        // vmul.s32 q7, q7, r11                // .......................................................*............................. 
        // restored r10, r11, ROOT1_STACK      // ..................................................................*.................. 
        // vmla.s32 q7, q4, r12                // .............................................................*....................... 
        // vadd.u32 q6, q3, q5                 // ................................................................*.................... 
        // vqrdmulh.s32 q4, q6, r11            // .............................................................................*....... 
        // vsub.u32 q3, q3, q5                 // .........................................................*........................... 
        // vmul.s32 q5, q6, r10                // ...............................................................................*..... 
        // vldrw.32 q6, [r0]                   // ....................................................................*................ 
        // vmla.s32 q5, q4, r12                // .................................................................................*... 
        // qsave QSTACK6, q3                   // ..........................................................*.......................... 
        // vqrdmulh.s32 q4, q2, r11            // ........................................................................*............ 
        // vsub.u32 q3, q6, q7                 // .....................................................................*............... 
        // vmul.s32 q2, q2, r10                // ......................................................................*.............. 
        // qsave QSTACK4, q3                   // .......................................................................*............. 
        // vmla.s32 q2, q4, r12                // ..........................................................................*.......... 
        // vadd.u32 q4, q6, q7                 // .........................................................................*........... 
        // restored r11, r10, ROOT4_STACK      // ....................................................................................* 
        // vsub.u32 q6, q1, q2                 // ..................................................................................*.. 
        // vmul.s32 q3, q6, r4                 // ...................................................................................*. 
        
        le lr, layer123_loop
layer123_loop_end: // end of loop kernel
        vsub.u32 q7, q4, q5
        vqrdmulh.s32 q6, q6, r5
        vadd.u32 q4, q4, q5
        vmla.s32 q3, q6, r12
        vadd.u32 q5, q1, q2
        vmul.s32 q6, q0, r11
        vsub.u32 q2, q7, q3
        vqrdmulh.s32 q1, q5, r3
        vstrw.u32 q2, [r0, #384]
        vqrdmulh.s32 q0, q0, r10
        vadd.u32 q7, q7, q3
        vmul.s32 q2, q5, r2
        qrestore q3, QSTACK6
        vmla.s32 q2, q1, r12
        qrestore q1, QSTACK5
        vmla.s32 q6, q0, r12
        vstrw.u32 q7, [r0, #256]
        vqrdmulh.s32 q0, q3, r10
        vsub.u32 q7, q1, q6
        vmul.s32 q3, q3, r11
        vadd.u32 q6, q1, q6
        vmul.s32 q5, q7, r8
        vsub.u32 q1, q4, q2
        vmla.s32 q3, q0, r12
        vstrw.u32 q1, [r0, #128]
        vadd.u32 q0, q4, q2
        vqrdmulh.s32 q2, q7, r9
        qrestore q7, QSTACK4
        vadd.u32 q1, q7, q3
        vmla.s32 q5, q2, r12
        vsub.u32 q3, q7, q3
        vstrw.u32 q0, [r0] , #16
        vsub.u32 q7, q3, q5
        vmul.s32 q2, q6, r6
        vadd.u32 q0, q3, q5
        vqrdmulh.s32 q3, q6, r7
        vstrw.u32 q7, [r1, #384]
        vmla.s32 q2, q3, r12
        vstrw.u32 q0, [r1, #256]
        vadd.u32 q6, q1, q2
        vstrw.u32 q6, [r1] , #16
        vsub.u32 q2, q1, q2
        vstrw.u32 q2, [r1, #112]
        .unreq in_high
        .unreq in_low

        sub in, in, #(128)
        restore r_ptr, RPTR_STACK

        // Layers 4,5,6

        .unreq rtmp
        .unreq rtmp_tw
        rtmp    .req r3
        rtmp_tw .req r4

        mov lr, #8
        .p2align 2
        ldrd r3, r5, [r11] , #56
        vldrw.32 q2, [r0, #112]
        vqrdmulh.s32 q6, q2, r5
        vldrw.32 q0, [r0, #80]
        vmul.s32 q3, q2, r3
        vldrw.32 q1, [r0, #48]
        vmla.s32 q3, q6, r12
        ldrd r1, r2, [r11, #-48]
        vmul.s32 q5, q0, r3
        vsub.u32 q7, q1, q3
        vqrdmulh.s32 q4, q0, r5
        vadd.u32 q0, q1, q3
        vmla.s32 q5, q4, r12
        vldrw.32 q1, [r0, #16]
        vmul.s32 q2, q0, r1
        vadd.u32 q6, q1, q5
        vqrdmulh.s32 q3, q0, r2
        vldrw.32 q4, [r0, #64]
        vmla.s32 q2, q3, r12
        ldrd r9, r8, [r11, #-32]
        vsub.u32 q3, q6, q2
        vmul.s32 q0, q3, r9
        vadd.u32 q2, q6, q2
        vmul.s32 q6, q4, r3
        vsub.u32 q5, q1, q5
        vqrdmulh.s32 q3, q3, r8
        ldrd r7, r4, [r11, #-24]
        vqrdmulh.s32 q1, q4, r5
        vldrw.32 q4, [r0, #96]
        vmla.s32 q6, q1, r12
        vldrw.32 q1, [r0]
        vmla.s32 q0, q3, r12
        qsave QSTACK5, q5
        vmul.s32 q5, q4, r3
        vsub.u32 q3, q1, q6
        vqrdmulh.s32 q4, q4, r5
        qsave QSTACK4, q3
        vmla.s32 q5, q4, r12
        vadd.u32 q3, q1, q6
        vqrdmulh.s32 q1, q7, r4
        vldrw.32 q6, [r0, #32]
        vmul.s32 q7, q7, r7
        ldrd r3, r6, [r11, #-40]
        vmla.s32 q7, q1, r12
        sub lr, lr, #1
.p2align 2
layer456_loop:
        vadd.u32 q1, q6, q5                // *........................................................................................
        vqrdmulh.s32 q4, q1, r2            // .*.......................................................................................
        ldrd r5, r9, [r11] , #56           // .............................................*...........................................
        vmul.s32 q1, q1, r1                // ...*.....................................................................................
        vsub.u32 q6, q6, q5                // ..*......................................................................................
        vmla.s32 q1, q4, r12               // .....*...................................................................................
        qsave QSTACK6, q6                  // ......*..................................................................................
        vsub.u32 q4, q3, q1                // .........*...............................................................................
        vqrdmulh.s32 q6, q2, r6            // ........*................................................................................
        vsub.u32 q5, q4, q0                // ...........*.............................................................................
        vstrw.u32 q5, [r0, #48]            // ............*............................................................................
        vmul.s32 q2, q2, r3                // ..............*..........................................................................
        vadd.u32 q1, q3, q1                // .......*.................................................................................
        qrestore q5, QSTACK6               // ...............*.........................................................................
        vqrdmulh.s32 q3, q5, r4            // ..................*......................................................................
        ldrd r10, r8, [r11, #-72]          // .....................*...................................................................
        vmul.s32 q5, q5, r7                // ....................*....................................................................
        ldrd r6, r3, [r11, #-64]           // ....*....................................................................................
        vmla.s32 q5, q3, r12               // ......................*..................................................................
        ldrd r7, r4, [r11, #-24]           // .......................................................................*.................
        ldrd r1, r2, [r11, #-48]           // ....................................................*....................................
        vmla.s32 q2, q6, r12               // ................*........................................................................
        qrestore q6, QSTACK5               // ........................*................................................................
        vadd.u32 q3, q1, q2                // ...................*.....................................................................
        vstrw.u32 q3, [r0] , #128          // ............................*............................................................
        vsub.u32 q1, q1, q2                // .......................*.................................................................
        vstrw.u32 q1, [r0, #-112]          // ..........................*..............................................................
        vadd.u32 q2, q4, q0                // .............*...........................................................................
        vstrw.u32 q2, [r0, #-96]           // .................*.......................................................................
        vsub.u32 q1, q6, q7                // .........................*...............................................................
        vqrdmulh.s32 q0, q1, r3            // ...........................*.............................................................
        qrestore q4, QSTACK4               // ..........*..............................................................................
        vsub.u32 q3, q4, q5                // ...............................*.........................................................
        vmul.s32 q1, q1, r6                // ..............................*..........................................................
        vadd.u32 q4, q4, q5                // .............................*...........................................................
        vmla.s32 q1, q0, r12               // ................................*........................................................
        vadd.u32 q7, q6, q7                // .................................*.......................................................
        vmul.s32 q2, q7, r10               // ..................................*......................................................
        vsub.u32 q0, q3, q1                // ...................................*.....................................................
        vstrw.u32 q0, [r0, #-16]           // ....................................*....................................................
        vadd.u32 q1, q3, q1                // ......................................*..................................................
        vqrdmulh.s32 q7, q7, r8            // .....................................*...................................................
        vldrw.32 q0, [r0, #48]             // ..................................................*......................................
        vmla.s32 q2, q7, r12               // .......................................*.................................................
        vldrw.32 q5, [r0, #64]             // ..............................................................*..........................
        vsub.u32 q3, q4, q2                // .........................................*...............................................
        vldrw.32 q7, [r0, #112]            // ..............................................*..........................................
        vqrdmulh.s32 q6, q7, r9            // ...............................................*.........................................
        vstrw.u32 q3, [r0, #-48]           // ..........................................*..............................................
        vmul.s32 q7, q7, r5                // .................................................*.......................................
        vadd.u32 q3, q4, q2                // ...........................................*.............................................
        vmla.s32 q7, q6, r12               // ...................................................*.....................................
        vstrw.u32 q3, [r0, #-64]           // ............................................*............................................
        vmul.s32 q4, q5, r5                // ....................................................................*....................
        vadd.u32 q2, q0, q7                // ........................................................*................................
        vmul.s32 q6, q2, r1                // ...........................................................*.............................
        vstrw.u32 q1, [r0, #-32]           // ........................................*................................................
        vqrdmulh.s32 q1, q5, r9            // ........................................................................*................
        vsub.u32 q5, q0, q7                // ......................................................*..................................
        vmul.s32 q7, q5, r7                // ......................................................................................*..
        vldrw.32 q3, [r0]                  // ...........................................................................*.............
        vmla.s32 q4, q1, r12               // ..........................................................................*..............
        vldrw.32 q0, [r0, #80]             // ................................................*........................................
        vqrdmulh.s32 q5, q5, r4            // ....................................................................................*....
        vsub.u32 q1, q3, q4                // ...............................................................................*.........
        vmla.s32 q7, q5, r12               // ........................................................................................*
        qsave QSTACK4, q1                  // .................................................................................*.......
        vqrdmulh.s32 q1, q0, r9            // .......................................................*.................................
        vadd.u32 q3, q3, q4                // ...................................................................................*.....
        vmul.s32 q0, q0, r5                // .....................................................*...................................
        ldrd r3, r6, [r11, #-40]           // .......................................................................................*.
        vmla.s32 q0, q1, r12               // .........................................................*...............................
        vldrw.32 q5, [r0, #16]             // ..........................................................*..............................
        vsub.u32 q4, q5, q0                // .....................................................................*...................
        vqrdmulh.s32 q1, q2, r2            // .............................................................*...........................
        vldrw.32 q2, [r0, #96]             // .........................................................................*...............
        vmla.s32 q6, q1, r12               // ...............................................................*.........................
        qsave QSTACK5, q4                  // .............................................................................*...........
        vqrdmulh.s32 q4, q2, r9            // ................................................................................*........
        vadd.u32 q1, q5, q0                // ............................................................*............................
        vmul.s32 q5, q2, r5                // ..............................................................................*..........
        ldrd r9, r5, [r11, #-32]           // ................................................................*........................
        vmla.s32 q5, q4, r12               // ..................................................................................*......
        vsub.u32 q4, q1, q6                // .................................................................*.......................
        vmul.s32 q0, q4, r9                // ..................................................................*......................
        vadd.u32 q2, q1, q6                // ...................................................................*.....................
        vqrdmulh.s32 q4, q4, r5            // ......................................................................*..................
        vldrw.32 q6, [r0, #32]             // .....................................................................................*...
        vmla.s32 q0, q4, r12               // ............................................................................*............
        
        // original source code
        // vadd.u32 q1, q6, q5            // *........................................................................................ 
        // vqrdmulh.s32 q4, q1, r2        // .*....................................................................................... 
        // vsub.u32 q6, q6, q5            // ....*.................................................................................... 
        // vmul.s32 q5, q1, r1            // ...*..................................................................................... 
        // ldrd r9, r10, [r11, #-8]       // .................*....................................................................... 
        // vmla.s32 q5, q4, r12           // .....*................................................................................... 
        // qsave QSTACK6, q6              // ......*.................................................................................. 
        // vadd.u32 q4, q3, q5            // ............*............................................................................ 
        // vqrdmulh.s32 q6, q2, r6        // ........*................................................................................ 
        // vsub.u32 q1, q3, q5            // .......*................................................................................. 
        // qrestore q5, QSTACK4           // ...............................*......................................................... 
        // vsub.u32 q3, q1, q0            // .........*............................................................................... 
        // vstrw.u32 q3, [r0, #48]        // ..........*.............................................................................. 
        // vadd.u32 q1, q1, q0            // ...........................*............................................................. 
        // vmul.s32 q0, q2, r3            // ...........*............................................................................. 
        // qrestore q3, QSTACK6           // .............*........................................................................... 
        // vmla.s32 q0, q6, r12           // .....................*................................................................... 
        // vstrw.u32 q1, [r0, #32]        // ............................*............................................................ 
        // vqrdmulh.s32 q1, q3, r4        // ..............*.......................................................................... 
        // vadd.u32 q2, q4, q0            // .......................*................................................................. 
        // vmul.s32 q3, q3, r7            // ................*........................................................................ 
        // ldrd r2, r1, [r11, #-16]       // ...............*......................................................................... 
        // vmla.s32 q3, q1, r12           // ..................*...................................................................... 
        // vsub.u32 q4, q4, q0            // .........................*............................................................... 
        // qrestore q6, QSTACK5           // ......................*.................................................................. 
        // vsub.u32 q1, q6, q7            // .............................*........................................................... 
        // vstrw.u32 q4, [r0, #16]        // ..........................*.............................................................. 
        // vqrdmulh.s32 q4, q1, r10       // ..............................*.......................................................... 
        // vstrw.u32 q2, [r0] , #128      // ........................*................................................................ 
        // vadd.u32 q2, q5, q3            // ..................................*...................................................... 
        // vmul.s32 q1, q1, r9            // .................................*....................................................... 
        // vsub.u32 q5, q5, q3            // ................................*........................................................ 
        // vmla.s32 q1, q4, r12           // ...................................*..................................................... 
        // vadd.u32 q3, q6, q7            // ....................................*.................................................... 
        // vmul.s32 q7, q3, r2            // .....................................*................................................... 
        // vsub.u32 q4, q5, q1            // ......................................*.................................................. 
        // vstrw.u32 q4, [r0, #-16]       // .......................................*................................................. 
        // vqrdmulh.s32 q4, q3, r1        // .........................................*............................................... 
        // vadd.u32 q0, q5, q1            // ........................................*................................................ 
        // vmla.s32 q7, q4, r12           // ...........................................*............................................. 
        // vstrw.u32 q0, [r0, #-32]       // ........................................................*................................ 
        // vsub.u32 q1, q2, q7            // .............................................*........................................... 
        // vstrw.u32 q1, [r0, #-48]       // ................................................*........................................ 
        // vadd.u32 q4, q2, q7            // ..................................................*...................................... 
        // vstrw.u32 q4, [r0, #-64]       // ....................................................*.................................... 
        // ldrd r3, r5, [r11] , #56       // ..*...................................................................................... 
        // vldrw.32 q2, [r0, #112]        // ..............................................*.......................................... 
        // vqrdmulh.s32 q6, q2, r5        // ...............................................*......................................... 
        // vldrw.32 q0, [r0, #80]         // ..............................................................*.......................... 
        // vmul.s32 q3, q2, r3            // .................................................*....................................... 
        // vldrw.32 q1, [r0, #48]         // ..........................................*.............................................. 
        // vmla.s32 q3, q6, r12           // ...................................................*..................................... 
        // ldrd r1, r2, [r11, #-48]       // ....................*.................................................................... 
        // vmul.s32 q5, q0, r3            // .....................................................................*................... 
        // vsub.u32 q7, q1, q3            // ..........................................................*.............................. 
        // vqrdmulh.s32 q4, q0, r5        // ...................................................................*..................... 
        // vadd.u32 q0, q1, q3            // ......................................................*.................................. 
        // vmla.s32 q5, q4, r12           // .......................................................................*................. 
        // vldrw.32 q1, [r0, #16]         // ........................................................................*................ 
        // vmul.s32 q2, q0, r1            // .......................................................*................................. 
        // vadd.u32 q6, q1, q5            // ...............................................................................*......... 
        // vqrdmulh.s32 q3, q0, r2        // ..........................................................................*.............. 
        // vldrw.32 q4, [r0, #64]         // ............................................*............................................ 
        // vmla.s32 q2, q3, r12           // ............................................................................*............ 
        // ldrd r9, r8, [r11, #-32]       // .................................................................................*....... 
        // vsub.u32 q3, q6, q2            // ...................................................................................*..... 
        // vmul.s32 q0, q3, r9            // ....................................................................................*.... 
        // vadd.u32 q2, q6, q2            // .....................................................................................*... 
        // vmul.s32 q6, q4, r3            // .....................................................*................................... 
        // vsub.u32 q5, q1, q5            // .........................................................................*............... 
        // vqrdmulh.s32 q3, q3, r8        // ......................................................................................*.. 
        // ldrd r7, r4, [r11, #-24]       // ...................*..................................................................... 
        // vqrdmulh.s32 q1, q4, r5        // .........................................................*............................... 
        // vldrw.32 q4, [r0, #96]         // ...........................................................................*............. 
        // vmla.s32 q6, q1, r12           // .............................................................*........................... 
        // vldrw.32 q1, [r0]              // ............................................................*............................ 
        // vmla.s32 q0, q3, r12           // ........................................................................................* 
        // qsave QSTACK5, q5              // .............................................................................*........... 
        // vmul.s32 q5, q4, r3            // ................................................................................*........ 
        // vsub.u32 q3, q1, q6            // ................................................................*........................ 
        // vqrdmulh.s32 q4, q4, r5        // ..............................................................................*.......... 
        // qsave QSTACK4, q3              // ..................................................................*...................... 
        // vmla.s32 q5, q4, r12           // ..................................................................................*...... 
        // vadd.u32 q3, q1, q6            // ....................................................................*.................... 
        // vqrdmulh.s32 q1, q7, r4        // ...............................................................*......................... 
        // vldrw.32 q6, [r0, #32]         // .......................................................................................*. 
        // vmul.s32 q7, q7, r7            // ...........................................................*............................. 
        // ldrd r3, r6, [r11, #-40]       // ......................................................................*.................. 
        // vmla.s32 q7, q1, r12           // .................................................................*....................... 
        
        le lr, layer456_loop
        layer456_loop_end:
        vadd.u32 q1, q6, q5                   // *....................................................
        vqrdmulh.s32 q4, q1, r2               // .*...................................................
        ldrd r10, r9, [r11, #-8]              // ....*................................................
        vmul.s32 q1, q1, r1                   // ...*.................................................
        vsub.u32 q5, q6, q5                   // ..*..................................................
        vmla.s32 q1, q4, r12                  // .....*...............................................
        qsave QSTACK6, q5                     // ......*..............................................
        vmul.s32 q5, q2, r3                   // ..............*......................................
        vsub.u32 q4, q3, q1                   // .........*...........................................
        vqrdmulh.s32 q6, q2, r6               // ........*............................................
        vadd.u32 q2, q3, q1                   // .......*.............................................
        vmla.s32 q5, q6, r12                  // ................*....................................
        qrestore q3, QSTACK6                  // ...............*.....................................
        vsub.u32 q1, q2, q5                   // .......................*.............................
        vstrw.u32 q1, [r0, #16]               // ..........................*..........................
        vadd.u32 q6, q4, q0                   // .............*.......................................
        vstrw.u32 q6, [r0, #32]               // .................*...................................
        vadd.u32 q5, q2, q5                   // ...................*.................................
        vqrdmulh.s32 q1, q3, r4               // ..................*..................................
        vstrw.u32 q5, [r0] , #128             // ............................*........................
        vmul.s32 q6, q3, r7                   // ....................*................................
        vsub.u32 q2, q4, q0                   // ...........*.........................................
        qrestore q4, QSTACK5                  // ........................*............................
        vsub.u32 q5, q4, q7                   // .........................*...........................
        vmul.s32 q3, q5, r10                  // ..............................*......................
        vadd.u32 q4, q4, q7                   // .................................*...................
        vqrdmulh.s32 q7, q5, r9               // ...........................*.........................
        ldrd r8, r5, [r11, #-16]              // .....................*...............................
        vmla.s32 q3, q7, r12                  // ................................*....................
        vldrw.32 q5, [r11] , #96              // ...................................................*.
        vmla.s32 q6, q1, r12                  // ......................*..............................
        qrestore q1, QSTACK4                  // ..........*..........................................
        vadd.u32 q0, q1, q6                   // .............................*.......................
        vstrw.u32 q2, [r0, #-80]              // ............*........................................
        vsub.u32 q1, q1, q6                   // ...............................*.....................
        vmul.s32 q7, q4, r8                   // ..................................*..................
        vsub.u32 q2, q1, q3                   // ...................................*.................
        vstrw.u32 q2, [r0, #-16]              // ....................................*................
        vqrdmulh.s32 q4, q4, r5               // .....................................*...............
        vadd.u32 q6, q1, q3                   // ......................................*..............
        vmla.s32 q7, q4, r12                  // .......................................*.............
        vstrw.u32 q6, [r0, #-32]              // ........................................*............
        vsub.u32 q6, q0, q7                   // .........................................*...........
        vstrw.u32 q6, [r0, #-48]              // ..........................................*..........
        vadd.u32 q6, q0, q7                   // ...........................................*.........
        vstrw.u32 q6, [r0, #-64]              // ............................................*........
        sub r0, r0, #(4*256)                  // .............................................*.......
        mov r14, #15                          // ..............................................*......
        vld40.32 {q0,q1,q2,q3}, [r0]          // ...............................................*.....
        // gap                                // .....................................................
        vld41.32 {q0,q1,q2,q3}, [r0]          // ................................................*....
        // gap                                // .....................................................
        vld42.32 {q0,q1,q2,q3}, [r0]          // .................................................*...
        // gap                                // .....................................................
        vld43.32 {q0,q1,q2,q3}, [r0]!         // ..................................................*..
        // gap                                // .....................................................
        vmul.s32 q4, q3, q5                   // ....................................................*
        
        // original source code
        // vadd.u32 q1, q6, q5                // *.................................................... 
        // vqrdmulh.s32 q4, q1, r2            // .*................................................... 
        // vsub.u32 q6, q6, q5                // ....*................................................ 
        // vmul.s32 q5, q1, r1                // ...*................................................. 
        // ldrd r9, r10, [r11, #-8]           // ..*.................................................. 
        // vmla.s32 q5, q4, r12               // .....*............................................... 
        // qsave QSTACK6, q6                  // ......*.............................................. 
        // vadd.u32 q4, q3, q5                // ..........*.......................................... 
        // vqrdmulh.s32 q6, q2, r6            // .........*........................................... 
        // vsub.u32 q1, q3, q5                // ........*............................................ 
        // qrestore q5, QSTACK4               // ...............................*..................... 
        // vsub.u32 q3, q1, q0                // .....................*............................... 
        // vstrw.u32 q3, [r0, #48]            // .................................*................... 
        // vadd.u32 q1, q1, q0                // ...............*..................................... 
        // vmul.s32 q0, q2, r3                // .......*............................................. 
        // qrestore q3, QSTACK6               // ............*........................................ 
        // vmla.s32 q0, q6, r12               // ...........*......................................... 
        // vstrw.u32 q1, [r0, #32]            // ................*.................................... 
        // vqrdmulh.s32 q1, q3, r4            // ..................*.................................. 
        // vadd.u32 q2, q4, q0                // .................*................................... 
        // vmul.s32 q3, q3, r7                // ....................*................................ 
        // ldrd r2, r1, [r11, #-16]           // ...........................*......................... 
        // vmla.s32 q3, q1, r12               // ..............................*...................... 
        // vsub.u32 q4, q4, q0                // .............*....................................... 
        // qrestore q6, QSTACK5               // ......................*.............................. 
        // vsub.u32 q1, q6, q7                // .......................*............................. 
        // vstrw.u32 q4, [r0, #16]            // ..............*...................................... 
        // vqrdmulh.s32 q4, q1, r10           // ..........................*.......................... 
        // vstrw.u32 q2, [r0] , #128          // ...................*................................. 
        // vadd.u32 q2, q5, q3                // ................................*.................... 
        // vmul.s32 q1, q1, r9                // ........................*............................ 
        // vsub.u32 q5, q5, q3                // ..................................*.................. 
        // vmla.s32 q1, q4, r12               // ............................*........................ 
        // vadd.u32 q3, q6, q7                // .........................*........................... 
        // vmul.s32 q7, q3, r2                // ...................................*................. 
        // vsub.u32 q4, q5, q1                // ....................................*................ 
        // vstrw.u32 q4, [r0, #-16]           // .....................................*............... 
        // vqrdmulh.s32 q4, q3, r1            // ......................................*.............. 
        // vadd.u32 q0, q5, q1                // .......................................*............. 
        // vmla.s32 q7, q4, r12               // ........................................*............ 
        // vstrw.u32 q0, [r0, #-32]           // .........................................*........... 
        // vsub.u32 q1, q2, q7                // ..........................................*.......... 
        // vstrw.u32 q1, [r0, #-48]           // ...........................................*......... 
        // vadd.u32 q4, q2, q7                // ............................................*........ 
        // vstrw.u32 q4, [r0, #-64]           // .............................................*....... 
        // sub r0, r0, #(4*256)               // ..............................................*...... 
        // mov r14, #15                       // ...............................................*..... 
        // vld40.32 {q0,q1,q2,q3}, [r0]       // ................................................*.... 
        // vld41.32 {q0,q1,q2,q3}, [r0]       // .................................................*... 
        // vld42.32 {q0,q1,q2,q3}, [r0]       // ..................................................*.. 
        // vld43.32 {q0,q1,q2,q3}, [r0]!      // ...................................................*. 
        // vldrw.32 q5, [r11] , #96           // .............................*....................... 
        // vmul.s32 q4, q3, q5                // ....................................................* 
        
        layer78_loop:

        vmul.s32 q7, q2, q5                   // ......*...........................
        vldrw.32 q6, [r11, #-80]              // .....*............................
        vqrdmulh.s32 q5, q2, q6               // .......*..........................
        vldrw.32 q2, [r11, #-32]              // .......................*..........
        vqrdmulh.s32 q6, q3, q6               // ............*.....................
        vldrw.32 q3, [r11, #-16]              // ........................*.........
        vmla.s32 q4, q6, r12                  // .............*....................
        vldrw.32 q6, [r11, #-64]              // ................*.................
        vmla.s32 q7, q5, r12                  // ........*.........................
        vsub.u32 q5, q1, q4                   // ..............*...................
        vmul.s32 q2, q5, q2                   // .........................*........
        vadd.u32 q4, q1, q4                   // ...............*..................
        vqrdmulh.s32 q3, q5, q3               // ..........................*.......
        vsub.u32 q1, q0, q7                   // .........*........................
        vmla.s32 q2, q3, r12                  // ...........................*......
        vldrw.32 q5, [r11, #-48]              // .................*................
        vadd.u32 q3, q1, q2                   // .............................*....
        vstrw.u32 q3, [r0, #-32]              // ................................*.
        vsub.u32 q3, q1, q2                   // ............................*.....
        vstrw.u32 q3, [r0, #-16]              // .................................*
        vadd.u32 q7, q0, q7                   // ..........*.......................
        vld40.32 {q0,q1,q2,q3}, [r0]          // e.................................
        vqrdmulh.s32 q5, q4, q5               // ...................*..............
        vld41.32 {q0,q1,q2,q3}, [r0]          // .e................................
        vmul.s32 q6, q4, q6                   // ..................*...............
        vld42.32 {q0,q1,q2,q3}, [r0]          // ..e...............................
        vmla.s32 q6, q5, r12                  // ....................*.............
        vldrw.32 q5, [r11] , #96              // ....e.............................
        vadd.u32 q4, q7, q6                   // ......................*...........
        vld43.32 {q0,q1,q2,q3}, [r0]!         // ...e..............................
        vsub.u32 q6, q7, q6                   // .....................*............
        vstrw.u32 q4, [r0, #-128]             // ..............................*...
        vmul.s32 q4, q3, q5                   // ...........e......................
        vstrw.u32 q6, [r0, #-112]             // ...............................*..
        
        // original source code
        // vld40.32 {q0,q1,q2,q3}, [r0]       // e.............................................. 
        // vld41.32 {q0,q1,q2,q3}, [r0]       // ..e............................................ 
        // vld42.32 {q0,q1,q2,q3}, [r0]       // ....e.......................................... 
        // vld43.32 {q0,q1,q2,q3}, [r0]!      // ........e...................................... 
        // vldrw.32 q5, [r11] , #96           // ......e........................................ 
        // vldrw.32 q6, [r11, #-80]           // ..............*................................ 
        // vmul.s32 q7, q2, q5                // .............*................................. 
        // vqrdmulh.s32 q2, q2, q6            // ...............*............................... 
        // vmla.s32 q7, q2, r12               // .....................*......................... 
        // vsub.u32 q2, q0, q7                // ..........................*.................... 
        // vadd.u32 q0, q0, q7                // .................................*............. 
        // vmul.s32 q7, q3, q5                // ...........e................................... 
        // vqrdmulh.s32 q3, q3, q6            // .................*............................. 
        // vmla.s32 q7, q3, r12               // ...................*........................... 
        // vsub.u32 q3, q1, q7                // ......................*........................ 
        // vadd.u32 q1, q1, q7                // ........................*...................... 
        // vldrw.32 q5, [r11, #-64]           // ....................*.......................... 
        // vldrw.32 q6, [r11, #-48]           // ............................*.................. 
        // vmul.s32 q7, q1, q5                // .....................................*......... 
        // vqrdmulh.s32 q1, q1, q6            // ...................................*........... 
        // vmla.s32 q7, q1, r12               // .......................................*....... 
        // vsub.u32 q1, q0, q7                // ...........................................*... 
        // vadd.u32 q0, q0, q7                // .........................................*..... 
        // vldrw.32 q5, [r11, #-32]           // ................*.............................. 
        // vldrw.32 q6, [r11, #-16]           // ..................*............................ 
        // vmul.s32 q7, q3, q5                // .......................*....................... 
        // vqrdmulh.s32 q3, q3, q6            // .........................*..................... 
        // vmla.s32 q7, q3, r12               // ...........................*................... 
        // vsub.u32 q3, q2, q7                // ...............................*............... 
        // vadd.u32 q2, q2, q7                // .............................*................. 
        // vstrw.u32 q0, [r0, #-64]           // ............................................*.. 
        // vstrw.u32 q1, [r0, #-48]           // ..............................................* 
        // vstrw.u32 q2, [r0, #-32]           // ..............................*................ 
        // vstrw.u32 q3, [r0, #-16]           // ................................*.............. 
        
        le lr, layer78_loop
        vmul.s32 q5, q2, q5               // *...........................
        vldrw.32 q6, [r11, #-80]          // .*..........................
        vqrdmulh.s32 q3, q3, q6           // ....*.......................
        vldrw.32 q7, [r11, #-64]          // .......*....................
        vmla.s32 q4, q3, r12              // ......*.....................
        vldrw.32 q3, [r11, #-32]          // ...*........................
        vqrdmulh.s32 q2, q2, q6           // ..*.........................
        vadd.u32 q6, q1, q4               // ...........*................
        vmla.s32 q5, q2, r12              // ........*...................
        vsub.u32 q2, q1, q4               // .........*..................
        vmul.s32 q7, q6, q7               // ......................*.....
        vldrw.32 q4, [r11, #-48]          // ...............*............
        vqrdmulh.s32 q4, q6, q4           // .....................*......
        vadd.u32 q1, q0, q5               // ....................*.......
        vmla.s32 q7, q4, r12              // .......................*....
        vldrw.32 q4, [r11, #-16]          // .....*......................
        vqrdmulh.s32 q4, q2, q4           // ............*...............
        vadd.u32 q6, q1, q7               // ........................*...
        vstrw.u32 q6, [r0, #-64]          // ..........................*.
        vsub.u32 q6, q1, q7               // .........................*..
        vmul.s32 q1, q2, q3               // ..........*.................
        vsub.u32 q0, q0, q5               // .............*..............
        vmla.s32 q1, q4, r12              // ..............*.............
        vstrw.u32 q6, [r0, #-48]          // ...........................*
        vadd.u32 q5, q0, q1               // ................*...........
        vstrw.u32 q5, [r0, #-32]          // .................*..........
        vsub.u32 q6, q0, q1               // ..................*.........
        vstrw.u32 q6, [r0, #-16]          // ...................*........
        
        // original source code
        // vmul.s32 q7, q2, q5            // *........................... 
        // vldrw.32 q6, [r11, #-80]       // .*.......................... 
        // vqrdmulh.s32 q5, q2, q6        // ......*..................... 
        // vldrw.32 q2, [r11, #-32]       // .....*...................... 
        // vqrdmulh.s32 q6, q3, q6        // ..*......................... 
        // vldrw.32 q3, [r11, #-16]       // ...............*............ 
        // vmla.s32 q4, q6, r12           // ....*....................... 
        // vldrw.32 q6, [r11, #-64]       // ...*........................ 
        // vmla.s32 q7, q5, r12           // ........*................... 
        // vsub.u32 q5, q1, q4            // .........*.................. 
        // vmul.s32 q2, q5, q2            // ....................*....... 
        // vadd.u32 q4, q1, q4            // .......*.................... 
        // vqrdmulh.s32 q3, q5, q3        // ................*........... 
        // vsub.u32 q1, q0, q7            // .....................*...... 
        // vmla.s32 q2, q3, r12           // ......................*..... 
        // vldrw.32 q5, [r11, #-48]       // ...........*................ 
        // vadd.u32 q3, q1, q2            // ........................*... 
        // vstrw.u32 q3, [r0, #-32]       // .........................*.. 
        // vsub.u32 q3, q1, q2            // ..........................*. 
        // vstrw.u32 q3, [r0, #-16]       // ...........................* 
        // vadd.u32 q7, q0, q7            // .............*.............. 
        // vqrdmulh.s32 q5, q4, q5        // ............*............... 
        // vmul.s32 q6, q4, q6            // ..........*................. 
        // vmla.s32 q6, q5, r12           // ..............*............. 
        // vadd.u32 q4, q7, q6            // .................*.......... 
        // vsub.u32 q6, q7, q6            // ...................*........ 
        // vstrw.u32 q4, [r0, #-64]       // ..................*......... 
        // vstrw.u32 q6, [r0, #-48]       // .......................*.... 
        

        add sp, sp, #STACK_SIZE
        align_stack_undo

        // Restore MVE vector registers
        vpop {d8-d15}
        // Restore GPRs
        pop {r4-r11,lr}
        bx lr