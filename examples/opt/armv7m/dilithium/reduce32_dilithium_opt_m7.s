.syntax unified
.thumb
.macro redq a, tmp, q
    add     \tmp, \a,  #4194304
    asrs    \tmp, \tmp, #23
    mls     \a, \tmp, \q, \a
.endm

// void asm_reduce32(int32_t a[N]);
.global pqcrystals_dilithium_asm_reduce32_opt_m7
.type pqcrystals_dilithium_asm_reduce32_opt_m7, %function
.align 2
pqcrystals_dilithium_asm_reduce32_opt_m7:
    push {r4-r11, r14}

    movw r12,#:lower16:8380417
    movt r12,#:upper16:8380417
    movw r10, #32
                                   // Instructions:    1
                                   // Expected cycles: 1
                                   // Expected IPC:    1.00
                                   //
                                   // Wall time:     0.00s
                                   // User time:     0.00s
                                   //
                                   // ----- cycle (expected) ------>
                                   // 0                        25
                                   // |------------------------|----
        ldr.w r4, [r0, #20]        // *.............................

                                    // ------ cycle (expected) ------>
                                    // 0                        25
                                    // |------------------------|-----
        // ldr.w r4, [r0, #20]      // *..............................

        sub r10, r10, #1
1:
                                     // Instructions:    42
                                     // Expected cycles: 21
                                     // Expected IPC:    2.00
                                     //
                                     // Wall time:     6.05s
                                     // User time:     6.05s
                                     //
                                     // ----- cycle (expected) ------>
                                     // 0                        25
                                     // |------------------------|----
        ldr.w r3, [r0, #4]           // *.............................
        ldr.w r8, [r0, #8]           // *.............................
        add r7, r8, #4194304         // .*............................
        add r11, r3, #4194304        // .*............................
        asrs r5, r7, #23             // ..*...........................
        asrs r7, r11, #23            // ..*...........................
        ldr.w r14, [r0, #24]         // ...*..........................
        mls r9, r5, r12, r8          // ...*..........................
        add r6, r14, #4194304        // ....*.........................
        mls r8, r7, r12, r3          // ....*.........................
        ldr.w r5, [r0, #16]          // .....*........................
        asrs r6, r6, #23             // .....*........................
        str.w r8, [r0, #4]           // ......*.......................
        ldr.w r3, [r0]               // ......*.......................
        add r8, r5, #4194304         // .......*......................
        mls r14, r6, r12, r14        // .......*......................
        add r7, r3, #4194304         // ........*.....................
        add r1, r4, #4194304         // ........*.....................
        str.w r14, [r0, #24]         // .........*....................
        asrs r11, r1, #23            // .........*....................
        asrs r6, r7, #23             // ..........*...................
        mls r2, r11, r12, r4         // ..........*...................
        asrs r14, r8, #23            // ...........*..................
        mls r4, r6, r12, r3          // ...........*..................
        ldr.w r3, [r0, #12]          // ............*.................
        str r4, [r0], #8*4           // ............*.................
        ldr r7, [r0, #-4]            // .............*................
        mls r6, r14, r12, r5         // .............*................
        str r6, [r0, #-16]           // ..............*...............
        add r11, r3, #4194304        // ..............*...............
        asrs r8, r11, #23            // ...............*..............
        str r9, [r0, #-24]           // ...............*..............
        add r1, r7, #4194304         // ................*.............
        mls r3, r8, r12, r3          // ................*.............
        str r3, [r0, #-20]           // .................*............
        asrs r8, r1, #23             // .................*............
        subs r10, #1                 // ..................*...........
        mls r6, r8, r12, r7          // ..................*...........
        ldr.w r4, [r0, #20]          // ...................e..........
        str r2, [r0, #-12]           // ...................*..........
        str r6, [r0, #-4]            // ....................*.........
        bne.w 1b                     // ....................*......... // @slothy:branch

                                          // ------ cycle (expected) ------>
                                          // 0                        25
                                          // |------------------------|-----
        // ldr.w r1, [r0]                 // ..'.....*..............'.....~.
        // ldr.w r2, [r0, #1*4]           // ..*....................~.......
        // ldr.w r3, [r0, #2*4]           // ..*....................~.......
        // ldr.w r4, [r0, #3*4]           // ..'...........*........'.......
        // ldr.w r5, [r0, #4*4]           // ..'....*...............'....~..
        // ldr.w r6, [r0, #5*4]           // e.'..................~.'.......
        // ldr.w r7, [r0, #6*4]           // ..'..*.................'..~....
        // ldr.w r8, [r0, #7*4]           // ..'............*.......'.......
        // add     r9, r1,  #4194304      // ..'.......*............'.......
        // asrs    r9, r9, #23            // ..'.........*..........'.......
        // mls     r1, r9, r12, r1        // ..'..........*.........'.......
        // add     r9, r2,  #4194304      // ..'*...................'~......
        // asrs    r9, r9, #23            // ..'.*..................'.~.....
        // mls     r2, r9, r12, r2        // ..'...*................'...~...
        // add     r9, r3,  #4194304      // ..'*...................'~......
        // asrs    r9, r9, #23            // ..'.*..................'.~.....
        // mls     r3, r9, r12, r3        // ..'..*.................'..~....
        // add     r9, r4,  #4194304      // ..'.............*......'.......
        // asrs    r9, r9, #23            // ..'..............*.....'.......
        // mls     r4, r9, r12, r4        // ..'...............*....'.......
        // add     r9, r5,  #4194304      // ..'......*.............'.......
        // asrs    r9, r9, #23            // ..'..........*.........'.......
        // mls     r5, r9, r12, r5        // ..'............*.......'.......
        // add     r9, r6,  #4194304      // ..'.......*............'.......
        // asrs    r9, r9, #23            // ..'........*...........'.......
        // mls     r6, r9, r12, r6        // ..'.........*..........'.......
        // add     r9, r7,  #4194304      // ..'...*................'...~...
        // asrs    r9, r9, #23            // ..'....*...............'....~..
        // mls     r7, r9, r12, r7        // ..'......*.............'.......
        // add     r9, r8,  #4194304      // ..'...............*....'.......
        // asrs    r9, r9, #23            // ..'................*...'.......
        // mls     r8, r9, r12, r8        // ..'.................*..'.......
        // str.w r2, [r0, #1*4]           // ..'.....*..............'.....~.
        // str.w r3, [r0, #2*4]           // ..'..............*.....'.......
        // str.w r4, [r0, #3*4]           // ..'................*...'.......
        // str.w r5, [r0, #4*4]           // ..'.............*......'.......
        // str.w r6, [r0, #5*4]           // ~.'..................*.'.......
        // str.w r7, [r0, #6*4]           // ..'........*...........'.......
        // str.w r8, [r0, #7*4]           // .~'...................*'.......
        // str r1, [r0], #8*4             // ..'...........*........'.......
        // subs r10, #1                   // ..'.................*..'.......
        // bne.w 1b                       // .~'...................*'.......


                                     // Instructions:    41
                                     // Expected cycles: 21
                                     // Expected IPC:    1.95
                                     //
                                     // Wall time:     0.81s
                                     // User time:     0.81s
                                     //
                                     // ----- cycle (expected) ------>
                                     // 0                        25
                                     // |------------------------|----
        add r11, r4, #4194304        // *.............................
        ldr r5, [r0, #28]            // *.............................
        asrs r6, r11, #23            // .*............................
        add r8, r5, #4194304         // .*............................
        ldr.w r3, [r0, #4]           // ..*...........................
        mls r9, r6, r12, r4          // ..*...........................
        str r9, [r0, #20]            // ...*..........................
        add r4, r3, #4194304         // ...*..........................
        asrs r4, r4, #23             // ....*.........................
        ldr.w r2, [r0, #16]          // ....*.........................
        add r7, r2, #4194304         // .....*........................
        mls r1, r4, r12, r3          // .....*........................
        str.w r1, [r0, #4]           // ......*.......................
        asrs r4, r7, #23             // ......*.......................
        ldr.w r9, [r0, #24]          // .......*......................
        mls r11, r4, r12, r2         // .......*......................
        str r11, [r0, #16]           // ........*.....................
        ldr.w r4, [r0]               // ........*.....................
        asrs r8, r8, #23             // .........*....................
        add r1, r9, #4194304         // .........*....................
        add r14, r4, #4194304        // ..........*...................
        asrs r3, r1, #23             // ..........*...................
        asrs r11, r14, #23           // ...........*..................
        mls r14, r3, r12, r9         // ...........*..................
        ldr.w r3, [r0, #8]           // ............*.................
        mls r1, r11, r12, r4         // ............*.................
        str r1, [r0], #8*4           // .............*................
        add r4, r3, #4194304         // .............*................
        str r14, [r0, #-8]           // ..............*...............
        asrs r6, r4, #23             // ..............*...............
        ldr r2, [r0, #-20]           // ...............*..............
        mls r9, r6, r12, r3          // ...............*..............
        str r9, [r0, #-24]           // ................*.............
        add r4, r2, #4194304         // ................*.............
        asrs r6, r4, #23             // .................*............
        mls r4, r8, r12, r5          // .................*............
        str r4, [r0, #-4]            // ..................*...........
        subs r10, #1                 // ..................*...........
        mls r5, r6, r12, r2          // ...................*..........
        str r5, [r0, #-20]           // ....................*.........

                                      // ------ cycle (expected) ------>
                                      // 0                        25
                                      // |------------------------|-----
        // ldr.w r3, [r0, #4]         // ..*............................
        // ldr.w r8, [r0, #8]         // ............*..................
        // add r7, r8, #4194304       // .............*.................
        // add r11, r3, #4194304      // ...*...........................
        // asrs r5, r7, #23           // ..............*................
        // asrs r7, r11, #23          // ....*..........................
        // ldr.w r14, [r0, #24]       // .......*.......................
        // mls r9, r5, r12, r8        // ...............*...............
        // add r6, r14, #4194304      // .........*.....................
        // mls r8, r7, r12, r3        // .....*.........................
        // ldr.w r5, [r0, #16]        // ....*..........................
        // asrs r6, r6, #23           // ..........*....................
        // str.w r8, [r0, #4]         // ......*........................
        // ldr.w r3, [r0]             // ........*......................
        // add r8, r5, #4194304       // .....*.........................
        // mls r14, r6, r12, r14      // ...........*...................
        // add r7, r3, #4194304       // ..........*....................
        // add r1, r4, #4194304       // *..............................
        // str.w r14, [r0, #24]       // ..............*................
        // asrs r11, r1, #23          // .*.............................
        // asrs r6, r7, #23           // ...........*...................
        // mls r2, r11, r12, r4       // ..*............................
        // asrs r14, r8, #23          // ......*........................
        // mls r4, r6, r12, r3        // ............*..................
        // ldr.w r3, [r0, #12]        // ...............*...............
        // str r4, [r0], #8*4         // .............*.................
        // ldr r7, [r0, #-4]          // *..............................
        // mls r6, r14, r12, r5       // .......*.......................
        // str r6, [r0, #-16]         // ........*......................
        // add r11, r3, #4194304      // ................*..............
        // asrs r8, r11, #23          // .................*.............
        // str r9, [r0, #-24]         // ................*..............
        // add r1, r7, #4194304       // .*.............................
        // mls r3, r8, r12, r3        // ...................*...........
        // str r3, [r0, #-20]         // ....................*..........
        // asrs r8, r1, #23           // .........*.....................
        // subs r10, #1               // ..................*............
        // mls r6, r8, r12, r7        // .................*.............
        // str r2, [r0, #-12]         // ...*...........................
        // str r6, [r0, #-4]          // ..................*............
        // bne.w 1b                   // ....................*..........


    pop {r4-r11, r14}
    bx lr

.size pqcrystals_dilithium_asm_reduce32_opt_m7, .-pqcrystals_dilithium_asm_reduce32_opt_m7