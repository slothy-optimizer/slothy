/// Copyright (c) 2024 Jipeng Zhang (jp-zhang@outlook.com) (Original Code)
/// Copyright (c) 2026 Amin Abdulrahman (amin@abdulrahman.de) (Modifications)
/// Copyright (c) 2026 Justus Bergermann (mail@justus-bergermann.de) (Modifications)
///
/// SPDX-License-Identifier: MIT
///
/// Permission is hereby granted, free of charge, to any person obtaining a copy
/// of this software and associated documentation files (the "Software"), to deal
/// in the Software without restriction, including without limitation the rights
/// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
/// copies of the Software, and to permit persons to whom the Software is
/// furnished to do so, subject to the following conditions:
///
/// The above copyright notice and this permission notice shall be included in all
/// copies or substantial portions of the Software.
///
/// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
/// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
/// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
/// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
/// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
/// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
/// SOFTWARE.

.macro load_coeffs poly, len, wordLen
  lh s0,  \len*\wordLen*0(\poly)
  lh s1,  \len*\wordLen*1(\poly)
  lh s2,  \len*\wordLen*2(\poly)
  lh s3,  \len*\wordLen*3(\poly)
  lh s4,  \len*\wordLen*4(\poly)
  lh s5,  \len*\wordLen*5(\poly)
  lh s6,  \len*\wordLen*6(\poly)
  lh s7,  \len*\wordLen*7(\poly)
  lh s8,  \len*\wordLen*8(\poly)
  lh s9,  \len*\wordLen*9(\poly)
  lh s10, \len*\wordLen*10(\poly)
  lh s11, \len*\wordLen*11(\poly)
  lh a2,  \len*\wordLen*12(\poly)
  lh a3,  \len*\wordLen*13(\poly)
  lh a4,  \len*\wordLen*14(\poly)
  lh a5,  \len*\wordLen*15(\poly)
.endm

.macro store_coeffs poly, len, wordLen
  sh s0,  \len*\wordLen*0(\poly)
  sh s1,  \len*\wordLen*1(\poly)
  sh s2,  \len*\wordLen*2(\poly)
  sh s3,  \len*\wordLen*3(\poly)
  sh s4,  \len*\wordLen*4(\poly)
  sh s5,  \len*\wordLen*5(\poly)
  sh s6,  \len*\wordLen*6(\poly)
  sh s7,  \len*\wordLen*7(\poly)
  sh s8,  \len*\wordLen*8(\poly)
  sh s9,  \len*\wordLen*9(\poly)
  sh s10, \len*\wordLen*10(\poly)
  sh s11, \len*\wordLen*11(\poly)
  sh a2,  \len*\wordLen*12(\poly)
  sh a3,  \len*\wordLen*13(\poly)
  sh a4,  \len*\wordLen*14(\poly)
  sh a5,  \len*\wordLen*15(\poly)
.endm

.macro save_regs
  sd s0,  0*8(sp)
  sd s1,  1*8(sp)
  sd s2,  2*8(sp)
  sd s3,  3*8(sp)
  sd s4,  4*8(sp)
  sd s5,  5*8(sp)
  sd s6,  6*8(sp)
  sd s7,  7*8(sp)
  sd s8,  8*8(sp)
  sd s9,  9*8(sp)
  sd s10, 10*8(sp)
  sd s11, 11*8(sp)
  sd gp,  12*8(sp)
  sd tp,  13*8(sp)
  sd ra,  14*8(sp)
.endm

.macro restore_regs
  ld s0,  0*8(sp)
  ld s1,  1*8(sp)
  ld s2,  2*8(sp)
  ld s3,  3*8(sp)
  ld s4,  4*8(sp)
  ld s5,  5*8(sp)
  ld s6,  6*8(sp)
  ld s7,  7*8(sp)
  ld s8,  8*8(sp)
  ld s9,  9*8(sp)
  ld s10, 10*8(sp)
  ld s11, 11*8(sp)
  ld gp,  12*8(sp)
  ld tp,  13*8(sp)
  ld ra,  14*8(sp)
.endm

// a <- a*b*(-2^{-64}) mod+- q
// q32: q<<32; bqinv: b*qinv
.macro plant_mul_const_inplace q32, bqinv, a
  mul  \a, \a, \bqinv
  srai \a, \a, 32
  addi \a, \a, 8
  mulh \a, \a, \q32
.endm

// r <- a*b*(-2^{-64}) mod+- q
// q32: q<<32; bqinv: b*qinv
.macro plant_mul_const q32, bqinv, a, r
    mul  \r, \a, \bqinv
    srai \r, \r, 32
    addi \r, \r, 8
    mulh \r, \r, \q32
.endm

// each layer increases coefficients by 0.5q; In ct_butterfly, twiddle and tmp can be reused because each twiddle is only used once. The gs_butterfly cannot.
.macro ct_butterfly coeff0, coeff1, twiddle, q, tmp
  plant_mul_const \q, \twiddle, \coeff1, \tmp
  sub \coeff1, \coeff0, \tmp
  add \coeff0, \coeff0, \tmp
.endm

.macro gs_butterfly coeff0, coeff1, twiddle, q, tmp
  sub \tmp, \coeff0, \coeff1
  add \coeff0, \coeff0, \coeff1
  plant_mul_const \q, \twiddle, \tmp, \coeff1
.endm

// in-place plantard reduction to a
// output \in (-0.5q, 0.5q); q32: q<<32
.macro plant_red q32, qinv, a
  mul  \a, \a, \qinv
  srai \a, \a, 32
  addi \a, \a, 8
  mulh \a, \a, \q32
.endm

.equ q,    3329
.equ q32,  0xd0100000000                // q << 32
.equ qinv, 0x3c0f12886ba8f301           // q^-1 mod 2^64
.equ plantconst, 0x13afb7680bb055       // (((-2**64) % q) * qinv) % (2**64)
.equ plantconst2, 0x1a390f4d9791e139    // (((-2**64) % q) * ((-2**64) % q) * qinv) % (2**64)

// plantard reduction to a poly
.global poly_plantard_rdc_rv64im_opt_c908
.align 2
poly_plantard_rdc_rv64im_opt_c908:
  addi sp, sp, -8*15
  save_regs
  li t6, plantconst
  li tp, q32
  addi gp, x0, 16
  addi a1, a0, 0
                                 // Instructions:    6
                                 // Expected cycles: 9
                                 // Expected IPC:    0.67
                                 //
                                 // Cycle bound:     9.0
                                 // IPC bound:       0.67
                                 //
                                 // Wall time:     0.04s
                                 // User time:     0.04s
                                 //
                                 // ----- cycle (expected) ------>
                                 // 0                        25
                                 // |------------------------|----
        lh x16, 2*3(x10)         // *.............................
        lh x17, 2*15(x10)        // .*............................
        mul x22, x16, x31        // ...*..........................
        mul x16, x17, x31        // ....*.........................
        srai x17, x22, 32        // .......*......................
        addi x19, x17, 8         // ........*.....................

                                 // ------ cycle (expected) ------>
                                 // 0                        25
                                 // |------------------------|-----
        // lh x6, 2*15(x10)      // .*.............................
        // lh x16, 2*3(x10)      // *..............................
        // mul x5, x16, x31      // ...*...........................
        // mul x16, x6, x31      // ....*..........................
        // srai x22, x5, 32      // .......*.......................
        // addi x19, x22, 8      // ........*......................

        addi gp, gp, -1
poly_plantard_rdc_rv64im_loop:
                                   // Instructions:    98
                                   // Expected cycles: 49
                                   // Expected IPC:    2.00
                                   //
                                   // Cycle bound:     50.0
                                   // IPC bound:       1.96
                                   //
                                   // Wall time:     45.39s
                                   // User time:     45.39s
                                   //
                                   // --------------- cycle (expected) --------------->
                                   // 0                        25
                                   // |------------------------|-----------------------
        lh x26, 2*12(x10)          // *................................................
        srai x18, x16, 32          // *................................................
        lh x28, 2*14(x10)          // .*...............................................
        addi x16, x18, 8           // .*...............................................
        mulh x22, x16, x4          // ..*..............................................
        lh x23, 2*6(x10)           // ..*..............................................
        mul x13, x26, x31          // ...*.............................................
        lh x18, 2*13(x10)          // ...*.............................................
        lh x30, 2*8(x10)           // ....*............................................
        mul x28, x28, x31          // ....*............................................
        lh x14, 2*9(x10)           // .....*...........................................
        mulh x12, x19, x4          // .....*...........................................
        lh x26, 2*7(x10)           // ......*..........................................
        mul x7, x18, x31           // ......*..........................................
        srai x5, x13, 32           // .......*.........................................
        lh x1, 2*0(x10)            // .......*.........................................
        lh x20, 2*5(x10)           // ........*........................................
        srai x15, x28, 32          // ........*........................................
        mul x18, x26, x31          // .........*.......................................
        lh x21, 2*11(x10)          // .........*.......................................
        addi x16, x5, 8            // ..........*......................................
        lh x8, 2*4(x10)            // ..........*......................................
        lh x17, 2*2(x10)           // ...........*.....................................
        mulh x13, x16, x4          // ...........*.....................................
        srai x24, x7, 32           // ............*....................................
        lh x27, 2*10(x10)          // ............*....................................
        lh x16, 2*1(x10)           // .............*...................................
        addi x10, x10, 16*2        // .............*...................................
        sh x12, 2*3(x11)           // ..............*..................................
        addi x28, x24, 8           // ..............*..................................
        mulh x25, x28, x4          // ...............*.................................
        sh x13, 2*12(x11)          // ...............*.................................
        srai x28, x18, 32          // ................*................................
        mul x16, x16, x31          // ................*................................
        mul x7, x27, x31           // .................*...............................
        addi x9, x28, 8            // .................*...............................
        mulh x13, x9, x4           // ..................*..............................
        addi x24, x15, 8           // ..................*..............................
        sh x25, 2*13(x11)          // ...................*.............................
        mul x25, x17, x31          // ...................*.............................
        mul x26, x8, x31           // ....................*............................
        srai x16, x16, 32          // ....................*............................
        addi x17, x16, 8           // .....................*...........................
        srai x16, x7, 32           // .....................*...........................
        addi x8, x16, 8            // ......................*..........................
        sh x13, 2*7(x11)           // ......................*..........................
        mul x28, x14, x31          // .......................*.........................
        mulh x13, x8, x4           // .......................*.........................
        lh x6, 2*15(x10)           // ........................e........................
        mul x30, x30, x31          // ........................*........................
        mul x5, x20, x31           // .........................*.......................
        srai x8, x25, 32           // .........................*.......................
        lh x16, 2*3(x10)           // ..........................e......................
        mul x18, x23, x31          // ..........................*......................
        sh x13, 2*10(x11)          // ...........................*.....................
        srai x13, x28, 32          // ...........................*.....................
        addi x7, x13, 8            // ............................*....................
        srai x27, x30, 32          // ............................*....................
        mulh x14, x7, x4           // .............................*...................
        addi x28, x27, 8           // .............................*...................
        mulh x29, x28, x4          // ..............................*..................
        srai x28, x18, 32          // ..............................*..................
        mul x15, x21, x31          // ...............................*.................
        addi x28, x28, 8           // ...............................*.................
        mulh x28, x28, x4          // ................................*................
        srai x5, x5, 32            // ................................*................
        sh x14, 2*9(x11)           // .................................*...............
        addi x5, x5, 8             // .................................*...............
        sh x29, 2*8(x11)           // ..................................*..............
        mulh x20, x5, x4           // ..................................*..............
        srai x23, x15, 32          // ...................................*.............
        mul x1, x1, x31            // ...................................*.............
        sh x28, 2*6(x11)           // ....................................*............
        mulh x18, x24, x4          // ....................................*............
        addi x19, x23, 8           // .....................................*...........
        sh x22, 2*15(x11)          // .....................................*...........
        sh x20, 2*5(x11)           // ......................................*..........
        mul x5, x16, x31           // ......................................e..........
        mulh x12, x17, x4          // .......................................*.........
        srai x1, x1, 32            // .......................................*.........
        srai x13, x26, 32          // ........................................*........
        addi x22, x1, 8            // ........................................*........
        addi x27, x13, 8           // .........................................*.......
        mulh x28, x22, x4          // .........................................*.......
        mulh x13, x27, x4          // ..........................................*......
        addi x9, x8, 8             // ..........................................*......
        sh x12, 2*1(x11)           // ...........................................*.....
        mulh x7, x9, x4            // ...........................................*.....
        sh x18, 2*14(x11)          // ............................................*....
        mulh x18, x19, x4          // ............................................*....
        mul x16, x6, x31           // .............................................e...
        sh x28, 2*0(x11)           // .............................................*...
        srai x22, x5, 32           // ..............................................e..
        sh x13, 2*4(x11)           // ..............................................*..
        sh x7, 2*2(x11)            // ...............................................*.
        addi x19, x22, 8           // ...............................................e.
        sh x18, 2*11(x11)          // ................................................*
        addi x11, x11, 16*2        // ................................................*

                                    // --------------------------- cycle (expected) ---------------------------->
                                    // 0                        25                       50
                                    // |------------------------|------------------------|-----------------------
        // lh x8,  2*0(x10)         // .........................'......*.........................................
        // lh x9,  2*1(x10)         // .........................'............*...................................
        // lh x18,  2*2(x10)        // .........................'..........*.....................................
        // lh x19,  2*3(x10)        // ..e......................'.........................~......................
        // mul  x8, x8, x31         // ...........~.............'..................................*.............
        // srai x8, x8, 32          // ...............~.........'......................................*.........
        // addi x8, x8, 8           // ................~........'.......................................*........
        // mulh x8, x8, x4          // .................~.......'........................................*.......
        // mul  x9, x9, x31         // .........................'...............*................................
        // srai x9, x9, 32          // .........................'...................*............................
        // addi x9, x9, 8           // .........................'....................*...........................
        // mulh x9, x9, x4          // ...............~.........'......................................*.........
        // sh x8,  2*0(x11)         // .....................~...'............................................*...
        // mul  x18, x18, x31       // .........................'..................*.............................
        // srai x18, x18, 32        // .~.......................'........................*.......................
        // addi x18, x18, 8         // ..................~......'.........................................*......
        // mulh x18, x18, x4        // ...................~.....'..........................................*.....
        // sh x9,  2*1(x11)         // ...................~.....'..........................................*.....
        // mul  x19, x19, x31       // ..............e..........'.....................................~..........
        // srai x19, x19, 32        // ......................e..'.............................................~..
        // addi x19, x19, 8         // .......................e.'..............................................~.
        // mulh x19, x19, x4        // .........................'....*...........................................
        // sh x18,  2*2(x11)        // .......................~.'..............................................*.
        // lh x20,  2*4(x10)        // .........................'.........*......................................
        // lh x21,  2*5(x10)        // .........................'.......*........................................
        // lh x22,  2*6(x10)        // .........................'.*..............................................
        // lh x23,  2*7(x10)        // .........................'.....*..........................................
        // mul  x20, x20, x31       // .........................'...................*............................
        // srai x20, x20, 32        // ................~........'.......................................*........
        // addi x20, x20, 8         // .................~.......'........................................*.......
        // mulh x20, x20, x4        // ..................~......'.........................................*......
        // sh x19,  2*3(x11)        // .........................'.............*..................................
        // mul  x21, x21, x31       // .~.......................'........................*.......................
        // srai x21, x21, 32        // ........~................'...............................*................
        // addi x21, x21, 8         // .........~...............'................................*...............
        // mulh x21, x21, x4        // ..........~..............'.................................*..............
        // sh x20,  2*4(x11)        // ......................~..'.............................................*..
        // mul  x22, x22, x31       // ..~......................'.........................*......................
        // srai x22, x22, 32        // ......~..................'.............................*..................
        // addi x22, x22, 8         // .......~.................'..............................*.................
        // mulh x22, x22, x4        // ........~................'...............................*................
        // sh x21,  2*5(x11)        // ..............~..........'.....................................*..........
        // mul  x23, x23, x31       // .........................'........*.......................................
        // srai x23, x23, 32        // .........................'...............*................................
        // addi x23, x23, 8         // .........................'................*...............................
        // mulh x23, x23, x4        // .........................'.................*..............................
        // sh x22,  2*6(x11)        // ............~............'...................................*............
        // lh x24,  2*8(x10)        // .........................'...*............................................
        // lh x25,  2*9(x10)        // .........................'....*...........................................
        // lh x26, 2*10(x10)        // .........................'...........*....................................
        // lh x27, 2*11(x10)        // .........................'........*.......................................
        // mul  x24, x24, x31       // ~........................'.......................*........................
        // srai x24, x24, 32        // ....~....................'...........................*....................
        // addi x24, x24, 8         // .....~...................'............................*...................
        // mulh x24, x24, x4        // ......~..................'.............................*..................
        // sh x23,  2*7(x11)        // .........................'.....................*..........................
        // mul  x25, x25, x31       // .........................'......................*.........................
        // srai x25, x25, 32        // ...~.....................'..........................*.....................
        // addi x25, x25, 8         // ....~....................'...........................*....................
        // mulh x25, x25, x4        // .....~...................'............................*...................
        // sh x24,  2*8(x11)        // ..........~..............'.................................*..............
        // mul  x26, x26, x31       // .........................'................*...............................
        // srai x26, x26, 32        // .........................'....................*...........................
        // addi x26, x26, 8         // .........................'.....................*..........................
        // mulh x26, x26, x4        // .........................'......................*.........................
        // sh x25,  2*9(x11)        // .........~...............'................................*...............
        // mul  x27, x27, x31       // .......~.................'..............................*.................
        // srai x27, x27, 32        // ...........~.............'..................................*.............
        // addi x27, x27, 8         // .............~...........'....................................*...........
        // mulh x27, x27, x4        // ....................~....'...........................................*....
        // sh x26, 2*10(x11)        // ...~.....................'..........................*.....................
        // lh x5,  2*12(x10)        // .........................*................................................
        // lh x6,  2*13(x10)        // .........................'..*.............................................
        // lh x7,  2*14(x10)        // .........................'*...............................................
        // lh x28,  2*15(x10)       // e........................'.......................~........................
        // mul  x5, x5, x31         // .........................'..*.............................................
        // srai x5, x5, 32          // .........................'......*.........................................
        // addi x5, x5, 8           // .........................'.........*......................................
        // mulh x5, x5, x4          // .........................'..........*.....................................
        // sh x27, 2*11(x11)        // ........................~'...............................................*
        // mul  x6, x6, x31         // .........................'.....*..........................................
        // srai x6, x6, 32          // .........................'...........*....................................
        // addi x6, x6, 8           // .........................'.............*..................................
        // mulh x6, x6, x4          // .........................'..............*.................................
        // sh x5,  2*12(x11)        // .........................'..............*.................................
        // mul  x7, x7, x31         // .........................'...*............................................
        // srai x7, x7, 32          // .........................'.......*........................................
        // addi x7, x7, 8           // .........................'.................*..............................
        // mulh x7, x7, x4          // ............~............'...................................*............
        // sh x6,  2*13(x11)        // .........................'..................*.............................
        // mul  x28, x28, x31       // .....................e...'............................................~...
        // srai x28, x28, 32        // .........................*................................................
        // addi x28, x28, 8         // .........................'*...............................................
        // mulh x28, x28, x4        // .........................'.*..............................................
        // sh x7,  2*14(x11)        // ....................~....'...........................................*....
        // sh x28,  2*15(x11)       // .............~...........'....................................*...........
        // addi x10, x10, 16*2      // .........................'............*...................................
        // addi x11, x11, 16*2      // ........................~'...............................................*

        addi gp, gp, -1
        bne gp, zero, poly_plantard_rdc_rv64im_loop
                                   // Instructions:    92
                                   // Expected cycles: 47
                                   // Expected IPC:    1.96
                                   //
                                   // Cycle bound:     46.0
                                   // IPC bound:       2.00
                                   //
                                   // Wall time:     29.21s
                                   // User time:     29.21s
                                   //
                                   // -------------- cycle (expected) -------------->
                                   // 0                        25
                                   // |------------------------|---------------------
        lh x17, 2*9(x10)           // *..............................................
        srai x1, x16, 32           // *..............................................
        addi x22, x1, 8            // .*.............................................
        lh x16, 2*12(x10)          // .*.............................................
        lh x25, 2*13(x10)          // ..*............................................
        mulh x14, x19, x4          // ..*............................................
        lh x28, 2*7(x10)           // ...*...........................................
        mul x13, x17, x31          // ...*...........................................
        mul x16, x16, x31          // ....*..........................................
        lh x17, 2*6(x10)           // ....*..........................................
        lh x12, 2*5(x10)           // .....*.........................................
        mul x19, x25, x31          // .....*.........................................
        mul x9, x28, x31           // ......*........................................
        lh x20, 2*10(x10)          // ......*........................................
        mul x15, x17, x31          // .......*.......................................
        srai x8, x13, 32           // .......*.......................................
        srai x1, x16, 32           // ........*......................................
        mul x30, x12, x31          // ........*......................................
        lh x24, 2*2(x10)           // .........*.....................................
        addi x28, x1, 8            // .........*.....................................
        mulh x21, x28, x4          // ..........*....................................
        mulh x16, x22, x4          // ..........*....................................
        srai x29, x15, 32          // ...........*...................................
        lh x25, 2*4(x10)           // ...........*...................................
        mul x7, x24, x31           // ............*..................................
        srai x28, x30, 32          // ............*..................................
        addi x24, x29, 8           // .............*.................................
        addi x18, x28, 8           // .............*.................................
        sh x16, 2*15(x11)          // ..............*................................
        mulh x18, x18, x4          // ..............*................................
        mulh x28, x24, x4          // ...............*...............................
        mul x16, x25, x31          // ...............*...............................
        lh x13, 2*8(x10)           // ................*..............................
        srai x5, x7, 32            // ................*..............................
        addi x12, x5, 8            // .................*.............................
        srai x17, x9, 32           // .................*.............................
        sh x18, 2*5(x11)           // ..................*............................
        mulh x18, x12, x4          // ..................*............................
        sh x28, 2*6(x11)           // ...................*...........................
        mul x13, x13, x31          // ...................*...........................
        addi x28, x17, 8           // ....................*..........................
        mul x5, x20, x31           // ....................*..........................
        lh x1, 2*14(x10)           // .....................*.........................
        addi x17, x8, 8            // .....................*.........................
        sh x18, 2*2(x11)           // ......................*........................
        mulh x8, x17, x4           // ......................*........................
        srai x7, x13, 32           // .......................*.......................
        lh x13, 2*1(x10)           // .......................*.......................
        srai x27, x5, 32           // ........................*......................
        addi x24, x7, 8            // ........................*......................
        mulh x24, x24, x4          // .........................*.....................
        addi x22, x27, 8           // .........................*.....................
        mulh x17, x22, x4          // ..........................*....................
        mul x15, x13, x31          // ..........................*....................
        mul x18, x1, x31           // ...........................*...................
        sh x8, 2*9(x11)            // ...........................*...................
        lh x7, 2*11(x10)           // ............................*..................
        srai x30, x19, 32          // ............................*..................
        sh x24, 2*8(x11)           // .............................*.................
        addi x13, x30, 8           // .............................*.................
        sh x17, 2*10(x11)          // ..............................*................
        srai x17, x15, 32          // ..............................*................
        srai x12, x18, 32          // ...............................*...............
        lh x22, 2*0(x10)           // ...............................*...............
        srai x5, x16, 32           // ................................*..............
        addi x20, x12, 8           // ................................*..............
        mulh x18, x20, x4          // .................................*.............
        addi x8, x17, 8            // .................................*.............
        mul x16, x22, x31          // ..................................*............
        addi x24, x5, 8            // ..................................*............
        mulh x1, x24, x4           // ...................................*...........
        mul x25, x7, x31           // ...................................*...........
        sh x21, 2*12(x11)          // ....................................*..........
        mulh x17, x13, x4          // ....................................*..........
        sh x14, 2*3(x11)           // .....................................*.........
        mulh x30, x28, x4          // .....................................*.........
        sh x18, 2*14(x11)          // ......................................*........
        srai x16, x16, 32          // ......................................*........
        srai x22, x25, 32          // .......................................*.......
        addi x12, x16, 8           // .......................................*.......
        mulh x19, x12, x4          // ........................................*......
        sh x17, 2*13(x11)          // ........................................*......
        mulh x17, x8, x4           // .........................................*.....
        addi x16, x22, 8           // .........................................*.....
        mulh x16, x16, x4          // ..........................................*....
        sh x1, 2*4(x11)            // ..........................................*....
        sh x30, 2*7(x11)           // ...........................................*...
        sh x19, 2*0(x11)           // ............................................*..
        sh x17, 2*1(x11)           // .............................................*.
        addi x10, x10, 16*2        // .............................................*.
        sh x16, 2*11(x11)          // ..............................................*
        addi x11, x11, 16*2        // ..............................................*

                                    // -------------- cycle (expected) -------------->
                                    // 0                        25
                                    // |------------------------|---------------------
        // lh x26, 2*12(x10)        // .*.............................................
        // srai x18, x16, 32        // *..............................................
        // lh x28, 2*14(x10)        // .....................*.........................
        // addi x16, x18, 8         // .*.............................................
        // mulh x22, x16, x4        // ..........*....................................
        // lh x23, 2*6(x10)         // ....*..........................................
        // mul x13, x26, x31        // ....*..........................................
        // lh x18, 2*13(x10)        // ..*............................................
        // lh x30, 2*8(x10)         // ................*..............................
        // mul x28, x28, x31        // ...........................*...................
        // lh x14, 2*9(x10)         // *..............................................
        // mulh x12, x19, x4        // ..*............................................
        // lh x26, 2*7(x10)         // ...*...........................................
        // mul x7, x18, x31         // .....*.........................................
        // srai x5, x13, 32         // ........*......................................
        // lh x1, 2*0(x10)          // ...............................*...............
        // lh x20, 2*5(x10)         // .....*.........................................
        // srai x15, x28, 32        // ...............................*...............
        // mul x18, x26, x31        // ......*........................................
        // lh x21, 2*11(x10)        // ............................*..................
        // addi x16, x5, 8          // .........*.....................................
        // lh x8, 2*4(x10)          // ...........*...................................
        // lh x17, 2*2(x10)         // .........*.....................................
        // mulh x13, x16, x4        // ..........*....................................
        // srai x24, x7, 32         // ............................*..................
        // lh x27, 2*10(x10)        // ......*........................................
        // lh x16, 2*1(x10)         // .......................*.......................
        // addi x10, x10, 16*2      // .............................................*.
        // sh x12, 2*3(x11)         // .....................................*.........
        // addi x28, x24, 8         // .............................*.................
        // mulh x25, x28, x4        // ....................................*..........
        // sh x13, 2*12(x11)        // ....................................*..........
        // srai x28, x18, 32        // .................*.............................
        // mul x16, x16, x31        // ..........................*....................
        // mul x7, x27, x31         // ....................*..........................
        // addi x9, x28, 8          // ....................*..........................
        // mulh x13, x9, x4         // .....................................*.........
        // addi x24, x15, 8         // ................................*..............
        // sh x25, 2*13(x11)        // ........................................*......
        // mul x25, x17, x31        // ............*..................................
        // mul x26, x8, x31         // ...............*...............................
        // srai x16, x16, 32        // ..............................*................
        // addi x17, x16, 8         // .................................*.............
        // srai x16, x7, 32         // ........................*......................
        // addi x8, x16, 8          // .........................*.....................
        // sh x13, 2*7(x11)         // ...........................................*...
        // mul x28, x14, x31        // ...*...........................................
        // mulh x13, x8, x4         // ..........................*....................
        // mul x30, x30, x31        // ...................*...........................
        // mul x5, x20, x31         // ........*......................................
        // srai x8, x25, 32         // ................*..............................
        // mul x18, x23, x31        // .......*.......................................
        // sh x13, 2*10(x11)        // ..............................*................
        // srai x13, x28, 32        // .......*.......................................
        // addi x7, x13, 8          // .....................*.........................
        // srai x27, x30, 32        // .......................*.......................
        // mulh x14, x7, x4         // ......................*........................
        // addi x28, x27, 8         // ........................*......................
        // mulh x29, x28, x4        // .........................*.....................
        // srai x28, x18, 32        // ...........*...................................
        // mul x15, x21, x31        // ...................................*...........
        // addi x28, x28, 8         // .............*.................................
        // mulh x28, x28, x4        // ...............*...............................
        // srai x5, x5, 32          // ............*..................................
        // sh x14, 2*9(x11)         // ...........................*...................
        // addi x5, x5, 8           // .............*.................................
        // sh x29, 2*8(x11)         // .............................*.................
        // mulh x20, x5, x4         // ..............*................................
        // srai x23, x15, 32        // .......................................*.......
        // mul x1, x1, x31          // ..................................*............
        // sh x28, 2*6(x11)         // ...................*...........................
        // mulh x18, x24, x4        // .................................*.............
        // addi x19, x23, 8         // .........................................*.....
        // sh x22, 2*15(x11)        // ..............*................................
        // sh x20, 2*5(x11)         // ..................*............................
        // mulh x12, x17, x4        // .........................................*.....
        // srai x1, x1, 32          // ......................................*........
        // srai x13, x26, 32        // ................................*..............
        // addi x22, x1, 8          // .......................................*.......
        // addi x27, x13, 8         // ..................................*............
        // mulh x28, x22, x4        // ........................................*......
        // mulh x13, x27, x4        // ...................................*...........
        // addi x9, x8, 8           // .................*.............................
        // sh x12, 2*1(x11)         // .............................................*.
        // mulh x7, x9, x4          // ..................*............................
        // sh x18, 2*14(x11)        // ......................................*........
        // mulh x18, x19, x4        // ..........................................*....
        // sh x28, 2*0(x11)         // ............................................*..
        // sh x13, 2*4(x11)         // ..........................................*....
        // sh x7, 2*2(x11)          // ......................*........................
        // sh x18, 2*11(x11)        // ..............................................*
        // addi x11, x11, 16*2      // ..............................................*

  restore_regs
  addi sp, sp, 8*15
  ret