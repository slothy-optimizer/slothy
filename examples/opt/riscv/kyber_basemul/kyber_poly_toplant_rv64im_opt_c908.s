/// Copyright (c) 2024 Jipeng Zhang (jp-zhang@outlook.com) (Original Code)
/// Copyright (c) 2026 Amin Abdulrahman (amin@abdulrahman.de) (Modifications)
/// Copyright (c) 2026 Justus Bergermann (mail@justus-bergermann.de) (Modifications)
///
/// SPDX-License-Identifier: MIT
///
/// Permission is hereby granted, free of charge, to any person obtaining a copy
/// of this software and associated documentation files (the "Software"), to deal
/// in the Software without restriction, including without limitation the rights
/// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
/// copies of the Software, and to permit persons to whom the Software is
/// furnished to do so, subject to the following conditions:
///
/// The above copyright notice and this permission notice shall be included in all
/// copies or substantial portions of the Software.
///
/// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
/// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
/// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
/// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
/// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
/// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
/// SOFTWARE.

.macro load_coeffs poly, len, wordLen
  lh s0,  \len*\wordLen*0(\poly)
  lh s1,  \len*\wordLen*1(\poly)
  lh s2,  \len*\wordLen*2(\poly)
  lh s3,  \len*\wordLen*3(\poly)
  lh s4,  \len*\wordLen*4(\poly)
  lh s5,  \len*\wordLen*5(\poly)
  lh s6,  \len*\wordLen*6(\poly)
  lh s7,  \len*\wordLen*7(\poly)
  lh s8,  \len*\wordLen*8(\poly)
  lh s9,  \len*\wordLen*9(\poly)
  lh s10, \len*\wordLen*10(\poly)
  lh s11, \len*\wordLen*11(\poly)
  lh a2,  \len*\wordLen*12(\poly)
  lh a3,  \len*\wordLen*13(\poly)
  lh a4,  \len*\wordLen*14(\poly)
  lh a5,  \len*\wordLen*15(\poly)
.endm

.macro store_coeffs poly, len, wordLen
  sh s0,  \len*\wordLen*0(\poly)
  sh s1,  \len*\wordLen*1(\poly)
  sh s2,  \len*\wordLen*2(\poly)
  sh s3,  \len*\wordLen*3(\poly)
  sh s4,  \len*\wordLen*4(\poly)
  sh s5,  \len*\wordLen*5(\poly)
  sh s6,  \len*\wordLen*6(\poly)
  sh s7,  \len*\wordLen*7(\poly)
  sh s8,  \len*\wordLen*8(\poly)
  sh s9,  \len*\wordLen*9(\poly)
  sh s10, \len*\wordLen*10(\poly)
  sh s11, \len*\wordLen*11(\poly)
  sh a2,  \len*\wordLen*12(\poly)
  sh a3,  \len*\wordLen*13(\poly)
  sh a4,  \len*\wordLen*14(\poly)
  sh a5,  \len*\wordLen*15(\poly)
.endm

.macro save_regs
  sd s0,  0*8(sp)
  sd s1,  1*8(sp)
  sd s2,  2*8(sp)
  sd s3,  3*8(sp)
  sd s4,  4*8(sp)
  sd s5,  5*8(sp)
  sd s6,  6*8(sp)
  sd s7,  7*8(sp)
  sd s8,  8*8(sp)
  sd s9,  9*8(sp)
  sd s10, 10*8(sp)
  sd s11, 11*8(sp)
  sd gp,  12*8(sp)
  sd tp,  13*8(sp)
  sd ra,  14*8(sp)
.endm

.macro restore_regs
  ld s0,  0*8(sp)
  ld s1,  1*8(sp)
  ld s2,  2*8(sp)
  ld s3,  3*8(sp)
  ld s4,  4*8(sp)
  ld s5,  5*8(sp)
  ld s6,  6*8(sp)
  ld s7,  7*8(sp)
  ld s8,  8*8(sp)
  ld s9,  9*8(sp)
  ld s10, 10*8(sp)
  ld s11, 11*8(sp)
  ld gp,  12*8(sp)
  ld tp,  13*8(sp)
  ld ra,  14*8(sp)
.endm

// a <- a*b*(-2^{-64}) mod+- q
// q32: q<<32; bqinv: b*qinv
.macro plant_mul_const_inplace q32, bqinv, a
  mul  \a, \a, \bqinv
  srai \a, \a, 32
  addi \a, \a, 8
  mulh \a, \a, \q32
.endm

// r <- a*b*(-2^{-64}) mod+- q
// q32: q<<32; bqinv: b*qinv
.macro plant_mul_const q32, bqinv, a, r
    mul  \r, \a, \bqinv
    srai \r, \r, 32
    addi \r, \r, 8
    mulh \r, \r, \q32
.endm

// each layer increases coefficients by 0.5q; In ct_butterfly, twiddle and tmp can be reused because each twiddle is only used once. The gs_butterfly cannot.
.macro ct_butterfly coeff0, coeff1, twiddle, q, tmp
  plant_mul_const \q, \twiddle, \coeff1, \tmp
  sub \coeff1, \coeff0, \tmp
  add \coeff0, \coeff0, \tmp
.endm

.macro gs_butterfly coeff0, coeff1, twiddle, q, tmp
  sub \tmp, \coeff0, \coeff1
  add \coeff0, \coeff0, \coeff1
  plant_mul_const \q, \twiddle, \tmp, \coeff1
.endm

// in-place plantard reduction to a
// output \in (-0.5q, 0.5q); q32: q<<32
.macro plant_red q32, qinv, a
  mul  \a, \a, \qinv
  srai \a, \a, 32
  addi \a, \a, 8
  mulh \a, \a, \q32
.endm

.equ q,    3329
.equ q32,  0xd0100000000                // q << 32
.equ qinv, 0x3c0f12886ba8f301           // q^-1 mod 2^64
.equ plantconst, 0x13afb7680bb055       // (((-2**64) % q) * qinv) % (2**64)
.equ plantconst2, 0x1a390f4d9791e139    // (((-2**64) % q) * ((-2**64) % q) * qinv) % (2**64)

// each coeff is multiplied by plantconst2 using plantard multiplication
.global poly_toplant_rv64im_opt_c908
.align 2
poly_toplant_rv64im_opt_c908:
  addi sp, sp, -8*15
  save_regs
  li t4, plantconst2
  li tp, q32
  addi gp, x0, 16
  addi a1, a0, 0
                                 // Instructions:    6
                                 // Expected cycles: 6
                                 // Expected IPC:    1.00
                                 //
                                 // Cycle bound:     6.0
                                 // IPC bound:       1.00
                                 //
                                 // Wall time:     0.03s
                                 // User time:     0.03s
                                 //
                                 // ----- cycle (expected) ------>
                                 // 0                        25
                                 // |------------------------|----
        lh x16, 2*14(x10)        // *.............................
        lh x17, 2*11(x10)        // .*............................
        lh x28, 2*15(x10)        // ..*...........................
        mul x22, x16, x29        // ...*..........................
        mul x23, x17, x29        // ....*.........................
        mul x19, x28, x29        // .....*........................

                                  // ------ cycle (expected) ------>
                                  // 0                        25
                                  // |------------------------|-----
        // lh x9, 2*14(x10)       // *..............................
        // lh x19, 2*11(x10)      // .*.............................
        // lh x15, 2*15(x10)      // ..*............................
        // mul x22, x9, x29       // ...*...........................
        // mul x23, x19, x29      // ....*..........................
        // mul x19, x15, x29      // .....*.........................

        addi gp, gp, -1
poly_toplant_rv64im_loop:
                                   // Instructions:    98
                                   // Expected cycles: 49
                                   // Expected IPC:    2.00
                                   //
                                   // Cycle bound:     51.0
                                   // IPC bound:       1.92
                                   //
                                   // Wall time:     94.38s
                                   // User time:     94.38s
                                   //
                                   // --------------- cycle (expected) --------------->
                                   // 0                        25
                                   // |------------------------|-----------------------
        srai x12, x22, 32          // *................................................
        lh x1, 2*0(x10)            // *................................................
        srai x31, x23, 32          // .*...............................................
        lh x8, 2*4(x10)            // .*...............................................
        lh x14, 2*8(x10)           // ..*..............................................
        srai x18, x19, 32          // ..*..............................................
        mul x22, x1, x29           // ...*.............................................
        lh x13, 2*6(x10)           // ...*.............................................
        mul x24, x8, x29           // ....*............................................
        lh x27, 2*12(x10)          // ....*............................................
        lh x20, 2*10(x10)          // .....*...........................................
        addi x19, x18, 8           // .....*...........................................
        lh x17, 2*3(x10)           // ......*..........................................
        addi x8, x31, 8            // ......*..........................................
        mulh x6, x8, x4            // .......*.........................................
        lh x9, 2*9(x10)            // .......*.........................................
        srai x26, x24, 32          // ........*........................................
        lh x16, 2*7(x10)           // ........*........................................
        addi x28, x12, 8           // .........*.......................................
        mul x23, x27, x29          // .........*.......................................
        lh x1, 2*1(x10)            // ..........*......................................
        mul x18, x9, x29           // ..........*......................................
        mulh x8, x28, x4           // ...........*.....................................
        lh x24, 2*13(x10)          // ...........*.....................................
        srai x22, x22, 32          // ............*....................................
        mul x15, x17, x29          // ............*....................................
        lh x17, 2*2(x10)           // .............*...................................
        addi x30, x26, 8           // .............*...................................
        mul x26, x16, x29          // ..............*..................................
        srai x31, x18, 32          // ..............*..................................
        addi x31, x31, 8           // ...............*.................................
        mul x7, x13, x29           // ...............*.................................
        lh x16, 2*5(x10)           // ................*................................
        mul x12, x17, x29          // ................*................................
        addi x17, x22, 8           // .................*...............................
        srai x28, x15, 32          // .................*...............................
        srai x18, x26, 32          // ..................*..............................
        addi x28, x28, 8           // ..................*..............................
        mulh x25, x19, x4          // ...................*.............................
        srai x27, x7, 32           // ...................*.............................
        mul x5, x20, x29           // ....................*............................
        addi x10, x10, 16*2        // ....................*............................
        addi x21, x18, 8           // .....................*...........................
        mul x18, x24, x29          // .....................*...........................
        lh x9, 2*14(x10)           // ......................e..........................
        srai x15, x23, 32          // ......................*..........................
        mul x1, x1, x29            // .......................*.........................
        sh x8, 2*14(x11)           // .......................*.........................
        lh x19, 2*11(x10)          // ........................e........................
        mul x13, x14, x29          // ........................*........................
        mulh x26, x21, x4          // .........................*.......................
        srai x12, x12, 32          // .........................*.......................
        addi x20, x27, 8           // ..........................*......................
        addi x7, x12, 8            // ..........................*......................
        mulh x22, x20, x4          // ...........................*.....................
        mulh x8, x30, x4           // ...........................*.....................
        sh x6, 2*11(x11)           // ............................*....................
        srai x24, x5, 32           // ............................*....................
        srai x14, x18, 32          // .............................*...................
        mul x27, x16, x29          // .............................*...................
        addi x30, x14, 8           // ..............................*..................
        srai x20, x13, 32          // ..............................*..................
        mulh x16, x31, x4          // ...............................*.................
        sh x8, 2*4(x11)            // ...............................*.................
        sh x26, 2*7(x11)           // ................................*................
        mulh x13, x30, x4          // ................................*................
        sh x22, 2*6(x11)           // .................................*...............
        mulh x18, x7, x4           // .................................*...............
        mulh x12, x28, x4          // ..................................*..............
        addi x14, x20, 8           // ..................................*..............
        sh x16, 2*9(x11)           // ...................................*.............
        addi x22, x15, 8           // ...................................*.............
        srai x5, x1, 32            // ....................................*............
        srai x30, x27, 32          // ....................................*............
        addi x23, x24, 8           // .....................................*...........
        mulh x26, x22, x4          // .....................................*...........
        mulh x7, x14, x4           // ......................................*..........
        sh x13, 2*13(x11)          // ......................................*..........
        addi x14, x30, 8           // .......................................*.........
        sh x18, 2*2(x11)           // .......................................*.........
        sh x25, 2*15(x11)          // ........................................*........
        mulh x16, x14, x4          // ........................................*........
        sh x12, 2*3(x11)           // .........................................*.......
        mulh x8, x23, x4           // .........................................*.......
        mulh x18, x17, x4          // ..........................................*......
        sh x26, 2*12(x11)          // ..........................................*......
        lh x15, 2*15(x10)          // ...........................................e.....
        addi x1, x5, 8             // ...........................................*.....
        sh x16, 2*5(x11)           // ............................................*....
        mulh x13, x1, x4           // ............................................*....
        sh x8, 2*10(x11)           // .............................................*...
        mul x22, x9, x29           // .............................................e...
        mul x23, x19, x29          // ..............................................e..
        sh x7, 2*8(x11)            // ..............................................*..
        sh x18, 2*0(x11)           // ...............................................*.
        mul x19, x15, x29          // ...............................................e.
        sh x13, 2*1(x11)           // ................................................*
        addi x11, x11, 16*2        // ................................................*

                                    // ---------------------------- cycle (expected) ----------------------------->
                                    // 0                        25                       50
                                    // |------------------------|------------------------|-------------------------
        // lh x8,  2*0(x10)         // ...........................*................................................
        // lh x9,  2*1(x10)         // ...........................'.........*......................................
        // lh x18,  2*2(x10)        // ...........................'............*...................................
        // lh x19,  2*3(x10)        // ...........................'.....*..........................................
        // mul  x8, x8, x29         // ...........................'..*.............................................
        // srai x8, x8, 32          // ...........................'...........*....................................
        // addi x8, x8, 8           // ...........................'................*...............................
        // mulh x8, x8, x4          // ....................~......'.........................................*......
        // mul  x9, x9, x29         // .~.........................'......................*.........................
        // srai x9, x9, 32          // ..............~............'...................................*............
        // addi x9, x9, 8           // .....................~.....'..........................................*.....
        // mulh x9, x9, x4          // ......................~....'...........................................*....
        // sh x8,  2*0(x11)         // .........................~.'..............................................*.
        // mul  x18, x18, x29       // ...........................'...............*................................
        // srai x18, x18, 32        // ...~.......................'........................*.......................
        // addi x18, x18, 8         // ....~......................'.........................*......................
        // mulh x18, x18, x4        // ...........~...............'................................*...............
        // sh x9,  2*1(x11)         // ..........................~'...............................................*
        // mul  x19, x19, x29       // ...........................'...........*....................................
        // srai x19, x19, 32        // ...........................'................*...............................
        // addi x19, x19, 8         // ...........................'.................*..............................
        // mulh x19, x19, x4        // ............~..............'.................................*..............
        // sh x18,  2*2(x11)        // .................~.........'......................................*.........
        // lh x20,  2*4(x10)        // ...........................'*...............................................
        // lh x21,  2*5(x10)        // ...........................'...............*................................
        // lh x22,  2*6(x10)        // ...........................'..*.............................................
        // lh x23,  2*7(x10)        // ...........................'.......*........................................
        // mul  x20, x20, x29       // ...........................'...*............................................
        // srai x20, x20, 32        // ...........................'.......*........................................
        // addi x20, x20, 8         // ...........................'............*...................................
        // mulh x20, x20, x4        // .....~.....................'..........................*.....................
        // sh x19,  2*3(x11)        // ...................~.......'........................................*.......
        // mul  x21, x21, x29       // .......~...................'............................*...................
        // srai x21, x21, 32        // ..............~............'...................................*............
        // addi x21, x21, 8         // .................~.........'......................................*.........
        // mulh x21, x21, x4        // ..................~........'.......................................*........
        // sh x20,  2*4(x11)        // .........~.................'..............................*.................
        // mul  x22, x22, x29       // ...........................'..............*.................................
        // srai x22, x22, 32        // ...........................'..................*.............................
        // addi x22, x22, 8         // ....~......................'.........................*......................
        // mulh x22, x22, x4        // .....~.....................'..........................*.....................
        // sh x21,  2*5(x11)        // ......................~....'...........................................*....
        // mul  x23, x23, x29       // ...........................'.............*..................................
        // srai x23, x23, 32        // ...........................'.................*..............................
        // addi x23, x23, 8         // ...........................'....................*...........................
        // mulh x23, x23, x4        // ...~.......................'........................*.......................
        // sh x22,  2*6(x11)        // ...........~...............'................................*...............
        // lh x24,  2*8(x10)        // ...........................'.*..............................................
        // lh x25,  2*9(x10)        // ...........................'......*.........................................
        // lh x26, 2*10(x10)        // ...........................'....*...........................................
        // lh x27, 2*11(x10)        // ..e........................'.......................~........................
        // mul  x24, x24, x29       // ..~........................'.......................*........................
        // srai x24, x24, 32        // ........~..................'.............................*..................
        // addi x24, x24, 8         // ............~..............'.................................*..............
        // mulh x24, x24, x4        // ................~..........'.....................................*..........
        // sh x23,  2*7(x11)        // ..........~................'...............................*................
        // mul  x25, x25, x29       // ...........................'.........*......................................
        // srai x25, x25, 32        // ...........................'.............*..................................
        // addi x25, x25, 8         // ...........................'..............*.................................
        // mulh x25, x25, x4        // .........~.................'..............................*.................
        // sh x24,  2*8(x11)        // ........................~..'.............................................*..
        // mul  x26, x26, x29       // ...........................'...................*............................
        // srai x26, x26, 32        // ......~....................'...........................*....................
        // addi x26, x26, 8         // ...............~...........'....................................*...........
        // mulh x26, x26, x4        // ...................~.......'........................................*.......
        // sh x25,  2*9(x11)        // .............~.............'..................................*.............
        // mul  x27, x27, x29       // ........................e..'.............................................~..
        // srai x27, x27, 32        // ...........................'*...............................................
        // addi x27, x27, 8         // ...........................'.....*..........................................
        // mulh x27, x27, x4        // ...........................'......*.........................................
        // sh x26, 2*10(x11)        // .......................~...'............................................*...
        // lh x5,  2*12(x10)        // ...........................'...*............................................
        // lh x6,  2*13(x10)        // ...........................'..........*.....................................
        // lh x7,  2*14(x10)        // e..........................'.....................~..........................
        // lh x28,  2*15(x10)       // .....................e.....'..........................................~.....
        // mul  x5, x5, x29         // ...........................'........*.......................................
        // srai x5, x5, 32          // ~..........................'.....................*..........................
        // addi x5, x5, 8           // .............~.............'..................................*.............
        // mulh x5, x5, x4          // ...............~...........'....................................*...........
        // sh x27, 2*11(x11)        // ......~....................'...........................*....................
        // mul  x6, x6, x29         // ...........................'....................*...........................
        // srai x6, x6, 32          // .......~...................'............................*...................
        // addi x6, x6, 8           // ........~..................'.............................*..................
        // mulh x6, x6, x4          // ..........~................'...............................*................
        // sh x5,  2*12(x11)        // ....................~......'.........................................*......
        // mul  x7, x7, x29         // .......................e...'............................................~...
        // srai x7, x7, 32          // ...........................*................................................
        // addi x7, x7, 8           // ...........................'........*.......................................
        // mulh x7, x7, x4          // ...........................'..........*.....................................
        // sh x6,  2*13(x11)        // ................~..........'.....................................*..........
        // mul  x28, x28, x29       // .........................e.'..............................................~.
        // srai x28, x28, 32        // ...........................'.*..............................................
        // addi x28, x28, 8         // ...........................'....*...........................................
        // mulh x28, x28, x4        // ...........................'..................*.............................
        // sh x7,  2*14(x11)        // .~.........................'......................*.........................
        // sh x28,  2*15(x11)       // ..................~........'.......................................*........
        // addi x10, x10, 16*2      // ...........................'...................*............................
        // addi x11, x11, 16*2      // ..........................~'...............................................*

        addi gp, gp, -1
        bne gp, zero, poly_toplant_rv64im_loop
                                   // Instructions:    92
                                   // Expected cycles: 47
                                   // Expected IPC:    1.96
                                   //
                                   // Cycle bound:     46.0
                                   // IPC bound:       2.00
                                   //
                                   // Wall time:     31.79s
                                   // User time:     31.79s
                                   //
                                   // -------------- cycle (expected) -------------->
                                   // 0                        25
                                   // |------------------------|---------------------
        srai x1, x22, 32           // *..............................................
        lh x22, 2*0(x10)           // *..............................................
        srai x23, x23, 32          // .*.............................................
        lh x17, 2*4(x10)           // .*.............................................
        lh x18, 2*8(x10)           // ..*............................................
        srai x16, x19, 32          // ..*............................................
        addi x7, x16, 8            // ...*...........................................
        lh x16, 2*6(x10)           // ...*...........................................
        mul x19, x17, x29          // ....*..........................................
        lh x28, 2*12(x10)          // ....*..........................................
        mul x17, x22, x29          // .....*.........................................
        lh x13, 2*10(x10)          // .....*.........................................
        addi x23, x23, 8           // ......*........................................
        lh x12, 2*3(x10)           // ......*........................................
        mul x30, x28, x29          // .......*.......................................
        lh x5, 2*9(x10)            // .......*.......................................
        srai x9, x19, 32           // ........*......................................
        lh x19, 2*2(x10)           // ........*......................................
        mul x24, x12, x29          // .........*.....................................
        addi x8, x1, 8             // .........*.....................................
        srai x1, x17, 32           // ..........*....................................
        mul x28, x5, x29           // ..........*....................................
        addi x6, x9, 8             // ...........*...................................
        mul x5, x19, x29           // ...........*...................................
        mulh x17, x6, x4           // ............*..................................
        lh x6, 2*1(x10)            // ............*..................................
        mul x15, x16, x29          // .............*.................................
        mul x13, x13, x29          // .............*.................................
        srai x14, x28, 32          // ..............*................................
        lh x25, 2*13(x10)          // ..............*................................
        addi x20, x14, 8           // ...............*...............................
        mul x14, x6, x29           // ...............*...............................
        sh x17, 2*4(x11)           // ................*..............................
        srai x22, x5, 32           // ................*..............................
        srai x16, x15, 32          // .................*.............................
        mul x17, x25, x29          // .................*.............................
        addi x27, x22, 8           // ..................*............................
        srai x28, x13, 32          // ..................*............................
        mul x25, x18, x29          // ...................*...........................
        addi x16, x16, 8           // ...................*...........................
        mulh x13, x16, x4          // ....................*..........................
        srai x12, x30, 32          // ....................*..........................
        lh x5, 2*7(x10)            // .....................*.........................
        srai x16, x17, 32          // .....................*.........................
        addi x19, x16, 8           // ......................*........................
        mulh x26, x8, x4           // ......................*........................
        mulh x16, x20, x4          // .......................*.......................
        srai x17, x25, 32          // .......................*.......................
        addi x18, x17, 8           // ........................*......................
        mul x31, x5, x29           // ........................*......................
        lh x22, 2*5(x10)           // .........................*.....................
        srai x17, x24, 32          // .........................*.....................
        mulh x25, x27, x4          // ..........................*....................
        addi x8, x17, 8            // ..........................*....................
        sh x13, 2*6(x11)           // ...........................*...................
        mulh x13, x8, x4           // ...........................*...................
        addi x17, x28, 8           // ............................*..................
        mul x24, x22, x29          // ............................*..................
        srai x9, x31, 32           // .............................*.................
        addi x22, x12, 8           // .............................*.................
        mulh x5, x19, x4           // ..............................*................
        mulh x28, x22, x4          // ..............................*................
        addi x30, x9, 8            // ...............................*...............
        sh x16, 2*9(x11)           // ...............................*...............
        mulh x17, x17, x4          // ................................*..............
        srai x16, x24, 32          // ................................*..............
        sh x25, 2*2(x11)           // .................................*.............
        mulh x7, x7, x4            // .................................*.............
        sh x13, 2*3(x11)           // ..................................*............
        srai x19, x14, 32          // ..................................*............
        sh x26, 2*14(x11)          // ...................................*...........
        mulh x22, x18, x4          // ...................................*...........
        mulh x23, x23, x4          // ....................................*..........
        addi x16, x16, 8           // ....................................*..........
        sh x7, 2*15(x11)           // .....................................*.........
        mulh x16, x16, x4          // .....................................*.........
        addi x15, x19, 8           // ......................................*........
        sh x28, 2*12(x11)          // ......................................*........
        addi x9, x1, 8             // .......................................*.......
        sh x5, 2*13(x11)           // .......................................*.......
        sh x23, 2*11(x11)          // ........................................*......
        mulh x27, x9, x4           // ........................................*......
        sh x16, 2*5(x11)           // .........................................*.....
        mulh x14, x30, x4          // .........................................*.....
        sh x17, 2*10(x11)          // ..........................................*....
        mulh x16, x15, x4          // ..........................................*....
        sh x22, 2*8(x11)           // ...........................................*...
        addi x10, x10, 16*2        // ...........................................*...
        sh x27, 2*0(x11)           // ............................................*..
        sh x14, 2*7(x11)           // .............................................*.
        sh x16, 2*1(x11)           // ..............................................*
        addi x11, x11, 16*2        // ..............................................*

                                    // -------------- cycle (expected) -------------->
                                    // 0                        25
                                    // |------------------------|---------------------
        // srai x12, x22, 32        // *..............................................
        // lh x1, 2*0(x10)          // *..............................................
        // srai x31, x23, 32        // .*.............................................
        // lh x8, 2*4(x10)          // .*.............................................
        // lh x14, 2*8(x10)         // ..*............................................
        // srai x18, x19, 32        // ..*............................................
        // mul x22, x1, x29         // .....*.........................................
        // lh x13, 2*6(x10)         // ...*...........................................
        // mul x24, x8, x29         // ....*..........................................
        // lh x27, 2*12(x10)        // ....*..........................................
        // lh x20, 2*10(x10)        // .....*.........................................
        // addi x19, x18, 8         // ...*...........................................
        // lh x17, 2*3(x10)         // ......*........................................
        // addi x8, x31, 8          // ......*........................................
        // mulh x6, x8, x4          // ....................................*..........
        // lh x9, 2*9(x10)          // .......*.......................................
        // srai x26, x24, 32        // ........*......................................
        // lh x16, 2*7(x10)         // .....................*.........................
        // addi x28, x12, 8         // .........*.....................................
        // mul x23, x27, x29        // .......*.......................................
        // lh x1, 2*1(x10)          // ............*..................................
        // mul x18, x9, x29         // ..........*....................................
        // mulh x8, x28, x4         // ......................*........................
        // lh x24, 2*13(x10)        // ..............*................................
        // srai x22, x22, 32        // ..........*....................................
        // mul x15, x17, x29        // .........*.....................................
        // lh x17, 2*2(x10)         // ........*......................................
        // addi x30, x26, 8         // ...........*...................................
        // mul x26, x16, x29        // ........................*......................
        // srai x31, x18, 32        // ..............*................................
        // addi x31, x31, 8         // ...............*...............................
        // mul x7, x13, x29         // .............*.................................
        // lh x16, 2*5(x10)         // .........................*.....................
        // mul x12, x17, x29        // ...........*...................................
        // addi x17, x22, 8         // .......................................*.......
        // srai x28, x15, 32        // .........................*.....................
        // srai x18, x26, 32        // .............................*.................
        // addi x28, x28, 8         // ..........................*....................
        // mulh x25, x19, x4        // .................................*.............
        // srai x27, x7, 32         // .................*.............................
        // mul x5, x20, x29         // .............*.................................
        // addi x10, x10, 16*2      // ...........................................*...
        // addi x21, x18, 8         // ...............................*...............
        // mul x18, x24, x29        // .................*.............................
        // srai x15, x23, 32        // ....................*..........................
        // mul x1, x1, x29          // ...............*...............................
        // sh x8, 2*14(x11)         // ...................................*...........
        // mul x13, x14, x29        // ...................*...........................
        // mulh x26, x21, x4        // .........................................*.....
        // srai x12, x12, 32        // ................*..............................
        // addi x20, x27, 8         // ...................*...........................
        // addi x7, x12, 8          // ..................*............................
        // mulh x22, x20, x4        // ....................*..........................
        // mulh x8, x30, x4         // ............*..................................
        // sh x6, 2*11(x11)         // ........................................*......
        // srai x24, x5, 32         // ..................*............................
        // srai x14, x18, 32        // .....................*.........................
        // mul x27, x16, x29        // ............................*..................
        // addi x30, x14, 8         // ......................*........................
        // srai x20, x13, 32        // .......................*.......................
        // mulh x16, x31, x4        // .......................*.......................
        // sh x8, 2*4(x11)          // ................*..............................
        // sh x26, 2*7(x11)         // .............................................*.
        // mulh x13, x30, x4        // ..............................*................
        // sh x22, 2*6(x11)         // ...........................*...................
        // mulh x18, x7, x4         // ..........................*....................
        // mulh x12, x28, x4        // ...........................*...................
        // addi x14, x20, 8         // ........................*......................
        // sh x16, 2*9(x11)         // ...............................*...............
        // addi x22, x15, 8         // .............................*.................
        // srai x5, x1, 32          // ..................................*............
        // srai x30, x27, 32        // ................................*..............
        // addi x23, x24, 8         // ............................*..................
        // mulh x26, x22, x4        // ..............................*................
        // mulh x7, x14, x4         // ...................................*...........
        // sh x13, 2*13(x11)        // .......................................*.......
        // addi x14, x30, 8         // ....................................*..........
        // sh x18, 2*2(x11)         // .................................*.............
        // sh x25, 2*15(x11)        // .....................................*.........
        // mulh x16, x14, x4        // .....................................*.........
        // sh x12, 2*3(x11)         // ..................................*............
        // mulh x8, x23, x4         // ................................*..............
        // mulh x18, x17, x4        // ........................................*......
        // sh x26, 2*12(x11)        // ......................................*........
        // addi x1, x5, 8           // ......................................*........
        // sh x16, 2*5(x11)         // .........................................*.....
        // mulh x13, x1, x4         // ..........................................*....
        // sh x8, 2*10(x11)         // ..........................................*....
        // sh x7, 2*8(x11)          // ...........................................*...
        // sh x18, 2*0(x11)         // ............................................*..
        // sh x13, 2*1(x11)         // ..............................................*
        // addi x11, x11, 16*2      // ..............................................*

  restore_regs
  addi sp, sp, 8*15
  ret