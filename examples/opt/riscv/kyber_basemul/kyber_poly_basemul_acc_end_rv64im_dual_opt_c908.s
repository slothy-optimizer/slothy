/// Copyright (c) 2024 Jipeng Zhang (jp-zhang@outlook.com) (Original Code)
/// Copyright (c) 2026 Amin Abdulrahman (amin@abdulrahman.de) (Modifications)
/// Copyright (c) 2026 Justus Bergermann (mail@justus-bergermann.de) (Modifications)
///
/// SPDX-License-Identifier: MIT
///
/// Permission is hereby granted, free of charge, to any person obtaining a copy
/// of this software and associated documentation files (the "Software"), to deal
/// in the Software without restriction, including without limitation the rights
/// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
/// copies of the Software, and to permit persons to whom the Software is
/// furnished to do so, subject to the following conditions:
///
/// The above copyright notice and this permission notice shall be included in all
/// copies or substantial portions of the Software.
///
/// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
/// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
/// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
/// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
/// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
/// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
/// SOFTWARE.

// Plantard based NTT implementation with l=16

.macro load_coeffs poly, len, wordLen
  lh s0,  \len*\wordLen*0(\poly)
  lh s1,  \len*\wordLen*1(\poly)
  lh s2,  \len*\wordLen*2(\poly)
  lh s3,  \len*\wordLen*3(\poly)
  lh s4,  \len*\wordLen*4(\poly)
  lh s5,  \len*\wordLen*5(\poly)
  lh s6,  \len*\wordLen*6(\poly)
  lh s7,  \len*\wordLen*7(\poly)
  lh s8,  \len*\wordLen*8(\poly)
  lh s9,  \len*\wordLen*9(\poly)
  lh s10, \len*\wordLen*10(\poly)
  lh s11, \len*\wordLen*11(\poly)
  lh a2,  \len*\wordLen*12(\poly)
  lh a3,  \len*\wordLen*13(\poly)
  lh a4,  \len*\wordLen*14(\poly)
  lh a5,  \len*\wordLen*15(\poly)
.endm

.macro store_coeffs poly, len, wordLen
  sh s0,  \len*\wordLen*0(\poly)
  sh s1,  \len*\wordLen*1(\poly)
  sh s2,  \len*\wordLen*2(\poly)
  sh s3,  \len*\wordLen*3(\poly)
  sh s4,  \len*\wordLen*4(\poly)
  sh s5,  \len*\wordLen*5(\poly)
  sh s6,  \len*\wordLen*6(\poly)
  sh s7,  \len*\wordLen*7(\poly)
  sh s8,  \len*\wordLen*8(\poly)
  sh s9,  \len*\wordLen*9(\poly)
  sh s10, \len*\wordLen*10(\poly)
  sh s11, \len*\wordLen*11(\poly)
  sh a2,  \len*\wordLen*12(\poly)
  sh a3,  \len*\wordLen*13(\poly)
  sh a4,  \len*\wordLen*14(\poly)
  sh a5,  \len*\wordLen*15(\poly)
.endm

.macro save_regs
  sd s0,  0*8(sp)
  sd s1,  1*8(sp)
  sd s2,  2*8(sp)
  sd s3,  3*8(sp)
  sd s4,  4*8(sp)
  sd s5,  5*8(sp)
  sd s6,  6*8(sp)
  sd s7,  7*8(sp)
  sd s8,  8*8(sp)
  sd s9,  9*8(sp)
  sd s10, 10*8(sp)
  sd s11, 11*8(sp)
  sd gp,  12*8(sp)
  sd tp,  13*8(sp)
  sd ra,  14*8(sp)
.endm

.macro restore_regs
  ld s0,  0*8(sp)
  ld s1,  1*8(sp)
  ld s2,  2*8(sp)
  ld s3,  3*8(sp)
  ld s4,  4*8(sp)
  ld s5,  5*8(sp)
  ld s6,  6*8(sp)
  ld s7,  7*8(sp)
  ld s8,  8*8(sp)
  ld s9,  9*8(sp)
  ld s10, 10*8(sp)
  ld s11, 11*8(sp)
  ld gp,  12*8(sp)
  ld tp,  13*8(sp)
  ld ra,  14*8(sp)
.endm

// a <- a*b*(-2^{-32}) mod+- q
// q48: q<<48; bqinv: b*qinv
.macro plant_mul_const_inplace q48, zeta, a
  mulw \a, \a, \zeta
  srai \a, \a, 16
  addi \a, \a, 8
  mulh \a, \a, \q48
.endm

.macro plant_mul_const_inplace_x2 q48, zeta, a_0, a_1
  mulw \a_0, \a_0, \zeta
  mulw \a_1, \a_1, \zeta
  srai \a_0, \a_0, 16
  srai \a_1, \a_1, 16
  addi \a_0, \a_0, 8
  addi \a_1, \a_1, 8
  mulh \a_0, \a_0, \q48
  mulh \a_1, \a_1, \q48
.endm

.macro plant_mul_const_inplace_x4 q48,   zeta_0, zeta_1, zeta_2, zeta_3,    a_0, a_1, a_2, a_3
  mulw \a_0, \a_0, \zeta_0
  mulw \a_1, \a_1, \zeta_1
  mulw \a_2, \a_2, \zeta_2
  mulw \a_3, \a_3, \zeta_3
  srai \a_0, \a_0, 16
  srai \a_1, \a_1, 16
  srai \a_2, \a_2, 16
  srai \a_3, \a_3, 16
  addi \a_0, \a_0, 8
  addi \a_1, \a_1, 8
  addi \a_2, \a_2, 8
  addi \a_3, \a_3, 8
  mulh \a_0, \a_0, \q48
  mulh \a_1, \a_1, \q48
  mulh \a_2, \a_2, \q48
  mulh \a_3, \a_3, \q48
.endm

// r <- a*b*(-2^{-32}) mod+- q
// q48: q<<48; zeta: b*qinv
.macro plant_mul_const q48, zeta, a, r
  mulw \r, \a, \zeta
  srai \r, \r, 16
  addi \r, \r, 8
  mulh \r, \r, \q48
.endm

.macro plant_mul_const_x2 q48, zeta_0, zeta_1, a_0, a_1, r_0, r_1
  mulw \r_0, \a_0, \zeta_0
  mulw \r_1, \a_1, \zeta_1
  srai \r_0, \r_0, 16
  srai \r_1, \r_1, 16
  addi \r_0, \r_0, 8
  addi \r_1, \r_1, 8
  mulh \r_0, \r_0, \q48
  mulh \r_1, \r_1, \q48
.endm

.macro plant_mul_const_x4    q48, zeta_0, zeta_1, zeta_2, zeta_3,      a_0, a_1, a_2, a_3,  r_0, r_1, r_2, r_3
  mulw \r_0, \a_0, \zeta_0
  mulw \r_1, \a_1, \zeta_1
  mulw \r_2, \a_2, \zeta_2
  mulw \r_3, \a_3, \zeta_3
  srai \r_0, \r_0, 16
  srai \r_1, \r_1, 16
  srai \r_2, \r_2, 16
  srai \r_3, \r_3, 16
  addi \r_0, \r_0, 8
  addi \r_1, \r_1, 8
  addi \r_2, \r_2, 8
  addi \r_3, \r_3, 8
  mulh \r_0, \r_0, \q48
  mulh \r_1, \r_1, \q48
  mulh \r_2, \r_2, \q48
  mulh \r_3, \r_3, \q48
.endm

// each layer increases coefficients by 0.5q; In ct_bfu, zeta and tmp can be reused because each zeta is only used once. The gs_bfu cannot.
// .macro ct_bfu a_0, a_1, zeta, q48, tmp
// plant_mul_const \q48, \zeta, \a_1, \tmp
// sub \a_1, \a_0, \tmp
// add \a_0, \a_0, \tmp
// .endm
.macro ct_bfu a_0, a_1, zeta, q48, tmp
  mulw \tmp, \a_1, \zeta
  srai \tmp, \tmp, 16
  addi \tmp, \tmp, 8
  mulh \tmp, \tmp, \q48
  sub \a_1, \a_0, \tmp
  add \a_0, \a_0, \tmp
.endm

.macro ct_bfu_x2  a_0_0, a_0_1, a_1_0, a_1_1,  zeta_0, zeta_1,  q48,  t_0, t_1
  mulw  \t_0, \a_0_1, \zeta_0
  mulw  \t_1, \a_1_1, \zeta_1
  srai \t_0, \t_0, 16
  srai \t_1, \t_1, 16
  addi \t_0, \t_0, 8
  addi \t_1, \t_1, 8
  mulh \t_0, \t_0, \q48
  mulh \t_1, \t_1, \q48
  sub  \a_0_1, \a_0_0, \t_0
  sub  \a_1_1, \a_1_0, \t_1
  add  \a_0_0, \a_0_0, \t_0
  add  \a_1_0, \a_1_0, \t_1
.endm

.macro ct_bfu_x8  a_0_0, a_0_1, a_1_0, a_1_1,  a_2_0, a_2_1, a_3_0, a_3_1,  a_4_0, a_4_1, a_5_0, a_5_1,  a_6_0, a_6_1, a_7_0, a_7_1,  zeta_0, zeta_1,  zeta_2, zeta_3,  zeta_4, zeta_5,  zeta_6, zeta_7,  q48,  t_0, t_1, t_2, t_3
  mulw \t_0, \a_0_1, \zeta_0
  mulw \t_1, \a_1_1, \zeta_1
  mulw \t_2, \a_2_1, \zeta_2
  mulw \t_3, \a_3_1, \zeta_3
  srai \t_0, \t_0, 16
  srai \t_1, \t_1, 16
  addi \t_0, \t_0, 8
  addi \t_1, \t_1, 8
  mulh \t_0, \t_0, \q48
  mulh \t_1, \t_1, \q48
  srai \t_2, \t_2, 16
  srai \t_3, \t_3, 16
  addi \t_2, \t_2, 8
  addi \t_3, \t_3, 8
  mulh \t_2, \t_2, \q48
  mulh \t_3, \t_3, \q48
  sub  \a_0_1, \a_0_0, \t_0
  sub  \a_1_1, \a_1_0, \t_1
  add  \a_0_0, \a_0_0, \t_0
  add  \a_1_0, \a_1_0, \t_1
  mulw \t_0, \a_4_1, \zeta_4
  mulw \t_1, \a_5_1, \zeta_5
  sub  \a_2_1, \a_2_0, \t_2
  sub  \a_3_1, \a_3_0, \t_3
  add  \a_2_0, \a_2_0, \t_2
  add  \a_3_0, \a_3_0, \t_3
  mulw \t_2, \a_6_1, \zeta_6
  mulw \t_3, \a_7_1, \zeta_7
  srai \t_0, \t_0, 16
  srai \t_1, \t_1, 16
  addi \t_0, \t_0, 8
  addi \t_1, \t_1, 8
  mulh \t_0, \t_0, \q48
  mulh \t_1, \t_1, \q48
  srai \t_2, \t_2, 16
  srai \t_3, \t_3, 16
  addi \t_2, \t_2, 8
  addi \t_3, \t_3, 8
  mulh \t_2, \t_2, \q48
  mulh \t_3, \t_3, \q48
  sub  \a_4_1, \a_4_0, \t_0
  sub  \a_5_1, \a_5_0, \t_1
  add  \a_4_0, \a_4_0, \t_0
  add  \a_5_0, \a_5_0, \t_1
  sub  \a_6_1, \a_6_0, \t_2
  sub  \a_7_1, \a_7_0, \t_3
  add  \a_6_0, \a_6_0, \t_2
  add  \a_7_0, \a_7_0, \t_3
.endm

.macro ct_bfu_x8_loadzetas  a_0_0, a_0_1, a_1_0, a_1_1,  a_2_0, a_2_1, a_3_0, a_3_1,  a_4_0, a_4_1, a_5_0, a_5_1,  a_6_0, a_6_1, a_7_0, a_7_1,  zeta_0, zeta_1,  zeta_2, zeta_3,  zeta_4, zeta_5,  zeta_6, zeta_7,  q48,  t_0, t_1, t_2, t_3
  lw   \t_0, \zeta_0(a1)
  lw   \t_1, \zeta_1(a1)
  lw   \t_2, \zeta_2(a1)
  lw   \t_3, \zeta_3(a1)
  mulw \t_0, \a_0_1, \t_0
  mulw \t_1, \a_1_1, \t_1
  mulw \t_2, \a_2_1, \t_2
  mulw \t_3, \a_3_1, \t_3
  srai \t_0, \t_0, 16
  srai \t_1, \t_1, 16
  addi \t_0, \t_0, 8
  addi \t_1, \t_1, 8
  mulh \t_0, \t_0, \q48
  mulh \t_1, \t_1, \q48
  srai \t_2, \t_2, 16
  srai \t_3, \t_3, 16
  addi \t_2, \t_2, 8
  addi \t_3, \t_3, 8
  mulh \t_2, \t_2, \q48
  mulh \t_3, \t_3, \q48
  sub  \a_0_1, \a_0_0, \t_0
  sub  \a_1_1, \a_1_0, \t_1
  add  \a_0_0, \a_0_0, \t_0
  lw   \t_0, \zeta_4(a1)
  add  \a_1_0, \a_1_0, \t_1
  lw   \t_1, \zeta_5(a1)
  mulw \t_0, \a_4_1, \t_0
  mulw \t_1, \a_5_1, \t_1
  sub  \a_2_1, \a_2_0, \t_2
  sub  \a_3_1, \a_3_0, \t_3
  add  \a_2_0, \a_2_0, \t_2
  lw   \t_2, \zeta_6(a1)
  add  \a_3_0, \a_3_0, \t_3
  lw   \t_3, \zeta_7(a1)
  mulw \t_2, \a_6_1, \t_2
  mulw \t_3, \a_7_1, \t_3
  srai \t_0, \t_0, 16
  srai \t_1, \t_1, 16
  addi \t_0, \t_0, 8
  addi \t_1, \t_1, 8
  mulh \t_0, \t_0, \q48
  mulh \t_1, \t_1, \q48
  srai \t_2, \t_2, 16
  srai \t_3, \t_3, 16
  addi \t_2, \t_2, 8
  addi \t_3, \t_3, 8
  mulh \t_2, \t_2, \q48
  mulh \t_3, \t_3, \q48
  sub  \a_4_1, \a_4_0, \t_0
  sub  \a_5_1, \a_5_0, \t_1
  add  \a_4_0, \a_4_0, \t_0
  add  \a_5_0, \a_5_0, \t_1
  sub  \a_6_1, \a_6_0, \t_2
  sub  \a_7_1, \a_7_0, \t_3
  add  \a_6_0, \a_6_0, \t_2
  add  \a_7_0, \a_7_0, \t_3
.endm

.macro gs_bfu a_0, a_1, zeta, q48, tmp
  sub \tmp, \a_0, \a_1
  add \a_0, \a_0, \a_1
  mulw \a_1, \tmp, \zeta
  srai \a_1, \a_1, 16
  addi \a_1, \a_1, 8
  mulh \a_1, \a_1, \q48
.endm

.macro gs_bfu_x2 a_0_0, a_0_1, a_1_0, a_1_1,  zeta_0, zeta_1, q48, t_0, t_1
  sub \t_0, \a_0_0, \a_0_1
  sub \t_1, \a_1_0, \a_1_1
  add \a_0_0, \a_0_0, \a_0_1
  add \a_1_0, \a_1_0, \a_1_1
  mulw \a_0_1, \t_0, \zeta_0
  mulw \a_1_1, \t_1, \zeta_1
  srai \a_0_1, \a_0_1, 16
  srai \a_1_1, \a_1_1, 16
  addi \a_0_1, \a_0_1, 8
  addi \a_1_1, \a_1_1, 8
  mulh \a_0_1, \a_0_1, \q48
  mulh \a_1_1, \a_1_1, \q48
.endm

.macro gs_bfu_x8  a_0_0, a_0_1, a_1_0, a_1_1,  a_2_0, a_2_1, a_3_0, a_3_1,  a_4_0, a_4_1, a_5_0, a_5_1,  a_6_0, a_6_1, a_7_0, a_7_1,  zeta_0, zeta_1,  zeta_2, zeta_3,  zeta_4, zeta_5,  zeta_6, zeta_7,  q48, t_0, t_1, t_2, t_3
  sub \t_0, \a_0_0, \a_0_1
  sub \t_1, \a_1_0, \a_1_1
  add \a_0_0, \a_0_0, \a_0_1
  add \a_1_0, \a_1_0, \a_1_1
  mulw \a_0_1, \t_0, \zeta_0
  mulw \a_1_1, \t_1, \zeta_1
  sub \t_2, \a_2_0, \a_2_1
  sub \t_3, \a_3_0, \a_3_1
  add \a_2_0, \a_2_0, \a_2_1
  add \a_3_0, \a_3_0, \a_3_1
  mulw \a_2_1, \t_2, \zeta_2
  mulw \a_3_1, \t_3, \zeta_3
  srai \a_0_1, \a_0_1, 16
  srai \a_1_1, \a_1_1, 16
  addi \a_0_1, \a_0_1, 8
  addi \a_1_1, \a_1_1, 8
  mulh \a_0_1, \a_0_1, \q48
  mulh \a_1_1, \a_1_1, \q48
  srai \a_2_1, \a_2_1, 16
  srai \a_3_1, \a_3_1, 16
  addi \a_2_1, \a_2_1, 8
  addi \a_3_1, \a_3_1, 8
  mulh \a_2_1, \a_2_1, \q48
  mulh \a_3_1, \a_3_1, \q48
  sub \t_0, \a_4_0, \a_4_1
  sub \t_1, \a_5_0, \a_5_1
  add \a_4_0, \a_4_0, \a_4_1
  add \a_5_0, \a_5_0, \a_5_1
  mulw \a_4_1, \t_0, \zeta_4
  mulw \a_5_1, \t_1, \zeta_5
  sub \t_2, \a_6_0, \a_6_1
  sub \t_3, \a_7_0, \a_7_1
  add \a_6_0, \a_6_0, \a_6_1
  add \a_7_0, \a_7_0, \a_7_1
  mulw \a_6_1, \t_2, \zeta_6
  mulw \a_7_1, \t_3, \zeta_7
  srai \a_4_1, \a_4_1, 16
  srai \a_5_1, \a_5_1, 16
  addi \a_4_1, \a_4_1, 8
  addi \a_5_1, \a_5_1, 8
  mulh \a_4_1, \a_4_1, \q48
  mulh \a_5_1, \a_5_1, \q48
  srai \a_6_1, \a_6_1, 16
  srai \a_7_1, \a_7_1, 16
  addi \a_6_1, \a_6_1, 8
  addi \a_7_1, \a_7_1, 8
  mulh \a_6_1, \a_6_1, \q48
  mulh \a_7_1, \a_7_1, \q48
.endm

.macro gs_bfu_x8_load_4zetas  a_0_0, a_0_1, a_1_0, a_1_1,  a_2_0, a_2_1, a_3_0, a_3_1,  a_4_0, a_4_1, a_5_0, a_5_1,  a_6_0, a_6_1, a_7_0, a_7_1,  zeta_0, zeta_1,  zeta_2, zeta_3,  q48, t_0, t_1, t_2, t_3
  lw  \t_2, \zeta_0(a1)
  sub \t_0, \a_0_0, \a_0_1
  sub \t_1, \a_1_0, \a_1_1
  add \a_0_0, \a_0_0, \a_0_1
  add \a_1_0, \a_1_0, \a_1_1
  mulw \a_0_1, \t_0, \t_2
  mulw \a_1_1, \t_1, \t_2
  sub \t_0, \a_2_0, \a_2_1
  sub \t_3, \a_3_0, \a_3_1
  lw  \t_2, \zeta_1(a1)
  add \a_2_0, \a_2_0, \a_2_1
  add \a_3_0, \a_3_0, \a_3_1
  mulw \a_2_1, \t_0, \t_2
  mulw \a_3_1, \t_3, \t_2
  srai \a_0_1, \a_0_1, 16
  srai \a_1_1, \a_1_1, 16
  addi \a_0_1, \a_0_1, 8
  addi \a_1_1, \a_1_1, 8
  mulh \a_0_1, \a_0_1, \q48
  mulh \a_1_1, \a_1_1, \q48
  srai \a_2_1, \a_2_1, 16
  srai \a_3_1, \a_3_1, 16
  addi \a_2_1, \a_2_1, 8
  addi \a_3_1, \a_3_1, 8
  mulh \a_2_1, \a_2_1, \q48
  mulh \a_3_1, \a_3_1, \q48
  sub \t_0, \a_4_0, \a_4_1
  sub \t_1, \a_5_0, \a_5_1
  lw  \t_2, \zeta_2(a1)
  add \a_4_0, \a_4_0, \a_4_1
  add \a_5_0, \a_5_0, \a_5_1
  mulw \a_4_1, \t_0, \t_2
  mulw \a_5_1, \t_1, \t_2
  sub \t_0, \a_6_0, \a_6_1
  sub \t_3, \a_7_0, \a_7_1
  lw  \t_2, \zeta_3(a1)
  add \a_6_0, \a_6_0, \a_6_1
  add \a_7_0, \a_7_0, \a_7_1
  mulw \a_6_1, \t_0, \t_2
  mulw \a_7_1, \t_3, \t_2
  srai \a_4_1, \a_4_1, 16
  srai \a_5_1, \a_5_1, 16
  addi \a_4_1, \a_4_1, 8
  addi \a_5_1, \a_5_1, 8
  mulh \a_4_1, \a_4_1, \q48
  mulh \a_5_1, \a_5_1, \q48
  srai \a_6_1, \a_6_1, 16
  srai \a_7_1, \a_7_1, 16
  addi \a_6_1, \a_6_1, 8
  addi \a_7_1, \a_7_1, 8
  mulh \a_6_1, \a_6_1, \q48
  mulh \a_7_1, \a_7_1, \q48
.endm

.macro gs_bfu_x8_load_2zetas  a_0_0, a_0_1, a_1_0, a_1_1,  a_2_0, a_2_1, a_3_0, a_3_1,  a_4_0, a_4_1, a_5_0, a_5_1,  a_6_0, a_6_1, a_7_0, a_7_1,  zeta_0, zeta_1,  q48, t_0, t_1, t_2, t_3
  lw  \t_2, \zeta_0(a1)
  sub \t_0, \a_0_0, \a_0_1
  sub \t_1, \a_1_0, \a_1_1
  add \a_0_0, \a_0_0, \a_0_1
  add \a_1_0, \a_1_0, \a_1_1
  mulw \a_0_1, \t_0, \t_2
  mulw \a_1_1, \t_1, \t_2
  sub \t_0, \a_2_0, \a_2_1
  sub \t_3, \a_3_0, \a_3_1
  add \a_2_0, \a_2_0, \a_2_1
  add \a_3_0, \a_3_0, \a_3_1
  mulw \a_2_1, \t_0, \t_2
  mulw \a_3_1, \t_3, \t_2
  srai \a_0_1, \a_0_1, 16
  srai \a_1_1, \a_1_1, 16
  addi \a_0_1, \a_0_1, 8
  addi \a_1_1, \a_1_1, 8
  mulh \a_0_1, \a_0_1, \q48
  mulh \a_1_1, \a_1_1, \q48
  srai \a_2_1, \a_2_1, 16
  srai \a_3_1, \a_3_1, 16
  addi \a_2_1, \a_2_1, 8
  addi \a_3_1, \a_3_1, 8
  mulh \a_2_1, \a_2_1, \q48
  mulh \a_3_1, \a_3_1, \q48
  lw  \t_2, \zeta_1(a1)
  sub \t_0, \a_4_0, \a_4_1
  sub \t_1, \a_5_0, \a_5_1
  add \a_4_0, \a_4_0, \a_4_1
  add \a_5_0, \a_5_0, \a_5_1
  mulw \a_4_1, \t_0, \t_2
  mulw \a_5_1, \t_1, \t_2
  sub \t_0, \a_6_0, \a_6_1
  sub \t_3, \a_7_0, \a_7_1
  add \a_6_0, \a_6_0, \a_6_1
  add \a_7_0, \a_7_0, \a_7_1
  mulw \a_6_1, \t_0, \t_2
  mulw \a_7_1, \t_3, \t_2
  srai \a_4_1, \a_4_1, 16
  srai \a_5_1, \a_5_1, 16
  addi \a_4_1, \a_4_1, 8
  addi \a_5_1, \a_5_1, 8
  mulh \a_4_1, \a_4_1, \q48
  mulh \a_5_1, \a_5_1, \q48
  srai \a_6_1, \a_6_1, 16
  srai \a_7_1, \a_7_1, 16
  addi \a_6_1, \a_6_1, 8
  addi \a_7_1, \a_7_1, 8
  mulh \a_6_1, \a_6_1, \q48
  mulh \a_7_1, \a_7_1, \q48
.endm

.macro plant_mul_const_inplace_x8  q48, zeta,  a_0, a_1, a_2, a_3,  a_4, a_5, a_6, a_7
  mulw \a_0, \a_0, \zeta
  mulw \a_1, \a_1, \zeta
  mulw \a_2, \a_2, \zeta
  mulw \a_3, \a_3, \zeta
  srai \a_0, \a_0, 16
  srai \a_1, \a_1, 16
  addi \a_0, \a_0, 8
  addi \a_1, \a_1, 8
  mulh \a_0, \a_0, \q48
  mulh \a_1, \a_1, \q48
  srai \a_2, \a_2, 16
  srai \a_3, \a_3, 16
  mulw \a_4, \a_4, \zeta
  mulw \a_5, \a_5, \zeta
  addi \a_2, \a_2, 8
  addi \a_3, \a_3, 8
  mulh \a_2, \a_2, \q48
  mulh \a_3, \a_3, \q48
  srai \a_4, \a_4, 16
  srai \a_5, \a_5, 16
  mulw \a_6, \a_6, \zeta
  mulw \a_7, \a_7, \zeta
  addi \a_4, \a_4, 8
  addi \a_5, \a_5, 8
  mulh \a_4, \a_4, \q48
  mulh \a_5, \a_5, \q48
  srai \a_6, \a_6, 16
  addi \a_6, \a_6, 8
  mulh \a_6, \a_6, \q48
  srai \a_7, \a_7, 16
  addi \a_7, \a_7, 8
  mulh \a_7, \a_7, \q48
.endm

// in-place plantard reduction to a
// output \in (-0.5q, 0.5q); q48: q<<48
.macro plant_red q48, qinv, a
  mulw \a, \a, \qinv
  srai \a, \a, 16
  addi \a, \a, 8
  mulh \a, \a, \q48
.endm

.macro plant_red_x4  q48, qinv,   a_0, a_1, a_2, a_3
  mulw \a_0, \a_0, \qinv
  mulw \a_1, \a_1, \qinv
  mulw \a_2, \a_2, \qinv
  mulw \a_3, \a_3, \qinv
  srai \a_0, \a_0, 16
  srai \a_1, \a_1, 16
  srai \a_2, \a_2, 16
  srai \a_3, \a_3, 16
  addi \a_0, \a_0, 8
  addi \a_1, \a_1, 8
  addi \a_2, \a_2, 8
  addi \a_3, \a_3, 8
  mulh \a_0, \a_0, \q48
  mulh \a_1, \a_1, \q48
  mulh \a_2, \a_2, \q48
  mulh \a_3, \a_3, \q48
.endm

.equ q, 3329
.equ q48, 0xd01000000000000     // q<<48
.equ qinv, 0x6ba8f301           // q^-1 mod+- 2^32
.equ plantconst, 0x13afb8       // (-2^{32} mod q)*qinv mod 2^32
.equ plantconst2, 0x97f44fac    // (2^{64} mod q)*qinv mod 2^32

// void poly_basemul_acc_end_rv64im(int16_t *r, const int16_t *a, const int16_t *b, uint32_t *zetas, int32_t *r_double)
// compute basemul, accumulate the 32-bit results into r_double, and reduce r_double to r
// a0: r, a1: a, a2: b, a3: zetas, a4: r_double
.global poly_basemul_acc_end_rv64im_dual_opt_c908
.align 2
poly_basemul_acc_end_rv64im_dual_opt_c908:
    addi sp, sp, -8*16
    save_regs
    li a5, q48
    li a6, qinv
    li a7, 32
    sd a7, 8*15(sp)
                               // Instructions:    1
                               // Expected cycles: 1
                               // Expected IPC:    1.00
                               //
                               // Cycle bound:     1.0
                               // IPC bound:       1.00
                               //
                               // Wall time:     0.02s
                               // User time:     0.02s
                               //
                               // ----- cycle (expected) ------>
                               // 0                        25
                               // |------------------------|----
        lh x6, 2*3(x12)        // *.............................

                                // ------ cycle (expected) ------>
                                // 0                        25
                                // |------------------------|-----
        // lh x6, 2*3(x12)      // *..............................

        ld a7, 8*15(sp)
        addi a7, a7, -1
        sd a7, 8*15(sp)
poly_basemul_acc_end_rv64im_loop:
                                  // Instructions:    121
                                  // Expected cycles: 61
                                  // Expected IPC:    1.98
                                  //
                                  // Cycle bound:     61.0
                                  // IPC bound:       1.98
                                  //
                                  // Wall time:     301.32s
                                  // User time:     301.32s
                                  //
                                  // --------------------- cycle (expected) --------------------->
                                  // 0                        25                       50
                                  // |------------------------|------------------------|----------
        lw x8, 4*0(x13)           // *............................................................
        lw x7, 4*1(x13)           // .*...........................................................
        addi x13, x13, 4*2        // .*...........................................................
        lh x20, 2*5(x12)          // ..*..........................................................
        neg x18, x8               // ..*..........................................................
        lh x31, 2*2(x11)          // ...*.........................................................
        mulw x23, x6, x18         // ...*.........................................................
        neg x27, x7               // ....*........................................................
        lh x1, 2*2(x12)           // ....*........................................................
        lw x28, 4*3(x14)          // .....*.......................................................
        mulw x19, x20, x7         // .....*.......................................................
        srai x23, x23, 16         // ......*......................................................
        lh x4, 2*1(x12)           // ......*......................................................
        mul x26, x31, x1          // .......*.....................................................
        addi x23, x23, 8          // .......*.....................................................
        mulh x23, x23, x15        // ........*....................................................
        srai x18, x19, 16         // ........*....................................................
        lh x24, 2*3(x11)          // .........*...................................................
        addi x5, x18, 8           // .........*...................................................
        lw x22, 4*2(x14)          // ..........*..................................................
        mulh x19, x5, x15         // ..........*..................................................
        lh x25, 2*1(x11)          // ...........*.................................................
        mul x9, x31, x6           // ...........*.................................................
        mul x3, x24, x23          // ............*................................................
        lh x23, 2*7(x12)          // ............*................................................
        lh x6, 2*0(x12)           // .............*...............................................
        mulw x29, x4, x8          // .............*...............................................
        add x7, x22, x26          // ..............*..............................................
        lh x18, 2*0(x11)          // ..............*..............................................
        mulw x27, x23, x27        // ...............*.............................................
        lw x26, 4*0(x14)          // ...............*.............................................
        add x8, x7, x3            // ................*............................................
        srai x7, x29, 16          // ................*............................................
        mulw x3, x8, x16          // .................*...........................................
        addi x5, x7, 8            // .................*...........................................
        mulh x31, x5, x15         // ..................*..........................................
        mul x8, x18, x6           // ..................*..........................................
        mul x4, x18, x4           // ...................*.........................................
        lw x7, 4*1(x14)           // ...................*.........................................
        lh x21, 2*6(x11)          // ....................*........................................
        mul x5, x25, x6           // ....................*........................................
        srai x3, x3, 16           // .....................*.......................................
        mul x29, x24, x1          // .....................*.......................................
        add x18, x26, x8          // ......................*......................................
        mul x24, x25, x31         // ......................*......................................
        lh x1, 2*5(x11)           // .......................*.....................................
        srai x8, x27, 16          // .......................*.....................................
        add x6, x7, x4            // ........................*....................................
        addi x8, x8, 8            // ........................*....................................
        mulh x7, x8, x15          // .........................*...................................
        add x4, x28, x9           // .........................*...................................
        add x22, x4, x29          // ..........................*..................................
        add x9, x18, x24          // ..........................*..................................
        lh x28, 2*4(x12)          // ...........................*.................................
        mulw x9, x9, x16          // ...........................*.................................
        lh x30, 2*4(x11)          // ............................*................................
        add x24, x6, x5           // ............................*................................
        mulw x26, x24, x16        // .............................*...............................
        mulw x25, x22, x16        // .............................*...............................
        addi x3, x3, 8            // ..............................*..............................
        srai x8, x9, 16           // ..............................*..............................
        mulh x29, x3, x15         // ...............................*.............................
        addi x6, x8, 8            // ...............................*.............................
        srai x18, x26, 16         // ................................*............................
        mulh x31, x6, x15         // ................................*............................
        lw x24, 4*5(x14)          // .................................*...........................
        addi x27, x18, 8          // .................................*...........................
        mul x8, x30, x20          // ..................................*..........................
        srai x20, x25, 16         // ..................................*..........................
        mul x9, x30, x28          // ...................................*.........................
        addi x18, x20, 8          // ...................................*.........................
        lh x22, 2*7(x11)          // ....................................*........................
        mul x3, x1, x19           // ....................................*........................
        mulh x25, x18, x15        // .....................................*.......................
        lw x20, 4*4(x14)          // .....................................*.......................
        mulh x27, x27, x15        // ......................................*......................
        lh x30, 2*6(x12)          // ......................................*......................
        add x20, x20, x9          // .......................................*.....................
        mul x19, x1, x28          // .......................................*.....................
        mul x18, x21, x23         // ........................................*....................
        add x5, x20, x3           // ........................................*....................
        mul x3, x22, x7           // .........................................*...................
        mul x23, x21, x30         // .........................................*...................
        mul x22, x22, x30         // ..........................................*..................
        lw x20, 4*6(x14)          // ..........................................*..................
        add x8, x24, x8           // ...........................................*.................
        sh x27, 2*1(x10)          // ...........................................*.................
        add x4, x8, x19           // ............................................*................
        lw x7, 4*7(x14)           // ............................................*................
        add x6, x20, x23          // .............................................*...............
        mulw x23, x5, x16         // .............................................*...............
        add x8, x6, x3            // ..............................................*..............
        add x6, x7, x18           // ..............................................*..............
        add x20, x6, x22          // ...............................................*.............
        mulw x18, x8, x16         // ...............................................*.............
        mulw x30, x20, x16        // ................................................*............
        mulw x6, x4, x16          // ................................................*............
        sh x29, 2*2(x10)          // .................................................*...........
        srai x8, x23, 16          // .................................................*...........
        addi x20, x8, 8           // ..................................................*..........
        srai x4, x18, 16          // ..................................................*..........
        srai x1, x6, 16           // ...................................................*.........
        srai x21, x30, 16         // ...................................................*.........
        mulh x30, x20, x15        // ....................................................*........
        addi x20, x1, 8           // ....................................................*........
        addi x22, x4, 8           // .....................................................*.......
        mulh x1, x20, x15         // .....................................................*.......
        sh x31, 2*0(x10)          // ......................................................*......
        mulh x19, x22, x15        // ......................................................*......
        sh x25, 2*3(x10)          // .......................................................*.....
        addi x4, x21, 8           // .......................................................*.....
        sh x30, 2*4(x10)          // ........................................................*....
        mulh x4, x4, x15          // ........................................................*....
        sh x1, 2*5(x10)           // .........................................................*...
        addi x11, x11, 2*8        // .........................................................*...
        addi x12, x12, 2*8        // ..........................................................*..
        sh x19, 2*6(x10)          // ..........................................................*..
        lh x6, 2*3(x12)           // ...........................................................e.
        addi x14, x14, 4*8        // ...........................................................*.
        sh x4, 2*7(x10)           // ............................................................*
        addi x10, x10, 2*8        // ............................................................*

                                   // ---------------------- cycle (expected) ---------------------->
                                   // 0                        25                       50
                                   // |------------------------|------------------------|------------
        // lh x8, 2*0(x12)         // ..'............*...............................................
        // lh x9, 2*1(x12)         // ..'.....*......................................................
        // lh x19, 2*3(x12)        // e.'..........................................................~.
        // lh x21, 2*5(x12)        // ..'.*..........................................................
        // lh x23, 2*7(x12)        // ..'...........*................................................
        // lw  x17, 4*0(x13)       // ..*............................................................
        // lw  x4, 4*1(x13)        // ..'*...........................................................
        // lh  x5, 2*0(x11)        // ..'.............*..............................................
        // lh  x6, 2*1(x11)        // ..'..........*.................................................
        // neg x3, x17             // ..'.*..........................................................
        // neg x1, x4              // ..'...*........................................................
        // mulw x7, x9, x17        // ..'............*...............................................
        // mulw x28, x19, x3       // ..'..*.........................................................
        // mulw x29, x21, x4       // ..'....*.......................................................
        // mulw x30, x23, x1       // ..'..............*.............................................
        // srai x7, x7, 16         // ..'...............*............................................
        // srai x28, x28, 16       // ..'.....*......................................................
        // srai x29, x29, 16       // ..'.......*....................................................
        // srai x30, x30, 16       // ..'......................*.....................................
        // addi x7, x7, 8          // ..'................*...........................................
        // addi x28, x28, 8        // ..'......*.....................................................
        // addi x29, x29, 8        // ..'........*...................................................
        // addi x30, x30, 8        // ..'.......................*....................................
        // mulh x7, x7, x15        // ..'.................*..........................................
        // mulh x28, x28, x15      // ..'.......*....................................................
        // mulh x29, x29, x15      // ..'.........*..................................................
        // mulh x30, x30, x15      // ..'........................*...................................
        // lw  x24, 4*0(x14)       // ..'..............*.............................................
        // lw  x25, 4*1(x14)       // ..'..................*.........................................
        // mul x18, x5, x8         // ..'.................*..........................................
        // mul x20, x6, x7         // ..'.....................*......................................
        // mul x22, x5, x9         // ..'..................*.........................................
        // mul x31, x6, x8         // ..'...................*........................................
        // lh  x5, 2*2(x11)        // ..'..*.........................................................
        // lh  x6, 2*3(x11)        // ..'........*...................................................
        // add x24, x24, x18       // ..'.....................*......................................
        // add x24, x24, x20       // ..'.........................*..................................
        // lh  x18, 2*2(x12)       // ..'...*........................................................
        // add x25, x25, x22       // ..'.......................*....................................
        // add x25, x25, x31       // ..'...........................*................................
        // lw  x26,4*2(x14)        // ..'.........*..................................................
        // lw  x27,4*3(x14)        // ..'....*.......................................................
        // mul x8, x5, x18         // ..'......*.....................................................
        // mul x9, x6, x28         // ..'...........*................................................
        // mul x17, x5, x19        // ..'..........*.................................................
        // mul x31, x6, x18        // ..'....................*.......................................
        // lh  x7, 2*4(x11)        // ..'...........................*................................
        // lh  x4, 2*5(x11)        // ..'......................*.....................................
        // lh  x20, 2*4(x12)       // ..'..........................*.................................
        // add x26, x26, x8        // ..'.............*..............................................
        // add x26, x26, x9        // ..'...............*............................................
        // add x27, x27, x17       // ..'........................*...................................
        // add x27, x27, x31       // ..'.........................*..................................
        // mulw x24, x24, x16      // ..'..........................*.................................
        // mulw x25, x25, x16      // ..'............................*...............................
        // mulw x26, x26, x16      // ..'................*...........................................
        // mulw x27, x27, x16      // ..'............................*...............................
        // srai x24, x24, 16       // ..'.............................*..............................
        // srai x25, x25, 16       // ..'...............................*............................
        // srai x26, x26, 16       // ..'....................*.......................................
        // srai x27, x27, 16       // ..'.................................*..........................
        // addi x24, x24, 8        // ..'..............................*.............................
        // addi x25, x25, 8        // ..'................................*...........................
        // addi x26, x26, 8        // ..'.............................*..............................
        // addi x27, x27, 8        // ..'..................................*.........................
        // mulh x24, x24, x15      // ..'...............................*............................
        // mulh x25, x25, x15      // ..'.....................................*......................
        // mulh x26, x26, x15      // ..'..............................*.............................
        // mulh x27, x27, x15      // ..'....................................*.......................
        // sh  x24, 2*0(x10)       // ..'.....................................................*......
        // sh  x25, 2*1(x10)       // ..'..........................................*.................
        // sh  x26,2*2(x10)        // ..'................................................*...........
        // sh  x27,2*3(x10)        // ..'......................................................*.....
        // mul x8, x7, x20         // ..'..................................*.........................
        // mul x9, x4, x29         // ..'...................................*........................
        // lw  x24, 4*4(x14)       // ..'....................................*.......................
        // lw  x25, 4*5(x14)       // ..'................................*...........................
        // mul x5, x7, x21         // ..'.................................*..........................
        // mul x6, x4, x20         // ..'......................................*.....................
        // lh  x22, 2*6(x12)       // ..'.....................................*......................
        // lh  x3, 2*6(x11)        // ..'...................*........................................
        // lh  x1, 2*7(x11)        // ..'...................................*........................
        // add x24, x24, x8        // ..'......................................*.....................
        // add x24, x24, x9        // ..'.......................................*....................
        // lw  x26,4*6(x14)        // ..'.........................................*..................
        // lw  x27,4*7(x14)        // ..'...........................................*................
        // add x25, x25, x5        // ..'..........................................*.................
        // add x25, x25, x6        // ..'...........................................*................
        // mul x8, x3, x22         // ..'........................................*...................
        // mul x9, x1, x30         // ..'........................................*...................
        // mul x5, x3, x23         // ..'.......................................*....................
        // mul x6, x1, x22         // ..'.........................................*..................
        // add x26, x26, x8        // ..'............................................*...............
        // add x26, x26, x9        // ..'.............................................*..............
        // add x27, x27, x5        // ..'.............................................*..............
        // add x27, x27, x6        // ..'..............................................*.............
        // mulw x24, x24, x16      // ..'............................................*...............
        // mulw x25, x25, x16      // ..'...............................................*............
        // mulw x26, x26, x16      // ..'..............................................*.............
        // mulw x27, x27, x16      // ..'...............................................*............
        // srai x24, x24, 16       // ..'................................................*...........
        // srai x25, x25, 16       // ..'..................................................*.........
        // srai x26, x26, 16       // ..'.................................................*..........
        // srai x27, x27, 16       // ..'..................................................*.........
        // addi x24, x24, 8        // ..'.................................................*..........
        // addi x25, x25, 8        // ..'...................................................*........
        // addi x26, x26, 8        // ..'....................................................*.......
        // addi x27, x27, 8        // ..'......................................................*.....
        // mulh x24, x24, x15      // ..'...................................................*........
        // mulh x25, x25, x15      // ..'....................................................*.......
        // mulh x26, x26, x15      // ..'.....................................................*......
        // mulh x27, x27, x15      // ..'.......................................................*....
        // sh  x24, 2*4(x10)       // ..'.......................................................*....
        // sh  x25, 2*5(x10)       // ..'........................................................*...
        // sh  x26,2*6(x10)        // ..'.........................................................*..
        // sh  x27,2*7(x10)        // .~'...........................................................*
        // addi x10, x10, 2*8      // .~'...........................................................*
        // addi x11, x11, 2*8      // ..'........................................................*...
        // addi x12, x12, 2*8      // ..'.........................................................*..
        // addi x13, x13, 4*2      // ..'*...........................................................
        // addi x14, x14, 4*8      // ~.'..........................................................*.

        ld a7, 8*15(sp)
        addi a7, a7, -1
        sd a7, 8*15(sp)
        bne a7, zero, poly_basemul_acc_end_rv64im_loop
                                  // Instructions:    120
                                  // Expected cycles: 61
                                  // Expected IPC:    1.97
                                  //
                                  // Cycle bound:     61.0
                                  // IPC bound:       1.97
                                  //
                                  // Wall time:     26.29s
                                  // User time:     26.29s
                                  //
                                  // --------------------- cycle (expected) --------------------->
                                  // 0                        25                       50
                                  // |------------------------|------------------------|----------
        lw x22, 4*0(x13)          // *............................................................
        lw x4, 4*1(x13)           // .*...........................................................
        lh x23, 2*5(x12)          // ..*..........................................................
        neg x20, x22              // ..*..........................................................
        mulw x20, x6, x20         // ...*.........................................................
        lh x8, 2*2(x11)           // ...*.........................................................
        neg x18, x4               // ....*........................................................
        lh x19, 2*2(x12)          // ....*........................................................
        mulw x4, x23, x4          // .....*.......................................................
        lw x25, 4*3(x14)          // .....*.......................................................
        srai x7, x20, 16          // ......*......................................................
        lh x20, 2*1(x12)          // ......*......................................................
        addi x1, x7, 8            // .......*.....................................................
        lh x28, 2*3(x11)          // .......*.....................................................
        mulh x1, x1, x15          // ........*....................................................
        lw x24, 4*2(x14)          // ........*....................................................
        srai x26, x4, 16          // .........*...................................................
        lh x9, 2*1(x11)           // .........*...................................................
        addi x26, x26, 8          // ..........*..................................................
        lh x7, 2*7(x12)           // ..........*..................................................
        lh x31, 2*0(x12)          // ...........*.................................................
        mul x29, x8, x19          // ...........*.................................................
        lh x4, 2*0(x11)           // ............*................................................
        mul x30, x28, x1          // ............*................................................
        mul x21, x8, x6           // .............*...............................................
        lw x27, 4*0(x14)          // .............*...............................................
        lw x8, 4*1(x14)           // ..............*..............................................
        mulh x26, x26, x15        // ..............*..............................................
        lh x3, 2*6(x11)           // ...............*.............................................
        mulw x5, x20, x22         // ...............*.............................................
        lh x6, 2*5(x11)           // ................*............................................
        add x24, x24, x29         // ................*............................................
        mulw x1, x7, x18          // .................*...........................................
        add x22, x24, x30         // .................*...........................................
        addi x13, x13, 4*2        // ..................*..........................................
        srai x5, x5, 16           // ..................*..........................................
        mulw x22, x22, x16        // ...................*.........................................
        addi x24, x5, 8           // ...................*.........................................
        mulh x29, x24, x15        // ....................*........................................
        mul x24, x4, x31          // ....................*........................................
        mul x20, x4, x20          // .....................*.......................................
        lh x18, 2*4(x12)          // .....................*.......................................
        mul x30, x28, x19         // ......................*......................................
        mul x19, x9, x31          // ......................*......................................
        srai x4, x22, 16          // .......................*.....................................
        lh x28, 2*4(x11)          // .......................*.....................................
        mul x29, x9, x29          // ........................*....................................
        add x9, x27, x24          // ........................*....................................
        lw x22, 4*5(x14)          // .........................*...................................
        srai x5, x1, 16           // .........................*...................................
        addi x31, x5, 8           // ..........................*..................................
        add x8, x8, x20           // ..........................*..................................
        add x27, x25, x21         // ...........................*.................................
        mulh x5, x31, x15         // ...........................*.................................
        add x9, x9, x29           // ............................*................................
        add x31, x27, x30         // ............................*................................
        mulw x21, x9, x16         // .............................*...............................
        addi x4, x4, 8            // .............................*...............................
        add x20, x8, x19          // ..............................*..............................
        mulh x25, x4, x15         // ..............................*..............................
        mulw x24, x31, x16        // ...............................*.............................
        mulw x20, x20, x16        // ...............................*.............................
        mul x8, x28, x18          // ................................*............................
        srai x4, x21, 16          // ................................*............................
        addi x4, x4, 8            // .................................*...........................
        lh x21, 2*7(x11)          // .................................*...........................
        mulh x29, x4, x15         // ..................................*..........................
        srai x4, x20, 16          // ..................................*..........................
        addi x27, x4, 8           // ...................................*.........................
        lw x19, 4*7(x14)          // ...................................*.........................
        srai x4, x24, 16          // ....................................*........................
        mul x28, x28, x23         // ....................................*........................
        addi x20, x4, 8           // .....................................*.......................
        lw x23, 4*4(x14)          // .....................................*.......................
        mul x30, x6, x26          // ......................................*......................
        mulh x1, x20, x15         // ......................................*......................
        mulh x24, x27, x15        // .......................................*.....................
        lh x4, 2*6(x12)           // .......................................*.....................
        add x20, x23, x8          // ........................................*....................
        mul x31, x6, x18          // ........................................*....................
        sh x25, 2*2(x10)          // .........................................*...................
        mul x27, x3, x7           // .........................................*...................
        mul x8, x21, x5           // ..........................................*..................
        add x30, x20, x30         // ..........................................*..................
        mulw x23, x30, x16        // ...........................................*.................
        mul x26, x3, x4           // ...........................................*.................
        mul x20, x21, x4          // ............................................*................
        sh x1, 2*3(x10)           // ............................................*................
        add x4, x19, x27          // .............................................*...............
        lw x21, 4*6(x14)          // .............................................*...............
        add x9, x22, x28          // ..............................................*..............
        srai x28, x23, 16         // ..............................................*..............
        addi x5, x28, 8           // ...............................................*.............
        add x23, x21, x26         // ...............................................*.............
        add x28, x23, x8          // ................................................*............
        add x19, x9, x31          // ................................................*............
        mulw x18, x28, x16        // .................................................*...........
        mulw x3, x19, x16         // .................................................*...........
        add x1, x4, x20           // ..................................................*..........
        sh x24, 2*1(x10)          // ..................................................*..........
        mulh x30, x5, x15         // ...................................................*.........
        mulw x26, x1, x16         // ...................................................*.........
        srai x22, x18, 16         // ....................................................*........
        srai x6, x3, 16           // ....................................................*........
        addi x6, x6, 8            // .....................................................*.......
        addi x22, x22, 8          // .....................................................*.......
        srai x31, x26, 16         // ......................................................*......
        mulh x22, x22, x15        // ......................................................*......
        mulh x3, x6, x15          // .......................................................*.....
        addi x6, x31, 8           // .......................................................*.....
        mulh x6, x6, x15          // ........................................................*....
        sh x30, 2*4(x10)          // ........................................................*....
        addi x12, x12, 2*8        // .........................................................*...
        sh x29, 2*0(x10)          // .........................................................*...
        sh x22, 2*6(x10)          // ..........................................................*..
        addi x14, x14, 4*8        // ..........................................................*..
        sh x3, 2*5(x10)           // ...........................................................*.
        addi x11, x11, 2*8        // ...........................................................*.
        sh x6, 2*7(x10)           // ............................................................*
        addi x10, x10, 2*8        // ............................................................*

                                   // --------------------- cycle (expected) --------------------->
                                   // 0                        25                       50
                                   // |------------------------|------------------------|----------
        // lw x8, 4*0(x13)         // *............................................................
        // lw x7, 4*1(x13)         // .*...........................................................
        // addi x13, x13, 4*2      // ..................*..........................................
        // lh x20, 2*5(x12)        // ..*..........................................................
        // neg x18, x8             // ..*..........................................................
        // lh x31, 2*2(x11)        // ...*.........................................................
        // mulw x23, x6, x18       // ...*.........................................................
        // neg x27, x7             // ....*........................................................
        // lh x1, 2*2(x12)         // ....*........................................................
        // lw x28, 4*3(x14)        // .....*.......................................................
        // mulw x19, x20, x7       // .....*.......................................................
        // srai x23, x23, 16       // ......*......................................................
        // lh x4, 2*1(x12)         // ......*......................................................
        // mul x26, x31, x1        // ...........*.................................................
        // addi x23, x23, 8        // .......*.....................................................
        // mulh x23, x23, x15      // ........*....................................................
        // srai x18, x19, 16       // .........*...................................................
        // lh x24, 2*3(x11)        // .......*.....................................................
        // addi x5, x18, 8         // ..........*..................................................
        // lw x22, 4*2(x14)        // ........*....................................................
        // mulh x19, x5, x15       // ..............*..............................................
        // lh x25, 2*1(x11)        // .........*...................................................
        // mul x9, x31, x6         // .............*...............................................
        // mul x3, x24, x23        // ............*................................................
        // lh x23, 2*7(x12)        // ..........*..................................................
        // lh x6, 2*0(x12)         // ...........*.................................................
        // mulw x29, x4, x8        // ...............*.............................................
        // add x7, x22, x26        // ................*............................................
        // lh x18, 2*0(x11)        // ............*................................................
        // mulw x27, x23, x27      // .................*...........................................
        // lw x26, 4*0(x14)        // .............*...............................................
        // add x8, x7, x3          // .................*...........................................
        // srai x7, x29, 16        // ..................*..........................................
        // mulw x3, x8, x16        // ...................*.........................................
        // addi x5, x7, 8          // ...................*.........................................
        // mulh x31, x5, x15       // ....................*........................................
        // mul x8, x18, x6         // ....................*........................................
        // mul x4, x18, x4         // .....................*.......................................
        // lw x7, 4*1(x14)         // ..............*..............................................
        // lh x21, 2*6(x11)        // ...............*.............................................
        // mul x5, x25, x6         // ......................*......................................
        // srai x3, x3, 16         // .......................*.....................................
        // mul x29, x24, x1        // ......................*......................................
        // add x18, x26, x8        // ........................*....................................
        // mul x24, x25, x31       // ........................*....................................
        // lh x1, 2*5(x11)         // ................*............................................
        // srai x8, x27, 16        // .........................*...................................
        // add x6, x7, x4          // ..........................*..................................
        // addi x8, x8, 8          // ..........................*..................................
        // mulh x7, x8, x15        // ...........................*.................................
        // add x4, x28, x9         // ...........................*.................................
        // add x22, x4, x29        // ............................*................................
        // add x9, x18, x24        // ............................*................................
        // lh x28, 2*4(x12)        // .....................*.......................................
        // mulw x9, x9, x16        // .............................*...............................
        // lh x30, 2*4(x11)        // .......................*.....................................
        // add x24, x6, x5         // ..............................*..............................
        // mulw x26, x24, x16      // ...............................*.............................
        // mulw x25, x22, x16      // ...............................*.............................
        // addi x3, x3, 8          // .............................*...............................
        // srai x8, x9, 16         // ................................*............................
        // mulh x29, x3, x15       // ..............................*..............................
        // addi x6, x8, 8          // .................................*...........................
        // srai x18, x26, 16       // ..................................*..........................
        // mulh x31, x6, x15       // ..................................*..........................
        // lw x24, 4*5(x14)        // .........................*...................................
        // addi x27, x18, 8        // ...................................*.........................
        // mul x8, x30, x20        // ....................................*........................
        // srai x20, x25, 16       // ....................................*........................
        // mul x9, x30, x28        // ................................*............................
        // addi x18, x20, 8        // .....................................*.......................
        // lh x22, 2*7(x11)        // .................................*...........................
        // mul x3, x1, x19         // ......................................*......................
        // mulh x25, x18, x15      // ......................................*......................
        // lw x20, 4*4(x14)        // .....................................*.......................
        // mulh x27, x27, x15      // .......................................*.....................
        // lh x30, 2*6(x12)        // .......................................*.....................
        // add x20, x20, x9        // ........................................*....................
        // mul x19, x1, x28        // ........................................*....................
        // mul x18, x21, x23       // .........................................*...................
        // add x5, x20, x3         // ..........................................*..................
        // mul x3, x22, x7         // ..........................................*..................
        // mul x23, x21, x30       // ...........................................*.................
        // mul x22, x22, x30       // ............................................*................
        // lw x20, 4*6(x14)        // .............................................*...............
        // add x8, x24, x8         // ..............................................*..............
        // sh x27, 2*1(x10)        // ..................................................*..........
        // add x4, x8, x19         // ................................................*............
        // lw x7, 4*7(x14)         // ...................................*.........................
        // add x6, x20, x23        // ...............................................*.............
        // mulw x23, x5, x16       // ...........................................*.................
        // add x8, x6, x3          // ................................................*............
        // add x6, x7, x18         // .............................................*...............
        // add x20, x6, x22        // ..................................................*..........
        // mulw x18, x8, x16       // .................................................*...........
        // mulw x30, x20, x16      // ...................................................*.........
        // mulw x6, x4, x16        // .................................................*...........
        // sh x29, 2*2(x10)        // .........................................*...................
        // srai x8, x23, 16        // ..............................................*..............
        // addi x20, x8, 8         // ...............................................*.............
        // srai x4, x18, 16        // ....................................................*........
        // srai x1, x6, 16         // ....................................................*........
        // srai x21, x30, 16       // ......................................................*......
        // mulh x30, x20, x15      // ...................................................*.........
        // addi x20, x1, 8         // .....................................................*.......
        // addi x22, x4, 8         // .....................................................*.......
        // mulh x1, x20, x15       // .......................................................*.....
        // sh x31, 2*0(x10)        // .........................................................*...
        // mulh x19, x22, x15      // ......................................................*......
        // sh x25, 2*3(x10)        // ............................................*................
        // addi x4, x21, 8         // .......................................................*.....
        // sh x30, 2*4(x10)        // ........................................................*....
        // mulh x4, x4, x15        // ........................................................*....
        // sh x1, 2*5(x10)         // ...........................................................*.
        // addi x11, x11, 2*8      // ...........................................................*.
        // addi x12, x12, 2*8      // .........................................................*...
        // sh x19, 2*6(x10)        // ..........................................................*..
        // addi x14, x14, 4*8      // ..........................................................*..
        // sh x4, 2*7(x10)         // ............................................................*
        // addi x10, x10, 2*8      // ............................................................*

    restore_regs
    addi sp, sp, 8*16
ret