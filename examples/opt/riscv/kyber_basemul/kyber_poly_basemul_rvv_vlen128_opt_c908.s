.macro montmul_x4 vr0, vr1, vr2, vr3,  va0, va1, va2, va3,  vb0, vb1, vb2, vb3,  xq, xqinv, vt0, vt1, vt2, vt3
    vmul.vv  \vr0, \va0, \vb0
    vmul.vv  \vr1, \va1, \vb1
    vmul.vv  \vr2, \va2, \vb2
    vmul.vv  \vr3, \va3, \vb3
    vmul.vx  \vr0, \vr0, \xqinv
    vmul.vx  \vr1, \vr1, \xqinv
    vmul.vx  \vr2, \vr2, \xqinv
    vmul.vx  \vr3, \vr3, \xqinv
    vmulh.vv \vt0, \va0, \vb0
    vmulh.vv \vt1, \va1, \vb1
    vmulh.vv \vt2, \va2, \vb2
    vmulh.vv \vt3, \va3, \vb3
    vmulh.vx \vr0, \vr0, \xq
    vmulh.vx \vr1, \vr1, \xq
    vmulh.vx \vr2, \vr2, \xq
    vmulh.vx \vr3, \vr3, \xq
    vsub.vv  \vr0, \vt0, \vr0
    vsub.vv  \vr1, \vt1, \vr1
    vsub.vv  \vr2, \vt2, \vr2
    vsub.vv  \vr3, \vt3, \vr3
.endm

// void poly_basemul_rvv_vlen128(int16_t *r, const int16_t *a, const int16_t *b, const int16_t *table);
// (a0b0 + b1 * (a1zeta mod q)) mod q + ((a0b1 + a1b0) mod q)x
.globl poly_basemul_rvv_vlen128_opt_c908
.align 2
poly_basemul_rvv_vlen128_opt_c908:
    li a7, 32
    li t3, _ZETAS_BASEMUL*2
    vsetvli a7, a7, e16, m1, tu, mu
    li t0, 3329
    li t1, -3327
    slli t5, a7, 3
    slli a6, a7, 2
    slli a7, a7, 1
    add  a3, a3, t3
    add  t3, a6, a7
    addi t2, a1, 256*2
poly_basemul_rvv_vlen128_loop:
        start:
                                      // Instructions:    84
                                      // Expected cycles: 68
                                      // Expected IPC:    1.24
                                      //
                                      // Cycle bound:     68.0
                                      // IPC bound:       1.24
                                      //
                                      // Wall time:     45.89s
                                      // User time:     45.89s
                                      //
                                      // ------------------------ cycle (expected) ------------------------->
                                      // 0                        25                       50
                                      // |------------------------|------------------------|-----------------
        vle16.v v17, (x11)            // *...................................................................
        add x14, x12, x17             // *...................................................................
        add x11, x11, x17             // .*..................................................................
        add x4, x14, x17              // .*..................................................................
        vle16.v v11, (x14)            // ..*.................................................................
        add x9, x4, x17               // ..*.................................................................
        add x21, x9, x17              // ...*................................................................
        add x7, x11, x17              // ...*................................................................
        vle16.v v13, (x21)            // ....*...............................................................
        add x1, x7, x17               // ....*...............................................................
        add x24, x1, x17              // .....*..............................................................
        vmul.vv v26, v17, v11         // .....*..............................................................
        vle16.v v0, (x24)             // ......*.............................................................
        add x8, x10, x17              // ......*.............................................................
        vmulh.vv v10, v17, v11        // .......*............................................................
        add x18, x24, x17             // .......*............................................................
        add x13, x10, x28             // ........*...........................................................
        vle16.v v25, (x18)            // ........*...........................................................
        vmul.vx v2, v26, x6           // .........*..........................................................
        add x29, x13, x30             // .........*..........................................................
        vle16.v v18, (x12)            // ..........*.........................................................
        add x14, x18, x17             // ..........*.........................................................
        vmulh.vv v27, v25, v13        // ...........*........................................................
        add x18, x14, x17             // ...........*........................................................
        vle16.v v17, (x11)            // ............*.......................................................
        add x23, x8, x30              // ............*.......................................................
        vmul.vv v23, v25, v13         // .............*......................................................
        add x11, x18, x17             // .............*......................................................
        vle16.v v12, (x18)            // ..............*.....................................................
        add x26, x21, x17             // ..............*.....................................................
        vmul.vv v4, v17, v18          // ...............*....................................................
        add x19, x26, x17             // ...............*....................................................
        vle16.v v20, (x19)            // ................*...................................................
        add x15, x19, x17             // ................*...................................................
        vmulh.vv v25, v17, v18        // .................*..................................................
        add x12, x15, x17             // .................*..................................................
        vle16.v v13, (x15)            // ..................*.................................................
        vmul.vv v30, v12, v20         // ...................*................................................
        vle16.v v31, (x14)            // ....................*...............................................
        vmulh.vv v24, v12, v20        // .....................*..............................................
        vle16.v v16, (x1)             // ......................*.............................................
        vmul.vv v7, v31, v13          // .......................*............................................
        vmulh.vv v22, v31, v13        // ........................*...........................................
        vmul.vx v28, v30, x6          // .........................*..........................................
        vle16.v v31, (x7)             // ..........................*.........................................
        vmul.vx v26, v7, x6           // ...........................*........................................
        vle16.v v13, (x9)             // ............................*.......................................
        vmul.vx v19, v4, x6           // .............................*......................................
        vmulh.vx v28, v28, x5         // ..............................*.....................................
        vmulh.vx v3, v26, x5          // ...............................*....................................
        vle16.v v14, (x4)             // ................................*...................................
        vmul.vv v21, v31, v13         // .................................*..................................
        vsub.vv v24, v24, v28         // ..................................*.................................
        vsub.vv v30, v22, v3          // ...................................*................................
        vmul.vx v26, v23, x6          // ....................................*...............................
        vmul.vv v7, v16, v14          // .....................................*..............................
        vmulh.vx v2, v2, x5           // ......................................*.............................
        vadd.vv v1, v30, v24          // .......................................*............................
        vmulh.vx v29, v26, x5         // ........................................*...........................
        vmul.vx v9, v21, x6           // .........................................*..........................
        vle16.v v20, (x26)            // ..........................................*.........................
        vmul.vx v5, v7, x6            // ...........................................*........................
        vmulh.vv v16, v16, v14        // ............................................*.......................
        vmulh.vv v28, v31, v13        // .............................................*......................
        vmulh.vx v24, v9, x5          // ..............................................*.....................
        vmul.vv v30, v0, v20          // ...............................................*....................
        vmulh.vx v3, v5, x5           // ................................................*...................
        vsub.vv v14, v10, v2          // .................................................*..................
        vsub.vv v21, v28, v24         // ..................................................*.................
        vmul.vx v24, v30, x6          // ...................................................*................
        vsub.vv v16, v16, v3          // ....................................................*...............
        vmulh.vx v6, v19, x5          // .....................................................*..............
        vmulh.vv v0, v0, v20          // ......................................................*.............
        vmulh.vx v8, v24, x5          // .......................................................*............
        vadd.vv v31, v21, v16         // ........................................................*...........
        vsub.vv v10, v25, v6          // .........................................................*..........
        vsub.vv v28, v27, v29         // ..........................................................*.........
        vsub.vv v18, v0, v8           // ...........................................................*........
        vse16.v v31, (x13)            // ............................................................*.......
        vadd.vv v16, v14, v10         // .............................................................*......
        vse16.v v1, (x29)             // ..............................................................*.....
        vadd.vv v2, v18, v28          // ...............................................................*....
        vse16.v v16, (x8)             // .................................................................*..
        vse16.v v2, (x23)             // ...................................................................*

                                       // ------------------------ cycle (expected) ------------------------->
                                       // 0                        25                       50
                                       // |------------------------|------------------------|-----------------
        // vle16.v v0, (x11)           // *...................................................................
        // vle16.v v8,  (x12)          // ..........*.........................................................
        // add x11, x11, x17           // .*..................................................................
        // add x12, x12, x17           // *...................................................................
        // vle16.v v4, (x11)           // ............*.......................................................
        // vle16.v v12, (x12)          // ..*.................................................................
        // add x11, x11, x17           // ...*................................................................
        // add x12, x12, x17           // .*..................................................................
        // vle16.v v1, (x11)           // ..........................*.........................................
        // vle16.v v9,  (x12)          // ................................*...................................
        // add x11, x11, x17           // ....*...............................................................
        // add x12, x12, x17           // ..*.................................................................
        // vle16.v v5, (x11)           // ......................*.............................................
        // vle16.v v13, (x12)          // ............................*.......................................
        // add x11, x11, x17           // .....*..............................................................
        // add x12, x12, x17           // ...*................................................................
        // vle16.v v2, (x11)           // ......*.............................................................
        // vle16.v v10, (x12)          // ....*...............................................................
        // add x11, x11, x17           // .......*............................................................
        // add x12, x12, x17           // ..............*.....................................................
        // vle16.v v6, (x11)           // ........*...........................................................
        // vle16.v v14, (x12)          // ..........................................*.........................
        // add x11, x11, x17           // ..........*.........................................................
        // add x12, x12, x17           // ...............*....................................................
        // vle16.v v3, (x11)           // ....................*...............................................
        // vle16.v v11, (x12)          // ................*...................................................
        // add x11, x11, x17           // ...........*........................................................
        // add x12, x12, x17           // ................*...................................................
        // vle16.v v7, (x11)           // ..............*.....................................................
        // vle16.v v15, (x12)          // ..................*.................................................
        // add x11, x11, x17           // .............*......................................................
        // add x12, x12, x17           // .................*..................................................
        // vmul.vv  v16, v0, v12       // .....*..............................................................
        // vmul.vv  v17, v1, v13       // .................................*..................................
        // vmul.vv  v18, v2, v14       // ...............................................*....................
        // vmul.vv  v19, v3, v15       // .......................*............................................
        // vmul.vx  v16, v16, x6       // .........*..........................................................
        // vmul.vx  v17, v17, x6       // .........................................*..........................
        // vmul.vx  v18, v18, x6       // ...................................................*................
        // vmul.vx  v19, v19, x6       // ...........................*........................................
        // vmulh.vv v24, v0, v12       // .......*............................................................
        // vmulh.vv v25, v1, v13       // .............................................*......................
        // vmulh.vv v26, v2, v14       // ......................................................*.............
        // vmulh.vv v27, v3, v15       // ........................*...........................................
        // vmulh.vx v16, v16, x5       // ......................................*.............................
        // vmulh.vx v17, v17, x5       // ..............................................*.....................
        // vmulh.vx v18, v18, x5       // .......................................................*............
        // vmulh.vx v19, v19, x5       // ...............................*....................................
        // vsub.vv  v16, v24, v16      // .................................................*..................
        // vsub.vv  v17, v25, v17      // ..................................................*.................
        // vsub.vv  v18, v26, v18      // ...........................................................*........
        // vsub.vv  v19, v27, v19      // ...................................*................................
        // vmul.vv  v20, v4, v8        // ...............*....................................................
        // vmul.vv  v21, v5, v9        // .....................................*..............................
        // vmul.vv  v22, v6, v10       // .............*......................................................
        // vmul.vv  v23, v7, v11       // ...................*................................................
        // vmul.vx  v20, v20, x6       // .............................*......................................
        // vmul.vx  v21, v21, x6       // ...........................................*........................
        // vmul.vx  v22, v22, x6       // ....................................*...............................
        // vmul.vx  v23, v23, x6       // .........................*..........................................
        // vmulh.vv v24, v4, v8        // .................*..................................................
        // vmulh.vv v25, v5, v9        // ............................................*.......................
        // vmulh.vv v26, v6, v10       // ...........*........................................................
        // vmulh.vv v27, v7, v11       // .....................*..............................................
        // vmulh.vx v20, v20, x5       // .....................................................*..............
        // vmulh.vx v21, v21, x5       // ................................................*...................
        // vmulh.vx v22, v22, x5       // ........................................*...........................
        // vmulh.vx v23, v23, x5       // ..............................*.....................................
        // vsub.vv  v20, v24, v20      // .........................................................*..........
        // vsub.vv  v21, v25, v21      // ....................................................*...............
        // vsub.vv  v22, v26, v22      // ..........................................................*.........
        // vsub.vv  v23, v27, v23      // ..................................*.................................
        // vadd.vv v16, v16, v20       // .............................................................*......
        // vadd.vv v17, v17, v21       // ........................................................*...........
        // vadd.vv v18, v18, v22       // ...............................................................*....
        // vadd.vv v19, v19, v23       // .......................................*............................
        // add x14, x10, x17           // ......*.............................................................
        // add x15, x10, x28           // ........*...........................................................
        // vse16.v v16, (x14)          // .................................................................*..
        // vse16.v v17, (x15)          // ............................................................*.......
        // add x14, x14, x30           // ............*.......................................................
        // add x15, x15, x30           // .........*..........................................................
        // vse16.v v18, (x14)          // ...................................................................*
        // vse16.v v19, (x15)          // ..............................................................*.....

        end:

    // load zetas
    addi a4, a3, 0
    add  a5, a3, a7
    vle16.v v16, (a4)
    vle16.v v17, (a5)
    add  a4, a4, a6
    add  a5, a5, a6
    vle16.v v18, (a4)
    vle16.v v19, (a5)
    montmul_x4 v20, v21, v22, v23, v0, v1, v2, v3,  v8,  v9,  v10, v11, t0, t1, v28, v29, v30, v31
    montmul_x4 v24, v25, v26, v27, v4, v5, v6, v7,  v16, v17, v18, v19, t0, t1, v28, v29, v30, v31
    montmul_x4 v0, v1, v2, v3, v12, v13, v14, v15,  v24, v25, v26, v27, t0, t1, v28, v29, v30, v31
    // a0b0 + b1 * (a1zeta mod q)
    vadd.vv v20, v20, v0
    vadd.vv v21, v21, v1
    vadd.vv v22, v22, v2
    vadd.vv v23, v23, v3
    addi a4, a0, 0
    add a5, a0, a6
    vse16.v v20, (a4)
    vse16.v v21, (a5)
    add  a4, a4, t5
    add a5, a5, t5
    vse16.v v22, (a4)
    vse16.v v23, (a5)
    add  a0, a0, t5
    add a3, a3, t5
    add a0, a0, t5

    bltu a1, t2, poly_basemul_rvv_vlen128_loop
ret