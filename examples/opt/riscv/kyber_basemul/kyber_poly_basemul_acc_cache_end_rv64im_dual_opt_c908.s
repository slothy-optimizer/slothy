// Plantard based NTT implementation with l=16

.macro load_coeffs poly, len, wordLen
  lh s0,  \len*\wordLen*0(\poly)
  lh s1,  \len*\wordLen*1(\poly)
  lh s2,  \len*\wordLen*2(\poly)
  lh s3,  \len*\wordLen*3(\poly)
  lh s4,  \len*\wordLen*4(\poly)
  lh s5,  \len*\wordLen*5(\poly)
  lh s6,  \len*\wordLen*6(\poly)
  lh s7,  \len*\wordLen*7(\poly)
  lh s8,  \len*\wordLen*8(\poly)
  lh s9,  \len*\wordLen*9(\poly)
  lh s10, \len*\wordLen*10(\poly)
  lh s11, \len*\wordLen*11(\poly)
  lh a2,  \len*\wordLen*12(\poly)
  lh a3,  \len*\wordLen*13(\poly)
  lh a4,  \len*\wordLen*14(\poly)
  lh a5,  \len*\wordLen*15(\poly)
.endm

.macro store_coeffs poly, len, wordLen
  sh s0,  \len*\wordLen*0(\poly)
  sh s1,  \len*\wordLen*1(\poly)
  sh s2,  \len*\wordLen*2(\poly)
  sh s3,  \len*\wordLen*3(\poly)
  sh s4,  \len*\wordLen*4(\poly)
  sh s5,  \len*\wordLen*5(\poly)
  sh s6,  \len*\wordLen*6(\poly)
  sh s7,  \len*\wordLen*7(\poly)
  sh s8,  \len*\wordLen*8(\poly)
  sh s9,  \len*\wordLen*9(\poly)
  sh s10, \len*\wordLen*10(\poly)
  sh s11, \len*\wordLen*11(\poly)
  sh a2,  \len*\wordLen*12(\poly)
  sh a3,  \len*\wordLen*13(\poly)
  sh a4,  \len*\wordLen*14(\poly)
  sh a5,  \len*\wordLen*15(\poly)
.endm

.macro save_regs
  sd s0,  0*8(sp)
  sd s1,  1*8(sp)
  sd s2,  2*8(sp)
  sd s3,  3*8(sp)
  sd s4,  4*8(sp)
  sd s5,  5*8(sp)
  sd s6,  6*8(sp)
  sd s7,  7*8(sp)
  sd s8,  8*8(sp)
  sd s9,  9*8(sp)
  sd s10, 10*8(sp)
  sd s11, 11*8(sp)
  sd gp,  12*8(sp)
  sd tp,  13*8(sp)
  sd ra,  14*8(sp)
.endm

.macro restore_regs
  ld s0,  0*8(sp)
  ld s1,  1*8(sp)
  ld s2,  2*8(sp)
  ld s3,  3*8(sp)
  ld s4,  4*8(sp)
  ld s5,  5*8(sp)
  ld s6,  6*8(sp)
  ld s7,  7*8(sp)
  ld s8,  8*8(sp)
  ld s9,  9*8(sp)
  ld s10, 10*8(sp)
  ld s11, 11*8(sp)
  ld gp,  12*8(sp)
  ld tp,  13*8(sp)
  ld ra,  14*8(sp)
.endm

// a <- a*b*(-2^{-32}) mod+- q
// q48: q<<48; bqinv: b*qinv
.macro plant_mul_const_inplace q48, zeta, a
  mulw \a, \a, \zeta
  srai \a, \a, 16
  addi \a, \a, 8
  mulh \a, \a, \q48
.endm

.macro plant_mul_const_inplace_x2 q48, zeta, a_0, a_1
  mulw \a_0, \a_0, \zeta
  mulw \a_1, \a_1, \zeta
  srai \a_0, \a_0, 16
  srai \a_1, \a_1, 16
  addi \a_0, \a_0, 8
  addi \a_1, \a_1, 8
  mulh \a_0, \a_0, \q48
  mulh \a_1, \a_1, \q48
.endm

.macro plant_mul_const_inplace_x4 q48,   zeta_0, zeta_1, zeta_2, zeta_3,    a_0, a_1, a_2, a_3
  mulw \a_0, \a_0, \zeta_0
  mulw \a_1, \a_1, \zeta_1
  mulw \a_2, \a_2, \zeta_2
  mulw \a_3, \a_3, \zeta_3
  srai \a_0, \a_0, 16
  srai \a_1, \a_1, 16
  srai \a_2, \a_2, 16
  srai \a_3, \a_3, 16
  addi \a_0, \a_0, 8
  addi \a_1, \a_1, 8
  addi \a_2, \a_2, 8
  addi \a_3, \a_3, 8
  mulh \a_0, \a_0, \q48
  mulh \a_1, \a_1, \q48
  mulh \a_2, \a_2, \q48
  mulh \a_3, \a_3, \q48
.endm

// r <- a*b*(-2^{-32}) mod+- q
// q48: q<<48; zeta: b*qinv
.macro plant_mul_const q48, zeta, a, r
  mulw \r, \a, \zeta
  srai \r, \r, 16
  addi \r, \r, 8
  mulh \r, \r, \q48
.endm

.macro plant_mul_const_x2 q48, zeta_0, zeta_1, a_0, a_1, r_0, r_1
  mulw \r_0, \a_0, \zeta_0
  mulw \r_1, \a_1, \zeta_1
  srai \r_0, \r_0, 16
  srai \r_1, \r_1, 16
  addi \r_0, \r_0, 8
  addi \r_1, \r_1, 8
  mulh \r_0, \r_0, \q48
  mulh \r_1, \r_1, \q48
.endm

.macro plant_mul_const_x4    q48, zeta_0, zeta_1, zeta_2, zeta_3,      a_0, a_1, a_2, a_3,  r_0, r_1, r_2, r_3
  mulw \r_0, \a_0, \zeta_0
  mulw \r_1, \a_1, \zeta_1
  mulw \r_2, \a_2, \zeta_2
  mulw \r_3, \a_3, \zeta_3
  srai \r_0, \r_0, 16
  srai \r_1, \r_1, 16
  srai \r_2, \r_2, 16
  srai \r_3, \r_3, 16
  addi \r_0, \r_0, 8
  addi \r_1, \r_1, 8
  addi \r_2, \r_2, 8
  addi \r_3, \r_3, 8
  mulh \r_0, \r_0, \q48
  mulh \r_1, \r_1, \q48
  mulh \r_2, \r_2, \q48
  mulh \r_3, \r_3, \q48
.endm

// each layer increases coefficients by 0.5q; In ct_bfu, zeta and tmp can be reused because each zeta is only used once. The gs_bfu cannot.
// .macro ct_bfu a_0, a_1, zeta, q48, tmp
// plant_mul_const \q48, \zeta, \a_1, \tmp
// sub \a_1, \a_0, \tmp
// add \a_0, \a_0, \tmp
// .endm
.macro ct_bfu a_0, a_1, zeta, q48, tmp
  mulw \tmp, \a_1, \zeta
  srai \tmp, \tmp, 16
  addi \tmp, \tmp, 8
  mulh \tmp, \tmp, \q48
  sub \a_1, \a_0, \tmp
  add \a_0, \a_0, \tmp
.endm

.macro ct_bfu_x2  a_0_0, a_0_1, a_1_0, a_1_1,  zeta_0, zeta_1,  q48,  t_0, t_1
  mulw  \t_0, \a_0_1, \zeta_0
  mulw  \t_1, \a_1_1, \zeta_1
  srai \t_0, \t_0, 16
  srai \t_1, \t_1, 16
  addi \t_0, \t_0, 8
  addi \t_1, \t_1, 8
  mulh \t_0, \t_0, \q48
  mulh \t_1, \t_1, \q48
  sub  \a_0_1, \a_0_0, \t_0
  sub  \a_1_1, \a_1_0, \t_1
  add  \a_0_0, \a_0_0, \t_0
  add  \a_1_0, \a_1_0, \t_1
.endm

.macro ct_bfu_x8  a_0_0, a_0_1, a_1_0, a_1_1,  a_2_0, a_2_1, a_3_0, a_3_1,  a_4_0, a_4_1, a_5_0, a_5_1,  a_6_0, a_6_1, a_7_0, a_7_1,  zeta_0, zeta_1,  zeta_2, zeta_3,  zeta_4, zeta_5,  zeta_6, zeta_7,  q48,  t_0, t_1, t_2, t_3
  mulw \t_0, \a_0_1, \zeta_0
  mulw \t_1, \a_1_1, \zeta_1
  mulw \t_2, \a_2_1, \zeta_2
  mulw \t_3, \a_3_1, \zeta_3
  srai \t_0, \t_0, 16
  srai \t_1, \t_1, 16
  addi \t_0, \t_0, 8
  addi \t_1, \t_1, 8
  mulh \t_0, \t_0, \q48
  mulh \t_1, \t_1, \q48
  srai \t_2, \t_2, 16
  srai \t_3, \t_3, 16
  addi \t_2, \t_2, 8
  addi \t_3, \t_3, 8
  mulh \t_2, \t_2, \q48
  mulh \t_3, \t_3, \q48
  sub  \a_0_1, \a_0_0, \t_0
  sub  \a_1_1, \a_1_0, \t_1
  add  \a_0_0, \a_0_0, \t_0
  add  \a_1_0, \a_1_0, \t_1
  mulw \t_0, \a_4_1, \zeta_4
  mulw \t_1, \a_5_1, \zeta_5
  sub  \a_2_1, \a_2_0, \t_2
  sub  \a_3_1, \a_3_0, \t_3
  add  \a_2_0, \a_2_0, \t_2
  add  \a_3_0, \a_3_0, \t_3
  mulw \t_2, \a_6_1, \zeta_6
  mulw \t_3, \a_7_1, \zeta_7
  srai \t_0, \t_0, 16
  srai \t_1, \t_1, 16
  addi \t_0, \t_0, 8
  addi \t_1, \t_1, 8
  mulh \t_0, \t_0, \q48
  mulh \t_1, \t_1, \q48
  srai \t_2, \t_2, 16
  srai \t_3, \t_3, 16
  addi \t_2, \t_2, 8
  addi \t_3, \t_3, 8
  mulh \t_2, \t_2, \q48
  mulh \t_3, \t_3, \q48
  sub  \a_4_1, \a_4_0, \t_0
  sub  \a_5_1, \a_5_0, \t_1
  add  \a_4_0, \a_4_0, \t_0
  add  \a_5_0, \a_5_0, \t_1
  sub  \a_6_1, \a_6_0, \t_2
  sub  \a_7_1, \a_7_0, \t_3
  add  \a_6_0, \a_6_0, \t_2
  add  \a_7_0, \a_7_0, \t_3
.endm

.macro ct_bfu_x8_loadzetas  a_0_0, a_0_1, a_1_0, a_1_1,  a_2_0, a_2_1, a_3_0, a_3_1,  a_4_0, a_4_1, a_5_0, a_5_1,  a_6_0, a_6_1, a_7_0, a_7_1,  zeta_0, zeta_1,  zeta_2, zeta_3,  zeta_4, zeta_5,  zeta_6, zeta_7,  q48,  t_0, t_1, t_2, t_3
  lw   \t_0, \zeta_0(a1)
  lw   \t_1, \zeta_1(a1)
  lw   \t_2, \zeta_2(a1)
  lw   \t_3, \zeta_3(a1)
  mulw \t_0, \a_0_1, \t_0
  mulw \t_1, \a_1_1, \t_1
  mulw \t_2, \a_2_1, \t_2
  mulw \t_3, \a_3_1, \t_3
  srai \t_0, \t_0, 16
  srai \t_1, \t_1, 16
  addi \t_0, \t_0, 8
  addi \t_1, \t_1, 8
  mulh \t_0, \t_0, \q48
  mulh \t_1, \t_1, \q48
  srai \t_2, \t_2, 16
  srai \t_3, \t_3, 16
  addi \t_2, \t_2, 8
  addi \t_3, \t_3, 8
  mulh \t_2, \t_2, \q48
  mulh \t_3, \t_3, \q48
  sub  \a_0_1, \a_0_0, \t_0
  sub  \a_1_1, \a_1_0, \t_1
  add  \a_0_0, \a_0_0, \t_0
  lw   \t_0, \zeta_4(a1)
  add  \a_1_0, \a_1_0, \t_1
  lw   \t_1, \zeta_5(a1)
  mulw \t_0, \a_4_1, \t_0
  mulw \t_1, \a_5_1, \t_1
  sub  \a_2_1, \a_2_0, \t_2
  sub  \a_3_1, \a_3_0, \t_3
  add  \a_2_0, \a_2_0, \t_2
  lw   \t_2, \zeta_6(a1)
  add  \a_3_0, \a_3_0, \t_3
  lw   \t_3, \zeta_7(a1)
  mulw \t_2, \a_6_1, \t_2
  mulw \t_3, \a_7_1, \t_3
  srai \t_0, \t_0, 16
  srai \t_1, \t_1, 16
  addi \t_0, \t_0, 8
  addi \t_1, \t_1, 8
  mulh \t_0, \t_0, \q48
  mulh \t_1, \t_1, \q48
  srai \t_2, \t_2, 16
  srai \t_3, \t_3, 16
  addi \t_2, \t_2, 8
  addi \t_3, \t_3, 8
  mulh \t_2, \t_2, \q48
  mulh \t_3, \t_3, \q48
  sub  \a_4_1, \a_4_0, \t_0
  sub  \a_5_1, \a_5_0, \t_1
  add  \a_4_0, \a_4_0, \t_0
  add  \a_5_0, \a_5_0, \t_1
  sub  \a_6_1, \a_6_0, \t_2
  sub  \a_7_1, \a_7_0, \t_3
  add  \a_6_0, \a_6_0, \t_2
  add  \a_7_0, \a_7_0, \t_3
.endm

.macro gs_bfu a_0, a_1, zeta, q48, tmp
  sub \tmp, \a_0, \a_1
  add \a_0, \a_0, \a_1
  mulw \a_1, \tmp, \zeta
  srai \a_1, \a_1, 16
  addi \a_1, \a_1, 8
  mulh \a_1, \a_1, \q48
.endm

.macro gs_bfu_x2 a_0_0, a_0_1, a_1_0, a_1_1,  zeta_0, zeta_1, q48, t_0, t_1
  sub \t_0, \a_0_0, \a_0_1
  sub \t_1, \a_1_0, \a_1_1
  add \a_0_0, \a_0_0, \a_0_1
  add \a_1_0, \a_1_0, \a_1_1
  mulw \a_0_1, \t_0, \zeta_0
  mulw \a_1_1, \t_1, \zeta_1
  srai \a_0_1, \a_0_1, 16
  srai \a_1_1, \a_1_1, 16
  addi \a_0_1, \a_0_1, 8
  addi \a_1_1, \a_1_1, 8
  mulh \a_0_1, \a_0_1, \q48
  mulh \a_1_1, \a_1_1, \q48
.endm

.macro gs_bfu_x8  a_0_0, a_0_1, a_1_0, a_1_1,  a_2_0, a_2_1, a_3_0, a_3_1,  a_4_0, a_4_1, a_5_0, a_5_1,  a_6_0, a_6_1, a_7_0, a_7_1,  zeta_0, zeta_1,  zeta_2, zeta_3,  zeta_4, zeta_5,  zeta_6, zeta_7,  q48, t_0, t_1, t_2, t_3
  sub \t_0, \a_0_0, \a_0_1
  sub \t_1, \a_1_0, \a_1_1
  add \a_0_0, \a_0_0, \a_0_1
  add \a_1_0, \a_1_0, \a_1_1
  mulw \a_0_1, \t_0, \zeta_0
  mulw \a_1_1, \t_1, \zeta_1
  sub \t_2, \a_2_0, \a_2_1
  sub \t_3, \a_3_0, \a_3_1
  add \a_2_0, \a_2_0, \a_2_1
  add \a_3_0, \a_3_0, \a_3_1
  mulw \a_2_1, \t_2, \zeta_2
  mulw \a_3_1, \t_3, \zeta_3
  srai \a_0_1, \a_0_1, 16
  srai \a_1_1, \a_1_1, 16
  addi \a_0_1, \a_0_1, 8
  addi \a_1_1, \a_1_1, 8
  mulh \a_0_1, \a_0_1, \q48
  mulh \a_1_1, \a_1_1, \q48
  srai \a_2_1, \a_2_1, 16
  srai \a_3_1, \a_3_1, 16
  addi \a_2_1, \a_2_1, 8
  addi \a_3_1, \a_3_1, 8
  mulh \a_2_1, \a_2_1, \q48
  mulh \a_3_1, \a_3_1, \q48
  sub \t_0, \a_4_0, \a_4_1
  sub \t_1, \a_5_0, \a_5_1
  add \a_4_0, \a_4_0, \a_4_1
  add \a_5_0, \a_5_0, \a_5_1
  mulw \a_4_1, \t_0, \zeta_4
  mulw \a_5_1, \t_1, \zeta_5
  sub \t_2, \a_6_0, \a_6_1
  sub \t_3, \a_7_0, \a_7_1
  add \a_6_0, \a_6_0, \a_6_1
  add \a_7_0, \a_7_0, \a_7_1
  mulw \a_6_1, \t_2, \zeta_6
  mulw \a_7_1, \t_3, \zeta_7
  srai \a_4_1, \a_4_1, 16
  srai \a_5_1, \a_5_1, 16
  addi \a_4_1, \a_4_1, 8
  addi \a_5_1, \a_5_1, 8
  mulh \a_4_1, \a_4_1, \q48
  mulh \a_5_1, \a_5_1, \q48
  srai \a_6_1, \a_6_1, 16
  srai \a_7_1, \a_7_1, 16
  addi \a_6_1, \a_6_1, 8
  addi \a_7_1, \a_7_1, 8
  mulh \a_6_1, \a_6_1, \q48
  mulh \a_7_1, \a_7_1, \q48
.endm

.macro gs_bfu_x8_load_4zetas  a_0_0, a_0_1, a_1_0, a_1_1,  a_2_0, a_2_1, a_3_0, a_3_1,  a_4_0, a_4_1, a_5_0, a_5_1,  a_6_0, a_6_1, a_7_0, a_7_1,  zeta_0, zeta_1,  zeta_2, zeta_3,  q48, t_0, t_1, t_2, t_3
  lw  \t_2, \zeta_0(a1)
  sub \t_0, \a_0_0, \a_0_1
  sub \t_1, \a_1_0, \a_1_1
  add \a_0_0, \a_0_0, \a_0_1
  add \a_1_0, \a_1_0, \a_1_1
  mulw \a_0_1, \t_0, \t_2
  mulw \a_1_1, \t_1, \t_2
  sub \t_0, \a_2_0, \a_2_1
  sub \t_3, \a_3_0, \a_3_1
  lw  \t_2, \zeta_1(a1)
  add \a_2_0, \a_2_0, \a_2_1
  add \a_3_0, \a_3_0, \a_3_1
  mulw \a_2_1, \t_0, \t_2
  mulw \a_3_1, \t_3, \t_2
  srai \a_0_1, \a_0_1, 16
  srai \a_1_1, \a_1_1, 16
  addi \a_0_1, \a_0_1, 8
  addi \a_1_1, \a_1_1, 8
  mulh \a_0_1, \a_0_1, \q48
  mulh \a_1_1, \a_1_1, \q48
  srai \a_2_1, \a_2_1, 16
  srai \a_3_1, \a_3_1, 16
  addi \a_2_1, \a_2_1, 8
  addi \a_3_1, \a_3_1, 8
  mulh \a_2_1, \a_2_1, \q48
  mulh \a_3_1, \a_3_1, \q48
  sub \t_0, \a_4_0, \a_4_1
  sub \t_1, \a_5_0, \a_5_1
  lw  \t_2, \zeta_2(a1)
  add \a_4_0, \a_4_0, \a_4_1
  add \a_5_0, \a_5_0, \a_5_1
  mulw \a_4_1, \t_0, \t_2
  mulw \a_5_1, \t_1, \t_2
  sub \t_0, \a_6_0, \a_6_1
  sub \t_3, \a_7_0, \a_7_1
  lw  \t_2, \zeta_3(a1)
  add \a_6_0, \a_6_0, \a_6_1
  add \a_7_0, \a_7_0, \a_7_1
  mulw \a_6_1, \t_0, \t_2
  mulw \a_7_1, \t_3, \t_2
  srai \a_4_1, \a_4_1, 16
  srai \a_5_1, \a_5_1, 16
  addi \a_4_1, \a_4_1, 8
  addi \a_5_1, \a_5_1, 8
  mulh \a_4_1, \a_4_1, \q48
  mulh \a_5_1, \a_5_1, \q48
  srai \a_6_1, \a_6_1, 16
  srai \a_7_1, \a_7_1, 16
  addi \a_6_1, \a_6_1, 8
  addi \a_7_1, \a_7_1, 8
  mulh \a_6_1, \a_6_1, \q48
  mulh \a_7_1, \a_7_1, \q48
.endm

.macro gs_bfu_x8_load_2zetas  a_0_0, a_0_1, a_1_0, a_1_1,  a_2_0, a_2_1, a_3_0, a_3_1,  a_4_0, a_4_1, a_5_0, a_5_1,  a_6_0, a_6_1, a_7_0, a_7_1,  zeta_0, zeta_1,  q48, t_0, t_1, t_2, t_3
  lw  \t_2, \zeta_0(a1)
  sub \t_0, \a_0_0, \a_0_1
  sub \t_1, \a_1_0, \a_1_1
  add \a_0_0, \a_0_0, \a_0_1
  add \a_1_0, \a_1_0, \a_1_1
  mulw \a_0_1, \t_0, \t_2
  mulw \a_1_1, \t_1, \t_2
  sub \t_0, \a_2_0, \a_2_1
  sub \t_3, \a_3_0, \a_3_1
  add \a_2_0, \a_2_0, \a_2_1
  add \a_3_0, \a_3_0, \a_3_1
  mulw \a_2_1, \t_0, \t_2
  mulw \a_3_1, \t_3, \t_2
  srai \a_0_1, \a_0_1, 16
  srai \a_1_1, \a_1_1, 16
  addi \a_0_1, \a_0_1, 8
  addi \a_1_1, \a_1_1, 8
  mulh \a_0_1, \a_0_1, \q48
  mulh \a_1_1, \a_1_1, \q48
  srai \a_2_1, \a_2_1, 16
  srai \a_3_1, \a_3_1, 16
  addi \a_2_1, \a_2_1, 8
  addi \a_3_1, \a_3_1, 8
  mulh \a_2_1, \a_2_1, \q48
  mulh \a_3_1, \a_3_1, \q48
  lw  \t_2, \zeta_1(a1)
  sub \t_0, \a_4_0, \a_4_1
  sub \t_1, \a_5_0, \a_5_1
  add \a_4_0, \a_4_0, \a_4_1
  add \a_5_0, \a_5_0, \a_5_1
  mulw \a_4_1, \t_0, \t_2
  mulw \a_5_1, \t_1, \t_2
  sub \t_0, \a_6_0, \a_6_1
  sub \t_3, \a_7_0, \a_7_1
  add \a_6_0, \a_6_0, \a_6_1
  add \a_7_0, \a_7_0, \a_7_1
  mulw \a_6_1, \t_0, \t_2
  mulw \a_7_1, \t_3, \t_2
  srai \a_4_1, \a_4_1, 16
  srai \a_5_1, \a_5_1, 16
  addi \a_4_1, \a_4_1, 8
  addi \a_5_1, \a_5_1, 8
  mulh \a_4_1, \a_4_1, \q48
  mulh \a_5_1, \a_5_1, \q48
  srai \a_6_1, \a_6_1, 16
  srai \a_7_1, \a_7_1, 16
  addi \a_6_1, \a_6_1, 8
  addi \a_7_1, \a_7_1, 8
  mulh \a_6_1, \a_6_1, \q48
  mulh \a_7_1, \a_7_1, \q48
.endm

.macro plant_mul_const_inplace_x8  q48, zeta,  a_0, a_1, a_2, a_3,  a_4, a_5, a_6, a_7
  mulw \a_0, \a_0, \zeta
  mulw \a_1, \a_1, \zeta
  mulw \a_2, \a_2, \zeta
  mulw \a_3, \a_3, \zeta
  srai \a_0, \a_0, 16
  srai \a_1, \a_1, 16
  addi \a_0, \a_0, 8
  addi \a_1, \a_1, 8
  mulh \a_0, \a_0, \q48
  mulh \a_1, \a_1, \q48
  srai \a_2, \a_2, 16
  srai \a_3, \a_3, 16
  mulw \a_4, \a_4, \zeta
  mulw \a_5, \a_5, \zeta
  addi \a_2, \a_2, 8
  addi \a_3, \a_3, 8
  mulh \a_2, \a_2, \q48
  mulh \a_3, \a_3, \q48
  srai \a_4, \a_4, 16
  srai \a_5, \a_5, 16
  mulw \a_6, \a_6, \zeta
  mulw \a_7, \a_7, \zeta
  addi \a_4, \a_4, 8
  addi \a_5, \a_5, 8
  mulh \a_4, \a_4, \q48
  mulh \a_5, \a_5, \q48
  srai \a_6, \a_6, 16
  addi \a_6, \a_6, 8
  mulh \a_6, \a_6, \q48
  srai \a_7, \a_7, 16
  addi \a_7, \a_7, 8
  mulh \a_7, \a_7, \q48
.endm

// in-place plantard reduction to a
// output \in (-0.5q, 0.5q); q48: q<<48
.macro plant_red q48, qinv, a
  mulw \a, \a, \qinv
  srai \a, \a, 16
  addi \a, \a, 8
  mulh \a, \a, \q48
.endm

.macro plant_red_x4  q48, qinv,   a_0, a_1, a_2, a_3
  mulw \a_0, \a_0, \qinv
  mulw \a_1, \a_1, \qinv
  mulw \a_2, \a_2, \qinv
  mulw \a_3, \a_3, \qinv
  srai \a_0, \a_0, 16
  srai \a_1, \a_1, 16
  srai \a_2, \a_2, 16
  srai \a_3, \a_3, 16
  addi \a_0, \a_0, 8
  addi \a_1, \a_1, 8
  addi \a_2, \a_2, 8
  addi \a_3, \a_3, 8
  mulh \a_0, \a_0, \q48
  mulh \a_1, \a_1, \q48
  mulh \a_2, \a_2, \q48
  mulh \a_3, \a_3, \q48
.endm

.equ q, 3329
.equ q48, 0xd01000000000000     // q<<48
.equ qinv, 0x6ba8f301           // q^-1 mod+- 2^32
.equ plantconst, 0x13afb8       // (-2^{32} mod q)*qinv mod 2^32
.equ plantconst2, 0x97f44fac    // (2^{64} mod q)*qinv mod 2^32

// void poly_basemul_acc_cache_end_rv64im(int16_t *r, const int16_t *a, const int16_t *b, int16_t *b_cache, int32_t *r_double)
// compute basemul using cached b_cache, accumulate the 32-bit results into r_double, and reduce r_double to r
// a0: r, a1: a, a2: b, a3: b_cache, a4: r_double
// a5: q<<48, a6: loop control
.global poly_basemul_acc_cache_end_rv64im_opt_c908
.align 2
poly_basemul_acc_cache_end_rv64im_opt_c908:
    addi sp, sp, -8*16
    save_regs
    li a5, q48
    li a6, qinv
    li a7, 32
    sd a7, 8*15(sp)
                                 // Instructions:    22
                                 // Expected cycles: 14
                                 // Expected IPC:    1.57
                                 //
                                 // Cycle bound:     14.0
                                 // IPC bound:       1.57
                                 //
                                 // Wall time:     0.13s
                                 // User time:     0.13s
                                 //
                                 // ----- cycle (expected) ------>
                                 // 0                        25
                                 // |------------------------|----
        lh x8, 2*2(x11)          // *.............................
        lh x23, 2*3(x12)         // .*............................
        lh x22, 2*2(x12)         // ..*...........................
        lh x28, 2*4(x11)         // ...*..........................
        mul x24, x8, x23         // ....*.........................
        lh x19, 2*5(x11)         // ....*.........................
        mul x8, x8, x22          // .....*........................
        lh x23, 2*4(x12)         // .....*........................
        lh x27, 2*2(x13)         // ......*.......................
        lh x17, 2*3(x11)         // .......*......................
        mul x20, x28, x23        // ........*.....................
        lh x9, 2*7(x11)          // ........*.....................
        mul x27, x19, x27        // .........*....................
        lw x26, 4*2(x14)         // .........*....................
        mul x25, x17, x22        // ..........*...................
        lw x22, 4*4(x14)         // ..........*...................
        add x6, x26, x8          // ...........*..................
        lh x1, 2*5(x12)          // ...........*..................
        add x8, x22, x20         // ............*.................
        lw x18, 4*3(x14)         // ............*.................
        add x8, x8, x27          // .............*................
        lh x22, 2*7(x12)         // .............*................

                                  // ------ cycle (expected) ------>
                                  // 0                        25
                                  // |------------------------|-----
        // lh x22, 2*2(x11)       // *..............................
        // lh x9, 2*7(x11)        // ........*......................
        // lh x28, 2*4(x11)       // ...*...........................
        // lh x23, 2*3(x12)       // .*.............................
        // mul x24, x22, x23      // ....*..........................
        // lh x19, 2*5(x11)       // ....*..........................
        // lh x18, 2*2(x12)       // ..*............................
        // lh x7, 2*2(x13)        // ......*........................
        // lh x1, 2*5(x12)        // ...........*...................
        // lh x23, 2*4(x12)       // .....*.........................
        // mul x26, x19, x7       // .........*.....................
        // mul x30, x22, x18      // .....*.........................
        // lh x17, 2*3(x11)       // .......*.......................
        // lw x29, 4*2(x14)       // .........*.....................
        // mul x4, x28, x23       // ........*......................
        // lw x22, 4*4(x14)       // ..........*....................
        // add x6, x29, x30       // ...........*...................
        // mul x25, x17, x18      // ..........*....................
        // add x20, x22, x4       // ............*..................
        // lw x18, 4*3(x14)       // ............*..................
        // add x8, x20, x26       // .............*.................
        // lh x22, 2*7(x12)       // .............*.................

        ld a7, 8*15(sp)
        addi a7, a7, -1
        sd a7, 8*15(sp)
poly_basemul_acc_cache_end_rv64im_loop:
                                  // Instructions:    105
                                  // Expected cycles: 53
                                  // Expected IPC:    1.98
                                  //
                                  // Cycle bound:     53.0
                                  // IPC bound:       1.98
                                  //
                                  // Wall time:     134.43s
                                  // User time:     134.43s
                                  //
                                  // ----------------- cycle (expected) ----------------->
                                  // 0                        25                       50
                                  // |------------------------|------------------------|--
        mul x7, x28, x1           // *....................................................
        lh x26, 2*1(x11)          // *....................................................
        lh x1, 2*0(x12)           // .*...................................................
        add x27, x18, x24         // .*...................................................
        lh x3, 2*6(x11)           // ..*..................................................
        add x31, x27, x25         // ..*..................................................
        lh x27, 2*0(x11)          // ...*.................................................
        addi x11, x11, 2*8        // ...*.................................................
        lw x5, 4*5(x14)           // ....*................................................
        mul x8, x8, x16           // ....*................................................
        mul x29, x26, x1          // .....*...............................................
        lh x21, 2*6(x12)          // .....*...............................................
        mul x30, x3, x22          // ......*..............................................
        mul x4, x19, x23          // ......*..............................................
        lh x22, 2*0(x13)          // .......*.............................................
        add x23, x5, x7           // .......*.............................................
        lh x7, 2*3(x13)           // ........*............................................
        mul x28, x9, x21          // ........*............................................
        mul x19, x27, x1          // .........*...........................................
        lw x5, 4*7(x14)           // .........*...........................................
        lh x1, 2*1(x12)           // ..........*..........................................
        addi x12, x12, 2*8        // ..........*..........................................
        lh x20, 2*1(x13)          // ...........*.........................................
        add x30, x5, x30          // ...........*.........................................
        mul x18, x9, x7           // ............*........................................
        add x23, x23, x4          // ............*........................................
        mul x5, x3, x21           // .............*.......................................
        mul x26, x26, x22         // .............*.......................................
        lw x25, 4*6(x14)          // ..............*......................................
        mul x24, x17, x20         // ..............*......................................
        lw x20, 4*1(x14)          // ...............*.....................................
        add x30, x30, x28         // ...............*.....................................
        mul x17, x23, x16         // ................*....................................
        lh x22, 2*2(x11)          // ................e....................................
        mul x21, x30, x16         // .................*...................................
        add x23, x25, x5          // .................*...................................
        lh x9, 2*7(x11)           // ..................e..................................
        add x4, x23, x18          // ..................*..................................
        srai x18, x17, 16         // ...................*.................................
        mul x23, x4, x16          // ...................*.................................
        addi x17, x18, 8          // ....................*................................
        srai x4, x21, 16          // ....................*................................
        mulh x30, x17, x15        // .....................*...............................
        addi x25, x4, 8           // .....................*...............................
        mulh x25, x25, x15        // ......................*..............................
        srai x18, x23, 16         // ......................*..............................
        addi x18, x18, 8          // .......................*.............................
        lh x28, 2*4(x11)          // .......................e.............................
        lh x23, 2*3(x12)          // ........................e............................
        mulh x4, x18, x15         // ........................*............................
        mul x18, x31, x16         // .........................*...........................
        srai x31, x8, 16          // .........................*...........................
        sh x25, 2*7(x10)          // ..........................*..........................
        addi x7, x31, 8           // ..........................*..........................
        lw x17, 4*0(x14)          // ...........................*.........................
        mulh x8, x7, x15          // ...........................*.........................
        addi x14, x14, 4*8        // ............................*........................
        sh x4, 2*6(x10)           // ............................*........................
        mul x21, x27, x1          // .............................*.......................
        sh x30, 2*5(x10)          // .............................*.......................
        add x6, x6, x24           // ..............................*......................
        mul x24, x22, x23         // ..............................e......................
        add x17, x17, x19         // ...............................*.....................
        sh x8, 2*4(x10)           // ...............................*.....................
        mul x27, x6, x16          // ................................*....................
        add x17, x17, x26         // ................................*....................
        srai x8, x18, 16          // .................................*...................
        add x21, x20, x21         // .................................*...................
        lh x19, 2*5(x11)          // ..................................e..................
        add x21, x21, x29         // ..................................*..................
        addi x13, x13, 2*4        // ...................................*.................
        mul x23, x21, x16         // ...................................*.................
        mul x26, x17, x16         // ....................................*................
        addi x29, x8, 8           // ....................................*................
        mulh x20, x29, x15        // .....................................*...............
        srai x8, x27, 16          // .....................................*...............
        lh x18, 2*2(x12)          // ......................................e..............
        srai x30, x23, 16         // ......................................*..............
        srai x26, x26, 16         // .......................................*.............
        lh x7, 2*2(x13)           // .......................................e.............
        lh x1, 2*5(x12)           // ........................................e............
        addi x27, x30, 8          // ........................................*............
        addi x17, x8, 8           // .........................................*...........
        addi x6, x26, 8           // .........................................*...........
        lh x23, 2*4(x12)          // ..........................................e..........
        mul x26, x19, x7          // ..........................................e..........
        mul x30, x22, x18         // ...........................................e.........
        mulh x21, x17, x15        // ...........................................*.........
        lh x17, 2*3(x11)          // ............................................e........
        mulh x25, x27, x15        // ............................................*........
        lw x29, 4*2(x14)          // .............................................e.......
        mul x4, x28, x23          // .............................................e.......
        lw x22, 4*4(x14)          // ..............................................e......
        mulh x5, x6, x15          // ..............................................*......
        add x6, x29, x30          // ...............................................e.....
        sh x21, 2*2(x10)          // ...............................................*.....
        sh x25, 2*1(x10)          // ................................................*....
        mul x25, x17, x18         // ................................................e....
        sh x20, 2*3(x10)          // .................................................*...
        add x20, x22, x4          // .................................................e...
        lw x18, 4*3(x14)          // ..................................................e..
        add x8, x20, x26          // ..................................................e..
        sh x5, 2*0(x10)           // ...................................................*.
        addi x10, x10, 2*8        // ...................................................*.
        lh x22, 2*7(x12)          // ....................................................e

                                   // ----------------------------------- cycle (expected) ----------------------------------->
                                   // 0                        25                       50                       75
                                   // |------------------------|------------------------|------------------------|-------------
        // lh x8, 2*0(x12)         // .....................................'*..................................................
        // lh x9, 2*1(x12)         // .....................................'.........*.........................................
        // lh x19, 2*3(x12)        // ........e............................'.......................~...........................
        // lh x21, 2*5(x12)        // ........................e............'.......................................~...........
        // lh x23, 2*7(x12)        // ....................................e'...................................................
        // lh  x5, 2*0(x11)        // .....................................'..*................................................
        // lh  x6, 2*1(x11)        // .....................................*...................................................
        // lh  x7,  2*0(x13)       // .....................................'......*............................................
        // lh  x28,  2*1(x13)      // .....................................'..........*........................................
        // lh  x29,  2*2(x13)      // .......................e.............'......................................~............
        // lh  x30,  2*3(x13)      // .....................................'.......*...........................................
        // lw  x24, 4*0(x14)       // ...........~.........................'..........................*........................
        // lw  x25, 4*1(x14)       // .....................................'..............*....................................
        // mul x18, x5, x8         // .....................................'........*..........................................
        // mul x20, x6, x7         // .....................................'............*......................................
        // mul x22, x5, x9         // .............~.......................'............................*......................
        // mul x31, x6, x8         // .....................................'....*..............................................
        // lh  x5, 2*2(x11)        // e....................................'...............~...................................
        // lh  x6, 2*3(x11)        // ............................e........'...........................................~.......
        // add x24, x24, x18       // ...............~.....................'..............................*....................
        // add x24, x24, x20       // ................~....................'...............................*...................
        // lh  x18, 2*2(x12)       // ......................e..............'.....................................~.............
        // add x25, x25, x22       // .................~...................'................................*..................
        // add x25, x25, x31       // ..................~..................'.................................*.................
        // lw  x26,4*2(x14)        // .............................e.......'............................................~......
        // lw  x27,4*3(x14)        // ..................................e..'.................................................~.
        // mul x8, x5, x18         // ...........................e.........'..........................................~........
        // mul x9, x6, x28         // .....................................'.............*.....................................
        // mul x17, x5, x19        // ..............e......................'.............................~.....................
        // mul x31, x6, x18        // ................................e....'...............................................~...
        // lh  x7, 2*4(x11)        // .......e.............................'......................~............................
        // lh  x4, 2*5(x11)        // ..................e..................'.................................~.................
        // lh  x20, 2*4(x12)       // ..........................e..........'.........................................~.........
        // add x26, x26, x8        // ...............................e.....'..............................................~....
        // add x26, x26, x9        // ..............~......................'.............................*.....................
        // add x27, x27, x17       // .....................................'*..................................................
        // add x27, x27, x31       // .....................................'.*.................................................
        // mulw x24, x24, x16      // ....................~................'...................................*...............
        // mulw x25, x25, x16      // ...................~.................'..................................*................
        // mulw x26, x26, x16      // ................~....................'...............................*...................
        // mulw x27, x27, x16      // .........~...........................'........................*..........................
        // srai x24, x24, 16       // .......................~.............'......................................*............
        // srai x25, x25, 16       // ......................~..............'.....................................*.............
        // srai x26, x26, 16       // .....................~...............'....................................*..............
        // srai x27, x27, 16       // .................~...................'................................*..................
        // addi x24, x24, 8        // .........................~...........'........................................*..........
        // addi x25, x25, 8        // ........................~............'.......................................*...........
        // addi x26, x26, 8        // .........................~...........'........................................*..........
        // addi x27, x27, 8        // ....................~................'...................................*...............
        // mulh x24, x24, x15      // ..............................~......'.............................................*.....
        // mulh x25, x25, x15      // ............................~........'...........................................*.......
        // mulh x26, x26, x15      // ...........................~.........'..........................................*........
        // mulh x27, x27, x15      // .....................~...............'....................................*..............
        // sh  x24, 2*0(x10)       // ...................................~.'..................................................*
        // sh  x25, 2*1(x10)       // ................................~....'...............................................*...
        // sh  x26,2*2(x10)        // ...............................~.....'..............................................*....
        // sh  x27,2*3(x10)        // .................................~...'................................................*..
        // mul x8, x7, x20         // .............................e.......'............................................~......
        // mul x9, x4, x29         // ..........................e..........'.........................................~.........
        // lw  x24, 4*4(x14)       // ..............................e......'.............................................~.....
        // lw  x25, 4*5(x14)       // .....................................'...*...............................................
        // mul x5, x7, x21         // .....................................*...................................................
        // mul x6, x4, x20         // .....................................'.....*.............................................
        // lh  x22, 2*6(x12)       // .....................................'....*..............................................
        // lh  x3, 2*6(x11)        // .....................................'.*.................................................
        // lh  x1, 2*7(x11)        // ..e..................................'.................~.................................
        // add x24, x24, x8        // .................................e...'................................................~..
        // add x24, x24, x9        // ..................................e..'.................................................~.
        // lw  x26,4*6(x14)        // .....................................'.............*.....................................
        // lw  x27,4*7(x14)        // .....................................'........*..........................................
        // add x25, x25, x5        // .....................................'......*............................................
        // add x25, x25, x6        // .....................................'...........*.......................................
        // mul x8, x3, x22         // .....................................'............*......................................
        // mul x9, x1, x30         // .....................................'...........*.......................................
        // mul x5, x3, x23         // .....................................'.....*.............................................
        // mul x6, x1, x22         // .....................................'.......*...........................................
        // add x26, x26, x8        // .~...................................'................*..................................
        // add x26, x26, x9        // ..~..................................'.................*.................................
        // add x27, x27, x5        // .....................................'..........*........................................
        // add x27, x27, x6        // .....................................'..............*....................................
        // mulw x24, x24, x16      // .....................................'...*...............................................
        // mulw x25, x25, x16      // ~....................................'...............*...................................
        // mulw x26, x26, x16      // ...~.................................'..................*................................
        // mulw x27, x27, x16      // .~...................................'................*..................................
        // srai x24, x24, 16       // .........~...........................'........................*..........................
        // srai x25, x25, 16       // ...~.................................'..................*................................
        // srai x26, x26, 16       // ......~..............................'.....................*.............................
        // srai x27, x27, 16       // ....~................................'...................*...............................
        // addi x24, x24, 8        // ..........~..........................'.........................*.........................
        // addi x25, x25, 8        // ....~................................'...................*...............................
        // addi x26, x26, 8        // .......~.............................'......................*............................
        // addi x27, x27, 8        // .....~...............................'....................*..............................
        // mulh x24, x24, x15      // ...........~.........................'..........................*........................
        // mulh x25, x25, x15      // .....~...............................'....................*..............................
        // mulh x26, x26, x15      // ........~............................'.......................*...........................
        // mulh x27, x27, x15      // ......~..............................'.....................*.............................
        // sh  x24, 2*4(x10)       // ...............~.....................'..............................*....................
        // sh  x25, 2*5(x10)       // .............~.......................'............................*......................
        // sh  x26,2*6(x10)        // ............~........................'...........................*.......................
        // sh  x27,2*7(x10)        // ..........~..........................'.........................*.........................
        // addi x10, x10, 2*8      // ...................................~.'..................................................*
        // addi x11, x11, 2*8      // .....................................'..*................................................
        // addi x12, x12, 2*8      // .....................................'.........*.........................................
        // addi x13, x13, 2*4      // ...................~.................'..................................*................
        // addi x14, x14, 4*8      // ............~........................'...........................*.......................

        ld a7, 8*15(sp)
        addi a7, a7, -1
        sd a7, 8*15(sp)
        bne a7, zero, poly_basemul_acc_cache_end_rv64im_loop
                                  // Instructions:    83
                                  // Expected cycles: 42
                                  // Expected IPC:    1.98
                                  //
                                  // Cycle bound:     42.0
                                  // IPC bound:       1.98
                                  //
                                  // Wall time:     14.66s
                                  // User time:     14.66s
                                  //
                                  // ----------- cycle (expected) ------------>
                                  // 0                        25
                                  // |------------------------|----------------
        add x27, x18, x24         // *.........................................
        lh x18, 2*0(x11)          // *.........................................
        mul x30, x28, x1          // .*........................................
        lh x28, 2*0(x12)          // .*........................................
        add x1, x27, x25          // ..*.......................................
        lh x31, 2*6(x12)          // ..*.......................................
        lh x21, 2*3(x13)          // ...*......................................
        mul x27, x1, x16          // ...*......................................
        lh x1, 2*1(x13)           // ....*.....................................
        mul x19, x19, x23         // ....*.....................................
        lh x5, 2*0(x13)           // .....*....................................
        addi x13, x13, 2*4        // .....*....................................
        mul x4, x9, x21           // ......*...................................
        lw x21, 4*5(x14)          // ......*...................................
        mul x24, x17, x1          // .......*..................................
        srai x23, x27, 16         // .......*..................................
        addi x23, x23, 8          // ........*.................................
        add x26, x21, x30         // ........*.................................
        add x20, x26, x19         // .........*................................
        mulh x27, x23, x15        // .........*................................
        mul x26, x20, x16         // ..........*...............................
        mul x19, x18, x28         // ..........*...............................
        lw x17, 4*0(x14)          // ...........*..............................
        add x23, x6, x24          // ...........*..............................
        lw x29, 4*6(x14)          // ............*.............................
        mul x23, x23, x16         // ............*.............................
        sh x27, 2*3(x10)          // .............*............................
        mul x6, x9, x31           // .............*............................
        add x20, x17, x19         // ..............*...........................
        srai x7, x26, 16          // ..............*...........................
        lh x3, 2*6(x11)           // ...............*..........................
        addi x27, x7, 8           // ...............*..........................
        mulh x25, x27, x15        // ................*.........................
        srai x23, x23, 16         // ................*.........................
        addi x23, x23, 8          // .................*........................
        lh x26, 2*1(x12)          // .................*........................
        mul x1, x8, x16           // ..................*.......................
        mulh x27, x23, x15        // ..................*.......................
        mul x23, x3, x22          // ...................*......................
        lh x9, 2*1(x11)           // ...................*......................
        sh x25, 2*5(x10)          // ....................*.....................
        mul x19, x3, x31          // ....................*.....................
        lw x21, 4*7(x14)          // .....................*....................
        mul x8, x18, x26          // .....................*....................
        sh x27, 2*2(x10)          // ......................*...................
        mul x17, x9, x28          // ......................*...................
        add x23, x21, x23         // .......................*..................
        lw x22, 4*1(x14)          // .......................*..................
        add x26, x23, x6          // ........................*.................
        add x23, x29, x19         // ........................*.................
        mul x27, x26, x16         // .........................*................
        add x8, x22, x8           // .........................*................
        mul x24, x9, x5           // ..........................*...............
        add x8, x8, x17           // ..........................*...............
        mul x8, x8, x16           // ...........................*..............
        add x26, x23, x4          // ...........................*..............
        mul x22, x26, x16         // ............................*.............
        addi x14, x14, 4*8        // ............................*.............
        srai x18, x1, 16          // .............................*............
        srai x23, x27, 16         // .............................*............
        addi x17, x23, 8          // ..............................*...........
        add x20, x20, x24         // ..............................*...........
        srai x8, x8, 16           // ...............................*..........
        mul x20, x20, x16         // ...............................*..........
        addi x8, x8, 8            // ................................*.........
        mulh x26, x17, x15        // ................................*.........
        srai x22, x22, 16         // .................................*........
        mulh x23, x8, x15         // .................................*........
        addi x24, x22, 8          // ..................................*.......
        addi x1, x18, 8           // ..................................*.......
        srai x8, x20, 16          // ...................................*......
        mulh x22, x24, x15        // ...................................*......
        mulh x27, x1, x15         // ....................................*.....
        addi x8, x8, 8            // ....................................*.....
        sh x26, 2*7(x10)          // .....................................*....
        mulh x8, x8, x15          // .....................................*....
        addi x12, x12, 2*8        // ......................................*...
        sh x23, 2*1(x10)          // ......................................*...
        sh x22, 2*6(x10)          // .......................................*..
        addi x11, x11, 2*8        // .......................................*..
        sh x27, 2*4(x10)          // ........................................*.
        sh x8, 2*0(x10)           // .........................................*
        addi x10, x10, 2*8        // .........................................*

                                   // ----------- cycle (expected) ------------>
                                   // 0                        25
                                   // |------------------------|----------------
        // mul x7, x28, x1         // .*........................................
        // lh x26, 2*1(x11)        // ...................*......................
        // lh x1, 2*0(x12)         // .*........................................
        // add x27, x18, x24       // *.........................................
        // lh x3, 2*6(x11)         // ...............*..........................
        // add x31, x27, x25       // ..*.......................................
        // lh x27, 2*0(x11)        // *.........................................
        // addi x11, x11, 2*8      // .......................................*..
        // lw x5, 4*5(x14)         // ......*...................................
        // mul x8, x8, x16         // ..................*.......................
        // mul x29, x26, x1        // ......................*...................
        // lh x21, 2*6(x12)        // ..*.......................................
        // mul x30, x3, x22        // ...................*......................
        // mul x4, x19, x23        // ....*.....................................
        // lh x22, 2*0(x13)        // .....*....................................
        // add x23, x5, x7         // ........*.................................
        // lh x7, 2*3(x13)         // ...*......................................
        // mul x28, x9, x21        // .............*............................
        // mul x19, x27, x1        // ..........*...............................
        // lw x5, 4*7(x14)         // .....................*....................
        // lh x1, 2*1(x12)         // .................*........................
        // addi x12, x12, 2*8      // ......................................*...
        // lh x20, 2*1(x13)        // ....*.....................................
        // add x30, x5, x30        // .......................*..................
        // mul x18, x9, x7         // ......*...................................
        // add x23, x23, x4        // .........*................................
        // mul x5, x3, x21         // ....................*.....................
        // mul x26, x26, x22       // ..........................*...............
        // lw x25, 4*6(x14)        // ............*.............................
        // mul x24, x17, x20       // .......*..................................
        // lw x20, 4*1(x14)        // .......................*..................
        // add x30, x30, x28       // ........................*.................
        // mul x17, x23, x16       // ..........*...............................
        // mul x21, x30, x16       // .........................*................
        // add x23, x25, x5        // ........................*.................
        // add x4, x23, x18        // ...........................*..............
        // srai x18, x17, 16       // ..............*...........................
        // mul x23, x4, x16        // ............................*.............
        // addi x17, x18, 8        // ...............*..........................
        // srai x4, x21, 16        // .............................*............
        // mulh x30, x17, x15      // ................*.........................
        // addi x25, x4, 8         // ..............................*...........
        // mulh x25, x25, x15      // ................................*.........
        // srai x18, x23, 16       // .................................*........
        // addi x18, x18, 8        // ..................................*.......
        // mulh x4, x18, x15       // ...................................*......
        // mul x18, x31, x16       // ...*......................................
        // srai x31, x8, 16        // .............................*............
        // sh x25, 2*7(x10)        // .....................................*....
        // addi x7, x31, 8         // ..................................*.......
        // lw x17, 4*0(x14)        // ...........*..............................
        // mulh x8, x7, x15        // ....................................*.....
        // addi x14, x14, 4*8      // ............................*.............
        // sh x4, 2*6(x10)         // .......................................*..
        // mul x21, x27, x1        // .....................*....................
        // sh x30, 2*5(x10)        // ....................*.....................
        // add x6, x6, x24         // ...........*..............................
        // add x17, x17, x19       // ..............*...........................
        // sh x8, 2*4(x10)         // ........................................*.
        // mul x27, x6, x16        // ............*.............................
        // add x17, x17, x26       // ..............................*...........
        // srai x8, x18, 16        // .......*..................................
        // add x21, x20, x21       // .........................*................
        // add x21, x21, x29       // ..........................*...............
        // addi x13, x13, 2*4      // .....*....................................
        // mul x23, x21, x16       // ...........................*..............
        // mul x26, x17, x16       // ...............................*..........
        // addi x29, x8, 8         // ........*.................................
        // mulh x20, x29, x15      // .........*................................
        // srai x8, x27, 16        // ................*.........................
        // srai x30, x23, 16       // ...............................*..........
        // srai x26, x26, 16       // ...................................*......
        // addi x27, x30, 8        // ................................*.........
        // addi x17, x8, 8         // .................*........................
        // addi x6, x26, 8         // ....................................*.....
        // mulh x21, x17, x15      // ..................*.......................
        // mulh x25, x27, x15      // .................................*........
        // mulh x5, x6, x15        // .....................................*....
        // sh x21, 2*2(x10)        // ......................*...................
        // sh x25, 2*1(x10)        // ......................................*...
        // sh x20, 2*3(x10)        // .............*............................
        // sh x5, 2*0(x10)         // .........................................*
        // addi x10, x10, 2*8      // .........................................*

    restore_regs
    addi sp, sp, 8*16
ret