.macro save_regs
  sd s0,  0*8(sp)
  sd s1,  1*8(sp)
  sd s2,  2*8(sp)
  sd s3,  3*8(sp)
  sd s4,  4*8(sp)
  sd s5,  5*8(sp)
  sd s6,  6*8(sp)
  sd s7,  7*8(sp)
  sd s8,  8*8(sp)
  sd s9,  9*8(sp)
  sd s10, 10*8(sp)
  sd s11, 11*8(sp)
  sd gp,  12*8(sp)
  sd tp,  13*8(sp)
  sd ra,  14*8(sp)
.endm

.macro restore_regs
  ld s0,  0*8(sp)
  ld s1,  1*8(sp)
  ld s2,  2*8(sp)
  ld s3,  3*8(sp)
  ld s4,  4*8(sp)
  ld s5,  5*8(sp)
  ld s6,  6*8(sp)
  ld s7,  7*8(sp)
  ld s8,  8*8(sp)
  ld s9,  9*8(sp)
  ld s10, 10*8(sp)
  ld s11, 11*8(sp)
  ld gp,  12*8(sp)
  ld tp,  13*8(sp)
  ld ra,  14*8(sp)
.endm

.macro plant_red_x4 q32, qinv, a_0, a_1, a_2, a_3
  mul  \a_0, \a_0, \qinv
  mul  \a_1, \a_1, \qinv
  mul  \a_2, \a_2, \qinv
  mul  \a_3, \a_3, \qinv
  srai \a_0, \a_0, 32
  srai \a_1, \a_1, 32
  srai \a_2, \a_2, 32
  srai \a_3, \a_3, 32
  addi \a_0, \a_0, 256
  addi \a_1, \a_1, 256
  addi \a_2, \a_2, 256
  addi \a_3, \a_3, 256
  mulh \a_0, \a_0, \q32
  mulh \a_1, \a_1, \q32
  mulh \a_2, \a_2, \q32
  mulh \a_3, \a_3, \q32
.endm

.equ q,    8380417
.equ q32,  0x7fe00100000000               // q << 32
.equ qinv, 0x180a406003802001             // q^-1 mod 2^64
.equ plantconst, 0x200801c0602            // (((-2**64) % q) * qinv) % (2**64)
.equ plantconst2, 0xb7b9f10ccf939804      // (((-2**64) % q) * ((-2**64) % q) * qinv) % (2**64)

# void poly_basemul_8l_acc_end_rv64im(int32_t r[256], const int32_t a[256], const int32_t b[256], int64_t r_double[256])
.globl poly_basemul_8l_acc_end_rv64im_opt_c908_dual
.align 2
poly_basemul_8l_acc_end_rv64im_opt_c908_dual:
    addi sp, sp, -8*16
    save_regs
    li a4, q32
    li a5, qinv
    // loop control
    li  gp, 32*8*4
    add gp, gp, a0
    sd  gp, 8*15(sp)
                                // Instructions:    12
                                // Expected cycles: 9
                                // Expected IPC:    1.33
                                //
                                // Cycle bound:     9.0
                                // IPC bound:       1.33
                                //
                                // Wall time:     0.07s
                                // User time:     0.07s
                                //
                                // ----- cycle (expected) ------>
                                // 0                        25
                                // |------------------------|----
        lw x26, 1*4(x11)        // *.............................
        lw x16, 3*4(x12)        // .*............................
        lw x7, 7*4(x12)         // ..*...........................
        lw x9, 3*4(x11)         // ...*..........................
        lw x21, 7*4(x11)        // ....*.........................
        mul x9, x9, x16         // .....*........................
        lw x1, 2*4(x12)         // .....*........................
        mul x8, x21, x7         // ......*.......................
        lw x21, 2*4(x11)        // ......*.......................
        lw x5, 1*4(x12)         // .......*......................
        mul x1, x21, x1         // ........*.....................
        ld x3, 2*8(x13)         // ........*.....................

                                 // ------ cycle (expected) ------>
                                 // 0                        25
                                 // |------------------------|-----
        // lw x26, 1*4(x11)      // *..............................
        // lw x5, 1*4(x12)       // .......*.......................
        // lw x4, 3*4(x12)       // .*.............................
        // lw x16, 7*4(x12)      // ..*............................
        // lw x22, 7*4(x11)      // ....*..........................
        // lw x1, 2*4(x12)       // .....*.........................
        // lw x29, 2*4(x11)      // ......*........................
        // lw x27, 3*4(x11)      // ...*...........................
        // mul x1, x29, x1       // ........*......................
        // mul x8, x22, x16      // ......*........................
        // ld x3, 2*8(x13)       // ........*......................
        // mul x9, x27, x4       // .....*.........................

        addi gp, gp, 32
poly_basemul_8l_acc_end_rv64im_looper:
                                  // Instructions:    84
                                  // Expected cycles: 42
                                  // Expected IPC:    2.00
                                  //
                                  // Cycle bound:     44.0
                                  // IPC bound:       1.91
                                  //
                                  // Wall time:     77.34s
                                  // User time:     77.34s
                                  //
                                  // ----------- cycle (expected) ------------>
                                  // 0                        25
                                  // |------------------------|----------------
        ld x20, 7*8(x13)          // *.........................................
        add x1, x1, x3            // *.........................................
        lw x21, 0*4(x11)          // .*........................................
        mul x29, x1, x15          // .*........................................
        lw x28, 6*4(x11)          // ..*.......................................
        add x16, x8, x20          // ..*.......................................
        mul x27, x26, x5          // ...*......................................
        lw x1, 4*4(x11)           // ...*......................................
        lw x19, 5*4(x11)          // ....*.....................................
        addi x11, x11, 4*8        // ....*.....................................
        srai x6, x29, 32          // .....*....................................
        lw x5, 6*4(x12)           // .....*....................................
        addi x7, x6, 256          // ......*...................................
        lw x31, 0*4(x12)          // ......*...................................
        lw x26, 1*4(x11)          // .......e..................................
        mulh x25, x7, x14         // .......*..................................
        lw x23, 5*4(x12)          // ........*.................................
        mul x18, x21, x31         // ........*.................................
        lw x8, 4*4(x12)           // .........*................................
        mul x22, x28, x5          // .........*................................
        ld x3, 6*8(x13)           // ..........*...............................
        addi x12, x12, 4*8        // ..........*...............................
        lw x5, 1*4(x12)           // ...........e..............................
        mul x21, x19, x23         // ...........*..............................
        ld x31, 0*8(x13)          // ............*.............................
        mul x23, x1, x8           // ............*.............................
        add x29, x22, x3          // .............*............................
        ld x8, 5*8(x13)           // .............*............................
        ld x20, 1*8(x13)          // ..............*...........................
        add x6, x18, x31          // ..............*...........................
        mul x19, x6, x15          // ...............*..........................
        add x31, x21, x8          // ...............*..........................
        mul x18, x31, x15         // ................*.........................
        mul x31, x16, x15         // ................*.........................
        add x27, x27, x20         // .................*........................
        ld x8, 4*8(x13)           // .................*........................
        mul x30, x27, x15         // ..................*.......................
        lw x4, 3*4(x12)           // ..................e.......................
        srai x7, x19, 32          // ...................*......................
        ld x20, 3*8(x13)          // ...................*......................
        srai x21, x18, 32         // ....................*.....................
        srai x28, x31, 32         // ....................*.....................
        addi x18, x28, 256        // .....................*....................
        addi x28, x21, 256        // .....................*....................
        mulh x1, x18, x14         // ......................*...................
        mulh x6, x28, x14         // ......................*...................
        sw x25, 2*4(x10)          // .......................*..................
        addi x27, x7, 256         // .......................*..................
        add x31, x9, x20          // ........................*.................
        mulh x28, x27, x14        // ........................*.................
        mul x31, x31, x15         // .........................*................
        srai x9, x30, 32          // .........................*................
        sw x6, 5*4(x10)           // ..........................*...............
        addi x16, x9, 256         // ..........................*...............
        sw x1, 7*4(x10)           // ...........................*..............
        mulh x19, x16, x14        // ...........................*..............
        sw x28, 0*4(x10)          // ............................*.............
        mul x27, x29, x15         // ............................*.............
        add x20, x23, x8          // .............................*............
        srai x7, x31, 32          // .............................*............
        addi x29, x7, 256         // ..............................*...........
        mul x23, x20, x15         // ..............................*...........
        sw x19, 1*4(x10)          // ...............................*..........
        mulh x25, x29, x14        // ...............................*..........
        srai x29, x27, 32         // ................................*.........
        lw x16, 7*4(x12)          // ................................e.........
        lw x22, 7*4(x11)          // .................................e........
        addi x8, x29, 256         // .................................*........
        lw x1, 2*4(x12)           // ..................................e.......
        mulh x6, x8, x14          // ..................................*.......
        srai x31, x23, 32         // ...................................*......
        sw x25, 3*4(x10)          // ...................................*......
        lw x29, 2*4(x11)          // ....................................e.....
        addi x21, x31, 256        // ....................................*.....
        lw x27, 3*4(x11)          // .....................................e....
        mulh x24, x21, x14        // .....................................*....
        sw x6, 6*4(x10)           // ......................................*...
        mul x1, x29, x1           // ......................................e...
        addi x13, x13, 8*8        // .......................................*..
        ld x3, 8*15(x2)           // .......................................*.. // @slothy:ignore_useless_output
        mul x8, x22, x16          // ........................................e.
        ld x3, 2*8(x13)           // ........................................e.
        sw x24, 4*4(x10)          // .........................................*
        mul x9, x27, x4           // .........................................e

                                   // ----------------------------- cycle (expected) ----------------------------->
                                   // 0                        25                       50                       75
                                   // |------------------------|------------------------|------------------------|-
        // lw x5, 0*4(x11)         // ...................................'*........................................
        // lw x6, 1*4(x11)         // e..................................'......~..................................
        // lw x8, 0*4(x12)         // ...................................'.....*...................................
        // lw x9, 1*4(x12)         // ....e..............................'..........~..............................
        // ld x16, 0*8(x13)        // .....~.............................'...........*.............................
        // ld x17, 1*8(x13)        // .......~...........................'.............*...........................
        // lw x7, 2*4(x11)         // .............................e.....'...................................~.....
        // lw x28, 3*4(x11)        // ..............................e....'....................................~....
        // lw x18, 2*4(x12)        // ...........................e.......'.................................~.......
        // lw x19, 3*4(x12)        // ...........e.......................'.................~.......................
        // mul x24, x5, x8         // .~.................................'.......*.................................
        // mul x25, x6, x9         // ...................................'..*......................................
        // ld x3, 2*8(x13)         // .................................e.'.......................................~.
        // ld x1, 3*8(x13)         // ............~......................'..................*......................
        // lw x29, 4*4(x11)        // ...................................'..*......................................
        // lw x30, 5*4(x11)        // ...................................'...*.....................................
        // mul x26, x7, x18        // ...............................e...'.....................................~...
        // mul x27, x28, x19       // ..................................e'.........................................
        // lw x20, 4*4(x12)        // ..~................................'........*................................
        // lw x21, 5*4(x12)        // .~.................................'.......*.................................
        // add x24, x24, x16       // .......~...........................'.............*...........................
        // add x25, x25, x17       // ..........~........................'................*........................
        // lw x31, 6*4(x11)        // ...................................'.*.......................................
        // lw x4, 7*4(x11)         // ..........................e........'................................~........
        // add x26, x26, x3        // ...................................*.........................................
        // add x27, x27, x1        // .................~.................'.......................*.................
        // lw x22, 6*4(x12)        // ...................................'....*....................................
        // lw x23, 7*4(x12)        // .........................e.........'...............................~.........
        // mul  x24, x24, x15      // ........~..........................'..............*..........................
        // mul  x25, x25, x15      // ...........~.......................'.................*.......................
        // mul  x26, x26, x15      // ...................................'*........................................
        // mul  x27, x27, x15      // ..................~................'........................*................
        // srai x24, x24, 32       // ............~......................'..................*......................
        // srai x25, x25, 32       // ..................~................'........................*................
        // srai x26, x26, 32       // ...................................'....*....................................
        // srai x27, x27, 32       // ......................~............'............................*............
        // addi x24, x24, 256      // ................~..................'......................*..................
        // addi x25, x25, 256      // ...................~...............'.........................*...............
        // addi x26, x26, 256      // ...................................'.....*...................................
        // addi x27, x27, 256      // .......................~...........'.............................*...........
        // mulh x24, x24, x14      // .................~.................'.......................*.................
        // mulh x25, x25, x14      // ....................~..............'..........................*..............
        // mulh x26, x26, x14      // ~..................................'......*..................................
        // mulh x27, x27, x14      // ........................~..........'..............................*..........
        // ld x16, 4*8(x13)        // ..........~........................'................*........................
        // ld x17, 5*8(x13)        // ......~............................'............*............................
        // sw x24, 0*4(x10)        // .....................~.............'...........................*.............
        // sw x25, 1*4(x10)        // ........................~..........'..............................*..........
        // mul x24, x29, x20       // .....~.............................'...........*.............................
        // mul x25, x30, x21       // ....~..............................'..........*..............................
        // sw x26, 2*4(x10)        // ................~..................'......................*..................
        // sw x27, 3*4(x10)        // ............................~......'..................................*......
        // ld x3, 6*8(x13)         // ...~...............................'.........*...............................
        // ld x1, 7*8(x13)         // ...................................*.........................................
        // mul x26, x31, x22       // ..~................................'........*................................
        // mul x27, x4, x23        // .................................e.'.......................................~.
        // add x24, x24, x16       // ......................~............'............................*............
        // add x25, x25, x17       // ........~..........................'..............*..........................
        // add x26, x26, x3        // ......~............................'............*............................
        // add x27, x27, x1        // ...................................'.*.......................................
        // mul  x24, x24, x15      // .......................~...........'.............................*...........
        // mul  x25, x25, x15      // .........~.........................'...............*.........................
        // mul  x26, x26, x15      // .....................~.............'...........................*.............
        // mul  x27, x27, x15      // .........~.........................'...............*.........................
        // srai x24, x24, 32       // ............................~......'..................................*......
        // srai x25, x25, 32       // .............~.....................'...................*.....................
        // srai x26, x26, 32       // .........................~.........'...............................*.........
        // srai x27, x27, 32       // .............~.....................'...................*.....................
        // addi x24, x24, 256      // .............................~.....'...................................*.....
        // addi x25, x25, 256      // ..............~....................'....................*....................
        // addi x26, x26, 256      // ..........................~........'................................*........
        // addi x27, x27, 256      // ..............~....................'....................*....................
        // mulh x24, x24, x14      // ..............................~....'....................................*....
        // mulh x25, x25, x14      // ...............~...................'.....................*...................
        // mulh x26, x26, x14      // ...........................~.......'.................................*.......
        // mulh x27, x27, x14      // ...............~...................'.....................*...................
        // ld  x3, 8*15(x2)        // ................................~..'......................................*..
        // addi x11, x11, 4*8      // ...................................'...*.....................................
        // addi x12, x12, 4*8      // ...~...............................'.........*...............................
        // addi x13, x13, 8*8      // ................................~..'......................................*..
        // sw x24, 4*4(x10)        // ..................................~'........................................*
        // sw x25, 5*4(x10)        // ...................~...............'.........................*...............
        // sw x26, 6*4(x10)        // ...............................~...'.....................................*...
        // sw x27, 7*4(x10)        // ....................~..............'..........................*..............

        addi gp, gp, 32
        bne gp, a0, poly_basemul_8l_acc_end_rv64im_looper
                                  // Instructions:    72
                                  // Expected cycles: 37
                                  // Expected IPC:    1.95
                                  //
                                  // Cycle bound:     36.0
                                  // IPC bound:       2.00
                                  //
                                  // Wall time:     89.29s
                                  // User time:     89.29s
                                  //
                                  // --------- cycle (expected) --------->
                                  // 0                        25
                                  // |------------------------|-----------
        add x31, x1, x3           // *....................................
        ld x1, 7*8(x13)           // *....................................
        lw x21, 0*4(x11)          // .*...................................
        mul x31, x31, x15         // .*...................................
        lw x27, 4*4(x12)          // ..*..................................
        add x29, x8, x1           // ..*..................................
        mul x25, x29, x15         // ...*.................................
        lw x1, 4*4(x11)           // ...*.................................
        lw x4, 6*4(x11)           // ....*................................
        mul x18, x26, x5          // ....*................................
        mul x26, x1, x27          // .....*...............................
        lw x22, 6*4(x12)          // .....*...............................
        srai x6, x31, 32          // ......*..............................
        ld x20, 3*8(x13)          // ......*..............................
        mul x24, x4, x22          // .......*.............................
        ld x5, 4*8(x13)           // .......*.............................
        add x20, x9, x20          // ........*............................
        lw x1, 5*4(x11)           // ........*............................
        mul x20, x20, x15         // .........*...........................
        add x26, x26, x5          // .........*...........................
        mul x5, x26, x15          // ..........*..........................
        ld x27, 1*8(x13)          // ..........*..........................
        srai x4, x25, 32          // ...........*.........................
        ld x31, 0*8(x13)          // ...........*.........................
        addi x11, x11, 4*8        // ............*........................
        ld x3, 6*8(x13)           // ............*........................
        srai x9, x20, 32          // .............*.......................
        add x28, x18, x27         // .............*.......................
        srai x26, x5, 32          // ..............*......................
        mul x22, x28, x15         // ..............*......................
        add x17, x24, x3          // ...............*.....................
        lw x29, 0*4(x12)          // ...............*.....................
        mul x5, x17, x15          // ................*....................
        ld x27, 5*8(x13)          // ................*....................
        lw x16, 5*4(x12)          // .................*...................
        mul x29, x21, x29         // .................*...................
        addi x19, x6, 256         // ..................*..................
        addi x30, x9, 256         // ..................*..................
        mul x24, x1, x16          // ...................*.................
        srai x6, x22, 32          // ...................*.................
        srai x20, x5, 32          // ....................*................
        mulh x18, x30, x14        // ....................*................
        mulh x1, x19, x14         // .....................*...............
        add x25, x29, x31         // .....................*...............
        addi x17, x20, 256        // ......................*..............
        mul x31, x25, x15         // ......................*..............
        add x20, x24, x27         // .......................*.............
        ld x3, 8*15(x2)           // .......................*............. // @slothy:ignore_useless_output
        mul x29, x20, x15         // ........................*............
        addi x7, x26, 256         // ........................*............
        sw x18, 3*4(x10)          // .........................*...........
        addi x24, x4, 256         // .........................*...........
        srai x4, x31, 32          // ..........................*..........
        mulh x5, x17, x14         // ..........................*..........
        addi x31, x4, 256         // ...........................*.........
        sw x1, 2*4(x10)           // ...........................*.........
        mulh x20, x31, x14        // ............................*........
        srai x17, x29, 32         // ............................*........
        addi x29, x17, 256        // .............................*.......
        mulh x26, x7, x14         // .............................*.......
        addi x31, x6, 256         // ..............................*......
        mulh x27, x29, x14        // ..............................*......
        sw x5, 6*4(x10)           // ...............................*.....
        mulh x5, x31, x14         // ...............................*.....
        sw x20, 0*4(x10)          // ................................*....
        mulh x29, x24, x14        // ................................*....
        sw x26, 4*4(x10)          // .................................*...
        addi x12, x12, 4*8        // ..................................*..
        sw x27, 5*4(x10)          // ..................................*..
        sw x5, 1*4(x10)           // ...................................*.
        sw x29, 7*4(x10)          // ....................................*
        addi x13, x13, 8*8        // ....................................*

                                   // --------- cycle (expected) --------->
                                   // 0                        25
                                   // |------------------------|-----------
        // ld x20, 7*8(x13)        // *....................................
        // add x1, x1, x3          // *....................................
        // lw x21, 0*4(x11)        // .*...................................
        // mul x29, x1, x15        // .*...................................
        // lw x28, 6*4(x11)        // ....*................................
        // add x16, x8, x20        // ..*..................................
        // mul x27, x26, x5        // ....*................................
        // lw x1, 4*4(x11)         // ...*.................................
        // lw x19, 5*4(x11)        // ........*............................
        // addi x11, x11, 4*8      // ............*........................
        // srai x6, x29, 32        // ......*..............................
        // lw x5, 6*4(x12)         // .....*...............................
        // addi x7, x6, 256        // ..................*..................
        // lw x31, 0*4(x12)        // ...............*.....................
        // mulh x25, x7, x14       // .....................*...............
        // lw x23, 5*4(x12)        // .................*...................
        // mul x18, x21, x31       // .................*...................
        // lw x8, 4*4(x12)         // ..*..................................
        // mul x22, x28, x5        // .......*.............................
        // ld x3, 6*8(x13)         // ............*........................
        // addi x12, x12, 4*8      // ..................................*..
        // mul x21, x19, x23       // ...................*.................
        // ld x31, 0*8(x13)        // ...........*.........................
        // mul x23, x1, x8         // .....*...............................
        // add x29, x22, x3        // ...............*.....................
        // ld x8, 5*8(x13)         // ................*....................
        // ld x20, 1*8(x13)        // ..........*..........................
        // add x6, x18, x31        // .....................*...............
        // mul x19, x6, x15        // ......................*..............
        // add x31, x21, x8        // .......................*.............
        // mul x18, x31, x15       // ........................*............
        // mul x31, x16, x15       // ...*.................................
        // add x27, x27, x20       // .............*.......................
        // ld x8, 4*8(x13)         // .......*.............................
        // mul x30, x27, x15       // ..............*......................
        // srai x7, x19, 32        // ..........................*..........
        // ld x20, 3*8(x13)        // ......*..............................
        // srai x21, x18, 32       // ............................*........
        // srai x28, x31, 32       // ...........*.........................
        // addi x18, x28, 256      // .........................*...........
        // addi x28, x21, 256      // .............................*.......
        // mulh x1, x18, x14       // ................................*....
        // mulh x6, x28, x14       // ..............................*......
        // sw x25, 2*4(x10)        // ...........................*.........
        // addi x27, x7, 256       // ...........................*.........
        // add x31, x9, x20        // ........*............................
        // mulh x28, x27, x14      // ............................*........
        // mul x31, x31, x15       // .........*...........................
        // srai x9, x30, 32        // ...................*.................
        // sw x6, 5*4(x10)         // ..................................*..
        // addi x16, x9, 256       // ..............................*......
        // sw x1, 7*4(x10)         // ....................................*
        // mulh x19, x16, x14      // ...............................*.....
        // sw x28, 0*4(x10)        // ................................*....
        // mul x27, x29, x15       // ................*....................
        // add x20, x23, x8        // .........*...........................
        // srai x7, x31, 32        // .............*.......................
        // addi x29, x7, 256       // ..................*..................
        // mul x23, x20, x15       // ..........*..........................
        // sw x19, 1*4(x10)        // ...................................*.
        // mulh x25, x29, x14      // ....................*................
        // srai x29, x27, 32       // ....................*................
        // addi x8, x29, 256       // ......................*..............
        // mulh x6, x8, x14        // ..........................*..........
        // srai x31, x23, 32       // ..............*......................
        // sw x25, 3*4(x10)        // .........................*...........
        // addi x21, x31, 256      // ........................*............
        // mulh x24, x21, x14      // .............................*.......
        // sw x6, 6*4(x10)         // ...............................*.....
        // addi x13, x13, 8*8      // ....................................*
        // ld x3, 8*15(x2)         // .......................*.............
        // sw x24, 4*4(x10)        // .................................*...

    restore_regs
    addi sp, sp, 8*16
    ret