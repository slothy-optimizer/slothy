.macro save_regs
  sd s0,  0*8(sp)
  sd s1,  1*8(sp)
  sd s2,  2*8(sp)
  sd s3,  3*8(sp)
  sd s4,  4*8(sp)
  sd s5,  5*8(sp)
  sd s6,  6*8(sp)
  sd s7,  7*8(sp)
  sd s8,  8*8(sp)
  sd s9,  9*8(sp)
  sd s10, 10*8(sp)
  sd s11, 11*8(sp)
  sd gp,  12*8(sp)
  sd tp,  13*8(sp)
  sd ra,  14*8(sp)
.endm

.macro restore_regs
  ld s0,  0*8(sp)
  ld s1,  1*8(sp)
  ld s2,  2*8(sp)
  ld s3,  3*8(sp)
  ld s4,  4*8(sp)
  ld s5,  5*8(sp)
  ld s6,  6*8(sp)
  ld s7,  7*8(sp)
  ld s8,  8*8(sp)
  ld s9,  9*8(sp)
  ld s10, 10*8(sp)
  ld s11, 11*8(sp)
  ld gp,  12*8(sp)
  ld tp,  13*8(sp)
  ld ra,  14*8(sp)
.endm

.macro plant_red_x4 q32, qinv, a_0, a_1, a_2, a_3
  mul  \a_0, \a_0, \qinv
  mul  \a_1, \a_1, \qinv
  mul  \a_2, \a_2, \qinv
  mul  \a_3, \a_3, \qinv
  srai \a_0, \a_0, 32
  srai \a_1, \a_1, 32
  srai \a_2, \a_2, 32
  srai \a_3, \a_3, 32
  addi \a_0, \a_0, 256
  addi \a_1, \a_1, 256
  addi \a_2, \a_2, 256
  addi \a_3, \a_3, 256
  mulh \a_0, \a_0, \q32
  mulh \a_1, \a_1, \q32
  mulh \a_2, \a_2, \q32
  mulh \a_3, \a_3, \q32
.endm

.equ q,    8380417
.equ q32,  0x7fe00100000000               // q << 32
.equ qinv, 0x180a406003802001             // q^-1 mod 2^64
.equ plantconst, 0x200801c0602            // (((-2**64) % q) * qinv) % (2**64)
.equ plantconst2, 0xb7b9f10ccf939804      // (((-2**64) % q) * ((-2**64) % q) * qinv) % (2**64)

# void poly_basemul_8l_acc_end_rv64im(int32_t r[256], const int32_t a[256], const int32_t b[256], int64_t r_double[256])
.globl poly_basemul_8l_acc_end_rv64im_dual_opt_c908
.align 2
poly_basemul_8l_acc_end_rv64im_dual_opt_c908:
    addi sp, sp, -8*16
    save_regs
    li a4, q32
    li a5, qinv
    // loop control
    li  gp, 32*8*4
    add gp, gp, a0
    sd  gp, 8*15(sp)
                                 // Instructions:    10
                                 // Expected cycles: 8
                                 // Expected IPC:    1.25
                                 //
                                 // Cycle bound:     8.0
                                 // IPC bound:       1.25
                                 //
                                 // Wall time:     0.06s
                                 // User time:     0.06s
                                 //
                                 // ----- cycle (expected) ------>
                                 // 0                        25
                                 // |------------------------|----
        // lw x21, 2*4(x12)         // *.............................
        // lw x1, 2*4(x11)          // .*............................
        // lw x16, 5*4(x12)         // ..*...........................
        // mul x19, x1, x21         // ...*..........................
        // lw x17, 5*4(x11)         // ...*..........................
        // lw x21, 7*4(x12)         // ....*.........................
        // mul x17, x17, x16        // .....*........................
        // lw x28, 7*4(x11)         // .....*........................
        // ld x22, 5*8(x13)         // ......*.......................
        // mul x6, x28, x21         // .......*......................

                                  // ------ cycle (expected) ------>
                                  // 0                        25
                                  // |------------------------|-----
        lw x18, 2*4(x12)       // *..............................
        lw x5, 5*4(x12)        // ..*............................
        lw x26, 5*4(x11)       // ...*...........................
        lw x21, 2*4(x11)       // .*.............................
        lw x9, 7*4(x12)        // ....*..........................
        lw x1, 7*4(x11)        // .....*.........................
        mul x17, x26, x5       // .....*.........................
        mul x6, x1, x9         // .......*.......................
        ld x22, 5*8(x13)       // ......*........................
        mul x19, x21, x18      // ...*...........................

        addi gp, gp, -32
poly_basemul_8l_acc_end_rv64im_looper:
                                  // Instructions:    84
                                  // Expected cycles: 42
                                  // Expected IPC:    2.00
                                  //
                                  // Cycle bound:     48.0
                                  // IPC bound:       1.75
                                  //
                                  // Wall time:     161.00s
                                  // User time:     161.00s
                                  //
                                  // ----------- cycle (expected) ------------>
                                  // 0                        25
                                  // |------------------------|----------------
        // ld x9, 7*8(x13)           // *.........................................
        // add x28, x17, x22         // *.........................................
        // lw x21, 0*4(x11)          // .*........................................
        // mul x22, x28, x15         // .*........................................
        // add x31, x6, x9           // ..*.......................................
        // ld x3, 2*8(x13)           // ..*.......................................
        // ld x18, 1*8(x13)          // ...*......................................
        // mul x17, x31, x15         // ...*......................................
        // lw x8, 1*4(x11)           // ....*.....................................
        // add x26, x19, x3          // ....*.....................................
        // srai x5, x22, 32          // .....*....................................
        // lw x20, 1*4(x12)          // .....*....................................
        // mul x7, x26, x15          // ......*...................................
        // lw x25, 4*4(x12)          // ......*...................................
        // ld x1, 4*8(x13)           // .......*..................................
        // addi x30, x5, 256         // .......*..................................
        // mul x26, x8, x20          // ........*.................................
        // lw x31, 6*4(x12)          // ........*.................................
        // srai x17, x17, 32         // .........*................................
        // lw x20, 0*4(x12)          // .........*................................
        // lw x19, 3*4(x12)          // ..........*...............................
        // addi x12, x12, 4*8        // ..........*...............................
        // ld x27, 0*8(x13)          // ...........*..............................
        // srai x9, x7, 32           // ...........*..............................
        // add x28, x26, x18         // ............*.............................
        // lw x26, 4*4(x11)          // ............*.............................
        // mul x7, x21, x20          // .............*............................
        // lw x24, 6*4(x11)          // .............*............................
        // addi x8, x9, 256          // ..............*...........................
        // lw x20, 3*4(x11)          // ..............*...........................
        // lw x18, 2*4(x12)          // ...............e..........................
        // addi x11, x11, 4*8        // ...............*..........................
        // mulh x9, x8, x14          // ................*.........................
        // lw x5, 5*4(x12)           // ................e.........................
        // mul x23, x26, x25         // .................*........................
        // ld x3, 6*8(x13)           // .................*........................
        // mul x22, x24, x31         // ..................*.......................
        // lw x26, 5*4(x11)          // ..................e.......................
        // ld x8, 3*8(x13)           // ...................*......................
        // mul x31, x28, x15         // ...................*......................
        // mul x28, x20, x19         // ....................*.....................
        // add x25, x7, x27          // ....................*.....................
        // sw x9, 2*4(x10)           // .....................*....................
        // mul x24, x25, x15         // .....................*....................
        // add x29, x23, x1          // ......................*...................
        // add x9, x22, x3           // ......................*...................
        // addi x25, x17, 256        // .......................*..................
        // mul x1, x29, x15          // .......................*..................
        // add x23, x28, x8          // ........................*.................
        // mul x4, x9, x15           // ........................*.................
        // mulh x19, x30, x14        // .........................*................
        // ld x3, 8*15(x2)           // .........................*................ // @slothy:ignore_useless_output
        // lw x21, 2*4(x11)          // ..........................e...............
        // mulh x27, x25, x14        // ..........................*...............
        // lw x9, 7*4(x12)           // ...........................e..............
        // srai x8, x1, 32           // ...........................*..............
        // mul x23, x23, x15         // ............................*.............
        // addi x8, x8, 256          // ............................*.............
        // mulh x20, x8, x14         // .............................*............
        // srai x25, x31, 32         // .............................*............
        // sw x27, 7*4(x10)          // ..............................*...........
        // srai x27, x4, 32          // ..............................*...........
        // addi x17, x25, 256        // ...............................*..........
        // sw x19, 5*4(x10)          // ...............................*..........
        // addi x8, x27, 256         // ................................*.........
        // srai x30, x23, 32         // ................................*.........
        // addi x7, x30, 256         // .................................*........
        // mulh x17, x17, x14        // .................................*........
        // mulh x27, x7, x14         // ..................................*.......
        // sw x20, 4*4(x10)          // ..................................*.......
        // mulh x8, x8, x14          // ...................................*......
        // srai x25, x24, 32         // ...................................*......
        // lw x1, 7*4(x11)           // ....................................e.....
        // addi x20, x25, 256        // ....................................*.....
        // sw x17, 1*4(x10)          // .....................................*....
        // mulh x20, x20, x14        // .....................................*....
        // sw x27, 3*4(x10)          // ......................................*...
        // mul x17, x26, x5          // ......................................e...
        // addi x13, x13, 8*8        // .......................................*..
        // sw x8, 6*4(x10)           // .......................................*..
        // mul x6, x1, x9            // ........................................e.
        // ld x22, 5*8(x13)          // ........................................e.
        // sw x20, 0*4(x10)          // .........................................*
        // mul x19, x21, x18         // .........................................e

                                   // ------------------------- cycle (expected) ------------------------->
                                   // 0                        25                       50
                                   // |------------------------|------------------------|------------------
        lw x5, 0*4(x11)         // ...........................'*........................................
        lw x6, 1*4(x11)         // ...........................'...*.....................................
        lw x8, 0*4(x12)         // ...........................'........*................................
        lw x9, 1*4(x12)         // ...........................'....*....................................
        ld x16, 0*8(x13)        // ...........................'..........*..............................
        ld x17, 1*8(x13)        // ...........................'..*......................................
        lw x7, 2*4(x11)         // ...........e...............'.........................~...............
        lw x28, 3*4(x11)        // ...........................'.............*...........................
        lw x18, 2*4(x12)        // e..........................'..............~..........................
        lw x19, 3*4(x12)        // ...........................'.........*...............................
        mul x24, x5, x8         // ...........................'............*............................
        mul x25, x6, x9         // ...........................'.......*.................................
        ld x3, 2*8(x13)         // ...........................'.*.......................................
        ld x1, 3*8(x13)         // ....~......................'..................*......................
        lw x29, 4*4(x11)        // ...........................'...........*.............................
        lw x30, 5*4(x11)        // ...e.......................'.................~.......................
        mul x26, x7, x18        // ..........................e'.........................................
        mul x27, x28, x19       // .....~.....................'...................*.....................
        lw x20, 4*4(x12)        // ...........................'.....*...................................
        lw x21, 5*4(x12)        // .e.........................'...............~.........................
        add x24, x24, x16       // .....~.....................'...................*.....................
        add x25, x25, x17       // ...........................'...........*.............................
        lw x31, 6*4(x11)        // ...........................'............*............................
        lw x4, 7*4(x11)         // .....................e.....'...................................~.....
        add x26, x26, x3        // ...........................'...*.....................................
        add x27, x27, x1        // .........~.................'.......................*.................
        lw x22, 6*4(x12)        // ...........................'.......*.................................
        lw x23, 7*4(x12)        // ............e..............'..........................~..............
        mul  x24, x24, x15      // ......~....................'....................*....................
        mul  x25, x25, x15      // ....~......................'..................*......................
        mul  x26, x26, x15      // ...........................'.....*...................................
        mul  x27, x27, x15      // .............~.............'...........................*.............
        srai x24, x24, 32       // ....................~......'..................................*......
        srai x25, x25, 32       // ..............~............'............................*............
        srai x26, x26, 32       // ...........................'..........*..............................
        srai x27, x27, 32       // .................~.........'...............................*.........
        addi x24, x24, 256      // .....................~.....'...................................*.....
        addi x25, x25, 256      // ................~..........'..............................*..........
        addi x26, x26, 256      // ...........................'.............*...........................
        addi x27, x27, 256      // ..................~........'................................*........
        mulh x24, x24, x14      // ......................~....'....................................*....
        mulh x25, x25, x14      // ..................~........'................................*........
        mulh x26, x26, x14      // .~.........................'...............*.........................
        mulh x27, x27, x14      // ...................~.......'.................................*.......
        ld x16, 4*8(x13)        // ...........................'......*..................................
        ld x17, 5*8(x13)        // .........................e.'.......................................~.
        sw x24, 0*4(x10)        // ..........................~'........................................*
        sw x25, 1*4(x10)        // ......................~....'....................................*....
        mul x24, x29, x20       // ..~........................'................*........................
        mul x25, x30, x21       // .......................e...'.....................................~...
        sw x26, 2*4(x10)        // ......~....................'....................*....................
        sw x27, 3*4(x10)        // .......................~...'.....................................*...
        ld x3, 6*8(x13)         // ..~........................'................*........................
        ld x1, 7*8(x13)         // ...........................*.........................................
        mul x26, x31, x22       // ...~.......................'.................*.......................
        mul x27, x4, x23        // .........................e.'.......................................~.
        add x24, x24, x16       // .......~...................'.....................*...................
        add x25, x25, x17       // ...........................*.........................................
        add x26, x26, x3        // .......~...................'.....................*...................
        add x27, x27, x1        // ...........................'.*.......................................
        mul  x24, x24, x15      // ........~..................'......................*..................
        mul  x25, x25, x15      // ...........................'*........................................
        mul  x26, x26, x15      // .........~.................'.......................*.................
        mul  x27, x27, x15      // ...........................'..*......................................
        srai x24, x24, 32       // ............~..............'..........................*..............
        srai x25, x25, 32       // ...........................'....*....................................
        srai x26, x26, 32       // ...............~...........'.............................*...........
        srai x27, x27, 32       // ...........................'........*................................
        addi x24, x24, 256      // .............~.............'...........................*.............
        addi x25, x25, 256      // ...........................'......*..................................
        addi x26, x26, 256      // .................~.........'...............................*.........
        addi x27, x27, 256      // ........~..................'......................*..................
        mulh x24, x24, x14      // ..............~............'............................*............
        mulh x25, x25, x14      // ..........~................'........................*................
        mulh x26, x26, x14      // ....................~......'..................................*......
        mulh x27, x27, x14      // ...........~...............'.........................*...............
        ld  x3, 8*15(x2)        // ..........~................'........................*................
        addi x11, x11, 4*8      // ~..........................'..............*..........................
        addi x12, x12, 4*8      // ...........................'.........*...............................
        addi x13, x13, 8*8      // ........................~..'......................................*..
        sw x24, 4*4(x10)        // ...................~.......'.................................*.......
        sw x25, 5*4(x10)        // ................~..........'..............................*..........
        sw x26, 6*4(x10)        // ........................~..'......................................*..
        sw x27, 7*4(x10)        // ...............~...........'.............................*...........

        addi a0, a0, 32
        bne a0, gp, poly_basemul_8l_acc_end_rv64im_looper
                                  // Instructions:    74
                                  // Expected cycles: 38
                                  // Expected IPC:    1.95
                                  //
                                  // Cycle bound:     37.0
                                  // IPC bound:       2.00
                                  //
                                  // Wall time:     66.77s
                                  // User time:     66.77s
                                  //
                                  // --------- cycle (expected) ---------->
                                  // 0                        25
                                  // |------------------------|------------
        // add x8, x17, x22          // *.....................................
        // ld x21, 7*8(x13)          // *.....................................
        // ld x3, 2*8(x13)           // .*....................................
        // mul x8, x8, x15           // .*....................................
        // add x27, x6, x21          // ..*...................................
        // lw x17, 6*4(x12)          // ..*...................................
        // add x6, x19, x3           // ...*..................................
        // ld x3, 6*8(x13)           // ...*..................................
        // mul x21, x27, x15         // ....*.................................
        // lw x27, 6*4(x11)          // ....*.................................
        // lw x26, 3*4(x11)          // .....*................................
        // srai x19, x8, 32          // .....*................................
        // mul x8, x27, x17          // ......*...............................
        // lw x20, 3*4(x12)          // ......*...............................
        // lw x1, 0*4(x12)           // .......*..............................
        // addi x27, x19, 256        // .......*..............................
        // lw x19, 0*4(x11)          // ........*.............................
        // mul x18, x26, x20         // ........*.............................
        // ld x20, 3*8(x13)          // .........*............................
        // mulh x29, x27, x14        // .........*............................
        // mul x7, x19, x1           // ..........*...........................
        // add x17, x8, x3           // ..........*...........................
        // lw x26, 1*4(x11)          // ...........*..........................
        // mul x28, x17, x15         // ...........*..........................
        // ld x24, 0*8(x13)          // ............*.........................
        // add x22, x18, x20         // ............*.........................
        // mul x27, x22, x15         // .............*........................
        // lw x25, 4*4(x12)          // .............*........................
        // lw x20, 1*4(x12)          // ..............*.......................
        // add x8, x7, x24           // ..............*.......................
        // srai x5, x28, 32          // ...............*......................
        // mul x22, x8, x15          // ...............*......................
        // mul x26, x26, x20         // ................*.....................
        // addi x8, x5, 256          // ................*.....................
        // mulh x20, x8, x14         // .................*....................
        // srai x27, x27, 32         // .................*....................
        // ld x19, 1*8(x13)          // ..................*...................
        // addi x17, x27, 256        // ..................*...................
        // mulh x27, x17, x14        // ...................*..................
        // srai x8, x22, 32          // ...................*..................
        // addi x18, x8, 256         // ....................*.................
        // lw x7, 4*4(x11)           // ....................*.................
        // add x31, x26, x19         // .....................*................
        // sw x29, 5*4(x10)          // .....................*................
        // mul x30, x7, x25          // ......................*...............
        // mul x19, x6, x15          // ......................*...............
        // sw x20, 6*4(x10)          // .......................*..............
        // srai x9, x21, 32          // .......................*..............
        // ld x22, 4*8(x13)          // ........................*.............
        // addi x13, x13, 8*8        // ........................*.............
        // ld x3, 8*15(x2)           // .........................*............ // @slothy:ignore_useless_output
        // mul x26, x31, x15         // .........................*............
        // add x8, x30, x22          // ..........................*...........
        // srai x28, x19, 32         // ..........................*...........
        // sw x27, 3*4(x10)          // ...........................*..........
        // mul x24, x8, x15          // ...........................*..........
        // addi x20, x9, 256         // ............................*.........
        // addi x25, x28, 256        // ............................*.........
        // srai x8, x26, 32          // .............................*........
        // mulh x29, x20, x14        // .............................*........
        // mulh x27, x18, x14        // ..............................*.......
        // addi x17, x8, 256         // ..............................*.......
        // mulh x19, x25, x14        // ...............................*......
        // srai x8, x24, 32          // ...............................*......
        // mulh x26, x17, x14        // ................................*.....
        // addi x20, x8, 256         // ................................*.....
        // sw x29, 7*4(x10)          // .................................*....
        // mulh x8, x20, x14         // .................................*....
        // addi x11, x11, 4*8        // ..................................*...
        // sw x27, 0*4(x10)          // ..................................*...
        // sw x19, 2*4(x10)          // ...................................*..
        // addi x12, x12, 4*8        // ...................................*..
        // sw x26, 1*4(x10)          // ....................................*.
        // sw x8, 4*4(x10)           // .....................................*

                                   // --------- cycle (expected) ---------->
                                   // 0                        25
                                   // |------------------------|------------
        ld x9, 7*8(x13)         // *.....................................
        add x28, x17, x22       // *.....................................
        lw x21, 0*4(x11)        // ........*.............................
        mul x22, x28, x15       // .*....................................
        add x31, x6, x9         // ..*...................................
        ld x3, 2*8(x13)         // .*....................................
        ld x18, 1*8(x13)        // ..................*...................
        mul x17, x31, x15       // ....*.................................
        lw x8, 1*4(x11)         // ...........*..........................
        add x26, x19, x3        // ...*..................................
        srai x5, x22, 32        // .....*................................
        lw x20, 1*4(x12)        // ..............*.......................
        mul x7, x26, x15        // ......................*...............
        lw x25, 4*4(x12)        // .............*........................
        ld x1, 4*8(x13)         // ........................*.............
        addi x30, x5, 256       // .......*..............................
        mul x26, x8, x20        // ................*.....................
        lw x31, 6*4(x12)        // ..*...................................
        srai x17, x17, 32       // .......................*..............
        lw x20, 0*4(x12)        // .......*..............................
        lw x19, 3*4(x12)        // ......*...............................
        addi x12, x12, 4*8      // ...................................*..
        ld x27, 0*8(x13)        // ............*.........................
        srai x9, x7, 32         // ..........................*...........
        add x28, x26, x18       // .....................*................
        lw x26, 4*4(x11)        // ....................*.................
        mul x7, x21, x20        // ..........*...........................
        lw x24, 6*4(x11)        // ....*.................................
        addi x8, x9, 256        // ............................*.........
        lw x20, 3*4(x11)        // .....*................................
        addi x11, x11, 4*8      // ..................................*...
        mulh x9, x8, x14        // ...............................*......
        mul x23, x26, x25       // ......................*...............
        ld x3, 6*8(x13)         // ...*..................................
        mul x22, x24, x31       // ......*...............................
        ld x8, 3*8(x13)         // .........*............................
        mul x31, x28, x15       // .........................*............
        mul x28, x20, x19       // ........*.............................
        add x25, x7, x27        // ..............*.......................
        sw x9, 2*4(x10)         // ...................................*..
        mul x24, x25, x15       // ...............*......................
        add x29, x23, x1        // ..........................*...........
        add x9, x22, x3         // ..........*...........................
        addi x25, x17, 256      // ............................*.........
        mul x1, x29, x15        // ...........................*..........
        add x23, x28, x8        // ............*.........................
        mul x4, x9, x15         // ...........*..........................
        mulh x19, x30, x14      // .........*............................
        ld x3, 8*15(x2)         // .........................*............
        mulh x27, x25, x14      // .............................*........
        srai x8, x1, 32         // ...............................*......
        mul x23, x23, x15       // .............*........................
        addi x8, x8, 256        // ................................*.....
        mulh x20, x8, x14       // .................................*....
        srai x25, x31, 32       // .............................*........
        sw x27, 7*4(x10)        // .................................*....
        srai x27, x4, 32        // ...............*......................
        addi x17, x25, 256      // ..............................*.......
        sw x19, 5*4(x10)        // .....................*................
        addi x8, x27, 256       // ................*.....................
        srai x30, x23, 32       // .................*....................
        addi x7, x30, 256       // ..................*...................
        mulh x17, x17, x14      // ................................*.....
        mulh x27, x7, x14       // ...................*..................
        sw x20, 4*4(x10)        // .....................................*
        mulh x8, x8, x14        // .................*....................
        srai x25, x24, 32       // ...................*..................
        addi x20, x25, 256      // ....................*.................
        sw x17, 1*4(x10)        // ....................................*.
        mulh x20, x20, x14      // ..............................*.......
        sw x27, 3*4(x10)        // ...........................*..........
        addi x13, x13, 8*8      // ........................*.............
        sw x8, 6*4(x10)         // .......................*..............
        sw x20, 0*4(x10)        // ..................................*...

    restore_regs
    addi sp, sp, 8*16
    ret