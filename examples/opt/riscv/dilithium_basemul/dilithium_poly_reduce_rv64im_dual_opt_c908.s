.equ q,    8380417
.equ q32,  0x7fe00100000000               // q << 32
.equ qinv, 0x180a406003802001             // q^-1 mod 2^64
.equ plantconst, 0x200801c0602            // (((-2**64) % q) * qinv) % (2**64)
.equ plantconst2, 0xb7b9f10ccf939804      // (((-2**64) % q) * ((-2**64) % q) * qinv) % (2**64)

# void poly_reduce_rv64im(int32_t in[256]);
.globl poly_reduce_rv64im_opt_c908_dual
.align 2
poly_reduce_rv64im_opt_c908_dual:
    li a1, 4194304  # 1<<22
    li a2, q
    addi a3, a0, 64*4*4
                                 // Instructions:    4
                                 // Expected cycles: 4
                                 // Expected IPC:    1.00
                                 //
                                 // Cycle bound:     4.0
                                 // IPC bound:       1.00
                                 //
                                 // Wall time:     0.02s
                                 // User time:     0.02s
                                 //
                                 // ----- cycle (expected) ------>
                                 // 0                        25
                                 // |------------------------|----
        lw x22, 2*4(x10)         // *.............................
        lw x14, 3*4(x10)         // .*............................
        add x29, x22, x11        // ..*...........................
        add x6, x14, x11         // ...*..........................

                                  // ------ cycle (expected) ------>
                                  // 0                        25
                                  // |------------------------|-----
        // lw x22, 2*4(x10)       // *..............................
        // add x29, x22, x11      // ..*............................
        // lw x14, 3*4(x10)       // .*.............................
        // add x6, x14, x11       // ...*...........................

        addi a3, a3, 16
poly_reduce_rv64im_loop:
                                 // Instructions:    24
                                 // Expected cycles: 12
                                 // Expected IPC:    2.00
                                 //
                                 // Cycle bound:     16.0
                                 // IPC bound:       1.50
                                 //
                                 // Wall time:     2.52s
                                 // User time:     2.52s
                                 //
                                 // ----- cycle (expected) ------>
                                 // 0                        25
                                 // |------------------------|----
        lw x19, 0*4(x10)         // *.............................
        srai x5, x29, 23         // *.............................
        mul x31, x5, x12         // .*............................
        lw x21, 1*4(x10)         // .*............................
        add x8, x19, x11         // ..*...........................
        srai x5, x6, 23          // ..*...........................
        mul x23, x5, x12         // ...*..........................
        add x6, x21, x11         // ...*..........................
        srai x4, x8, 23          // ....*.........................
        srai x27, x6, 23         // ....*.........................
        sub x20, x22, x31        // .....*........................
        mul x1, x27, x12         // .....*........................
        lw x22, 2*4(x10)         // ......e.......................
        mul x15, x4, x12         // ......*.......................
        sw x20, 2*4(x10)         // .......*......................
        sub x16, x14, x23        // .......*......................
        add x29, x22, x11        // ........e.....................
        sw x16, 3*4(x10)         // ........*.....................
        sub x26, x21, x1         // .........*....................
        lw x14, 3*4(x10)         // .........e....................
        sw x26, 1*4(x10)         // ..........*...................
        sub x28, x19, x15        // ..........*...................
        sw x28, 0*4(x10)         // ...........*..................
        add x6, x14, x11         // ...........e..................

                                   // ------ cycle (expected) ------>
                                   // 0                        25
                                   // |------------------------|-----
        // lw x14, 0*4(x10)        // ......*...........~............
        // lw x15, 1*4(x10)        // ......'*..........'~...........
        // lw x16, 2*4(x10)        // e.....'.....~.....'.....~......
        // lw x17, 3*4(x10)        // ...e..'........~..'........~...
        // add  x5, x14, x11       // ......'.*.........'.~..........
        // add  x6, x15, x11       // ......'..*........'..~.........
        // add  x7, x16, x11       // ..e...'.......~...'.......~....
        // add  x28, x17, x11      // .....e'..........~'..........~.
        // srai x5, x5, 23         // ......'...*.......'...~........
        // srai x6, x6, 23         // ......'...*.......'...~........
        // srai x7, x7, 23         // ......*...........~............
        // srai x28, x28, 23       // ......'.*.........'.~..........
        // mul  x5, x5, x12        // ~.....'.....*.....'.....~......
        // mul  x6, x6, x12        // ......'....*......'....~.......
        // mul  x7, x7, x12        // ......'*..........'~...........
        // mul  x28, x28, x12      // ......'..*........'..~.........
        // sub  x14, x14, x5       // ....~.'.........*.'.........~..
        // sub  x15, x15, x6       // ...~..'........*..'........~...
        // sub  x16, x16, x7       // ......'....*......'....~.......
        // sub  x17, x17, x28      // .~....'......*....'......~.....
        // sw x14, 0*4(x10)        // .....~'..........*'..........~.
        // sw x15, 1*4(x10)        // ....~.'.........*.'.........~..
        // sw x16, 2*4(x10)        // .~....'......*....'......~.....
        // sw x17, 3*4(x10)        // ..~...'.......*...'.......~....

        addi a3, a3, 16
        bne a3, a0, poly_reduce_rv64im_loop
                                 // Instructions:    20
                                 // Expected cycles: 12
                                 // Expected IPC:    1.67
                                 //
                                 // Cycle bound:     12.0
                                 // IPC bound:       1.67
                                 //
                                 // Wall time:     0.17s
                                 // User time:     0.17s
                                 //
                                 // ----- cycle (expected) ------>
                                 // 0                        25
                                 // |------------------------|----
        srai x15, x6, 23         // *.............................
        lw x23, 0*4(x10)         // *.............................
        srai x26, x29, 23        // .*............................
        lw x29, 1*4(x10)         // .*............................
        mul x24, x26, x12        // ..*...........................
        add x26, x23, x11        // ..*...........................
        srai x5, x26, 23         // ...*..........................
        add x18, x29, x11        // ...*..........................
        srai x16, x18, 23        // ....*.........................
        mul x25, x5, x12         // ....*.........................
        mul x30, x16, x12        // .....*........................
        sub x9, x22, x24         // ......*.......................
        mul x18, x15, x12        // ......*.......................
        sw x9, 2*4(x10)          // .......*......................
        sub x21, x23, x25        // ........*.....................
        sub x24, x29, x30        // .........*....................
        sw x21, 0*4(x10)         // .........*....................
        sub x4, x14, x18         // ..........*...................
        sw x24, 1*4(x10)         // ..........*...................
        sw x4, 3*4(x10)          // ...........*..................

                                  // ------ cycle (expected) ------>
                                  // 0                        25
                                  // |------------------------|-----
        // lw x19, 0*4(x10)       // *..............................
        // srai x5, x29, 23       // .*.............................
        // mul x31, x5, x12       // ..*............................
        // lw x21, 1*4(x10)       // .*.............................
        // add x8, x19, x11       // ..*............................
        // srai x5, x6, 23        // *..............................
        // mul x23, x5, x12       // ......*........................
        // add x6, x21, x11       // ...*...........................
        // srai x4, x8, 23        // ...*...........................
        // srai x27, x6, 23       // ....*..........................
        // sub x20, x22, x31      // ......*........................
        // mul x1, x27, x12       // .....*.........................
        // mul x15, x4, x12       // ....*..........................
        // sw x20, 2*4(x10)       // .......*.......................
        // sub x16, x14, x23      // ..........*....................
        // sw x16, 3*4(x10)       // ...........*...................
        // sub x26, x21, x1       // .........*.....................
        // sw x26, 1*4(x10)       // ..........*....................
        // sub x28, x19, x15      // ........*......................
        // sw x28, 0*4(x10)       // .........*.....................

    ret