/// Copyright (c) 2024 Jipeng Zhang (jp-zhang@outlook.com) (Original Code)
/// Copyright (c) 2026 Amin Abdulrahman (amin@abdulrahman.de) (Modifications)
/// Copyright (c) 2026 Justus Bergermann (mail@justus-bergermann.de) (Modifications)
///
/// SPDX-License-Identifier: MIT
///
/// Permission is hereby granted, free of charge, to any person obtaining a copy
/// of this software and associated documentation files (the "Software"), to deal
/// in the Software without restriction, including without limitation the rights
/// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
/// copies of the Software, and to permit persons to whom the Software is
/// furnished to do so, subject to the following conditions:
///
/// The above copyright notice and this permission notice shall be included in all
/// copies or substantial portions of the Software.
///
/// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
/// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
/// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
/// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
/// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
/// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
/// SOFTWARE.

.macro save_regs
  sd s0,  0*8(sp)
  sd s1,  1*8(sp)
  sd s2,  2*8(sp)
  sd s3,  3*8(sp)
  sd s4,  4*8(sp)
  sd s5,  5*8(sp)
  sd s6,  6*8(sp)
  sd s7,  7*8(sp)
  sd s8,  8*8(sp)
  sd s9,  9*8(sp)
  sd s10, 10*8(sp)
  sd s11, 11*8(sp)
  sd gp,  12*8(sp)
  sd tp,  13*8(sp)
  sd ra,  14*8(sp)
.endm

.macro restore_regs
  ld s0,  0*8(sp)
  ld s1,  1*8(sp)
  ld s2,  2*8(sp)
  ld s3,  3*8(sp)
  ld s4,  4*8(sp)
  ld s5,  5*8(sp)
  ld s6,  6*8(sp)
  ld s7,  7*8(sp)
  ld s8,  8*8(sp)
  ld s9,  9*8(sp)
  ld s10, 10*8(sp)
  ld s11, 11*8(sp)
  ld gp,  12*8(sp)
  ld tp,  13*8(sp)
  ld ra,  14*8(sp)
.endm

.macro plant_red_x4 q32, qinv, a_0, a_1, a_2, a_3
  mul  \a_0, \a_0, \qinv
  mul  \a_1, \a_1, \qinv
  mul  \a_2, \a_2, \qinv
  mul  \a_3, \a_3, \qinv
  srai \a_0, \a_0, 32
  srai \a_1, \a_1, 32
  srai \a_2, \a_2, 32
  srai \a_3, \a_3, 32
  addi \a_0, \a_0, 256
  addi \a_1, \a_1, 256
  addi \a_2, \a_2, 256
  addi \a_3, \a_3, 256
  mulh \a_0, \a_0, \q32
  mulh \a_1, \a_1, \q32
  mulh \a_2, \a_2, \q32
  mulh \a_3, \a_3, \q32
.endm

.equ q,    8380417
.equ q32,  0x7fe00100000000               // q << 32
.equ qinv, 0x180a406003802001             // q^-1 mod 2^64
.equ plantconst, 0x200801c0602            // (((-2**64) % q) * qinv) % (2**64)
.equ plantconst2, 0xb7b9f10ccf939804      // (((-2**64) % q) * ((-2**64) % q) * qinv) % (2**64)

# void poly_basemul_8l_acc_end_rv64im(int32_t r[256], const int32_t a[256], const int32_t b[256], int64_t r_double[256])
.globl poly_basemul_8l_acc_end_rv64im_dual_opt_c908
.align 2
poly_basemul_8l_acc_end_rv64im_dual_opt_c908:
    addi sp, sp, -8*16
    save_regs
    li a4, q32
    li a5, qinv
    // loop control
    li  gp, 32*8*4
    add gp, gp, a0
    sd  gp, 8*15(sp)
poly_basemul_8l_acc_end_rv64im_looper:
                                  // Instructions:    84
                                  // Expected cycles: 45
                                  // Expected IPC:    1.87
                                  //
                                  // Cycle bound:     43.0
                                  // IPC bound:       1.95
                                  //
                                  // Wall time:     44.06s
                                  // User time:     44.06s
                                  //
                                  // ------------- cycle (expected) ------------->
                                  // 0                        25
                                  // |------------------------|-------------------
        lw x18, 1*4(x12)          // *............................................
        lw x22, 1*4(x11)          // .*...........................................
        lw x21, 4*4(x12)          // ..*..........................................
        lw x30, 4*4(x11)          // ...*.........................................
        mul x29, x22, x18         // ...*.........................................
        lw x27, 7*4(x11)          // ....*........................................
        mul x18, x30, x21         // .....*.......................................
        ld x24, 1*8(x13)          // .....*.......................................
        lw x7, 7*4(x12)           // ......*......................................
        add x25, x29, x24         // .......*.....................................
        ld x26, 4*8(x13)          // .......*.....................................
        mul x24, x27, x7          // ........*....................................
        lw x27, 2*4(x12)          // ........*....................................
        lw x22, 2*4(x11)          // .........*...................................
        add x4, x18, x26          // .........*...................................
        ld x16, 7*8(x13)          // ..........*..................................
        mul x7, x4, x15           // ..........*..................................
        lw x18, 5*4(x12)          // ...........*.................................
        mul x1, x25, x15          // ...........*.................................
        lw x4, 5*4(x11)           // ............*................................
        add x9, x24, x16          // ............*................................
        lw x8, 3*4(x12)           // .............*...............................
        mul x26, x22, x27         // .............*...............................
        srai x24, x7, 32          // ..............*..............................
        mul x25, x4, x18          // ..............*..............................
        lw x22, 0*4(x11)          // ...............*.............................
        addi x19, x24, 256        // ...............*.............................
        mulh x4, x19, x14         // ................*............................
        ld x18, 5*8(x13)          // ................*............................
        srai x21, x1, 32          // .................*...........................
        ld x3, 2*8(x13)           // .................*...........................
        lw x24, 0*4(x12)          // ..................*..........................
        add x27, x25, x18         // ..................*..........................
        mul x25, x27, x15         // ...................*.........................
        add x18, x26, x3          // ...................*.........................
        lw x26, 3*4(x11)          // ....................*........................
        mul x7, x22, x24          // ....................*........................
        lw x17, 6*4(x11)          // .....................*.......................
        mul x27, x18, x15         // .....................*.......................
        addi x29, x21, 256        // ......................*......................
        ld x22, 0*8(x13)          // ......................*......................
        lw x5, 6*4(x12)           // .......................*.....................
        srai x18, x25, 32         // .......................*.....................
        addi x24, x18, 256        // ........................*....................
        add x31, x7, x22          // ........................*....................
        mulh x20, x24, x14        // .........................*...................
        srai x18, x27, 32         // .........................*...................
        addi x18, x18, 256        // ..........................*..................
        ld x16, 3*8(x13)          // ..........................*..................
        mulh x18, x18, x14        // ...........................*.................
        sw x4, 4*4(x10)           // ...........................*.................
        mul x7, x17, x5           // ............................*................
        mul x8, x26, x8           // ............................*................
        sw x20, 5*4(x10)          // .............................*...............
        mul x5, x31, x15          // .............................*...............
        mul x24, x9, x15          // ..............................*..............
        ld x3, 6*8(x13)           // ..............................*..............
        sw x18, 2*4(x10)          // ...............................*.............
        mulh x31, x29, x14        // ...............................*.............
        add x27, x7, x3           // ................................*............
        ld x3, 8*15(x2)           // ................................*............
        mul x9, x27, x15          // .................................*...........
        add x27, x8, x16          // .................................*...........
        srai x7, x24, 32          // ..................................*..........
        mul x26, x27, x15         // ..................................*..........
        addi x24, x7, 256         // ...................................*.........
        srai x18, x5, 32          // ...................................*.........
        mulh x24, x24, x14        // ....................................*........
        addi x28, x18, 256        // ....................................*........
        srai x7, x9, 32           // .....................................*.......
        mulh x8, x28, x14         // .....................................*.......
        addi x7, x7, 256          // ......................................*......
        srai x28, x26, 32         // ......................................*......
        mulh x7, x7, x14          // .......................................*.....
        addi x17, x28, 256        // .......................................*.....
        sw x24, 7*4(x10)          // ........................................*....
        mulh x26, x17, x14        // ........................................*....
        addi x11, x11, 4*8        // .........................................*...
        sw x31, 1*4(x10)          // .........................................*...
        sw x8, 0*4(x10)           // ..........................................*..
        addi x13, x13, 8*8        // ..........................................*..
        sw x7, 6*4(x10)           // ...........................................*.
        addi x12, x12, 4*8        // ...........................................*.
        sw x26, 3*4(x10)          // ............................................*

                                   // ------------- cycle (expected) ------------->
                                   // 0                        25
                                   // |------------------------|-------------------
        // lw x5, 0*4(x11)         // ...............*.............................
        // lw x6, 1*4(x11)         // .*...........................................
        // lw x8, 0*4(x12)         // ..................*..........................
        // lw x9, 1*4(x12)         // *............................................
        // ld x16, 0*8(x13)        // ......................*......................
        // ld x17, 1*8(x13)        // .....*.......................................
        // lw x7, 2*4(x11)         // .........*...................................
        // lw x28, 3*4(x11)        // ....................*........................
        // lw x18, 2*4(x12)        // ........*....................................
        // lw x19, 3*4(x12)        // .............*...............................
        // mul x24, x5, x8         // ....................*........................
        // mul x25, x6, x9         // ...*.........................................
        // ld x3, 2*8(x13)         // .................*...........................
        // ld x1, 3*8(x13)         // ..........................*..................
        // lw x29, 4*4(x11)        // ...*.........................................
        // lw x30, 5*4(x11)        // ............*................................
        // mul x26, x7, x18        // .............*...............................
        // mul x27, x28, x19       // ............................*................
        // lw x20, 4*4(x12)        // ..*..........................................
        // lw x21, 5*4(x12)        // ...........*.................................
        // add x24, x24, x16       // ........................*....................
        // add x25, x25, x17       // .......*.....................................
        // lw x31, 6*4(x11)        // .....................*.......................
        // lw x4, 7*4(x11)         // ....*........................................
        // add x26, x26, x3        // ...................*.........................
        // add x27, x27, x1        // .................................*...........
        // lw x22, 6*4(x12)        // .......................*.....................
        // lw x23, 7*4(x12)        // ......*......................................
        // mul  x24, x24, x15      // .............................*...............
        // mul  x25, x25, x15      // ...........*.................................
        // mul  x26, x26, x15      // .....................*.......................
        // mul  x27, x27, x15      // ..................................*..........
        // srai x24, x24, 32       // ...................................*.........
        // srai x25, x25, 32       // .................*...........................
        // srai x26, x26, 32       // .........................*...................
        // srai x27, x27, 32       // ......................................*......
        // addi x24, x24, 256      // ....................................*........
        // addi x25, x25, 256      // ......................*......................
        // addi x26, x26, 256      // ..........................*..................
        // addi x27, x27, 256      // .......................................*.....
        // mulh x24, x24, x14      // .....................................*.......
        // mulh x25, x25, x14      // ...............................*.............
        // mulh x26, x26, x14      // ...........................*.................
        // mulh x27, x27, x14      // ........................................*....
        // ld x16, 4*8(x13)        // .......*.....................................
        // ld x17, 5*8(x13)        // ................*............................
        // sw x24, 0*4(x10)        // ..........................................*..
        // sw x25, 1*4(x10)        // .........................................*...
        // mul x24, x29, x20       // .....*.......................................
        // mul x25, x30, x21       // ..............*..............................
        // sw x26, 2*4(x10)        // ...............................*.............
        // sw x27, 3*4(x10)        // ............................................*
        // ld x3, 6*8(x13)         // ..............................*..............
        // ld x1, 7*8(x13)         // ..........*..................................
        // mul x26, x31, x22       // ............................*................
        // mul x27, x4, x23        // ........*....................................
        // add x24, x24, x16       // .........*...................................
        // add x25, x25, x17       // ..................*..........................
        // add x26, x26, x3        // ................................*............
        // add x27, x27, x1        // ............*................................
        // mul  x24, x24, x15      // ..........*..................................
        // mul  x25, x25, x15      // ...................*.........................
        // mul  x26, x26, x15      // .................................*...........
        // mul  x27, x27, x15      // ..............................*..............
        // srai x24, x24, 32       // ..............*..............................
        // srai x25, x25, 32       // .......................*.....................
        // srai x26, x26, 32       // .....................................*.......
        // srai x27, x27, 32       // ..................................*..........
        // addi x24, x24, 256      // ...............*.............................
        // addi x25, x25, 256      // ........................*....................
        // addi x26, x26, 256      // ......................................*......
        // addi x27, x27, 256      // ...................................*.........
        // mulh x24, x24, x14      // ................*............................
        // mulh x25, x25, x14      // .........................*...................
        // mulh x26, x26, x14      // .......................................*.....
        // mulh x27, x27, x14      // ....................................*........
        // ld  x3, 8*15(x2)        // ................................*............
        // addi x11, x11, 4*8      // .........................................*...
        // addi x12, x12, 4*8      // ...........................................*.
        // addi x13, x13, 8*8      // ..........................................*..
        // sw x24, 4*4(x10)        // ...........................*.................
        // sw x25, 5*4(x10)        // .............................*...............
        // sw x26, 6*4(x10)        // ...........................................*.
        // sw x27, 7*4(x10)        // ........................................*....

        addi gp, gp, 4
        bne gp, a0, poly_basemul_8l_acc_end_rv64im_looper
    restore_regs
    addi sp, sp, 8*16
    ret