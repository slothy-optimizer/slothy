.macro save_regs
  sd s0,  0*8(sp)
  sd s1,  1*8(sp)
  sd s2,  2*8(sp)
  sd s3,  3*8(sp)
  sd s4,  4*8(sp)
  sd s5,  5*8(sp)
  sd s6,  6*8(sp)
  sd s7,  7*8(sp)
  sd s8,  8*8(sp)
  sd s9,  9*8(sp)
  sd s10, 10*8(sp)
  sd s11, 11*8(sp)
  sd gp,  12*8(sp)
  sd tp,  13*8(sp)
  sd ra,  14*8(sp)
.endm

.macro restore_regs
  ld s0,  0*8(sp)
  ld s1,  1*8(sp)
  ld s2,  2*8(sp)
  ld s3,  3*8(sp)
  ld s4,  4*8(sp)
  ld s5,  5*8(sp)
  ld s6,  6*8(sp)
  ld s7,  7*8(sp)
  ld s8,  8*8(sp)
  ld s9,  9*8(sp)
  ld s10, 10*8(sp)
  ld s11, 11*8(sp)
  ld gp,  12*8(sp)
  ld tp,  13*8(sp)
  ld ra,  14*8(sp)
.endm

.macro plant_red_x4 q32, qinv, a_0, a_1, a_2, a_3
  mul  \a_0, \a_0, \qinv
  mul  \a_1, \a_1, \qinv
  mul  \a_2, \a_2, \qinv
  mul  \a_3, \a_3, \qinv
  srai \a_0, \a_0, 32
  srai \a_1, \a_1, 32
  srai \a_2, \a_2, 32
  srai \a_3, \a_3, 32
  addi \a_0, \a_0, 256
  addi \a_1, \a_1, 256
  addi \a_2, \a_2, 256
  addi \a_3, \a_3, 256
  mulh \a_0, \a_0, \q32
  mulh \a_1, \a_1, \q32
  mulh \a_2, \a_2, \q32
  mulh \a_3, \a_3, \q32
.endm

.equ q,    8380417
.equ q32,  0x7fe00100000000               // q << 32
.equ qinv, 0x180a406003802001             // q^-1 mod 2^64
.equ plantconst, 0x200801c0602            // (((-2**64) % q) * qinv) % (2**64)
.equ plantconst2, 0xb7b9f10ccf939804      // (((-2**64) % q) * ((-2**64) % q) * qinv) % (2**64)

# void poly_basemul_8l_acc_end_rv64im(int32_t r[256], const int32_t a[256], const int32_t b[256], int64_t r_double[256])
.globl poly_basemul_8l_acc_end_rv64im_opt_c908
.align 2
poly_basemul_8l_acc_end_rv64im_opt_c908:
    addi sp, sp, -8*16
    save_regs
    li a4, q32
    li a5, qinv
    // loop control
    li  gp, 32*8*4
    add gp, gp, a0
    sd  gp, 8*15(sp)
poly_basemul_8l_acc_end_rv64im_looper:
                                  // Instructions:    84
                                  // Expected cycles: 45
                                  // Expected IPC:    1.87
                                  //
                                  // Cycle bound:     43.0
                                  // IPC bound:       1.95
                                  //
                                  // Wall time:     132.28s
                                  // User time:     132.28s
                                  //
                                  // ------------- cycle (expected) ------------->
                                  // 0                        25
                                  // |------------------------|-------------------
        lw x22, 1*4(x12)          // *............................................
        lw x21, 1*4(x11)          // .*...........................................
        lw x20, 6*4(x11)          // ..*..........................................
        lw x19, 6*4(x12)          // ...*.........................................
        mul x4, x21, x22          // ...*.........................................
        lw x26, 7*4(x12)          // ....*........................................
        mul x18, x20, x19         // .....*.......................................
        ld x22, 1*8(x13)          // .....*.......................................
        lw x6, 7*4(x11)           // ......*......................................
        add x29, x4, x22          // .......*.....................................
        ld x3, 6*8(x13)           // .......*.....................................
        ld x9, 3*8(x13)           // ........*....................................
        mul x4, x6, x26           // ........*....................................
        lw x6, 0*4(x12)           // .........*...................................
        add x8, x18, x3           // .........*...................................
        mul x20, x8, x15          // ..........*..................................
        ld x22, 7*8(x13)          // ..........*..................................
        lw x25, 3*4(x11)          // ...........*.................................
        mul x29, x29, x15         // ...........*.................................
        add x4, x4, x22           // ............*................................
        lw x23, 3*4(x12)          // ............*................................
        lw x21, 0*4(x11)          // .............*...............................
        mul x4, x4, x15           // .............*...............................
        lw x19, 4*4(x12)          // ..............*..............................
        mul x22, x25, x23         // ..............*..............................
        lw x25, 5*4(x12)          // ...............*.............................
        srai x27, x29, 32         // ...............*.............................
        addi x29, x27, 256        // ................*............................
        lw x1, 5*4(x11)           // ................*............................
        srai x16, x4, 32          // .................*...........................
        lw x8, 4*4(x11)           // .................*...........................
        add x28, x22, x9          // ..................*..........................
        addi x4, x16, 256         // ..................*..........................
        mul x7, x21, x6           // ...................*.........................
        mulh x4, x4, x14          // ...................*.........................
        srai x6, x20, 32          // ....................*........................
        ld x22, 0*8(x13)          // ....................*........................
        addi x6, x6, 256          // .....................*.......................
        mul x9, x8, x19           // .....................*.......................
        mulh x30, x29, x14        // ......................*......................
        mul x8, x28, x15          // ......................*......................
        sw x4, 7*4(x10)           // .......................*.....................
        add x23, x7, x22          // .......................*.....................
        mul x17, x1, x25          // ........................*....................
        mul x16, x23, x15         // ........................*....................
        ld x22, 4*8(x13)          // .........................*...................
        mulh x6, x6, x14          // .........................*...................
        srai x29, x8, 32          // ..........................*..................
        lw x7, 2*4(x12)           // ..........................*..................
        add x1, x9, x22           // ...........................*.................
        lw x8, 2*4(x11)           // ...........................*.................
        ld x9, 5*8(x13)           // ............................*................
        srai x25, x16, 32         // ............................*................
        addi x25, x25, 256        // .............................*...............
        mul x19, x8, x7           // .............................*...............
        mulh x8, x25, x14         // ..............................*..............
        mul x4, x1, x15           // ..............................*..............
        ld x3, 2*8(x13)           // ...............................*.............
        add x9, x17, x9           // ...............................*.............
        mul x7, x9, x15           // ................................*............
        addi x23, x29, 256        // ................................*............
        mulh x22, x23, x14        // .................................*...........
        add x16, x19, x3          // .................................*...........
        sw x8, 0*4(x10)           // ..................................*..........
        mul x8, x16, x15          // ..................................*..........
        srai x1, x4, 32           // ...................................*.........
        sw x30, 1*4(x10)          // ...................................*.........
        srai x29, x7, 32          // ....................................*........
        addi x4, x1, 256          // ....................................*........
        addi x31, x29, 256        // .....................................*.......
        mulh x9, x4, x14          // .....................................*.......
        sw x22, 3*4(x10)          // ......................................*......
        srai x28, x8, 32          // ......................................*......
        mulh x7, x31, x14         // .......................................*.....
        addi x31, x28, 256        // .......................................*.....
        ld x3, 8*15(x2)           // ........................................*....
        mulh x27, x31, x14        // ........................................*....
        sw x9, 4*4(x10)           // .........................................*...
        addi x13, x13, 8*8        // .........................................*...
        sw x6, 6*4(x10)           // ..........................................*..
        addi x12, x12, 4*8        // ..........................................*..
        sw x7, 5*4(x10)           // ...........................................*.
        sw x27, 2*4(x10)          // ............................................*
        addi x11, x11, 4*8        // ............................................*

                                   // ------------- cycle (expected) ------------->
                                   // 0                        25
                                   // |------------------------|-------------------
        // lw x5, 0*4(x11)         // .............*...............................
        // lw x6, 1*4(x11)         // .*...........................................
        // lw x8, 0*4(x12)         // .........*...................................
        // lw x9, 1*4(x12)         // *............................................
        // ld x16, 0*8(x13)        // ....................*........................
        // ld x17, 1*8(x13)        // .....*.......................................
        // lw x7, 2*4(x11)         // ...........................*.................
        // lw x28, 3*4(x11)        // ...........*.................................
        // lw x18, 2*4(x12)        // ..........................*..................
        // lw x19, 3*4(x12)        // ............*................................
        // mul x24, x5, x8         // ...................*.........................
        // mul x25, x6, x9         // ...*.........................................
        // ld x3, 2*8(x13)         // ...............................*.............
        // ld x1, 3*8(x13)         // ........*....................................
        // lw x29, 4*4(x11)        // .................*...........................
        // lw x30, 5*4(x11)        // ................*............................
        // mul x26, x7, x18        // .............................*...............
        // mul x27, x28, x19       // ..............*..............................
        // lw x20, 4*4(x12)        // ..............*..............................
        // lw x21, 5*4(x12)        // ...............*.............................
        // add x24, x24, x16       // .......................*.....................
        // add x25, x25, x17       // .......*.....................................
        // lw x31, 6*4(x11)        // ..*..........................................
        // lw x4, 7*4(x11)         // ......*......................................
        // add x26, x26, x3        // .................................*...........
        // add x27, x27, x1        // ..................*..........................
        // lw x22, 6*4(x12)        // ...*.........................................
        // lw x23, 7*4(x12)        // ....*........................................
        // mul  x24, x24, x15      // ........................*....................
        // mul  x25, x25, x15      // ...........*.................................
        // mul  x26, x26, x15      // ..................................*..........
        // mul  x27, x27, x15      // ......................*......................
        // srai x24, x24, 32       // ............................*................
        // srai x25, x25, 32       // ...............*.............................
        // srai x26, x26, 32       // ......................................*......
        // srai x27, x27, 32       // ..........................*..................
        // addi x24, x24, 256      // .............................*...............
        // addi x25, x25, 256      // ................*............................
        // addi x26, x26, 256      // .......................................*.....
        // addi x27, x27, 256      // ................................*............
        // mulh x24, x24, x14      // ..............................*..............
        // mulh x25, x25, x14      // ......................*......................
        // mulh x26, x26, x14      // ........................................*....
        // mulh x27, x27, x14      // .................................*...........
        // ld x16, 4*8(x13)        // .........................*...................
        // ld x17, 5*8(x13)        // ............................*................
        // sw x24, 0*4(x10)        // ..................................*..........
        // sw x25, 1*4(x10)        // ...................................*.........
        // mul x24, x29, x20       // .....................*.......................
        // mul x25, x30, x21       // ........................*....................
        // sw x26, 2*4(x10)        // ............................................*
        // sw x27, 3*4(x10)        // ......................................*......
        // ld x3, 6*8(x13)         // .......*.....................................
        // ld x1, 7*8(x13)         // ..........*..................................
        // mul x26, x31, x22       // .....*.......................................
        // mul x27, x4, x23        // ........*....................................
        // add x24, x24, x16       // ...........................*.................
        // add x25, x25, x17       // ...............................*.............
        // add x26, x26, x3        // .........*...................................
        // add x27, x27, x1        // ............*................................
        // mul  x24, x24, x15      // ..............................*..............
        // mul  x25, x25, x15      // ................................*............
        // mul  x26, x26, x15      // ..........*..................................
        // mul  x27, x27, x15      // .............*...............................
        // srai x24, x24, 32       // ...................................*.........
        // srai x25, x25, 32       // ....................................*........
        // srai x26, x26, 32       // ....................*........................
        // srai x27, x27, 32       // .................*...........................
        // addi x24, x24, 256      // ....................................*........
        // addi x25, x25, 256      // .....................................*.......
        // addi x26, x26, 256      // .....................*.......................
        // addi x27, x27, 256      // ..................*..........................
        // mulh x24, x24, x14      // .....................................*.......
        // mulh x25, x25, x14      // .......................................*.....
        // mulh x26, x26, x14      // .........................*...................
        // mulh x27, x27, x14      // ...................*.........................
        // ld  x3, 8*15(x2)        // ........................................*....
        // addi x11, x11, 4*8      // ............................................*
        // addi x12, x12, 4*8      // ..........................................*..
        // addi x13, x13, 8*8      // .........................................*...
        // sw x24, 4*4(x10)        // .........................................*...
        // sw x25, 5*4(x10)        // ...........................................*.
        // sw x26, 6*4(x10)        // ..........................................*..
        // sw x27, 7*4(x10)        // .......................*.....................

        addi gp, gp, 4
        bne gp, a0, poly_basemul_8l_acc_end_rv64im_looper
    restore_regs
    addi sp, sp, 8*16
    ret