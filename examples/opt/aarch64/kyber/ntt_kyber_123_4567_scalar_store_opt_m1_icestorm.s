///
/// Copyright (c) 2022 Arm Limited
/// Copyright (c) 2022 Hanno Becker
/// Copyright (c) 2023 Amin Abdulrahman, Matthias Kannwischer
/// SPDX-License-Identifier: MIT
///
/// Permission is hereby granted, free of charge, to any person obtaining a copy
/// of this software and associated documentation files (the "Software"), to deal
/// in the Software without restriction, including without limitation the rights
/// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
/// copies of the Software, and to permit persons to whom the Software is
/// furnished to do so, subject to the following conditions:
///
/// The above copyright notice and this permission notice shall be included in all
/// copies or substantial portions of the Software.
///
/// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
/// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
/// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
/// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
/// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
/// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
/// SOFTWARE.
///

// Needed to provide ASM_LOAD directive
#include <hal_env.h>

// NOTE
// We use a lot of trivial macros to simplify the parsing burden for Slothy
// The macros are not unfolded by Slothy and thus interpreted as instructions,
// which are easier to parse due to e.g. the lack of size specifiers and simpler
// syntax for pre and post increment for loads and stores.

// Eventually, NeLight should include a proper parser for AArch64,
// but for initial investigations, the below is enough.

.macro ldr_vo vec, base, offset
       ldr qform_\vec, [\base, #\offset]
.endm
.macro ldr_vi vec, base, inc
        ldr qform_\vec, [\base], #\inc
.endm

.macro str_vo vec, base, offset
        str qform_\vec, [\base, #\offset]
.endm
.macro str_vi vec, base, inc
        str qform_\vec, [\base], #\inc
.endm

.macro vqrdmulh d,a,b
        sqrdmulh \d\().8h, \a\().8h, \b\().8h
.endm
.macro vmlsq d,a,b,i
        mls \d\().8h, \a\().8h, \b\().h[\i]
.endm
.macro vqrdmulhq d,a,b,i
        sqrdmulh \d\().8h, \a\().8h, \b\().h[\i]
.endm
.macro vqdmulhq d,a,b,i
        sqdmulh \d\().8h, \a\().8h, \b\().h[\i]
.endm
.macro vmulq d,a,b,i
        mul \d\().8h, \a\().8h, \b\().h[\i]
.endm

.macro mulmodq dst, src, const, idx0, idx1
        vmulq       \dst,  \src, \const, \idx0
        vqrdmulhq   \src,  \src, \const, \idx1
        vmlsq        \dst,  \src, consts, 0
.endm

.macro mulmod dst, src, const, const_twisted
        mul        \dst\().8h,  \src\().8h, \const\().8h
        vqrdmulh   \src,  \src, \const_twisted
        vmlsq      \dst,  \src, consts, 0
.endm

.macro ct_butterfly a, b, root, idx0, idx1
        mulmodq  tmp, \b, \root, \idx0, \idx1
        sub     \b\().8h,    \a\().8h, tmp.8h
        add     \a\().8h,    \a\().8h, tmp.8h
.endm

.macro mulmod_v dst, src, const, const_twisted
        vmul        \dst,  \src, \const
        vqrdmulh    \src,  \src, \const_twisted
        vmlsq       \dst,  \src, consts, 0
.endm

.macro ct_butterfly_v a, b, root, root_twisted
        mulmod  tmp, \b, \root, \root_twisted
        sub    \b\().8h,    \a\().8h, tmp.8h
        add    \a\().8h,    \a\().8h, tmp.8h
.endm

.macro barrett_reduce a
        vqdmulhq tmp, \a, consts, 1
        srshr    tmp.8h, tmp.8h, #11
        vmlsq    \a, tmp, consts, 0
.endm

.macro load_roots_123
        ldr_vi root0, r_ptr0, 32
        ldr_vo root1, r_ptr0, -16
.endm

.macro load_next_roots_45
        ldr_vi root0, r_ptr0, 16
.endm

.macro load_next_roots_67
        ldr_vi root0,    r_ptr1, (6*16)
        ldr_vo root0_tw, r_ptr1, (-6*16 + 1*16)
        ldr_vo root1,    r_ptr1, (-6*16 + 2*16)
        ldr_vo root1_tw, r_ptr1, (-6*16 + 3*16)
        ldr_vo root2,    r_ptr1, (-6*16 + 4*16)
        ldr_vo root2_tw, r_ptr1, (-6*16 + 5*16)
.endm

.macro transpose4 data
        trn1 t0.4s, \data\()0.4s, \data\()1.4s
        trn2 t1.4s, \data\()0.4s, \data\()1.4s
        trn1 t2.4s, \data\()2.4s, \data\()3.4s
        trn2 t3.4s, \data\()2.4s, \data\()3.4s

        trn2 \data\()2.2d, t0.2d, t2.2d
        trn2 \data\()3.2d, t1.2d, t3.2d
        trn1 \data\()0.2d, t0.2d, t2.2d
        trn1 \data\()1.2d, t1.2d, t3.2d
.endm

.macro transpose_single data_out, data_in
        trn1 \data_out\()0.4s, \data_in\()0.4s, \data_in\()1.4s
        trn2 \data_out\()1.4s, \data_in\()0.4s, \data_in\()1.4s
        trn1 \data_out\()2.4s, \data_in\()2.4s, \data_in\()3.4s
        trn2 \data_out\()3.4s, \data_in\()2.4s, \data_in\()3.4s
.endm

.macro vext gpr_out, vec_in, lane
        umov \gpr_out\(), \vec_in\().d[\lane]
.endm

.macro vec_to_scalar_matrix out, in
        vext \out\()_00, \in\()0, 0
        vext \out\()_01, \in\()0, 1
        vext \out\()_10, \in\()1, 0
        vext \out\()_11, \in\()1, 1
        vext \out\()_20, \in\()2, 0
        vext \out\()_21, \in\()2, 1
        vext \out\()_30, \in\()3, 0
        vext \out\()_31, \in\()3, 1
.endm

.macro store_scalar_matrix_with_inc x, addr, inc
        str \x\()t_00, [\addr], #( \inc)
        str \x\()t_01, [\addr,  #(-\inc + 8*1)]
        str \x\()t_10, [\addr,  #(-\inc + 8*2)]
        str \x\()t_11, [\addr,  #(-\inc + 8*3)]
        str \x\()t_20, [\addr,  #(-\inc + 8*4)]
        str \x\()t_21, [\addr,  #(-\inc + 8*5)]
        str \x\()t_30, [\addr,  #(-\inc + 8*6)]
        str \x\()t_31, [\addr,  #(-\inc + 8*7)]
.endm


.macro save_gprs // slothy:no-unfold
        sub sp, sp, #(16*6)
        stp x19, x20, [sp, #16*0]
        stp x19, x20, [sp, #16*0]
        stp x21, x22, [sp, #16*1]
        stp x23, x24, [sp, #16*2]
        stp x25, x26, [sp, #16*3]
        stp x27, x28, [sp, #16*4]
        str x29, [sp, #16*5]
.endm

.macro restore_gprs // slothy:no-unfold
        ldp x19, x20, [sp, #16*0]
        ldp x21, x22, [sp, #16*1]
        ldp x23, x24, [sp, #16*2]
        ldp x25, x26, [sp, #16*3]
        ldp x27, x28, [sp, #16*4]
        ldr x29, [sp, #16*5]
        add sp, sp, #(16*6)
.endm

.macro save_vregs // slothy:no-unfold
        sub sp, sp, #(16*4)
        stp  d8,  d9, [sp, #16*0]
        stp d10, d11, [sp, #16*1]
        stp d12, d13, [sp, #16*2]
        stp d14, d15, [sp, #16*3]
.endm

.macro restore_vregs // slothy:no-unfold
        ldp  d8,  d9, [sp, #16*0]
        ldp d10, d11, [sp, #16*1]
        ldp d12, d13, [sp, #16*2]
        ldp d14, d15, [sp, #16*3]
        add sp, sp, #(16*4)
.endm

#define STACK_SIZE 16
#define STACK0 0

.macro restore a, loc     // slothy:no-unfold
        ldr \a, [sp, #\loc\()]
.endm
.macro save loc, a        // slothy:no-unfold
        str \a, [sp, #\loc\()]
.endm
.macro push_stack // slothy:no-unfold
        save_gprs
        save_vregs
        sub sp, sp, #STACK_SIZE
.endm

.macro pop_stack // slothy:no-unfold
        add sp, sp, #STACK_SIZE
        restore_vregs
        restore_gprs
.endm

.data
.p2align 4
roots:
#include "ntt_kyber_123_45_67_twiddles.s"
.text

        .global ntt_kyber_123_4567_scalar_store_opt_m1_icestorm
        .global _ntt_kyber_123_4567_scalar_store_opt_m1_icestorm

.p2align 4
const_addr:       .short 3329
                  .short 20159
                  .short 0
                  .short 0
                  .short 0
                  .short 0
                  .short 0
                  .short 0
ntt_kyber_123_4567_scalar_store_opt_m1_icestorm:
_ntt_kyber_123_4567_scalar_store_opt_m1_icestorm:
        push_stack

        in      .req x0
        inp     .req x1
        count   .req x2
        r_ptr0  .req x3
        r_ptr1  .req x4
        xtmp    .req x5

        qform_v0  .req q0
        qform_v1  .req q1
        qform_v2  .req q2
        qform_v3  .req q3
        qform_v4  .req q4
        qform_v5  .req q5
        qform_v6  .req q6
        qform_v7  .req q7
        qform_v8  .req q8
        qform_v9  .req q9
        qform_v10 .req q10
        qform_v11 .req q11
        qform_v12 .req q12
        qform_v13 .req q13
        qform_v14 .req q14
        qform_v15 .req q15
        qform_v16 .req q16
        qform_v17 .req q17
        qform_v18 .req q18
        qform_v19 .req q19
        qform_v20 .req q20
        qform_v21 .req q21
        qform_v22 .req q22
        qform_v23 .req q23
        qform_v24 .req q24
        qform_v25 .req q25
        qform_v26 .req q26
        qform_v27 .req q27
        qform_v28 .req q28
        qform_v29 .req q29
        qform_v30 .req q30
        qform_v31 .req q31

        data0  .req v8
        data1  .req v9
        data2  .req v10
        data3  .req v11
        data4  .req v12
        data5  .req v13
        data6  .req v14
        data7  .req v15

        x_00 .req x10
        x_01 .req x11
        x_10 .req x12
        x_11 .req x13
        x_20 .req x14
        x_21 .req x15
        x_30 .req x16
        x_31 .req x17

        xt_00 .req x_00
        xt_01 .req x_20
        xt_10 .req x_10
        xt_11 .req x_30
        xt_20 .req x_01
        xt_21 .req x_21
        xt_30 .req x_11
        xt_31 .req x_31

        qform_data0  .req q8
        qform_data1  .req q9
        qform_data2  .req q10
        qform_data3  .req q11
        qform_data4  .req q12
        qform_data5  .req q13
        qform_data6  .req q14
        qform_data7  .req q15

        root0    .req v0
        root1    .req v1
        root2    .req v2
        root0_tw .req v4
        root1_tw .req v5
        root2_tw .req v6

        consts         .req v7
        qform_consts   .req q7

        qform_root0    .req q0
        qform_root1    .req q1
        qform_root2    .req q2
        qform_root0_tw .req q4
        qform_root1_tw .req q5
        qform_root2_tw .req q6

        tmp .req v24
        t0  .req v25
        t1  .req v26
        t2  .req v27
        t3  .req v28

        ASM_LOAD(r_ptr0, roots)
        ASM_LOAD(r_ptr1, roots_l56)

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]

        save STACK0, in
        mov count, #4

        load_roots_123

        .p2align 2
        ldr q8, [x0, #320]                      // ...*...............
        // gap                                  // ...................
        // gap                                  // ...................
        ldr q9, [x0, #256]                      // .*.................
        ldr q23, [x0, #448]                     // *..................
        // gap                                  // ...................
        // gap                                  // ...................
        // gap                                  // ...................
        ldr q31, [x0, #192]                     // .......*...........
        // gap                                  // ...................
        // gap                                  // ...................
        // gap                                  // ...................
        ldr q24, [x0, #64]                      // .........*.........
        // gap                                  // ...................
        // gap                                  // ...................
        // gap                                  // ...................
        sqrdmulh v13.8H, v9.8H, v0.H[1]         // .....*.............
        mul v9.8H, v9.8H, v0.H[0]               // ....*..............
        // gap                                  // ...................
        ldr q11, [x0, #384]                     // ..*................
        ldr q16, [x0, #128]                     // ........*..........
        // gap                                  // ...................
        // gap                                  // ...................
        sqrdmulh v15.8H, v23.8H, v0.H[1]        // ......*............
        mul v10.8H, v23.8H, v0.H[0]             // ..........*........
        ldr q30, [x0, #0]                       // ...........*.......
        // gap                                  // ...................
        // gap                                  // ...................
        mls v9.8H, v13.8H, v7.H[0]              // ............*......
        mul v29.8H, v8.8H, v0.H[0]              // ..................*
        // gap                                  // ...................
        // gap                                  // ...................
        sqrdmulh v20.8H, v11.8H, v0.H[1]        // .............*.....
        // gap                                  // ...................
        // gap                                  // ...................
        // gap                                  // ...................
        mul v28.8H, v11.8H, v0.H[0]             // ...............*...
        mls v10.8H, v15.8H, v7.H[0]             // ..............*....
        // gap                                  // ...................
        // gap                                  // ...................
        add v23.8H, v30.8H, v9.8H               // .................*.
        sub v15.8H, v30.8H, v9.8H               // ................*..
        // gap                                  // ...................
        // gap                                  // ...................

        // original source code
        // ldr q3, [x0, #448]                    // ..*................
        // ldr q22, [x0, #256]                   // .*.................
        // ldr q5, [x0, #384]                    // .......*...........
        // ldr q8, [x0, #320]                    // *..................
        // mul v21.8H, v22.8H, v0.H[0]           // ......*............
        // sqrdmulh v22.8H, v22.8H, v0.H[1]      // .....*.............
        // sqrdmulh v28.8H, v3.8H, v0.H[1]       // .........*.........
        // ldr q31, [x0, #192]                   // ...*...............
        // ldr q16, [x0, #128]                   // ........*..........
        // ldr q24, [x0, #64]                    // ....*..............
        // mul v10.8H, v3.8H, v0.H[0]            // ..........*........
        // ldr q19, [x0, #0]                     // ...........*.......
        // mls v21.8H, v22.8H, v7.H[0]           // ............*......
        // sqrdmulh v20.8H, v5.8H, v0.H[1]       // ..............*....
        // mls v10.8H, v28.8H, v7.H[0]           // ................*..
        // mul v28.8H, v5.8H, v0.H[0]            // ...............*...
        // sub v15.8H, v19.8H, v21.8H            // ..................*
        // add v23.8H, v19.8H, v21.8H            // .................*.
        // mul v29.8H, v8.8H, v0.H[0]            // .............*.....

        sub count, count, #1
layer123_start:
        sub v27.8H, v31.8H, v10.8H              // ..........................*.................................................
        sqrdmulh v25.8H, v8.8H, v0.H[1]         // ..............*.............................................................
        ldr q3, [x0, #464]                      // .......e....................................................................
        ldr q22, [x0, #272]                     // ....e.......................................................................
        mls v28.8H, v20.8H, v7.H[0]             // ....................*.......................................................
        ldr q5, [x0, #400]                      // ......e.....................................................................
        add v17.8H, v31.8H, v10.8H              // ...........................*................................................
        // gap                                  // ............................................................................
        mul v2.8H, v27.8H, v0.H[4]              // ...........................................*................................
        sqrdmulh v18.8H, v27.8H, v0.H[5]        // ............................................*...............................
        ldr q8, [x0, #336]                      // .....e......................................................................
        // gap                                  // ............................................................................
        sqrdmulh v27.8H, v17.8H, v0.H[3]        // ..................................*.........................................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        mls v29.8H, v25.8H, v7.H[0]             // ...............*............................................................
        mul v9.8H, v17.8H, v0.H[2]              // .................................*..........................................
        add v11.8H, v16.8H, v28.8H              // ......................*.....................................................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        mls v2.8H, v18.8H, v7.H[0]              // .............................................*..............................
        sub v17.8H, v16.8H, v28.8H              // .....................*......................................................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        sub v18.8H, v24.8H, v29.8H              // ................*...........................................................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        mul v26.8H, v11.8H, v0.H[2]             // ............................*...............................................
        mls v9.8H, v27.8H, v7.H[0]              // ...................................*........................................
        mul v20.8H, v17.8H, v0.H[4]             // ......................................*.....................................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        add v10.8H, v24.8H, v29.8H              // .................*..........................................................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        sub v28.8H, v18.8H, v2.8H               // ..............................................*.............................
        add v29.8H, v18.8H, v2.8H               // ...............................................*............................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        mul v21.8H, v22.8H, v0.H[0]             // ........e...................................................................
        sub v27.8H, v10.8H, v9.8H               // ....................................*.......................................
        mul v25.8H, v28.8H, v1.H[4]             // ...............................................................*............
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        sqrdmulh v30.8H, v11.8H, v0.H[3]        // .............................*..............................................
        sqrdmulh v18.8H, v28.8H, v1.H[5]        // ................................................................*...........
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        add v11.8H, v10.8H, v9.8H               // .....................................*......................................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        sqrdmulh v2.8H, v27.8H, v1.H[1]         // ......................................................*.....................
        mul v19.8H, v27.8H, v1.H[0]             // .....................................................*......................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        sqrdmulh v22.8H, v22.8H, v0.H[1]        // .........e..................................................................
        sqrdmulh v14.8H, v17.8H, v0.H[5]        // .......................................*....................................
        mls v26.8H, v30.8H, v7.H[0]             // ..............................*.............................................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        sqrdmulh v28.8H, v3.8H, v0.H[1]         // ........................e...................................................
        mul v6.8H, v11.8H, v0.H[6]              // ................................................*...........................
        sqrdmulh v16.8H, v11.8H, v0.H[7]        // .................................................*..........................
        mls v19.8H, v2.8H, v7.H[0]              // .......................................................*....................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        mls v20.8H, v14.8H, v7.H[0]             // ........................................*...................................
        sub v2.8H, v23.8H, v26.8H               // ...............................*............................................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        mls v25.8H, v18.8H, v7.H[0]             // .................................................................*..........
        mul v18.8H, v29.8H, v1.H[2]             // ..........................................................*.................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        sub v24.8H, v2.8H, v19.8H               // ........................................................*...................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        sqrdmulh v4.8H, v29.8H, v1.H[3]         // ...........................................................*................
        sub v27.8H, v15.8H, v20.8H              // .........................................*..................................
        mls v6.8H, v16.8H, v7.H[0]              // ..................................................*.........................
        // gap                                  // ............................................................................
        // gap                                  // ............................................................................
        add v29.8H, v23.8H, v26.8H              // ................................*...........................................
        str q24, [x0, #192]                     // .......................................................................*....
        add v24.8H, v2.8H, v19.8H               // .........................................................*..................
        ldr q31, [x0, #208]                     // ...e........................................................................
        mls v18.8H, v4.8H, v7.H[0]              // ............................................................*...............
        sub v11.8H, v27.8H, v25.8H              // ..................................................................*.........
        // gap                                  // ............................................................................
        ldr q16, [x0, #144]                     // ..e.........................................................................
        add v2.8H, v15.8H, v20.8H               // ..........................................*.................................
        str q24, [x0, #128]                     // ......................................................................*.....
        add v4.8H, v29.8H, v6.8H                // ....................................................*.......................
        ldr q24, [x0, #80]                      // .e..........................................................................
        mul v10.8H, v3.8H, v0.H[0]              // .......................e....................................................
        str q11, [x0, #448]                     // ...........................................................................*
        add v11.8H, v27.8H, v25.8H              // ...................................................................*........
        ldr q19, [x0, #16]                      // e...........................................................................
        mls v21.8H, v22.8H, v7.H[0]             // ..........e.................................................................
        str q4, [x0], #(16)                     // ....................................................................*.......
        sub v15.8H, v2.8H, v18.8H               // .............................................................*..............
        // gap                                  // ............................................................................
        str q11, [x0, #368]                     // ..........................................................................*.
        sqrdmulh v20.8H, v5.8H, v0.H[1]         // ...................e........................................................
        // gap                                  // ............................................................................
        add v30.8H, v2.8H, v18.8H               // ..............................................................*.............
        mls v10.8H, v28.8H, v7.H[0]             // .........................e..................................................
        sub v11.8H, v29.8H, v6.8H               // ...................................................*........................
        str q15, [x0, #304]                     // .........................................................................*..
        // gap                                  // ............................................................................
        mul v28.8H, v5.8H, v0.H[0]              // ..................e.........................................................
        str q30, [x0, #240]                     // ........................................................................*...
        // gap                                  // ............................................................................
        sub v15.8H, v19.8H, v21.8H              // ...........e................................................................
        add v23.8H, v19.8H, v21.8H              // ............e...............................................................
        str q11, [x0, #48]                      // .....................................................................*......
        // gap                                  // ............................................................................
        mul v29.8H, v8.8H, v0.H[0]              // .............e..............................................................

        // original source code
        // ldr q8, [x0, #0]                       // ..........................................................e...............|...........................................................e..............
        // ldr q9, [x0, #(1*(512/8))]             // ......................................................e...................|.......................................................e..................
        // ldr q10, [x0, #(2*(512/8))]            // ..................................................e.......................|...................................................e......................
        // ldr q11, [x0, #(3*(512/8))]            // ...............................................e..........................|................................................e.........................
        // ldr q12, [x0, #(4*(512/8))]            // .e........................................................................|..e.......................................................................
        // ldr q13, [x0, #(5*(512/8))]            // .......e..................................................................|........e.................................................................
        // ldr q14, [x0, #(6*(512/8))]            // ...e......................................................................|....e.....................................................................
        // ldr q15, [x0, #(7*(512/8))]            // e.........................................................................|.e........................................................................
        // mul v24.8h, v12.8h, v0.h[0]            // .....................e....................................................|......................e...................................................
        // sqrdmulh v12.8h, v12.8h, v0.h[1]       // .............................e............................................|..............................e...........................................
        // mls v24.8h, v12.8h, v7.h[0]            // ...........................................................e..............|............................................................e.............
        // sub     v12.8h,    v8.8h, v24.8h       // ......................................................................e...|.......................................................................e..
        // add     v8.8h,    v8.8h, v24.8h        // .......................................................................e..|........................................................................e.
        // mul v24.8h, v13.8h, v0.h[0]            // .........................................................................e|..........................................................................
        // sqrdmulh v13.8h, v13.8h, v0.h[1]       // ..........................................................................|*.........................................................................
        // mls v24.8h, v13.8h, v7.h[0]            // .........*................................................................|..........*...............................................................
        // sub     v13.8h,    v9.8h, v24.8h       // ..............*...........................................................|...............*..........................................................
        // add     v9.8h,    v9.8h, v24.8h        // ..................*.......................................................|...................*......................................................
        // mul v24.8h, v14.8h, v0.h[0]            // ....................................................................e.....|.....................................................................e....
        // sqrdmulh v14.8h, v14.8h, v0.h[1]       // ...............................................................e..........|................................................................e.........
        // mls v24.8h, v14.8h, v7.h[0]            // ..*.......................................................................|...*......................................................................
        // sub     v14.8h,    v10.8h, v24.8h      // .............*............................................................|..............*...........................................................
        // add     v10.8h,    v10.8h, v24.8h      // ...........*..............................................................|............*.............................................................
        // mul v24.8h, v15.8h, v0.h[0]            // .......................................................e..................|........................................................e.................
        // sqrdmulh v15.8h, v15.8h, v0.h[1]       // ................................e.........................................|.................................e........................................
        // mls v24.8h, v15.8h, v7.h[0]            // .................................................................e........|..................................................................e.......
        // sub     v15.8h,    v11.8h, v24.8h      // ..........................................................................*..........................................................................
        // add     v11.8h,    v11.8h, v24.8h      // ....*.....................................................................|.....*....................................................................
        // mul v24.8h, v10.8h, v0.h[2]            // ...............*..........................................................|................*.........................................................
        // sqrdmulh v10.8h, v10.8h, v0.h[3]       // ........................*.................................................|.........................*................................................
        // mls v24.8h, v10.8h, v7.h[0]            // ...............................*..........................................|................................*.........................................
        // sub     v10.8h,    v8.8h, v24.8h       // .....................................*....................................|......................................*...................................
        // add     v8.8h,    v8.8h, v24.8h        // ............................................*.............................|.............................................*............................
        // mul v24.8h, v11.8h, v0.h[2]            // ..........*...............................................................|...........*..............................................................
        // sqrdmulh v11.8h, v11.8h, v0.h[3]       // ........*.................................................................|.........*................................................................
        // mls v24.8h, v11.8h, v7.h[0]            // ................*.........................................................|.................*........................................................
        // sub     v11.8h,    v9.8h, v24.8h       // ......................*...................................................|.......................*..................................................
        // add     v9.8h,    v9.8h, v24.8h        // ..........................*...............................................|...........................*..............................................
        // mul v24.8h, v14.8h, v0.h[4]            // .................*........................................................|..................*.......................................................
        // sqrdmulh v14.8h, v14.8h, v0.h[5]       // ..............................*...........................................|...............................*..........................................
        // mls v24.8h, v14.8h, v7.h[0]            // ....................................*.....................................|.....................................*....................................
        // sub     v14.8h,    v12.8h, v24.8h      // ..........................................*...............................|...........................................*..............................
        // add     v12.8h,    v12.8h, v24.8h      // ...................................................*......................|....................................................*.....................
        // mul v24.8h, v15.8h, v0.h[4]            // .....*....................................................................|......*...................................................................
        // sqrdmulh v15.8h, v15.8h, v0.h[5]       // ......*...................................................................|.......*..................................................................
        // mls v24.8h, v15.8h, v7.h[0]            // ............*.............................................................|.............*............................................................
        // sub     v15.8h,    v13.8h, v24.8h      // ...................*......................................................|....................*.....................................................
        // add     v13.8h,    v13.8h, v24.8h      // ....................*.....................................................|.....................*....................................................
        // mul v24.8h, v9.8h, v0.h[6]             // .................................*........................................|..................................*.......................................
        // sqrdmulh v9.8h, v9.8h, v0.h[7]         // ..................................*.......................................|...................................*......................................
        // mls v24.8h, v9.8h, v7.h[0]             // ...........................................*..............................|............................................*.............................
        // sub     v9.8h,    v8.8h, v24.8h        // ..................................................................*.......|...................................................................*......
        // add     v8.8h,    v8.8h, v24.8h        // .....................................................*....................|......................................................*...................
        // mul v24.8h, v11.8h, v1.h[0]            // ............................*.............................................|.............................*............................................
        // sqrdmulh v11.8h, v11.8h, v1.h[1]       // ...........................*..............................................|............................*.............................................
        // mls v24.8h, v11.8h, v7.h[0]            // ...................................*......................................|....................................*.....................................
        // sub     v11.8h,    v10.8h, v24.8h      // ........................................*.................................|.........................................*................................
        // add     v10.8h,    v10.8h, v24.8h      // ..............................................*...........................|...............................................*..........................
        // mul v24.8h, v13.8h, v1.h[2]            // .......................................*..................................|........................................*.................................
        // sqrdmulh v13.8h, v13.8h, v1.h[3]       // .........................................*................................|..........................................*...............................
        // mls v24.8h, v13.8h, v7.h[0]            // ................................................*.........................|.................................................*........................
        // sub     v13.8h,    v12.8h, v24.8h      // .............................................................*............|..............................................................*...........
        // add     v12.8h,    v12.8h, v24.8h      // ................................................................*.........|.................................................................*........
        // mul v24.8h, v15.8h, v1.h[4]            // .......................*..................................................|........................*.................................................
        // sqrdmulh v15.8h, v15.8h, v1.h[5]       // .........................*................................................|..........................*...............................................
        // mls v24.8h, v15.8h, v7.h[0]            // ......................................*...................................|.......................................*..................................
        // sub     v15.8h,    v14.8h, v24.8h      // .................................................*........................|..................................................*.......................
        // add     v14.8h,    v14.8h, v24.8h      // .........................................................*................|..........................................................*...............
        // str q8, [x0], #(16)                    // ............................................................*.............|.............................................................*............
        // str q9, [x0, #(-16 + 1*(512/8))]       // ........................................................................*.|.........................................................................*
        // str q10, [x0, #(-16 + 2*(512/8))]      // ....................................................*.....................|.....................................................*....................
        // str q11, [x0, #(-16 + 3*(512/8))]      // .............................................*............................|..............................................*...........................
        // str q12, [x0, #(-16 + 4*(512/8))]      // .....................................................................*....|......................................................................*...
        // str q13, [x0, #(-16 + 5*(512/8))]      // ...................................................................*......|....................................................................*.....
        // str q14, [x0, #(-16 + 6*(512/8))]      // ..............................................................*...........|...............................................................*..........
        // str q15, [x0, #(-16 + 7*(512/8))]      // ........................................................*.................|.........................................................*................

        sub count, count, #1
        cbnz count, layer123_start
        sub v26.8H, v31.8H, v10.8H              // *........................................................
        sqrdmulh v27.8H, v8.8H, v0.H[1]         // .*.......................................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        mls v28.8H, v20.8H, v7.H[0]             // ..*......................................................
        add v6.8H, v31.8H, v10.8H               // ...*.....................................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        mul v14.8H, v26.8H, v0.H[4]             // ....*....................................................
        sqrdmulh v12.8H, v26.8H, v0.H[5]        // .....*...................................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        mls v29.8H, v27.8H, v7.H[0]             // .......*.................................................
        sqrdmulh v3.8H, v6.8H, v0.H[3]          // ......*..................................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        mul v18.8H, v6.8H, v0.H[2]              // ........*................................................
        add v17.8H, v16.8H, v28.8H              // .........*...............................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        sub v10.8H, v16.8H, v28.8H              // ...........*.............................................
        mls v14.8H, v12.8H, v7.H[0]             // ..........*..............................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        sub v9.8H, v24.8H, v29.8H               // ............*............................................
        mul v31.8H, v17.8H, v0.H[2]             // .............*...........................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        sqrdmulh v11.8H, v10.8H, v0.H[5]        // ..........................*..............................
        mls v18.8H, v3.8H, v7.H[0]              // ..............*..........................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        add v2.8H, v9.8H, v14.8H                // ..................*......................................
        mul v5.8H, v10.8H, v0.H[4]              // ...............*.........................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        add v8.8H, v24.8H, v29.8H               // ................*........................................
        sub v12.8H, v9.8H, v14.8H               // .................*.......................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        mul v22.8H, v2.8H, v1.H[2]              // ..................................*......................
        sqrdmulh v19.8H, v2.8H, v1.H[3]         // ....................................*....................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        sqrdmulh v20.8H, v12.8H, v1.H[5]        // ......................*..................................
        mls v5.8H, v11.8H, v7.H[0]              // ...............................*.........................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        mul v27.8H, v12.8H, v1.H[4]             // ....................*....................................
        sub v4.8H, v8.8H, v18.8H                // ...................*.....................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        sqrdmulh v26.8H, v17.8H, v0.H[3]        // .....................*...................................
        mls v22.8H, v19.8H, v7.H[0]             // ..........................................*..............
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        mul v25.8H, v4.8H, v1.H[0]              // .........................*...............................
        add v11.8H, v15.8H, v5.8H               // ............................................*............
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        mls v27.8H, v20.8H, v7.H[0]             // .................................*.......................
        add v8.8H, v8.8H, v18.8H                // .......................*.................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        sub v12.8H, v11.8H, v22.8H              // ..................................................*......
        sqrdmulh v2.8H, v4.8H, v1.H[1]          // ........................*................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        mul v30.8H, v8.8H, v0.H[6]              // ............................*............................
        mls v31.8H, v26.8H, v7.H[0]             // ...........................*.............................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        sub v24.8H, v15.8H, v5.8H               // .....................................*...................
        str q12, [x0, #320]                     // ......................................................*..
        sqrdmulh v18.8H, v8.8H, v0.H[7]         // .............................*...........................
        // gap                                  // .........................................................
        mls v25.8H, v2.8H, v7.H[0]              // ..............................*..........................
        add v6.8H, v11.8H, v22.8H               // ....................................................*....
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        add v22.8H, v24.8H, v27.8H              // ................................................*........
        sub v12.8H, v23.8H, v31.8H              // ................................*........................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        sub v9.8H, v24.8H, v27.8H               // ...........................................*.............
        mls v30.8H, v18.8H, v7.H[0]             // ......................................*..................
        str q6, [x0, #256]                      // .......................................................*.
        // gap                                  // .........................................................
        add v21.8H, v23.8H, v31.8H              // .......................................*.................
        add v26.8H, v12.8H, v25.8H              // .........................................*...............
        str q22, [x0, #384]                     // ...................................................*.....
        // gap                                  // .........................................................
        sub v8.8H, v12.8H, v25.8H               // ...................................*.....................
        str q9, [x0, #448]                      // ...............................................*.........
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        str q26, [x0, #128]                     // .............................................*...........
        add v13.8H, v21.8H, v30.8H              // ..............................................*..........
        sub v12.8H, v21.8H, v30.8H              // .....................................................*...
        // gap                                  // .........................................................
        str q8, [x0, #192]                      // ........................................*................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        str q13, [x0], #(16)                    // .................................................*.......
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        str q12, [x0, #48]                      // ........................................................*
        // gap                                  // .........................................................
        // gap                                  // .........................................................
        // gap                                  // .........................................................

        // original source code
        // sub v27.8H, v31.8H, v10.8H            // *........................................................
        // sqrdmulh v25.8H, v8.8H, v0.H[1]       // .*.......................................................
        // mls v28.8H, v20.8H, v7.H[0]           // ..*......................................................
        // add v17.8H, v31.8H, v10.8H            // ...*.....................................................
        // mul v2.8H, v27.8H, v0.H[4]            // ....*....................................................
        // sqrdmulh v18.8H, v27.8H, v0.H[5]      // .....*...................................................
        // sqrdmulh v27.8H, v17.8H, v0.H[3]      // .......*.................................................
        // mls v29.8H, v25.8H, v7.H[0]           // ......*..................................................
        // mul v9.8H, v17.8H, v0.H[2]            // ........*................................................
        // add v11.8H, v16.8H, v28.8H            // .........*...............................................
        // mls v2.8H, v18.8H, v7.H[0]            // ...........*.............................................
        // sub v17.8H, v16.8H, v28.8H            // ..........*..............................................
        // sub v18.8H, v24.8H, v29.8H            // ............*............................................
        // mul v26.8H, v11.8H, v0.H[2]           // .............*...........................................
        // mls v9.8H, v27.8H, v7.H[0]            // ...............*.........................................
        // mul v20.8H, v17.8H, v0.H[4]           // .................*.......................................
        // add v10.8H, v24.8H, v29.8H            // ..................*......................................
        // sub v28.8H, v18.8H, v2.8H             // ...................*.....................................
        // add v29.8H, v18.8H, v2.8H             // ................*........................................
        // sub v27.8H, v10.8H, v9.8H             // .........................*...............................
        // mul v25.8H, v28.8H, v1.H[4]           // ........................*................................
        // sqrdmulh v30.8H, v11.8H, v0.H[3]      // ..........................*..............................
        // sqrdmulh v18.8H, v28.8H, v1.H[5]      // ......................*..................................
        // add v11.8H, v10.8H, v9.8H             // ...............................*.........................
        // sqrdmulh v2.8H, v27.8H, v1.H[1]       // .................................*.......................
        // mul v19.8H, v27.8H, v1.H[0]           // ............................*............................
        // sqrdmulh v14.8H, v17.8H, v0.H[5]      // ..............*..........................................
        // mls v26.8H, v30.8H, v7.H[0]           // ...................................*.....................
        // mul v6.8H, v11.8H, v0.H[6]            // ..................................*......................
        // sqrdmulh v16.8H, v11.8H, v0.H[7]      // ......................................*..................
        // mls v19.8H, v2.8H, v7.H[0]            // .......................................*.................
        // mls v20.8H, v14.8H, v7.H[0]           // .......................*.................................
        // sub v2.8H, v23.8H, v26.8H             // ..........................................*..............
        // mls v25.8H, v18.8H, v7.H[0]           // ..............................*..........................
        // mul v18.8H, v29.8H, v1.H[2]           // ....................*....................................
        // sub v24.8H, v2.8H, v19.8H             // .................................................*.......
        // sqrdmulh v4.8H, v29.8H, v1.H[3]       // .....................*...................................
        // sub v27.8H, v15.8H, v20.8H            // ....................................*....................
        // mls v6.8H, v16.8H, v7.H[0]            // ............................................*............
        // add v29.8H, v23.8H, v26.8H            // ..............................................*..........
        // str q24, [x0, #192]                   // ......................................................*..
        // add v24.8H, v2.8H, v19.8H             // ...............................................*.........
        // mls v18.8H, v4.8H, v7.H[0]            // ...........................*.............................
        // sub v11.8H, v27.8H, v25.8H            // ...........................................*.............
        // add v2.8H, v15.8H, v20.8H             // .............................*...........................
        // str q24, [x0, #128]                   // ...................................................*.....
        // add v4.8H, v29.8H, v6.8H              // ....................................................*....
        // str q11, [x0, #448]                   // ..................................................*......
        // add v11.8H, v27.8H, v25.8H            // .........................................*...............
        // str q4, [x0], #(16)                   // .......................................................*.
        // sub v15.8H, v2.8H, v18.8H             // ................................*........................
        // str q11, [x0, #368]                   // ................................................*........
        // add v30.8H, v2.8H, v18.8H             // ........................................*................
        // sub v11.8H, v29.8H, v6.8H             // .....................................................*...
        // str q15, [x0, #304]                   // .....................................*...................
        // str q30, [x0, #240]                   // .............................................*...........
        // str q11, [x0, #48]                    // ........................................................*


        restore inp, STACK0
        mov count, #8

        .p2align 2
        ldr q0, [x3], #16                       // *..........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        ldr q8, [x1, #48]                       // .*.........................................................
        ldr q21, [x4, #80]                      // ...*.......................................................
        ldr q19, [x1, #32]                      // ..*........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        ldr q5, [x4, #16]                       // ........*..................................................
        ldr q27, [x4, #32]                      // .....*.....................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        ldr q9, [x1, #0]                        // ............*..............................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        sqrdmulh v14.8H, v8.8H, v0.H[1]         // .........*.................................................
        mul v30.8H, v8.8H, v0.H[0]              // ..........*................................................
        ldr q12, [x1, #16]                      // ...........*...............................................
        // gap                                  // ...........................................................
        sqrdmulh v20.8H, v19.8H, v0.H[1]        // ...............*...........................................
        ldr q16, [x4, #64]                      // ....*......................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        mul v17.8H, v19.8H, v0.H[0]             // ..............*............................................
        ldr q2, [x4, #48]                       // ......*....................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        mls v30.8H, v14.8H, v7.H[0]             // .............*.............................................
        ldr q3, [x4], #(6*16)                   // .......*...................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        mls v17.8H, v20.8H, v7.H[0]             // .................*.........................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        sub v1.8H, v12.8H, v30.8H               // ................*..........................................
        add v18.8H, v12.8H, v30.8H              // ..................*........................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        sqrdmulh v14.8H, v1.8H, v0.H[5]         // ...................*.......................................
        mul v22.8H, v1.8H, v0.H[4]              // ....................*......................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        sqrdmulh v15.8H, v18.8H, v0.H[3]        // .....................*.....................................
        mul v28.8H, v18.8H, v0.H[2]             // ......................*....................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        sub v25.8H, v9.8H, v17.8H               // .......................*...................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        mls v22.8H, v14.8H, v7.H[0]             // ........................*..................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        mls v28.8H, v15.8H, v7.H[0]             // .........................*.................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        add v14.8H, v9.8H, v17.8H               // ..........................*................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        add v24.8H, v25.8H, v22.8H              // ...........................*...............................
        sub v6.8H, v25.8H, v22.8H               // ............................*..............................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        sub v11.8H, v14.8H, v28.8H              // .............................*.............................
        add v22.8H, v14.8H, v28.8H              // ..............................*............................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        trn1 v18.4S, v24.4S, v6.4S              // .................................*.........................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        trn2 v0.4S, v24.4S, v6.4S               // ...............................*...........................
        trn2 v19.4S, v22.4S, v11.4S             // ................................*..........................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        trn1 v28.4S, v22.4S, v11.4S             // ..................................*........................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        trn2 v13.2D, v19.2D, v0.2D              // ....................................*......................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        trn1 v14.2D, v19.2D, v0.2D              // ...................................*.......................
        trn2 v23.2D, v28.2D, v18.2D             // ......................................*....................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        mul v0.8H, v13.8H, v3.8H                // .......................................*...................
        sqrdmulh v29.8H, v13.8H, v5.8H          // ........................................*..................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        mul v1.8H, v23.8H, v3.8H                // ..........................................*................
        sqrdmulh v31.8H, v23.8H, v5.8H          // .........................................*.................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        mls v0.8H, v29.8H, v7.H[0]              // ...........................................*...............
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        trn1 v10.2D, v28.2D, v18.2D             // .....................................*.....................
        mls v1.8H, v31.8H, v7.H[0]              // ............................................*..............
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        sub v26.8H, v14.8H, v0.8H               // ..............................................*............
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        add v20.8H, v14.8H, v0.8H               // .............................................*.............
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        sqrdmulh v31.8H, v26.8H, v21.8H         // ..................................................*........
        mul v24.8H, v26.8H, v16.8H              // .................................................*.........
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        sqrdmulh v15.8H, v20.8H, v2.8H          // ...............................................*...........
        mul v20.8H, v20.8H, v27.8H              // ................................................*..........
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        sub v3.8H, v10.8H, v1.8H                // .....................................................*.....
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        mls v24.8H, v31.8H, v7.H[0]             // ......................................................*....
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        mls v20.8H, v15.8H, v7.H[0]             // ....................................................*......
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        add v19.8H, v10.8H, v1.8H               // ...................................................*.......
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        add v11.8H, v3.8H, v24.8H               // .........................................................*.
        sub v9.8H, v3.8H, v24.8H                // ..........................................................*
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................
        sub v22.8H, v19.8H, v20.8H              // .......................................................*...
        add v2.8H, v19.8H, v20.8H               // ........................................................*..
        // gap                                  // ...........................................................
        // gap                                  // ...........................................................

        // original source code
        // ldr q13, [x3], #16                     // *..........................................................
        // ldr q6, [x1, #48]                      // .*.........................................................
        // ldr q31, [x1, #32]                     // ...*.......................................................
        // ldr q28, [x4, #80]                     // ..*........................................................
        // ldr q0, [x4, #64]                      // ...........*...............................................
        // ldr q3, [x4, #32]                      // .....*.....................................................
        // ldr q30, [x4, #48]                     // .............*.............................................
        // ldr q10, [x4], #(6*16)                 // ...............*...........................................
        // ldr q29, [x4, #-80]                    // ....*......................................................
        // sqrdmulh v21.8H, v6.8H, v13.H[1]       // .......*...................................................
        // mul v4.8H, v6.8H, v13.H[0]             // ........*..................................................
        // ldr q24, [x1, #16]                     // .........*.................................................
        // ldr q15, [x1, #0]                      // ......*....................................................
        // mls v4.8H, v21.8H, v7.H[0]             // ..............*............................................
        // mul v21.8H, v31.8H, v13.H[0]           // ............*..............................................
        // sqrdmulh v20.8H, v31.8H, v13.H[1]      // ..........*................................................
        // sub v11.8H, v24.8H, v4.8H              // .................*.........................................
        // mls v21.8H, v20.8H, v7.H[0]            // ................*..........................................
        // add v2.8H, v24.8H, v4.8H               // ..................*........................................
        // sqrdmulh v9.8H, v11.8H, v13.H[5]       // ...................*.......................................
        // mul v11.8H, v11.8H, v13.H[4]           // ....................*......................................
        // sqrdmulh v20.8H, v2.8H, v13.H[3]       // .....................*.....................................
        // mul v4.8H, v2.8H, v13.H[2]             // ......................*....................................
        // sub v23.8H, v15.8H, v21.8H             // .......................*...................................
        // mls v11.8H, v9.8H, v7.H[0]             // ........................*..................................
        // mls v4.8H, v20.8H, v7.H[0]             // .........................*.................................
        // add v13.8H, v15.8H, v21.8H             // ..........................*................................
        // add v2.8H, v23.8H, v11.8H              // ...........................*...............................
        // sub v9.8H, v23.8H, v11.8H              // ............................*..............................
        // sub v21.8H, v13.8H, v4.8H              // .............................*.............................
        // add v11.8H, v13.8H, v4.8H              // ..............................*............................
        // trn2 v12.4S, v2.4S, v9.4S              // ................................*..........................
        // trn2 v4.4S, v11.4S, v21.4S             // .................................*.........................
        // trn1 v20.4S, v2.4S, v9.4S              // ...............................*...........................
        // trn1 v16.4S, v11.4S, v21.4S            // ..................................*........................
        // trn1 v2.2D, v4.2D, v12.2D              // ....................................*......................
        // trn2 v24.2D, v4.2D, v12.2D             // ...................................*.......................
        // trn1 v21.2D, v16.2D, v20.2D            // ...........................................*...............
        // trn2 v4.2D, v16.2D, v20.2D             // .....................................*.....................
        // mul v11.8H, v24.8H, v10.8H             // ......................................*....................
        // sqrdmulh v20.8H, v24.8H, v29.8H        // .......................................*...................
        // sqrdmulh v9.8H, v4.8H, v29.8H          // .........................................*.................
        // mul v29.8H, v4.8H, v10.8H              // ........................................*..................
        // mls v11.8H, v20.8H, v7.H[0]            // ..........................................*................
        // mls v29.8H, v9.8H, v7.H[0]             // ............................................*..............
        // add v9.8H, v2.8H, v11.8H               // ..............................................*............
        // sub v11.8H, v2.8H, v11.8H              // .............................................*.............
        // sqrdmulh v30.8H, v9.8H, v30.8H         // .................................................*.........
        // mul v13.8H, v9.8H, v3.8H               // ..................................................*........
        // mul v20.8H, v11.8H, v0.8H              // ................................................*..........
        // sqrdmulh v9.8H, v11.8H, v28.8H         // ...............................................*...........
        // add v11.8H, v21.8H, v29.8H             // ......................................................*....
        // mls v13.8H, v30.8H, v7.H[0]            // .....................................................*.....
        // sub v27.8H, v21.8H, v29.8H             // ...................................................*.......
        // mls v20.8H, v9.8H, v7.H[0]             // ....................................................*......
        // sub v22.8H, v11.8H, v13.8H             // .........................................................*.
        // add v2.8H, v11.8H, v13.8H              // ..........................................................*
        // add v11.8H, v27.8H, v20.8H             // .......................................................*...
        // sub v9.8H, v27.8H, v20.8H              // ........................................................*..

        sub count, count, #1
layer4567_start:
        trn1 v27.4S, v2.4S, v22.4S               // ...........................................................*...............................
        trn2 v18.4S, v2.4S, v22.4S               // ............................................................*..............................
        ldr q13, [x3], #16                       // ....e......................................................................................
        ldr q6, [x1, #112]                       // ...e.......................................................................................
        ldr q31, [x1, #96]                       // ..e........................................................................................
        trn2 v5.4S, v11.4S, v9.4S                // ..............................................................*............................
        trn1 v22.4S, v11.4S, v9.4S               // .............................................................*.............................
        ldr q28, [x4, #80]                       // ......................................e....................................................
        sqdmulh v9.8H, v18.8H, v7.H[1]           // ..................................................................*........................
        sqdmulh v2.8H, v27.8H, v7.H[1]           // ...............................................................*...........................
        ldr q0, [x4, #64]                        // .....................................e.....................................................
        ldr q3, [x4, #32]                        // ...................................e.......................................................
        sqdmulh v23.8H, v5.8H, v7.H[1]           // ........................................................................*..................
        ldr q30, [x4, #48]                       // ....................................e......................................................
        ldr q10, [x4], #(6*16)                   // .................................e.........................................................
        sqdmulh v11.8H, v22.8H, v7.H[1]          // .....................................................................*.....................
        ldr q29, [x4, #-80]                      // ..................................e........................................................
        sqrdmulh v21.8H, v6.8H, v13.H[1]         // ...........e...............................................................................
        mul v4.8H, v6.8H, v13.H[0]               // ..........e................................................................................
        ldr q24, [x1, #80]                       // .e.........................................................................................
        ldr q15, [x1, #64]                       // e..........................................................................................
        srshr v20.8H, v9.8H, #11                 // ...................................................................*.......................
        srshr v2.8H, v2.8H, #11                  // ................................................................*..........................
        // gap                                   // ...........................................................................................
        srshr v9.8H, v23.8H, #11                 // .........................................................................*.................
        srshr v25.8H, v11.8H, #11                // ......................................................................*....................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        mls v4.8H, v21.8H, v7.H[0]               // ............e..............................................................................
        mul v21.8H, v31.8H, v13.H[0]             // .....e.....................................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        mls v18.8H, v20.8H, v7.H[0]              // ....................................................................*......................
        sqrdmulh v20.8H, v31.8H, v13.H[1]        // ......e....................................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        mls v5.8H, v9.8H, v7.H[0]                // ..........................................................................*................
        mls v22.8H, v25.8H, v7.H[0]              // .......................................................................*...................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        mls v27.8H, v2.8H, v7.H[0]               // .................................................................*.........................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        sub v11.8H, v24.8H, v4.8H                // .............e.............................................................................
        mls v21.8H, v20.8H, v7.H[0]              // .......e...................................................................................
        // gap                                   // ...........................................................................................
        add v2.8H, v24.8H, v4.8H                 // ..............e............................................................................
        // gap                                   // ...........................................................................................
        sqrdmulh v9.8H, v11.8H, v13.H[5]         // .....................e.....................................................................
        mul v11.8H, v11.8H, v13.H[4]             // ....................e......................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        sqrdmulh v20.8H, v2.8H, v13.H[3]         // ................e..........................................................................
        mul v4.8H, v2.8H, v13.H[2]               // ...............e...........................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        umov x25, v27.d[0]                       // ...........................................................................*...............
        sub v23.8H, v15.8H, v21.8H               // ........e..................................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        mls v11.8H, v9.8H, v7.H[0]               // ......................e....................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        mls v4.8H, v20.8H, v7.H[0]               // .................e.........................................................................
        umov x15, v22.d[1]                       // ................................................................................*..........
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        add v13.8H, v15.8H, v21.8H               // .........e.................................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        str x25, [x1], #( 16*4)                  // ...................................................................................*.......
        add v2.8H, v23.8H, v11.8H                // ........................e..................................................................
        sub v9.8H, v23.8H, v11.8H                // .......................e...................................................................
        // gap                                   // ...........................................................................................
        sub v21.8H, v13.8H, v4.8H                // ..................e........................................................................
        add v11.8H, v13.8H, v4.8H                // ...................e.......................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        str x15, [x1, #-24]                      // ........................................................................................*..
        umov x15, v5.d[0]                        // .................................................................................*.........
        trn2 v12.4S, v2.4S, v9.4S                // ............................e..............................................................
        // gap                                   // ...........................................................................................
        trn2 v4.4S, v11.4S, v21.4S               // ..........................e................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        trn1 v20.4S, v2.4S, v9.4S                // ...........................e...............................................................
        trn1 v16.4S, v11.4S, v21.4S              // .........................e.................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        trn1 v2.2D, v4.2D, v12.2D                // ................................e..........................................................
        trn2 v24.2D, v4.2D, v12.2D               // ..............................e............................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        str x15, [x1, #-40]                      // ......................................................................................*....
        trn1 v21.2D, v16.2D, v20.2D              // ...............................e...........................................................
        trn2 v4.2D, v16.2D, v20.2D               // .............................e.............................................................
        // gap                                   // ...........................................................................................
        mul v11.8H, v24.8H, v10.8H               // ............................................e..............................................
        sqrdmulh v20.8H, v24.8H, v29.8H          // .............................................e.............................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        umov x10, v5.d[1]                        // ..................................................................................*........
        sqrdmulh v9.8H, v4.8H, v29.8H            // ........................................e..................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        mul v29.8H, v4.8H, v10.8H                // .......................................e...................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        umov x15, v27.d[1]                       // ............................................................................*..............
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        mls v11.8H, v20.8H, v7.H[0]              // ..............................................e............................................
        umov x19, v22.d[0]                       // ...............................................................................*...........
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        mls v29.8H, v9.8H, v7.H[0]               // .........................................e.................................................
        str x10, [x1, #-8]                       // ..........................................................................................*
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        umov x10, v18.d[1]                       // ..............................................................................*............
        add v9.8H, v2.8H, v11.8H                 // ................................................e..........................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        str x15, [x1, #-32]                      // .......................................................................................*...
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        sub v11.8H, v2.8H, v11.8H                // ...............................................e...........................................
        str x19, [x1, #-56]                      // ....................................................................................*......
        sqrdmulh v30.8H, v9.8H, v30.8H           // ..................................................e........................................
        mul v13.8H, v9.8H, v3.8H                 // .................................................e.........................................
        // gap                                   // ...........................................................................................
        mul v20.8H, v11.8H, v0.8H                // ......................................................e....................................
        sqrdmulh v9.8H, v11.8H, v28.8H           // .......................................................e...................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        add v11.8H, v21.8H, v29.8H               // ...........................................e...............................................
        umov x15, v18.d[0]                       // .............................................................................*.............
        str x10, [x1, #-16]                      // .........................................................................................*.
        // gap                                   // ...........................................................................................
        mls v13.8H, v30.8H, v7.H[0]              // ...................................................e.......................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        sub v27.8H, v21.8H, v29.8H               // ..........................................e................................................
        mls v20.8H, v9.8H, v7.H[0]               // ........................................................e..................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................
        sub v22.8H, v11.8H, v13.8H               // ....................................................e......................................
        str x15, [x1, #-48]                      // .....................................................................................*.....
        add v2.8H, v11.8H, v13.8H                // .....................................................e.....................................
        // gap                                   // ...........................................................................................
        add v11.8H, v27.8H, v20.8H               // ..........................................................e................................
        sub v9.8H, v27.8H, v20.8H                // .........................................................e.................................
        // gap                                   // ...........................................................................................
        // gap                                   // ...........................................................................................

        // original source code
        // ldr q8, [x1, #(16*0)]                  // ..................e......................................................................|...................e...................................................................
        // ldr q9, [x1, #(16*1)]                  // .................e.......................................................................|..................e....................................................................
        // ldr q10, [x1, #(16*2)]                 // ..e......................................................................................|...e...................................................................................
        // ldr q11, [x1, #(16*3)]                 // .e.......................................................................................|..e....................................................................................
        // ldr q0, [x3], #16                      // e........................................................................................|.e.....................................................................................
        // mul v24.8h, v10.8h, v0.h[0]            // ........................e................................................................|.........................e.............................................................
        // sqrdmulh v10.8h, v10.8h, v0.h[1]       // ..........................e..............................................................|...........................e...........................................................
        // mls v24.8h, v10.8h, v7.h[0]            // ...............................e.........................................................|................................e......................................................
        // sub     v10.8h,    v8.8h, v24.8h       // ......................................e..................................................|.......................................e...............................................
        // add     v8.8h,    v8.8h, v24.8h        // ..........................................e..............................................|...........................................e...........................................
        // mul v24.8h, v11.8h, v0.h[0]            // ................e........................................................................|.................e.....................................................................
        // sqrdmulh v11.8h, v11.8h, v0.h[1]       // ...............e.........................................................................|................e......................................................................
        // mls v24.8h, v11.8h, v7.h[0]            // .......................e.................................................................|........................e..............................................................
        // sub     v11.8h,    v9.8h, v24.8h       // ..............................e..........................................................|...............................e.......................................................
        // add     v9.8h,    v9.8h, v24.8h        // ................................e........................................................|.................................e.....................................................
        // mul v24.8h, v9.8h, v0.h[2]             // ....................................e....................................................|.....................................e.................................................
        // sqrdmulh v9.8h, v9.8h, v0.h[3]         // ...................................e.....................................................|....................................e..................................................
        // mls v24.8h, v9.8h, v7.h[0]             // ........................................e................................................|.........................................e.............................................
        // sub     v9.8h,    v8.8h, v24.8h        // ..............................................e..........................................|...............................................e.......................................
        // add     v8.8h,    v8.8h, v24.8h        // ...............................................e.........................................|................................................e......................................
        // mul v24.8h, v11.8h, v0.h[4]            // ..................................e......................................................|...................................e...................................................
        // sqrdmulh v11.8h, v11.8h, v0.h[5]       // .................................e.......................................................|..................................e....................................................
        // mls v24.8h, v11.8h, v7.h[0]            // .......................................e.................................................|........................................e..............................................
        // sub     v11.8h,    v10.8h, v24.8h      // .............................................e...........................................|..............................................e........................................
        // add     v10.8h,    v10.8h, v24.8h      // ............................................e............................................|.............................................e.........................................
        // trn1 v25.4s, v8.4s, v9.4s              // .....................................................e...................................|......................................................e................................
        // trn2 v26.4s, v8.4s, v9.4s              // ...................................................e.....................................|....................................................e..................................
        // trn1 v27.4s, v10.4s, v11.4s            // ....................................................e....................................|.....................................................e.................................
        // trn2 v28.4s, v10.4s, v11.4s            // ..................................................e......................................|...................................................e...................................
        // trn2 v10.2d, v25.2d, v27.2d            // ..........................................................e..............................|...........................................................e...........................
        // trn2 v11.2d, v26.2d, v28.2d            // .......................................................e.................................|........................................................e..............................
        // trn1 v8.2d, v25.2d, v27.2d             // .........................................................e...............................|..........................................................e............................
        // trn1 v9.2d, v26.2d, v28.2d             // ......................................................e..................................|.......................................................e...............................
        // ldr q0, [x4], #(6*16)                  // ............e............................................................................|.............e.........................................................................
        // ldr q4, [x4, #(-6*16 + 1*16)]          // ..............e..........................................................................|...............e.......................................................................
        // ldr q1, [x4, #(-6*16 + 2*16)]          // .........e...............................................................................|..........e............................................................................
        // ldr q5, [x4, #(-6*16 + 3*16)]          // ...........e.............................................................................|............e..........................................................................
        // ldr q2, [x4, #(-6*16 + 4*16)]          // ........e................................................................................|.........e.............................................................................
        // ldr q6, [x4, #(-6*16 + 5*16)]          // .....e...................................................................................|......e................................................................................
        // mul        v24.8h,  v10.8h, v0.8h      // ...............................................................e.........................|................................................................e......................
        // sqrdmulh v10.8h, v10.8h, v4.8h         // ..............................................................e..........................|...............................................................e.......................
        // mls v24.8h, v10.8h, v7.h[0]            // ...................................................................e.....................|....................................................................e..................
        // sub    v10.8h,    v8.8h, v24.8h        // ..................................................................................e......|...................................................................................e...
        // add    v8.8h,    v8.8h, v24.8h         // ..............................................................................e..........|...............................................................................e.......
        // mul        v24.8h,  v11.8h, v0.8h      // ...........................................................e.............................|............................................................e..........................
        // sqrdmulh v11.8h, v11.8h, v4.8h         // ............................................................e............................|.............................................................e.........................
        // mls v24.8h, v11.8h, v7.h[0]            // .................................................................e.......................|..................................................................e....................
        // sub    v11.8h,    v9.8h, v24.8h        // ........................................................................e................|.........................................................................e.............
        // add    v9.8h,    v9.8h, v24.8h         // ......................................................................e..................|.......................................................................e...............
        // mul        v24.8h,  v9.8h, v1.8h       // ...........................................................................e.............|............................................................................e..........
        // sqrdmulh v9.8h, v9.8h, v5.8h           // ..........................................................................e..............|...........................................................................e...........
        // mls v24.8h, v9.8h, v7.h[0]             // .................................................................................e.......|..................................................................................e....
        // sub    v9.8h,    v8.8h, v24.8h         // ....................................................................................e....|.....................................................................................e.
        // add    v8.8h,    v8.8h, v24.8h         // ......................................................................................e..|.......................................................................................
        // mul        v24.8h,  v11.8h, v2.8h      // ............................................................................e............|.............................................................................e.........
        // sqrdmulh v11.8h, v11.8h, v6.8h         // .............................................................................e...........|..............................................................................e........
        // mls v24.8h, v11.8h, v7.h[0]            // ...................................................................................e.....|....................................................................................e..
        // sub    v11.8h,    v10.8h, v24.8h       // ........................................................................................e|.......................................................................................
        // add    v10.8h,    v10.8h, v24.8h       // .......................................................................................e.|.......................................................................................
        // trn1 v25.4s, v8.4s, v9.4s              // .........................................................................................*.......................................................................................
        // trn2 v26.4s, v8.4s, v9.4s              // .........................................................................................|*......................................................................................
        // trn1 v27.4s, v10.4s, v11.4s            // ....*....................................................................................|.....*.................................................................................
        // trn2 v28.4s, v10.4s, v11.4s            // ...*.....................................................................................|....*..................................................................................
        // sqdmulh v24.8h, v25.8h, v7.h[1]        // .......*.................................................................................|........*..............................................................................
        // srshr    v24.8h, v24.8h, #11           // ....................*....................................................................|.....................*.................................................................
        // mls v25.8h, v24.8h, v7.h[0]            // .............................*...........................................................|..............................*........................................................
        // sqdmulh v24.8h, v26.8h, v7.h[1]        // ......*..................................................................................|.......*...............................................................................
        // srshr    v24.8h, v24.8h, #11           // ...................*.....................................................................|....................*..................................................................
        // mls v26.8h, v24.8h, v7.h[0]            // .........................*...............................................................|..........................*............................................................
        // sqdmulh v24.8h, v27.8h, v7.h[1]        // .............*...........................................................................|..............*........................................................................
        // srshr    v24.8h, v24.8h, #11           // ......................*..................................................................|.......................*...............................................................
        // mls v27.8h, v24.8h, v7.h[0]            // ............................*............................................................|.............................*.........................................................
        // sqdmulh v24.8h, v28.8h, v7.h[1]        // ..........*..............................................................................|...........*...........................................................................
        // srshr    v24.8h, v24.8h, #11           // .....................*...................................................................|......................*................................................................
        // mls v28.8h, v24.8h, v7.h[0]            // ...........................*.............................................................|............................*..........................................................
        // umov x10, v25.d[0]                     // .....................................*...................................................|......................................*................................................
        // umov x11, v25.d[1]                     // ................................................................*........................|.................................................................*.....................
        // umov x12, v26.d[0]                     // ...............................................................................*.........|................................................................................*......
        // umov x13, v26.d[1]                     // .....................................................................*...................|......................................................................*................
        // umov x14, v27.d[0]                     // ..................................................................*......................|...................................................................*...................
        // umov x15, v27.d[1]                     // .........................................*...............................................|..........................................*............................................
        // umov x16, v28.d[0]                     // .................................................*.......................................|..................................................*....................................
        // umov x17, v28.d[1]                     // .............................................................*...........................|..............................................................*........................
        // str x10, [x1], #( 16*4)                // ...........................................*.............................................|............................................*..........................................
        // str x14, [x1,  #(-16*4 + 8*1)]         // .........................................................................*...............|..........................................................................*............
        // str x12, [x1,  #(-16*4 + 8*2)]         // .....................................................................................*...|......................................................................................*
        // str x16, [x1,  #(-16*4 + 8*3)]         // ........................................................*................................|.........................................................*.............................
        // str x11, [x1,  #(-16*4 + 8*4)]         // .......................................................................*.................|........................................................................*..............
        // str x15, [x1,  #(-16*4 + 8*5)]         // ................................................*........................................|.................................................*.....................................
        // str x13, [x1,  #(-16*4 + 8*6)]         // ................................................................................*........|.................................................................................*.....
        // str x17, [x1,  #(-16*4 + 8*7)]         // ....................................................................*....................|.....................................................................*.................

        sub count, count, #1
        cbnz count, layer4567_start
        trn1 v20.4S, v2.4S, v22.4S             // *...............................
        trn2 v2.4S, v2.4S, v22.4S              // .*..............................
        // gap                                 // ................................
        // gap                                 // ................................
        trn2 v22.4S, v11.4S, v9.4S             // ..*.............................
        trn1 v9.4S, v11.4S, v9.4S              // ...*............................
        // gap                                 // ................................
        // gap                                 // ................................
        sqdmulh v11.8H, v2.8H, v7.H[1]         // ....*...........................
        sqdmulh v27.8H, v20.8H, v7.H[1]        // .....*..........................
        // gap                                 // ................................
        // gap                                 // ................................
        sqdmulh v18.8H, v22.8H, v7.H[1]        // ......*.........................
        sqdmulh v30.8H, v9.8H, v7.H[1]         // .......*........................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        srshr v11.8H, v11.8H, #11              // ........*.......................
        srshr v27.8H, v27.8H, #11              // .........*......................
        // gap                                 // ................................
        // gap                                 // ................................
        srshr v18.8H, v18.8H, #11              // ..........*.....................
        srshr v30.8H, v30.8H, #11              // ...........*....................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        mls v20.8H, v27.8H, v7.H[0]            // ...............*................
        mls v2.8H, v11.8H, v7.H[0]             // ............*...................
        // gap                                 // ................................
        // gap                                 // ................................
        mls v22.8H, v18.8H, v7.H[0]            // .............*..................
        mls v9.8H, v30.8H, v7.H[0]             // ..............*.................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        umov x15, v20.d[0]                     // ................*...............
        umov x10, v20.d[1]                     // .......................*........
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        umov x19, v9.d[1]                      // .................*..............
        umov x13, v22.d[0]                     // ....................*...........
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        umov x12, v22.d[1]                     // ......................*.........
        umov x25, v9.d[0]                      // ........................*.......
        str x15, [x1], #( 16*4)                // ..................*.............
        // gap                                 // ................................
        str x10, [x1, #-32]                    // ...........................*....
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        umov x15, v2.d[1]                      // ..........................*.....
        umov x10, v2.d[0]                      // .............................*..
        str x19, [x1, #-24]                    // ...................*............
        // gap                                 // ................................
        str x13, [x1, #-40]                    // .....................*..........
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        str x12, [x1, #-8]                     // .........................*......
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        str x25, [x1, #-56]                    // ............................*...
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        str x15, [x1, #-16]                    // ..............................*.
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................
        str x10, [x1, #-48]                    // ...............................*
        // gap                                 // ................................
        // gap                                 // ................................
        // gap                                 // ................................

        // original source code
        // trn1 v27.4S, v2.4S, v22.4S           // *...............................
        // trn2 v18.4S, v2.4S, v22.4S           // .*..............................
        // trn2 v5.4S, v11.4S, v9.4S            // ..*.............................
        // trn1 v22.4S, v11.4S, v9.4S           // ...*............................
        // sqdmulh v9.8H, v18.8H, v7.H[1]       // ....*...........................
        // sqdmulh v2.8H, v27.8H, v7.H[1]       // .....*..........................
        // sqdmulh v23.8H, v5.8H, v7.H[1]       // ......*.........................
        // sqdmulh v11.8H, v22.8H, v7.H[1]      // .......*........................
        // srshr v20.8H, v9.8H, #11             // ........*.......................
        // srshr v2.8H, v2.8H, #11              // .........*......................
        // srshr v9.8H, v23.8H, #11             // ..........*.....................
        // srshr v25.8H, v11.8H, #11            // ...........*....................
        // mls v18.8H, v20.8H, v7.H[0]          // .............*..................
        // mls v5.8H, v9.8H, v7.H[0]            // ..............*.................
        // mls v22.8H, v25.8H, v7.H[0]          // ...............*................
        // mls v27.8H, v2.8H, v7.H[0]           // ............*...................
        // umov x25, v27.d[0]                   // ................*...............
        // umov x15, v22.d[1]                   // ..................*.............
        // str x25, [x1], #( 16*4)              // ......................*.........
        // str x15, [x1, #-24]                  // ..........................*.....
        // umov x15, v5.d[0]                    // ...................*............
        // str x15, [x1, #-40]                  // ...........................*....
        // umov x10, v5.d[1]                    // ....................*...........
        // umov x15, v27.d[1]                   // .................*..............
        // umov x19, v22.d[0]                   // .....................*..........
        // str x10, [x1, #-8]                   // ............................*...
        // umov x10, v18.d[1]                   // ........................*.......
        // str x15, [x1, #-32]                  // .......................*........
        // str x19, [x1, #-56]                  // .............................*..
        // umov x15, v18.d[0]                   // .........................*......
        // str x10, [x1, #-16]                  // ..............................*.
        // str x15, [x1, #-48]                  // ...............................*


       pop_stack
       ret