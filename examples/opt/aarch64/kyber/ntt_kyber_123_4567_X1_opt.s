///
/// Copyright (c) 2022 Arm Limited
/// Copyright (c) 2022 Hanno Becker
/// Copyright (c) 2023 Amin Abdulrahman, Matthias Kannwischer
/// SPDX-License-Identifier: MIT
///
/// Permission is hereby granted, free of charge, to any person obtaining a copy
/// of this software and associated documentation files (the "Software"), to deal
/// in the Software without restriction, including without limitation the rights
/// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
/// copies of the Software, and to permit persons to whom the Software is
/// furnished to do so, subject to the following conditions:
///
/// The above copyright notice and this permission notice shall be included in all
/// copies or substantial portions of the Software.
///
/// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
/// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
/// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
/// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
/// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
/// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
/// SOFTWARE.
///

// Needed to provide ASM_LOAD directive
#include <hal_env.h>

// NOTE
// We use a lot of trivial macros to simplify the parsing burden for Slothy
// The macros are not unfolded by Slothy and thus interpreted as instructions,
// which are easier to parse due to e.g. the lack of size specifiers and simpler
// syntax for pre and post increment for loads and stores.
//
// Eventually, NeLight should include a proper parser for AArch64,
// but for initial investigations, the below is enough.

.macro ldr_vo vec, base, offset                    // slothy:no-unfold
        ldr qform_\vec, [\base, \offset]
.endm
.macro ldr_vi vec, base, inc                        // slothy:no-unfold
        ldr qform_\vec, [\base], \inc
.endm
.macro str_vo vec, base, offset                     // slothy:no-unfold
        str qform_\vec, [\base, \offset]
.endm
.macro str_vi vec, base, inc                        // slothy:no-unfold
        str qform_\vec, [\base], \inc
.endm
.macro vsub d,a,b                                   // slothy:no-unfold
        sub \d\().8h, \a\().8h, \b\().8h
.endm
.macro vadd d,a,b                                   // slothy:no-unfold
        add \d\().8h, \a\().8h, \b\().8h
.endm
.macro vqrdmulh d,a,b                               // slothy:no-unfold
        sqrdmulh \d\().8h, \a\().8h, \b\().8h
.endm
.macro vmul d,a,b                                   // slothy:no-unfold
        mul \d\().8h, \a\().8h, \b\().8h
.endm
.macro vmla d,a,b                                   // slothy:no-unfold
        mla \d\().8h, \a\().8h, \b\().8h
.endm
.macro vqrdmulhq d,a,b,i                            // slothy:no-unfold
        sqrdmulh \d\().8h, \a\().8h, \b\().h[\i]
.endm
.macro vqdmulhq d,a,b,i                            // slothy:no-unfold
        sqdmulh \d\().8h, \a\().8h, \b\().h[\i]
.endm
.macro vmulq d,a,b,i                                // slothy:no-unfold
        mul \d\().8h, \a\().8h, \b\().h[\i]
.endm
.macro vmlaq d,a,b,i                                // slothy:no-unfold
        mla \d\().8h, \a\().8h, \b\().h[\i]
.endm
.macro trn1_d d,a,b                                 // slothy:no-unfold
        trn1 \d\().2d, \a\().2d, \b\().2d
.endm
.macro trn2_d d,a,b                                 // slothy:no-unfold
        trn2 \d\().2d, \a\().2d, \b\().2d
.endm
.macro trn1_s d,a,b                                 // slothy:no-unfold
        trn1 \d\().4s, \a\().4s, \b\().4s
.endm
.macro trn2_s d,a,b                                 // slothy:no-unfold
        trn2 \d\().4s, \a\().4s, \b\().4s
.endm

.macro mulmodq dst, src, const, idx0, idx1
        vmulq       \dst,  \src, \const, \idx0
        vqrdmulhq   \src,  \src, \const, \idx1
        vmla        \dst,  \src, modulus
.endm

.macro mulmod dst, src, const, const_twisted
        vmul       \dst,  \src, \const
        vqrdmulh   \src,  \src, \const_twisted
        vmla       \dst,  \src, modulus
.endm

.macro ct_butterfly a, b, root, idx0, idx1
        mulmodq  tmp, \b, \root, \idx0, \idx1
        vsub     \b,    \a, tmp
        vadd     \a,    \a, tmp
.endm

.macro mulmod_v dst, src, const, const_twisted
        vmul        \dst,  \src, \const
        vqrdmulh    \src,  \src, \const_twisted
        vmla        \dst,  \src, modulus
.endm

.macro ct_butterfly_v a, b, root, root_twisted
        mulmod  tmp, \b, \root, \root_twisted
        vsub    \b,    \a, tmp
        vadd    \a,    \a, tmp
.endm

.macro barrett_reduce a, barrett_const, barrett_const_idx
        vqdmulhq t0, \a, \barrett_const, \barrett_const_idx
        srshr    t0.8H, t0.8H, #11
        vmla     \a, t0, modulus
.endm 

.macro load_roots_123
        ldr_vi root0, r_ptr0, 32
        ldr_vo root1, r_ptr0, -16
.endm

.macro load_next_roots_45 root0, r_ptr0
        ldr_vi \root0, \r_ptr0, 16
.endm

.macro load_next_roots_67 root0, root0_tw, root1, root1_tw, root2, root2_tw, r_ptr1
        ldr_vi \root0,    \r_ptr1, (6*16)
        ldr_vo \root0_tw, \r_ptr1, (-6*16 + 1*16)
        ldr_vo \root1,    \r_ptr1, (-6*16 + 2*16)
        ldr_vo \root1_tw, \r_ptr1, (-6*16 + 3*16)
        ldr_vo \root2,    \r_ptr1, (-6*16 + 4*16)
        ldr_vo \root2_tw, \r_ptr1, (-6*16 + 5*16)
.endm

.macro transpose4 data
        trn1_s t0, \data\()0, \data\()1
        trn2_s t1, \data\()0, \data\()1
        trn1_s t2, \data\()2, \data\()3
        trn2_s t3, \data\()2, \data\()3

        trn2_d \data\()2, t0, t2
        trn2_d \data\()3, t1, t3
        trn1_d \data\()0, t0, t2
        trn1_d \data\()1, t1, t3
.endm

.macro save_gprs // slothy:no-unfold
        sub sp, sp, #(16*6)
        stp x19, x20, [sp, #16*0]
        stp x19, x20, [sp, #16*0]
        stp x21, x22, [sp, #16*1]
        stp x23, x24, [sp, #16*2]
        stp x25, x26, [sp, #16*3]
        stp x27, x28, [sp, #16*4]
        str x29, [sp, #16*5]
.endm

.macro restore_gprs // slothy:no-unfold
        ldp x19, x20, [sp, #16*0]
        ldp x21, x22, [sp, #16*1]
        ldp x23, x24, [sp, #16*2]
        ldp x25, x26, [sp, #16*3]
        ldp x27, x28, [sp, #16*4]
        ldr x29, [sp, #16*5]
        add sp, sp, #(16*6)
.endm

.macro save_vregs // slothy:no-unfold
        sub sp, sp, #(16*4)
        stp  d8,  d9, [sp, #16*0]
        stp d10, d11, [sp, #16*1]
        stp d12, d13, [sp, #16*2]
        stp d14, d15, [sp, #16*3]
.endm

.macro restore_vregs // slothy:no-unfold
        ldp  d8,  d9, [sp, #16*0]
        ldp d10, d11, [sp, #16*1]
        ldp d12, d13, [sp, #16*2]
        ldp d14, d15, [sp, #16*3]
        add sp, sp, #(16*4)
.endm

#define STACK_SIZE 16
#define STACK0 0

.macro restore a, loc     // slothy:no-unfold
        ldr \a, [sp, #\loc\()]
.endm
.macro save loc, a        // slothy:no-unfold
        str \a, [sp, #\loc\()]
.endm
.macro push_stack // slothy:no-unfold
        save_gprs
        save_vregs
        sub sp, sp, #STACK_SIZE
.endm

.macro pop_stack // slothy:no-unfold
        add sp, sp, #STACK_SIZE
        restore_vregs
        restore_gprs
.endm

.data
.p2align 4
roots:
#include "ntt_kyber_123_45_67_twiddles.s"
.text

        .global ntt_kyber_123_4567_X1_opt
        .global _ntt_kyber_123_4567_X1

.p2align 4
modulus_addr:       .quad -3329
barrett_const_addr: .quad 20159
ntt_kyber_123_4567_X1_opt:
_ntt_kyber_123_4567_X1_opt:
        push_stack

        in      .req x0
        inp     .req x1
        count   .req x2
        r_ptr0  .req x3
        r_ptr1  .req x4
        xtmp    .req x5

        qform_v0  .req q0
        qform_v1  .req q1
        qform_v2  .req q2
        qform_v3  .req q3
        qform_v4  .req q4
        qform_v5  .req q5
        qform_v6  .req q6
        qform_v7  .req q7
        qform_v8  .req q8
        qform_v9  .req q9
        qform_v10 .req q10
        qform_v11 .req q11
        qform_v12 .req q12
        qform_v13 .req q13
        qform_v14 .req q14
        qform_v15 .req q15
        qform_v16 .req q16
        qform_v17 .req q17
        qform_v18 .req q18
        qform_v19 .req q19
        qform_v20 .req q20
        qform_v21 .req q21
        qform_v22 .req q22
        qform_v23 .req q23
        qform_v24 .req q24
        qform_v25 .req q25
        qform_v26 .req q26
        qform_v27 .req q27
        qform_v28 .req q28
        qform_v29 .req q29
        qform_v30 .req q30
        qform_v31 .req q31

        data0  .req v8
        data1  .req v9
        data2  .req v10
        data3  .req v11
        data4  .req v12
        data5  .req v13
        data6  .req v14
        data7  .req v15
        data8  .req v16
        data9  .req v17
        data10 .req v18
        data11 .req v19
        data12 .req v20
        data13 .req v21
        data14 .req v22
        data15 .req v23

        qform_data0  .req q8
        qform_data1  .req q9
        qform_data2  .req q10
        qform_data3  .req q11
        qform_data4  .req q12
        qform_data5  .req q13
        qform_data6  .req q14
        qform_data7  .req q15
        qform_data8  .req q16
        qform_data9  .req q17
        qform_data10 .req q18
        qform_data11 .req q19
        qform_data12 .req q20
        qform_data13 .req q21
        qform_data14 .req q22
        qform_data15 .req q23

        root0    .req v0
        root1    .req v1
        root2    .req v2
        root3    .req v3
        root0_tw .req v4
        root1_tw .req v5
        root2_tw .req v6
        root3_tw .req v7

        qform_root0    .req q0
        qform_root1    .req q1
        qform_root2    .req q2
        qform_root3    .req q3
        qform_root0_tw .req q4
        qform_root1_tw .req q5
        qform_root2_tw .req q6
        qform_root3_tw .req q7

        tmp .req v24
        t0  .req v25
        t1  .req v26
        t2  .req v27
        t3  .req v28

        modulus .req v29

        ASM_LOAD(r_ptr0, roots)
        ASM_LOAD(r_ptr1, roots_l56)

        ASM_LOAD(xtmp, modulus_addr)
        ld1r {modulus.8h}, [xtmp]

        save STACK0, in
        mov count, #4

        load_roots_123

        .p2align 2
        ldr_vo v17, x0, 320
        ldr_vo v23, x0, 256
        ldr_vo v4, x0, 384
        ldr_vo v28, x0, 0
        ldr_vo v6, x0, 128
        ldr_vo v14, x0, 64
        vqrdmulhq v2, v23, v0, 1
        vmulq v9, v17, v0, 0
        ldr_vo v16, x0, 448
        vmulq v11, v23, v0, 0
        vmulq v12, v4, v0, 0
        vqrdmulhq v24, v17, v0, 1
        vqrdmulhq v21, v4, v0, 1
        vmulq v30, v16, v0, 0
        vqrdmulhq v31, v16, v0, 1
        vmla v12, v21, v29
        vmla v11, v2, v29
        ldr_vo v10, x0, 192
        vmla v30, v31, v29
        vadd v5, v28, v11
        vmla v9, v24, v29
        vadd v31, v6, v12
        vqrdmulhq v13, v31, v0, 3
        vmulq v17, v31, v0, 2
        vadd v31, v10, v30
        vqrdmulhq v16, v31, v0, 3
        vsub v7, v10, v30
        vmulq v10, v31, v0, 2
        vmla v17, v13, v29
        vmulq v15, v7, v0, 4
        vsub v18, v6, v12
        vmla v10, v16, v29
        vqrdmulhq v7, v7, v0, 5
        vadd v16, v14, v9
        vsub v31, v28, v11
        vqrdmulhq v23, v18, v0, 5
        vmla v15, v7, v29
        vadd v7, v16, v10
        sub count, count, #1
.p2align 2
layer123_start:
        vmulq v3, v7, v0, 6               // ..*.........................................................................
        vsub v4, v16, v10                 // .*..........................................................................
        vmulq v10, v18, v0, 4             // *...........................................................................
        vsub v9, v14, v9                  // ...*........................................................................
        // gap                            // ............................................................................
        ldr_vo v26, x0, 464               // ..............................................*.............................
        ldr_vo v25, x0, 400               // ........................................*...................................
        ldr_vo v2, x0, 336                // ......................................*.....................................
        vmulq v24, v4, v1, 0              // ............*...............................................................
        vadd v28, v9, v15                 // .....*......................................................................
        vqrdmulhq v16, v7, v0, 7          // ....*.......................................................................
        vsub v8, v9, v15                  // ..............*.............................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        ldr_vo v6, x0, 272                // .......................................*....................................
        vqrdmulhq v27, v28, v1, 3         // .........*..................................................................
        // gap                            // ............................................................................
        vmla v10, v23, v29                // ..........*.................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        vmulq v14, v28, v1, 2             // .......*....................................................................
        // gap                            // ............................................................................
        vqrdmulhq v18, v25, v0, 1         // ..................................................*.........................
        vsub v7, v5, v17                  // ........*...................................................................
        // gap                            // ............................................................................
        ldr_vo v12, x0, 16                // .........................................*..................................
        // gap                            // ............................................................................
        ldr_vo v11, x0, 144               // ..........................................*.................................
        vmulq v30, v25, v0, 0             // ................................................*...........................
        // gap                            // ............................................................................
        vmulq v23, v26, v0, 0             // ...................................................*........................
        vadd v15, v5, v17                 // ...........*................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        ldr_vo v21, x0, 208               // .......................................................*....................
        vqrdmulhq v22, v26, v0, 1         // ....................................................*.......................
        vsub v26, v31, v10                // ..................*.........................................................
        vqrdmulhq v25, v8, v1, 5          // ...................*........................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        vmla v30, v18, v29                // .....................................................*......................
        vadd v28, v31, v10                // ................*...........................................................
        vmla v14, v27, v29                // ...............*............................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        vmulq v9, v2, v0, 0               // .............................................*..............................
        // gap                            // ............................................................................
        vmla v23, v22, v29                // ........................................................*...................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        vmulq v20, v6, v0, 0              // ...............................................*............................
        vsub v31, v28, v14                // ...........................*................................................
        vmulq v13, v8, v1, 4              // .................*..........................................................
        vsub v18, v11, v30                // ....................................................................*.......
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        vqrdmulhq v8, v2, v0, 1           // .................................................*..........................
        str_vo v31, x0, 320               // .............................*..............................................
        vqrdmulhq v31, v4, v1, 1          // ......*.....................................................................
        vadd v27, v21, v23                // ..............................................................*.............
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        vmulq v10, v27, v0, 2             // .................................................................*..........
        vsub v5, v21, v23                 // ................................................................*...........
        vmla v3, v16, v29                 // .............*..............................................................
        vadd v19, v28, v14                // .......................*....................................................
        // gap                            // ............................................................................
        ldr_vo v14, x0, 80                // ...........................................*................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        vmla v13, v25, v29                // ..........................*.................................................
        str_vo v19, x0, 256               // ............................*...............................................
        vmla v24, v31, v29                // ....................*.......................................................
        vadd v25, v11, v30                // ...........................................................*................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        vmla v9, v8, v29                  // ..........................................................*.................
        vadd v22, v15, v3                 // ......................*.....................................................
        vqrdmulhq v31, v27, v0, 3         // ...............................................................*............
        vsub v3, v15, v3                  // .....................*......................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        vmulq v15, v5, v0, 4              // ...................................................................*........
        vsub v21, v7, v24                 // ...............................*............................................
        vmulq v17, v25, v0, 2             // .............................................................*..............
        vsub v30, v26, v13                // ..................................*.........................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        vqrdmulhq v23, v6, v0, 1          // ............................................*...............................
        str_vo v30, x0, 448               // ....................................*.......................................
        vqrdmulhq v30, v5, v0, 5          // ......................................................................*.....
        vadd v27, v7, v24                 // ..............................*.............................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        vmla v10, v31, v29                // .....................................................................*......
        str_vo v27, x0, 128               // ................................*...........................................
        vqrdmulhq v5, v25, v0, 3          // ............................................................*...............
        vadd v27, v26, v13                // ...................................*........................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        vmla v20, v23, v29                // ......................................................*.....................
        str_vi v22, x0, 16                // .........................*..................................................
        vqrdmulhq v23, v18, v0, 5         // .........................................................................*..
        vadd v16, v14, v9                 // .......................................................................*....
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        str_vo v3, x0, 48                 // ........................*...................................................
        str_vo v21, x0, 176               // .................................*..........................................
        vmla v17, v5, v29                 // ..................................................................*.........
        vadd v7, v16, v10                 // ...........................................................................*
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        str_vo v27, x0, 368               // .....................................*......................................
        vadd v5, v12, v20                 // .........................................................*..................
        vmla v15, v30, v29                // ..........................................................................*.
        vsub v31, v12, v20                // ........................................................................*...
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        // gap                            // ............................................................................
        
        // original source code
        // vmulq v27, v18, v0, 4          // ..*......................................................................... || *..................
        // vsub v24, v16, v10             // .*.......................................................................... || *..................
        // vmulq v28, v7, v0, 6           // *........................................................................... || *..................
        // vsub v30, v14, v9              // ...*........................................................................ || *..................
        // vqrdmulhq v3, v7, v0, 7        // .........*.................................................................. || .*.................
        // vadd v14, v30, v15             // ........*................................................................... || .*.................
        // vqrdmulhq v13, v24, v1, 1      // .....................................*...................................... || .........*.........
        // vmulq v8, v14, v1, 2           // ..............*............................................................. || ...*...............
        // vsub v25, v5, v17              // ................*........................................................... || ...*...............
        // vqrdmulhq v14, v14, v1, 3      // ............*............................................................... || ..*................
        // vmla v27, v23, v29             // .............*.............................................................. || ..*................
        // vadd v19, v5, v17              // .....................*...................................................... || ....*..............
        // vmulq v10, v24, v1, 0          // .......*.................................................................... || .*.................
        // vmla v28, v3, v29              // .........................................*.................................. || ..........*........
        // vsub v3, v30, v15              // ..........*................................................................. || .*.................
        // vmla v8, v14, v29              // ............................*............................................... || ......*............
        // vadd v14, v31, v27             // ...........................*................................................ || ......*............
        // vmulq v17, v3, v1, 4           // .................................*.......................................... || ........*..........
        // vsub v31, v31, v27             // ........................*................................................... || .....*.............
        // vqrdmulhq v3, v3, v1, 5        // .........................*.................................................. || .....*.............
        // vmla v10, v13, v29             // ..............................................*............................. || ...........*.......
        // vsub v13, v19, v28             // ...................................................*........................ || ............*......
        // vadd v24, v19, v28             // .................................................*.......................... || ............*......
        // vadd v19, v14, v8              // ..........................................*................................. || ..........*........
        // str_vo v13, x0, 64             // ....................................................................*....... || .................*.
        // str_vi v24, x0, 16             // .................................................................*.......... || ................*..
        // vmla v17, v3, v29              // ............................................*............................... || ...........*.......
        // vsub v14, v14, v8              // ................................*........................................... || ........*..........
        // str_vo v19, x0, 240            // .............................................*.............................. || ...........*.......
        // str_vo v14, x0, 304            // ....................................*....................................... || .........*.........
        // vadd v14, v25, v10             // ...........................................................*................ || ..............*....
        // vsub v3, v25, v10              // .....................................................*...................... || .............*.....
        // str_vo v14, x0, 112            // .............................................................*.............. || ...............*...
        // str_vo v3, x0, 176             // .....................................................................*...... || .................*.
        // vsub v14, v31, v17             // .......................................................*.................... || .............*.....
        // vadd v31, v31, v17             // ...............................................................*............ || ...............*...
        // str_vo v14, x0, 432            // .........................................................*.................. || ..............*....
        // str_vo v31, x0, 368            // ........................................................................*... || ..................*
        // ldr_vo v17, x0, 320            // ......*..................................................................... || *..................
        // ldr_vo v23, x0, 256            // ...........*................................................................ || .*.................
        // ldr_vo v4, x0, 384             // .....*...................................................................... || *..................
        // ldr_vo v28, x0, 0              // .................*.......................................................... || ...*...............
        // ldr_vo v6, x0, 128             // ..................*......................................................... || ...*...............
        // ldr_vo v14, x0, 64             // ...........................................*................................ || ..........*........
        // vqrdmulhq v2, v23, v0, 1       // ........................................................*................... || ..............*....
        // vmulq v9, v17, v0, 0           // .............................*.............................................. || .......*...........
        // ldr_vo v16, x0, 448            // ....*....................................................................... || *..................
        // vmulq v11, v23, v0, 0          // ...............................*............................................ || ........*..........
        // vmulq v12, v4, v0, 0           // ...................*........................................................ || ....*..............
        // vqrdmulhq v24, v17, v0, 1      // ...................................*........................................ || .........*.........
        // vqrdmulhq v21, v4, v0, 1       // ...............*............................................................ || ...*...............
        // vmulq v30, v16, v0, 0          // ....................*....................................................... || ....*..............
        // vqrdmulhq v31, v16, v0, 1      // .......................*.................................................... || .....*.............
        // vmla v12, v21, v29             // ..........................*................................................. || ......*............
        // vmla v11, v2, v29              // ................................................................*........... || ................*..
        // ldr_vo v10, x0, 192            // ......................*..................................................... || ....*..............
        // vmla v30, v31, v29             // ..............................*............................................. || .......*...........
        // vadd v5, v28, v11              // .........................................................................*.. || ..................*
        // vmla v9, v24, v29              // ................................................*........................... || ............*......
        // vadd v31, v6, v12              // ...............................................*............................ || ...........*.......
        // vqrdmulhq v13, v31, v0, 3      // ..............................................................*............. || ...............*...
        // vmulq v17, v31, v0, 2          // ......................................................*..................... || .............*.....
        // vadd v31, v10, v30             // ......................................*..................................... || .........*.........
        // vqrdmulhq v16, v31, v0, 3      // ..................................................*......................... || ............*......
        // vsub v7, v10, v30              // ........................................*................................... || ..........*........
        // vmulq v10, v31, v0, 2          // .......................................*.................................... || ..........*........
        // vmla v17, v13, v29             // ......................................................................*..... || .................*.
        // vmulq v15, v7, v0, 4           // ....................................................*....................... || .............*.....
        // vsub v18, v6, v12              // ..................................*......................................... || ........*..........
        // vmla v10, v16, v29             // ............................................................*............... || ...............*...
        // vqrdmulhq v7, v7, v0, 5        // ..........................................................*................. || ..............*....
        // vadd v16, v14, v9              // ...................................................................*........ || ................*..
        // vsub v31, v28, v11             // ...........................................................................* || ..................*
        // vqrdmulhq v23, v18, v0, 5      // ..................................................................*......... || ................*..
        // vmla v15, v7, v29              // ..........................................................................*. || ..................*
        // vadd v7, v16, v10              // .......................................................................*.... || .................*.
        
        sub count, count, #1
        cbnz count, layer123_start
layer123_end: // end of loop kernel
        vmulq v27, v18, v0, 4
        vsub v24, v16, v10
        vmulq v28, v7, v0, 6
        vsub v30, v14, v9
        vqrdmulhq v3, v7, v0, 7
        vadd v14, v30, v15
        vqrdmulhq v13, v24, v1, 1
        vmulq v8, v14, v1, 2
        vsub v25, v5, v17
        vqrdmulhq v14, v14, v1, 3
        vmla v27, v23, v29
        vadd v19, v5, v17
        vmulq v10, v24, v1, 0
        vmla v28, v3, v29
        vsub v3, v30, v15
        vmla v8, v14, v29
        vadd v14, v31, v27
        vmulq v17, v3, v1, 4
        vsub v31, v31, v27
        vqrdmulhq v3, v3, v1, 5
        vmla v10, v13, v29
        vsub v13, v19, v28
        vadd v24, v19, v28
        vadd v19, v14, v8
        str_vo v13, x0, 64
        str_vi v24, x0, 16
        vmla v17, v3, v29
        vsub v14, v14, v8
        str_vo v19, x0, 240
        str_vo v14, x0, 304
        vadd v14, v25, v10
        vsub v3, v25, v10
        str_vo v14, x0, 112
        str_vo v3, x0, 176
        vsub v14, v31, v17
        vadd v31, v31, v17
        str_vo v14, x0, 432
        str_vo v31, x0, 368
        
        restore inp, STACK0
        mov count, #8
        .unreq data4
        barrett_const .req v12
        ASM_LOAD(xtmp, barrett_const_addr)
        ld1r {barrett_const.8h}, [xtmp]

        .p2align 2
        ldr_vo v19, x1, 0
        ldr_vo v10, x1, 48
        ldr_vi v5, x3, 16
        ldr_vo v1, x1, 32
        ldr_vo v14, x1, 16
        vmulq v21, v10, v5, 0
        vqrdmulhq v7, v10, v5, 1
        vmulq v24, v1, v5, 0
        vmla v21, v7, v29
        vqrdmulhq v13, v1, v5, 1
        vadd v31, v14, v21
        vsub v26, v14, v21
        vmulq v25, v31, v5, 2
        vmulq v30, v26, v5, 4
        vqrdmulhq v31, v31, v5, 3
        vqrdmulhq v0, v26, v5, 5
        vmla v24, v13, v29
        vmla v25, v31, v29
        vmla v30, v0, v29
        vadd v13, v19, v24
        vsub v3, v19, v24
        vsub v17, v13, v25
        vadd v31, v3, v30
        vsub v14, v3, v30
        vadd v5, v13, v25
        trn1_s v7, v31, v14
        trn2_s v1, v31, v14
        ldr_vi v23, x4, 96
        ldr_vo v16, x4, -80
        trn2_s v9, v5, v17
        trn1_s v5, v5, v17
        ldr_vo v30, x4, -64
        trn2_d v10, v9, v1
        trn1_d v28, v9, v1
        trn2_d v8, v5, v7
        ldr_vo v19, x4, -32
        sub count, count, #1
.p2align 2
layer4567_start:
        vqrdmulh v24, v10, v16                           // .*......................................................................
        trn1_d v6, v5, v7                                // ..............*.........................................................
        vmul v1, v10, v23                                // *.......................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        ldr_vi v4, x3, 16                                // ......................................*.................................
        ldr_vo v27, x1, 32                               // .......................................*................................
        ldr_vo v26, x1, 48                               // .....................................*..................................
        vmul v18, v8, v23                                // ...*....................................................................
        // gap                                           // ........................................................................
        vqrdmulh v7, v8, v16                             // ......*.................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        ldr_vo v22, x4, -48                              // ..*.....................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        vmla v1, v24, v29                                // .....*..................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        ldr_vo v0, x4, -16                               // ....*...................................................................
        vmulq v3, v26, v4, 0                             // .........................................*..............................
        // gap                                           // ........................................................................
        vmulq v17, v27, v4, 0                            // ...........................................*............................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        ldr_vo v31, x1, 16                               // ........................................*...............................
        vqrdmulhq v9, v26, v4, 1                         // ..........................................*.............................
        vsub v14, v28, v1                                // ...........*............................................................
        vmla v18, v7, v29                                // .......*................................................................
        vadd v25, v28, v1                                // ........*...............................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        vqrdmulhq v23, v27, v4, 1                        // .............................................*..........................
        // gap                                           // ........................................................................
        vmul v5, v25, v30                                // .........*..............................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        vqrdmulh v1, v25, v22                            // ..........*.............................................................
        // gap                                           // ........................................................................
        vmla v3, v9, v29                                 // ............................................*...........................
        vadd v10, v6, v18                                // ................*.......................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        vqrdmulh v22, v14, v0                            // .............*..........................................................
        // gap                                           // ........................................................................
        vmla v17, v23, v29                               // ....................................................*...................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        vmul v20, v14, v19                               // ............*...........................................................
        vadd v28, v31, v3                                // ..............................................*.........................
        vmla v5, v1, v29                                 // ...............*........................................................
        vsub v25, v31, v3                                // ...............................................*........................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        ldr_vo v31, x1, 0                                // ....................................*...................................
        vmulq v9, v28, v4, 2                             // ................................................*.......................
        // gap                                           // ........................................................................
        vmulq v7, v25, v4, 4                             // .................................................*......................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        vmla v20, v22, v29                               // .................*......................................................
        vadd v0, v10, v5                                 // ...................*....................................................
        vqrdmulhq v15, v28, v4, 3                        // ..................................................*.....................
        vsub v1, v10, v5                                 // ....................*...................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        vqdmulhq v16, v1, v12, 0                         // .......................*................................................
        vsub v10, v6, v18                                // ..................*.....................................................
        vqdmulhq v23, v0, v12, 0                         // .....................*..................................................
        vsub v30, v31, v17                               // ........................................................*...............
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        vqrdmulhq v6, v25, v4, 5                         // ...................................................*....................
        vsub v3, v10, v20                                // ......................*.................................................
        vmla v9, v15, v29                                // .....................................................*..................
        vadd v2, v10, v20                                // ........................*...............................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        vqdmulhq v14, v2, v12, 0                         // .........................*..............................................
        srshr v18.8H, v16.8H, #11                        // ............................*...........................................
        vqdmulhq v10, v3, v12, 0                         // ..........................*.............................................
        vadd v16, v31, v17                               // .......................................................*................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        vsub v21, v16, v9                                // .........................................................*..............
        srshr v23.8H, v23.8H, #11                        // ...........................*............................................
        vmla v7, v6, v29                                 // ......................................................*.................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        vmla v1, v18, v29                                // ...............................*........................................
        srshr v13.8H, v14.8H, #11                        // .............................*..........................................
        srshr v10.8H, v10.8H, #11                        // ..............................*.........................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        vmla v0, v23, v29                                // ................................*.......................................
        vsub v19, v30, v7                                // ...........................................................*............
        // gap                                           // ........................................................................
        vadd v15, v30, v7                                // ..........................................................*.............
        // gap                                           // ........................................................................
        ldr_vi v23, x4, 96                               // ...............................................................*........
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        vmla v3, v10, v29                                // .................................*......................................
        // gap                                           // ........................................................................
        vmla v2, v13, v29                                // ..................................*.....................................
        vadd v7, v16, v9                                 // ............................................................*...........
        // gap                                           // ........................................................................
        ldr_vo v30, x4, -64                              // ...................................................................*....
        ldr_vo v16, x4, -80                              // ................................................................*.......
        // gap                                           // ........................................................................
        trn2_s v31, v7, v21                              // .................................................................*......
        trn1_s v5, v7, v21                               // ..................................................................*.....
        trn2_s v18, v15, v19                             // ..............................................................*.........
        trn1_s v7, v15, v19                              // .............................................................*..........
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        ldr_vo v19, x4, -32                              // .......................................................................*
        st4 {v0.4S,v1.4S,v2.4S,v3.4S}, [x1], #64         // ...................................*....................................
        trn2_d v10, v31, v18                             // ....................................................................*...
        trn1_d v28, v31, v18                             // .....................................................................*..
        trn2_d v8, v5, v7                                // ......................................................................*.
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        // gap                                           // ........................................................................
        
        // original source code
        // vmul v14, v10, v23                            // ..*..................................................................... || *...................
        // vqrdmulh v31, v10, v16                        // *....................................................................... || *...................
        // ldr_vo v0, x4, -48                            // ........*............................................................... || .*..................
        // vmul v17, v8, v23                             // ......*................................................................. || .*..................
        // ldr_vo v13, x4, -16                           // ..........*............................................................. || ..*.................
        // vmla v14, v31, v29                            // .........*.............................................................. || ..*.................
        // vqrdmulh v31, v8, v16                         // .......*................................................................ || .*..................
        // vmla v17, v31, v29                            // ................*....................................................... || ....*...............
        // vadd v31, v28, v14                            // .................*...................................................... || ....*...............
        // vmul v3, v31, v30                             // ...................*.................................................... || .....*..............
        // vqrdmulh v0, v31, v0                          // ....................*................................................... || ......*.............
        // vsub v31, v28, v14                            // ...............*........................................................ || ....*...............
        // vmul v24, v31, v19                            // .........................*.............................................. || ........*...........
        // vqrdmulh v14, v31, v13                        // .......................*................................................ || .......*............
        // trn1_d v31, v5, v7                            // .*...................................................................... || *...................
        // vmla v3, v0, v29                              // ...........................*............................................ || ........*...........
        // vadd v23, v31, v17                            // ......................*................................................. || ......*.............
        // vmla v24, v14, v29                            // ................................*....................................... || ..........*.........
        // vsub v31, v31, v17                            // .....................................*.................................. || ...........*........
        // vadd v4, v23, v3                              // .................................*...................................... || ..........*.........
        // vsub v5, v23, v3                              // ...................................*.................................... || ..........*.........
        // vqdmulhq v0, v4, v12, 0                       // ......................................*................................. || ...........*........
        // vsub v7, v31, v24                             // .........................................*.............................. || ............*.......
        // vqdmulhq v14, v5, v12, 0                      // ....................................*................................... || ...........*........
        // vadd v6, v31, v24                             // ...........................................*............................ || ............*.......
        // vqdmulhq v21, v6, v12, 0                      // ............................................*........................... || .............*......
        // vqdmulhq v31, v7, v12, 0                      // ..............................................*......................... || .............*......
        // srshr v3.8H, v0.8H, #11                       // .................................................*...................... || ..............*.....
        // srshr v0.8H, v14.8H, #11                      // .............................................*.......................... || .............*......
        // srshr v14.8H, v21.8H, #11                     // ....................................................*................... || ...............*....
        // srshr v31.8H, v31.8H, #11                     // .....................................................*.................. || ...............*....
        // vmla v5, v0, v29                              // ...................................................*.................... || ...............*....
        // vmla v4, v3, v29                              // ......................................................*................. || ................*...
        // vmla v7, v31, v29                             // ..........................................................*............. || .................*..
        // vmla v6, v14, v29                             // ...........................................................*............ || .................*..
        // st4 {v4.4S,v5.4S,v6.4S,v7.4S}, [x1], #64      // ....................................................................*... || ...................*
        // ldr_vo v19, x1, 0                             // .............................*.......................................... || ........*...........
        // ldr_vo v10, x1, 48                            // .....*.................................................................. || *...................
        // ldr_vi v5, x3, 16                             // ...*.................................................................... || *...................
        // ldr_vo v1, x1, 32                             // ....*................................................................... || *...................
        // ldr_vo v14, x1, 16                            // .............*.......................................................... || ...*................
        // vmulq v21, v10, v5, 0                         // ...........*............................................................ || ...*................
        // vqrdmulhq v7, v10, v5, 1                      // ..............*......................................................... || ....*...............
        // vmulq v24, v1, v5, 0                          // ............*........................................................... || ...*................
        // vmla v21, v7, v29                             // .....................*.................................................. || ......*.............
        // vqrdmulhq v13, v1, v5, 1                      // ..................*..................................................... || .....*..............
        // vadd v31, v14, v21                            // ..........................*............................................. || ........*...........
        // vsub v26, v14, v21                            // ............................*........................................... || ........*...........
        // vmulq v25, v31, v5, 2                         // ..............................*......................................... || .........*..........
        // vmulq v30, v26, v5, 4                         // ...............................*........................................ || .........*..........
        // vqrdmulhq v31, v31, v5, 3                     // ..................................*..................................... || ..........*.........
        // vqrdmulhq v0, v26, v5, 5                      // ........................................*............................... || ............*.......
        // vmla v24, v13, v29                            // ........................*............................................... || .......*............
        // vmla v25, v31, v29                            // ..........................................*............................. || ............*.......
        // vmla v30, v0, v29                             // ..................................................*..................... || ..............*.....
        // vadd v13, v19, v24                            // ...............................................*........................ || .............*......
        // vsub v3, v19, v24                             // .......................................*................................ || ...........*........
        // vsub v17, v13, v25                            // ................................................*....................... || ..............*.....
        // vadd v31, v3, v30                             // ........................................................*............... || ................*...
        // vsub v14, v3, v30                             // .......................................................*................ || ................*...
        // vadd v5, v13, v25                             // ............................................................*........... || .................*..
        // trn1_s v7, v31, v14                           // ..................................................................*..... || ..................*.
        // trn2_s v1, v31, v14                           // .................................................................*...... || ..................*.
        // ldr_vi v23, x4, 96                            // .........................................................*.............. || ................*...
        // ldr_vo v16, x4, -80                           // ..............................................................*......... || .................*..
        // trn2_s v9, v5, v17                            // ...............................................................*........ || ..................*.
        // trn1_s v5, v5, v17                            // ................................................................*....... || ..................*.
        // ldr_vo v30, x4, -64                           // .............................................................*.......... || .................*..
        // trn2_d v10, v9, v1                            // .....................................................................*.. || ...................*
        // trn1_d v28, v9, v1                            // ......................................................................*. || ...................*
        // trn2_d v8, v5, v7                             // .......................................................................* || ...................*
        // ldr_vo v19, x4, -32                           // ...................................................................*.... || ..................*.
        
        sub count, count, #1
        cbnz count, layer4567_start
layer4567_end: // end of loop kernel
        vmul v14, v10, v23
        vqrdmulh v31, v10, v16
        ldr_vo v0, x4, -48
        vmul v17, v8, v23
        ldr_vo v13, x4, -16
        vmla v14, v31, v29
        vqrdmulh v31, v8, v16
        vmla v17, v31, v29
        vadd v31, v28, v14
        vmul v3, v31, v30
        vqrdmulh v0, v31, v0
        vsub v31, v28, v14
        vmul v24, v31, v19
        vqrdmulh v14, v31, v13
        trn1_d v31, v5, v7
        vmla v3, v0, v29
        vadd v23, v31, v17
        vmla v24, v14, v29
        vsub v31, v31, v17
        vadd v4, v23, v3
        vsub v5, v23, v3
        vqdmulhq v0, v4, v12, 0
        vsub v7, v31, v24
        vqdmulhq v14, v5, v12, 0
        vadd v6, v31, v24
        vqdmulhq v21, v6, v12, 0
        vqdmulhq v31, v7, v12, 0
        srshr v3.8H, v0.8H, #11
        srshr v0.8H, v14.8H, #11
        srshr v14.8H, v21.8H, #11
        srshr v31.8H, v31.8H, #11
        vmla v5, v0, v29
        vmla v4, v3, v29
        vmla v7, v31, v29
        vmla v6, v14, v29
        st4 {v4.4S,v5.4S,v6.4S,v7.4S}, [x1], #64

       pop_stack
       ret