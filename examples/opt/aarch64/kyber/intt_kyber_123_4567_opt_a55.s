///
/// Copyright (c) 2022 Arm Limited
/// Copyright (c) 2022 Hanno Becker
/// Copyright (c) 2023 Amin Abdulrahman, Matthias Kannwischer
/// SPDX-License-Identifier: MIT
///
/// Permission is hereby granted, free of charge, to any person obtaining a copy
/// of this software and associated documentation files (the "Software"), to deal
/// in the Software without restriction, including without limitation the rights
/// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
/// copies of the Software, and to permit persons to whom the Software is
/// furnished to do so, subject to the following conditions:
///
/// The above copyright notice and this permission notice shall be included in all
/// copies or substantial portions of the Software.
///
/// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
/// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
/// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
/// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
/// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
/// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
/// SOFTWARE.
///

// Needed to provide ASM_LOAD directive
#include <hal_env.h>

.macro mulmodq dst, src, const, idx0, idx1
        sqrdmulh t2.8h,      \src\().8h, \const\().h[\idx1\()]
        mul      \dst\().8h, \src\().8h, \const\().h[\idx0\()]
        mls      \dst\().8h, t2.8h,      consts.h[0]
.endm

.macro mulmod dst, src, const, const_twisted
        sqrdmulh t2.8h,      \src\().8h, \const_twisted\().8h
        mul      \dst\().8h, \src\().8h, \const\().8h
        mls      \dst\().8h, t2.8h,      consts.h[0]
.endm

.macro gs_butterfly a, b, root, idx0, idx1
        sub tmp.8h,   \a\().8h, \b\().8h
        add \a\().8h, \a\().8h, \b\().8h
        mulmodq  \b, tmp, \root, \idx0, \idx1
.endm

.macro gs_butterfly_v a, b, root, root_twisted
        sub tmp.8h,   \a\().8h, \b\().8h
        add \a\().8h, \a\().8h, \b\().8h
        mulmod  \b, tmp, \root, \root_twisted
.endm

.macro mul_ninv dst0, dst1, dst2, dst3, src0, src1, src2, src3
        mulmod \dst0, \src0, ninv, ninv_tw
        mulmod \dst1, \src1, ninv, ninv_tw
        mulmod \dst2, \src2, ninv, ninv_tw
        mulmod \dst3, \src3, ninv, ninv_tw
.endm

.macro barrett_reduce a
        sqdmulh t0.8h,    \a\().8h, consts.h[1]
        srshr   t0.8h,    t0.8h,    #11
        mls     \a\().8h, t0.8h,    consts.h[0]
.endm

.macro load_roots_123
        ldr q_root0, [r_ptr0], #32
        ldr q_root1, [r_ptr0, #-16]
.endm

.macro load_next_roots_45
        ldr q_root0, [r_ptr0], #16
.endm

.macro load_next_roots_67
        ldr q_root0,    [r_ptr1], #(6*16)
        ldr q_root0_tw, [r_ptr1, #(-6*16 + 1*16)]
        ldr q_root1,    [r_ptr1, #(-6*16 + 2*16)]
        ldr q_root1_tw, [r_ptr1, #(-6*16 + 3*16)]
        ldr q_root2,    [r_ptr1, #(-6*16 + 4*16)]
        ldr q_root2_tw, [r_ptr1, #(-6*16 + 5*16)]
.endm

.macro transpose4 data
        trn1 t0.4s, \data\()0.4s, \data\()1.4s
        trn2 t1.4s, \data\()0.4s, \data\()1.4s
        trn1 t2.4s, \data\()2.4s, \data\()3.4s
        trn2 t3.4s, \data\()2.4s, \data\()3.4s

        trn2 \data\()2.2d, t0.2d, t2.2d
        trn2 \data\()3.2d, t1.2d, t3.2d
        trn1 \data\()0.2d, t0.2d, t2.2d
        trn1 \data\()1.2d, t1.2d, t3.2d
.endm

.macro transpose_single data_out, data_in
        trn1 \data_out\()0.4s, \data_in\()0.4s, \data_in\()1.4s
        trn2 \data_out\()1.4s, \data_in\()0.4s, \data_in\()1.4s
        trn1 \data_out\()2.4s, \data_in\()2.4s, \data_in\()3.4s
        trn2 \data_out\()3.4s, \data_in\()2.4s, \data_in\()3.4s
.endm

.macro save_gprs
        sub sp, sp, #(16*6)
        stp x19, x20, [sp, #16*0]
        stp x19, x20, [sp, #16*0]
        stp x21, x22, [sp, #16*1]
        stp x23, x24, [sp, #16*2]
        stp x25, x26, [sp, #16*3]
        stp x27, x28, [sp, #16*4]
        str x29, [sp, #16*5]
.endm

.macro restore_gprs
        ldp x19, x20, [sp, #16*0]
        ldp x21, x22, [sp, #16*1]
        ldp x23, x24, [sp, #16*2]
        ldp x25, x26, [sp, #16*3]
        ldp x27, x28, [sp, #16*4]
        ldr x29, [sp, #16*5]
        add sp, sp, #(16*6)
.endm

.macro save_vregs
        sub sp, sp, #(16*4)
        stp  d8,  d9, [sp, #16*0]
        stp d10, d11, [sp, #16*1]
        stp d12, d13, [sp, #16*2]
        stp d14, d15, [sp, #16*3]
.endm

.macro restore_vregs
        ldp  d8,  d9, [sp, #16*0]
        ldp d10, d11, [sp, #16*1]
        ldp d12, d13, [sp, #16*2]
        ldp d14, d15, [sp, #16*3]
        add sp, sp, #(16*4)
.endm

.macro push_stack
        save_gprs
        save_vregs
.endm

.macro pop_stack
        restore_vregs
        restore_gprs
.endm

// For comparability reasons, the output range for the coefficients of this
// invNTT code is supposed to match the implementation from PQClean on commit
// ee71d2c823982bfcf54686f3cf1d666f396dc9aa. After the invNTT, the coefficients
// are NOT canonically reduced. The ordering of the coefficients is canonical,
// also matching PQClean.

.data
.p2align 4
roots:
#include "intt_kyber_123_45_67_twiddles.s"
.text

        .global intt_kyber_123_4567_opt_a55
        .global _intt_kyber_123_4567_opt_a55

.p2align 4
const_addr:       .short 3329
                  .short 20159
                  .short 0
                  .short 0
                  .short 0
                  .short 0
                  .short 0
                  .short 0
ninv_addr:        .short 512
                  .short 512
                  .short 512
                  .short 512
                  .short 512
                  .short 512
                  .short 512
                  .short 512
ninv_tw_addr:     .short 5040
                  .short 5040
                  .short 5040
                  .short 5040
                  .short 5040
                  .short 5040
                  .short 5040
                  .short 5040

intt_kyber_123_4567_opt_a55:
_intt_kyber_123_4567_opt_a55:
        push_stack

        in      .req x0
        inp     .req x1
        count   .req x2
        r_ptr0  .req x3
        r_ptr1  .req x4
        xtmp    .req x5

        data0  .req v8
        data1  .req v9
        data2  .req v10
        data3  .req v11
        data4  .req v12
        data5  .req v13
        data6  .req v14
        data7  .req v15

        q_data0  .req q8
        q_data1  .req q9
        q_data2  .req q10
        q_data3  .req q11
        q_data4  .req q12
        q_data5  .req q13
        q_data6  .req q14
        q_data7  .req q15

        root0    .req v0
        root1    .req v1
        root2    .req v2
        root0_tw .req v4
        root1_tw .req v5
        root2_tw .req v6

        consts     .req v7
        q_consts   .req q7

        q_root0    .req q0
        q_root1    .req q1
        q_root2    .req q2
        q_root0_tw .req q4
        q_root1_tw .req q5
        q_root2_tw .req q6

        tmp .req v24
        t0  .req v25
        t1  .req v26
        t2  .req v27
        t3  .req v28

        ASM_LOAD(r_ptr0, roots_l34)
        ASM_LOAD(r_ptr1, roots_l56)

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]

        mov inp, in
        mov count, #8

        .p2align 2
                                          // Instructions:    11
                                          // Expected cycles: 20
                                          // Expected IPC:    0.55
                                          //
                                          // Cycle bound:     20.0
                                          // IPC bound:       0.55
                                          //
                                          // Wall time:     0.01s
                                          // User time:     0.01s
                                          //
                                          // ----- cycle (expected) ------>
                                          // 0                        25
                                          // |------------------------|----
        ldr q9, [x1, #0]                  // *.............................
        ldr q12, [x1, #16]                // ..*...........................
        ldr q16, [x1, #32]                // ....*.........................
        ldr q5, [x1, #48]                 // ......*.......................
        ldr q2, [x4], #(6*16)             // ........*.....................
        trn1 v22.4S, v16.4S, v5.4S        // ..........*...................
        ldr q20, [x4, #-80]               // ...........*..................
        ldr q30, [x4, #-64]               // .............*................
        ldr q8, [x4, #-48]                // ...............*..............
        ldr q11, [x4, #-32]               // .................*............
        ldr q14, [x4, #-16]               // ...................*..........

                                           // ------ cycle (expected) ------>
                                           // 0                        25
                                           // |------------------------|-----
        // ldr q9, [x1, #0]                // *..............................
        // ldr q12, [x1, #16]              // ..*............................
        // ldr q16, [x1, #32]              // ....*..........................
        // ldr q5, [x1, #48]               // ......*........................
        // trn1 v22.4S, v16.4S, v5.4S      // ..........*....................
        // ldr q2, [x4], #(6*16)           // ........*......................
        // ldr q20, [x4, #-80]             // ...........*...................
        // ldr q30, [x4, #-64]             // .............*.................
        // ldr q8, [x4, #-48]              // ...............*...............
        // ldr q11, [x4, #-32]             // .................*.............
        // ldr q14, [x4, #-16]             // ...................*...........

        sub count, count, #1
layer4567_start:
                                                // Instructions:    83
                                                // Expected cycles: 94
                                                // Expected IPC:    0.88
                                                //
                                                // Cycle bound:     94.0
                                                // IPC bound:       0.88
                                                //
                                                // Wall time:     3.34s
                                                // User time:     3.34s
                                                //
                                                // ------------------------------------- cycle (expected) -------------------------------------->
                                                // 0                        25                       50                       75
                                                // |------------------------|------------------------|------------------------|------------------
        trn1 v23.4S, v9.4S, v12.4S              // *.............................................................................................
        trn2 v9.4S, v9.4S, v12.4S               // .*............................................................................................
        trn2 v12.4S, v16.4S, v5.4S              // ..*...........................................................................................
        trn2 v21.2D, v23.2D, v22.2D             // ...*..........................................................................................
        trn1 v23.2D, v23.2D, v22.2D             // ....*.........................................................................................
        trn2 v5.2D, v9.2D, v12.2D               // .....*........................................................................................
        trn1 v9.2D, v9.2D, v12.2D               // ......*.......................................................................................
        sub v12.8H, v21.8H, v5.8H               // .......*......................................................................................
        add v21.8H, v21.8H, v5.8H               // ........*.....................................................................................
        sub v5.8H, v23.8H, v9.8H                // .........*....................................................................................
        add v23.8H, v23.8H, v9.8H               // ..........*...................................................................................
        sqrdmulh v9.8H, v12.8H, v14.8H          // ...........*..................................................................................
        sqrdmulh v8.8H, v5.8H, v8.8H            // ............*.................................................................................
        mul v5.8H, v5.8H, v30.8H                // .............*................................................................................
        mul v12.8H, v12.8H, v11.8H              // ..............*...............................................................................
        sub v22.8H, v23.8H, v21.8H              // ...............*..............................................................................
        add v23.8H, v23.8H, v21.8H              // ................*.............................................................................
        mls v5.8H, v8.8H, v7.H[0]               // .................*............................................................................
        mls v12.8H, v9.8H, v7.H[0]              // ..................*...........................................................................
        sqrdmulh v9.8H, v22.8H, v20.8H          // ...................*..........................................................................
        mul v21.8H, v22.8H, v2.8H               // ....................*.........................................................................
        ldr q8, [x3], #16                       // .....................*........................................................................
        sub v22.8H, v5.8H, v12.8H               // .......................*......................................................................
        mls v21.8H, v9.8H, v7.H[0]              // ........................*.....................................................................
        add v9.8H, v5.8H, v12.8H                // .........................*....................................................................
        sqrdmulh v12.8H, v22.8H, v20.8H         // ..........................*...................................................................
        mul v5.8H, v22.8H, v2.8H                // ...........................*..................................................................
        trn1 v22.4S, v23.4S, v9.4S              // ............................*.................................................................
        trn2 v23.4S, v23.4S, v9.4S              // .............................*................................................................
        ldr q9, [x1, #64]                       // ..............................e...............................................................
        mls v5.8H, v12.8H, v7.H[0]              // ................................*.............................................................
        ldr q12, [x1, #80]                      // .................................e............................................................
        ldr q16, [x1, #96]                      // ...................................e..........................................................
        trn1 v2.4S, v21.4S, v5.4S               // .....................................*........................................................
        trn2 v21.4S, v21.4S, v5.4S              // ......................................*.......................................................
        ldr q5, [x1, #112]                      // .......................................e......................................................
        trn2 v20.2D, v22.2D, v2.2D              // .........................................*....................................................
        trn2 v30.2D, v23.2D, v21.2D             // ..........................................*...................................................
        trn1 v22.2D, v22.2D, v2.2D              // ...........................................*..................................................
        trn1 v23.2D, v23.2D, v21.2D             // ............................................*.................................................
        sub v21.8H, v20.8H, v30.8H              // .............................................*................................................
        sub v2.8H, v22.8H, v23.8H               // ..............................................*...............................................
        add v23.8H, v22.8H, v23.8H              // ...............................................*..............................................
        sqrdmulh v22.8H, v21.8H, v8.H[5]        // ................................................*.............................................
        sqrdmulh v11.8H, v2.8H, v8.H[3]         // .................................................*............................................
        mul v2.8H, v2.8H, v8.H[2]               // ..................................................*...........................................
        mul v21.8H, v21.8H, v8.H[4]             // ...................................................*..........................................
        add v20.8H, v20.8H, v30.8H              // ....................................................*.........................................
        sqdmulh v30.8H, v23.8H, v7.H[1]         // .....................................................*........................................
        mls v2.8H, v11.8H, v7.H[0]              // ......................................................*.......................................
        mls v21.8H, v22.8H, v7.H[0]             // .......................................................*......................................
        sqdmulh v22.8H, v20.8H, v7.H[1]         // ........................................................*.....................................
        srshr v30.8H, v30.8H, #11               // .........................................................*....................................
        sqdmulh v11.8H, v2.8H, v7.H[1]          // ..........................................................*...................................
        sqdmulh v14.8H, v21.8H, v7.H[1]         // ...........................................................*..................................
        mls v23.8H, v30.8H, v7.H[0]             // ............................................................*.................................
        srshr v22.8H, v22.8H, #11               // .............................................................*................................
        srshr v30.8H, v11.8H, #11               // ..............................................................*...............................
        srshr v11.8H, v14.8H, #11               // ...............................................................*..............................
        mls v20.8H, v22.8H, v7.H[0]             // ................................................................*.............................
        mls v2.8H, v30.8H, v7.H[0]              // .................................................................*............................
        mls v21.8H, v11.8H, v7.H[0]             // ..................................................................*...........................
        trn1 v22.4S, v16.4S, v5.4S              // ...................................................................e..........................
        sub v30.8H, v23.8H, v20.8H              // ....................................................................*.........................
        add v23.8H, v23.8H, v20.8H              // .....................................................................*........................
        sub v20.8H, v2.8H, v21.8H               // ......................................................................*.......................
        sqrdmulh v11.8H, v30.8H, v8.H[1]        // .......................................................................*......................
        mul v30.8H, v30.8H, v8.H[0]             // ........................................................................*.....................
        sqrdmulh v14.8H, v20.8H, v8.H[1]        // .........................................................................*....................
        mul v8.8H, v20.8H, v8.H[0]              // ..........................................................................*...................
        add v21.8H, v2.8H, v21.8H               // ...........................................................................*..................
        mls v30.8H, v11.8H, v7.H[0]             // ............................................................................*.................
        str q23, [x1], #(64)                    // .............................................................................*................
        mls v8.8H, v14.8H, v7.H[0]              // ..............................................................................*...............
        str q21, [x1, #-48]                     // ...............................................................................*..............
        ldr q2, [x4], #(6*16)                   // ................................................................................e.............
        str q30, [x1, #-32]                     // ..................................................................................*...........
        ldr q20, [x4, #-80]                     // ...................................................................................e..........
        str q8, [x1, #-16]                      // .....................................................................................*........
        ldr q30, [x4, #-64]                     // ......................................................................................e.......
        ldr q8, [x4, #-48]                      // ........................................................................................e.....
        ldr q11, [x4, #-32]                     // ..........................................................................................e...
        ldr q14, [x4, #-16]                     // ............................................................................................e.

                                                      // ----------------------------------------------------------------- cycle (expected) ------------------------------------------------------------------>
                                                      // 0                        25                       50                       75                       100                      125
                                                      // |------------------------|------------------------|------------------------|------------------------|------------------------|------------------------
        // ldr q8, [x1, #(16*0)]                      // e...............................................................'.............................~.......................................................
        // ldr q9, [x1, #(16*1)]                      // ...e............................................................'................................~....................................................
        // ldr q10, [x1, #(16*2)]                     // .....e..........................................................'..................................~..................................................
        // ldr q11, [x1, #(16*3)]                     // .........e......................................................'......................................~..............................................
        // trn1 v25.4s, v8.4s, v9.4s                  // ................................................................*.....................................................................................
        // trn2 v26.4s, v8.4s, v9.4s                  // ................................................................'*....................................................................................
        // trn1 v27.4s, v10.4s, v11.4s                // .....................................e..........................'..................................................................~..................
        // trn2 v28.4s, v10.4s, v11.4s                // ................................................................'.*...................................................................................
        // trn2 v10.2d, v25.2d, v27.2d                // ................................................................'..*..................................................................................
        // trn2 v11.2d, v26.2d, v28.2d                // ................................................................'....*................................................................................
        // trn1 v8.2d, v25.2d, v27.2d                 // ................................................................'...*.................................................................................
        // trn1 v9.2d, v26.2d, v28.2d                 // ................................................................'.....*...............................................................................
        // ldr q0,    [x4], #(6*16)                   // ..................................................e.............'...............................................................................~.....
        // ldr q4, [x4, #(-6*16 + 1*16)]              // .....................................................e..........'..................................................................................~..
        // ldr q1,    [x4, #(-6*16 + 2*16)]           // ........................................................e.......'.....................................................................................
        // ldr q5, [x4, #(-6*16 + 3*16)]              // ..........................................................e.....'.....................................................................................
        // ldr q2,    [x4, #(-6*16 + 4*16)]           // ............................................................e...'.....................................................................................
        // ldr q6, [x4, #(-6*16 + 5*16)]              // ..............................................................e.'.....................................................................................
        // sub v24.8h,   v8.8h, v9.8h                 // ................................................................'........*............................................................................
        // add v8.8h, v8.8h, v9.8h                    // ................................................................'.........*...........................................................................
        // sqrdmulh v27.8h,      v24.8h, v5.8h        // ................................................................'...........*.........................................................................
        // mul      v9.8h, v24.8h, v1.8h              // ................................................................'............*........................................................................
        // mls      v9.8h, v27.8h,      v7.h[0]       // ................................................................'................*....................................................................
        // sub v24.8h,   v10.8h, v11.8h               // ................................................................'......*..............................................................................
        // add v10.8h, v10.8h, v11.8h                 // ................................................................'.......*.............................................................................
        // sqrdmulh v27.8h,      v24.8h, v6.8h        // ................................................................'..........*..........................................................................
        // mul      v11.8h, v24.8h, v2.8h             // ................................................................'.............*.......................................................................
        // mls      v11.8h, v27.8h,      v7.h[0]      // ................................................................'.................*...................................................................
        // sub v24.8h,   v8.8h, v10.8h                // ................................................................'..............*......................................................................
        // add v8.8h, v8.8h, v10.8h                   // ................................................................'...............*.....................................................................
        // sqrdmulh v27.8h,      v24.8h, v4.8h        // ................................................................'..................*..................................................................
        // mul      v10.8h, v24.8h, v0.8h             // ................................................................'...................*.................................................................
        // mls      v10.8h, v27.8h,      v7.h[0]      // ................................................................'.......................*.............................................................
        // sub v24.8h,   v9.8h, v11.8h                // ................................................................'......................*..............................................................
        // add v9.8h, v9.8h, v11.8h                   // ................................................................'........................*............................................................
        // sqrdmulh v27.8h,      v24.8h, v4.8h        // ................................................................'.........................*...........................................................
        // mul      v11.8h, v24.8h, v0.8h             // ................................................................'..........................*..........................................................
        // mls      v11.8h, v27.8h,      v7.h[0]      // ..~.............................................................'...............................*.....................................................
        // trn1 v25.4s, v8.4s, v9.4s                  // ................................................................'...........................*.........................................................
        // trn2 v26.4s, v8.4s, v9.4s                  // ................................................................'............................*........................................................
        // trn1 v27.4s, v10.4s, v11.4s                // .......~........................................................'....................................*................................................
        // trn2 v28.4s, v10.4s, v11.4s                // ........~.......................................................'.....................................*...............................................
        // trn2 v10.2d, v25.2d, v27.2d                // ...........~....................................................'........................................*............................................
        // trn2 v11.2d, v26.2d, v28.2d                // ............~...................................................'.........................................*...........................................
        // trn1 v8.2d, v25.2d, v27.2d                 // .............~..................................................'..........................................*..........................................
        // trn1 v9.2d, v26.2d, v28.2d                 // ..............~.................................................'...........................................*.........................................
        // ldr q0, [x3], #16                          // ................................................................'....................*................................................................
        // sub v24.8h,   v8.8h, v9.8h                 // ................~...............................................'.............................................*.......................................
        // add v8.8h, v8.8h, v9.8h                    // .................~..............................................'..............................................*......................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[3]      // ...................~............................................'................................................*....................................
        // mul      v9.8h, v24.8h, v0.h[2]            // ....................~...........................................'.................................................*...................................
        // mls      v9.8h, v27.8h,      v7.h[0]       // ........................~.......................................'.....................................................*...............................
        // sub v24.8h,   v10.8h, v11.8h               // ...............~................................................'............................................*........................................
        // add v10.8h, v10.8h, v11.8h                 // ......................~.........................................'...................................................*.................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[5]      // ..................~.............................................'...............................................*.....................................
        // mul      v11.8h, v24.8h, v0.h[4]           // .....................~..........................................'..................................................*..................................
        // mls      v11.8h, v27.8h,      v7.h[0]      // .........................~......................................'......................................................*..............................
        // sqdmulh v25.8h,    v8.8h, v7.h[1]          // .......................~........................................'....................................................*................................
        // srshr   v25.8h,    v25.8h,    #11          // ...........................~....................................'........................................................*............................
        // mls     v8.8h, v25.8h,    v7.h[0]          // ..............................~.................................'...........................................................*.........................
        // sqdmulh v25.8h,    v10.8h, v7.h[1]         // ..........................~.....................................'.......................................................*.............................
        // srshr   v25.8h,    v25.8h,    #11          // ...............................~................................'............................................................*........................
        // mls     v10.8h, v25.8h,    v7.h[0]         // ..................................~.............................'...............................................................*.....................
        // sqdmulh v25.8h,    v9.8h, v7.h[1]          // ............................~...................................'.........................................................*...........................
        // srshr   v25.8h,    v25.8h,    #11          // ................................~...............................'.............................................................*.......................
        // mls     v9.8h, v25.8h,    v7.h[0]          // ...................................~............................'................................................................*....................
        // sqdmulh v25.8h,    v11.8h, v7.h[1]         // .............................~..................................'..........................................................*..........................
        // srshr   v25.8h,    v25.8h,    #11          // .................................~..............................'..............................................................*......................
        // mls     v11.8h, v25.8h,    v7.h[0]         // ....................................~...........................'.................................................................*...................
        // sub v24.8h,   v8.8h, v10.8h                // ......................................~.........................'...................................................................*.................
        // add v8.8h, v8.8h, v10.8h                   // .......................................~........................'....................................................................*................
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // .........................................~......................'......................................................................*..............
        // mul      v10.8h, v24.8h, v0.h[0]           // ..........................................~.....................'.......................................................................*.............
        // mls      v10.8h, v27.8h,      v7.h[0]      // ..............................................~.................'...........................................................................*.........
        // sub v24.8h,   v9.8h, v11.8h                // ........................................~.......................'.....................................................................*...............
        // add v9.8h, v9.8h, v11.8h                   // .............................................~..................'..........................................................................*..........
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ...........................................~....................'........................................................................*............
        // mul      v11.8h, v24.8h, v0.h[0]           // ............................................~...................'.........................................................................*...........
        // mls      v11.8h, v27.8h,      v7.h[0]      // ................................................~...............'.............................................................................*.......
        // str q8, [x1], #(64)                        // ...............................................~................'............................................................................*........
        // str q9, [x1, #(-64 + 16*1)]                // .................................................~..............'..............................................................................*......
        // str q10, [x1, #(-64 + 16*2)]               // ....................................................~...........'.................................................................................*...
        // str q11, [x1, #(-64 + 16*3)]               // .......................................................~........'....................................................................................*

        sub count, count, #1
        cbnz count, layer4567_start
                                                // Instructions:    72
                                                // Expected cycles: 79
                                                // Expected IPC:    0.91
                                                //
                                                // Cycle bound:     79.0
                                                // IPC bound:       0.91
                                                //
                                                // Wall time:     9.68s
                                                // User time:     9.68s
                                                //
                                                // ------------------------------ cycle (expected) ------------------------------>
                                                // 0                        25                       50                       75
                                                // |------------------------|------------------------|------------------------|---
        trn1 v3.4S, v9.4S, v12.4S               // *..............................................................................
        trn2 v23.4S, v16.4S, v5.4S              // .*.............................................................................
        trn2 v18.4S, v9.4S, v12.4S              // ..*............................................................................
        trn1 v5.2D, v3.2D, v22.2D               // ...*...........................................................................
        trn2 v22.2D, v3.2D, v22.2D              // ....*..........................................................................
        trn1 v12.2D, v18.2D, v23.2D             // .....*.........................................................................
        trn2 v29.2D, v18.2D, v23.2D             // ......*........................................................................
        sub v23.8H, v5.8H, v12.8H               // .......*.......................................................................
        add v13.8H, v22.8H, v29.8H              // ........*......................................................................
        sub v9.8H, v22.8H, v29.8H               // .........*.....................................................................
        mul v16.8H, v23.8H, v30.8H              // ..........*....................................................................
        sqrdmulh v23.8H, v23.8H, v8.8H          // ...........*...................................................................
        mul v21.8H, v9.8H, v11.8H               // ............*..................................................................
        sqrdmulh v9.8H, v9.8H, v14.8H           // .............*.................................................................
        add v6.8H, v5.8H, v12.8H                // ..............*................................................................
        mls v16.8H, v23.8H, v7.H[0]             // ...............*...............................................................
        mls v21.8H, v9.8H, v7.H[0]              // .................*.............................................................
        sub v23.8H, v6.8H, v13.8H               // ..................*............................................................
        ldr q3, [x3], #16                       // ...................*...........................................................
        sub v12.8H, v16.8H, v21.8H              // .....................*.........................................................
        sqrdmulh v5.8H, v23.8H, v20.8H          // ......................*........................................................
        mul v22.8H, v23.8H, v2.8H               // .......................*.......................................................
        mul v9.8H, v12.8H, v2.8H                // ........................*......................................................
        sqrdmulh v23.8H, v12.8H, v20.8H         // .........................*.....................................................
        add v12.8H, v16.8H, v21.8H              // ..........................*....................................................
        add v8.8H, v6.8H, v13.8H                // ...........................*...................................................
        mls v22.8H, v5.8H, v7.H[0]              // ............................*..................................................
        mls v9.8H, v23.8H, v7.H[0]              // .............................*.................................................
        trn2 v5.4S, v8.4S, v12.4S               // ..............................*................................................
        trn1 v8.4S, v8.4S, v12.4S               // ...............................*...............................................
        trn2 v18.4S, v22.4S, v9.4S              // .................................*.............................................
        trn1 v21.4S, v22.4S, v9.4S              // ..................................*............................................
        trn2 v19.2D, v5.2D, v18.2D              // ....................................*..........................................
        trn2 v23.2D, v8.2D, v21.2D              // .....................................*.........................................
        trn1 v21.2D, v8.2D, v21.2D              // ......................................*........................................
        sub v12.8H, v23.8H, v19.8H              // .......................................*.......................................
        trn1 v9.2D, v5.2D, v18.2D               // ........................................*......................................
        add v5.8H, v23.8H, v19.8H               // .........................................*.....................................
        sub v23.8H, v21.8H, v9.8H               // ..........................................*....................................
        sqrdmulh v30.8H, v12.8H, v3.H[5]        // ...........................................*...................................
        mul v22.8H, v12.8H, v3.H[4]             // ............................................*..................................
        mul v2.8H, v23.8H, v3.H[2]              // .............................................*.................................
        sqrdmulh v16.8H, v23.8H, v3.H[3]        // ..............................................*................................
        add v20.8H, v21.8H, v9.8H               // ...............................................*...............................
        sqdmulh v31.8H, v5.8H, v7.H[1]          // ................................................*..............................
        mls v22.8H, v30.8H, v7.H[0]             // .................................................*.............................
        mls v2.8H, v16.8H, v7.H[0]              // ..................................................*............................
        sqdmulh v23.8H, v20.8H, v7.H[1]         // ...................................................*...........................
        srshr v12.8H, v31.8H, #11               // ....................................................*..........................
        sqdmulh v21.8H, v22.8H, v7.H[1]         // .....................................................*.........................
        sqdmulh v1.8H, v2.8H, v7.H[1]           // ......................................................*........................
        mls v5.8H, v12.8H, v7.H[0]              // .......................................................*.......................
        srshr v23.8H, v23.8H, #11               // ........................................................*......................
        srshr v9.8H, v21.8H, #11                // .........................................................*.....................
        srshr v24.8H, v1.8H, #11                // ..........................................................*....................
        mls v20.8H, v23.8H, v7.H[0]             // ...........................................................*...................
        mls v22.8H, v9.8H, v7.H[0]              // ............................................................*..................
        mls v2.8H, v24.8H, v7.H[0]              // .............................................................*.................
        sub v16.8H, v20.8H, v5.8H               // ...............................................................*...............
        add v8.8H, v20.8H, v5.8H                // ................................................................*..............
        sub v9.8H, v2.8H, v22.8H                // .................................................................*.............
        sqrdmulh v5.8H, v16.8H, v3.H[1]         // ..................................................................*............
        mul v21.8H, v16.8H, v3.H[0]             // ...................................................................*...........
        sqrdmulh v12.8H, v9.8H, v3.H[1]         // ....................................................................*..........
        add v23.8H, v2.8H, v22.8H               // .....................................................................*.........
        mul v9.8H, v9.8H, v3.H[0]               // ......................................................................*........
        str q8, [x1], #(64)                     // .......................................................................*.......
        mls v21.8H, v5.8H, v7.H[0]              // ........................................................................*......
        str q23, [x1, #-48]                     // .........................................................................*.....
        mls v9.8H, v12.8H, v7.H[0]              // ..........................................................................*....
        str q21, [x1, #-32]                     // ............................................................................*..
        str q9, [x1, #-16]                      // ..............................................................................*

                                                 // ------------------------------ cycle (expected) ------------------------------>
                                                 // 0                        25                       50                       75
                                                 // |------------------------|------------------------|------------------------|---
        // trn1 v23.4S, v9.4S, v12.4S            // *..............................................................................
        // trn2 v9.4S, v9.4S, v12.4S             // ..*............................................................................
        // trn2 v12.4S, v16.4S, v5.4S            // .*.............................................................................
        // trn2 v21.2D, v23.2D, v22.2D           // ....*..........................................................................
        // trn1 v23.2D, v23.2D, v22.2D           // ...*...........................................................................
        // trn2 v5.2D, v9.2D, v12.2D             // ......*........................................................................
        // trn1 v9.2D, v9.2D, v12.2D             // .....*.........................................................................
        // sub v12.8H, v21.8H, v5.8H             // .........*.....................................................................
        // add v21.8H, v21.8H, v5.8H             // ........*......................................................................
        // sub v5.8H, v23.8H, v9.8H              // .......*.......................................................................
        // add v23.8H, v23.8H, v9.8H             // ..............*................................................................
        // sqrdmulh v9.8H, v12.8H, v14.8H        // .............*.................................................................
        // sqrdmulh v8.8H, v5.8H, v8.8H          // ...........*...................................................................
        // mul v5.8H, v5.8H, v30.8H              // ..........*....................................................................
        // mul v12.8H, v12.8H, v11.8H            // ............*..................................................................
        // sub v22.8H, v23.8H, v21.8H            // ..................*............................................................
        // add v23.8H, v23.8H, v21.8H            // ...........................*...................................................
        // mls v5.8H, v8.8H, v7.H[0]             // ...............*...............................................................
        // mls v12.8H, v9.8H, v7.H[0]            // .................*.............................................................
        // sqrdmulh v9.8H, v22.8H, v20.8H        // ......................*........................................................
        // mul v21.8H, v22.8H, v2.8H             // .......................*.......................................................
        // ldr q8, [x3], #16                     // ...................*...........................................................
        // sub v22.8H, v5.8H, v12.8H             // .....................*.........................................................
        // mls v21.8H, v9.8H, v7.H[0]            // ............................*..................................................
        // add v9.8H, v5.8H, v12.8H              // ..........................*....................................................
        // sqrdmulh v12.8H, v22.8H, v20.8H       // .........................*.....................................................
        // mul v5.8H, v22.8H, v2.8H              // ........................*......................................................
        // trn1 v22.4S, v23.4S, v9.4S            // ...............................*...............................................
        // trn2 v23.4S, v23.4S, v9.4S            // ..............................*................................................
        // mls v5.8H, v12.8H, v7.H[0]            // .............................*.................................................
        // trn1 v2.4S, v21.4S, v5.4S             // ..................................*............................................
        // trn2 v21.4S, v21.4S, v5.4S            // .................................*.............................................
        // trn2 v20.2D, v22.2D, v2.2D            // .....................................*.........................................
        // trn2 v30.2D, v23.2D, v21.2D           // ....................................*..........................................
        // trn1 v22.2D, v22.2D, v2.2D            // ......................................*........................................
        // trn1 v23.2D, v23.2D, v21.2D           // ........................................*......................................
        // sub v21.8H, v20.8H, v30.8H            // .......................................*.......................................
        // sub v2.8H, v22.8H, v23.8H             // ..........................................*....................................
        // add v23.8H, v22.8H, v23.8H            // ...............................................*...............................
        // sqrdmulh v22.8H, v21.8H, v8.H[5]      // ...........................................*...................................
        // sqrdmulh v11.8H, v2.8H, v8.H[3]       // ..............................................*................................
        // mul v2.8H, v2.8H, v8.H[2]             // .............................................*.................................
        // mul v21.8H, v21.8H, v8.H[4]           // ............................................*..................................
        // add v20.8H, v20.8H, v30.8H            // .........................................*.....................................
        // sqdmulh v30.8H, v23.8H, v7.H[1]       // ...................................................*...........................
        // mls v2.8H, v11.8H, v7.H[0]            // ..................................................*............................
        // mls v21.8H, v22.8H, v7.H[0]           // .................................................*.............................
        // sqdmulh v22.8H, v20.8H, v7.H[1]       // ................................................*..............................
        // srshr v30.8H, v30.8H, #11             // ........................................................*......................
        // sqdmulh v11.8H, v2.8H, v7.H[1]        // ......................................................*........................
        // sqdmulh v14.8H, v21.8H, v7.H[1]       // .....................................................*.........................
        // mls v23.8H, v30.8H, v7.H[0]           // ...........................................................*...................
        // srshr v22.8H, v22.8H, #11             // ....................................................*..........................
        // srshr v30.8H, v11.8H, #11             // ..........................................................*....................
        // srshr v11.8H, v14.8H, #11             // .........................................................*.....................
        // mls v20.8H, v22.8H, v7.H[0]           // .......................................................*.......................
        // mls v2.8H, v30.8H, v7.H[0]            // .............................................................*.................
        // mls v21.8H, v11.8H, v7.H[0]           // ............................................................*..................
        // sub v30.8H, v23.8H, v20.8H            // ...............................................................*...............
        // add v23.8H, v23.8H, v20.8H            // ................................................................*..............
        // sub v20.8H, v2.8H, v21.8H             // .................................................................*.............
        // sqrdmulh v11.8H, v30.8H, v8.H[1]      // ..................................................................*............
        // mul v30.8H, v30.8H, v8.H[0]           // ...................................................................*...........
        // sqrdmulh v14.8H, v20.8H, v8.H[1]      // ....................................................................*..........
        // mul v8.8H, v20.8H, v8.H[0]            // ......................................................................*........
        // add v21.8H, v2.8H, v21.8H             // .....................................................................*.........
        // mls v30.8H, v11.8H, v7.H[0]           // ........................................................................*......
        // str q23, [x1], #(64)                  // .......................................................................*.......
        // mls v8.8H, v14.8H, v7.H[0]            // ..........................................................................*....
        // str q21, [x1, #-48]                   // .........................................................................*.....
        // str q30, [x1, #-32]                   // ............................................................................*..
        // str q8, [x1, #-16]                    // ..............................................................................*


        // ---------------------------------------------------------------------

        ninv             .req v29
        ninv_tw          .req v30

        ASM_LOAD(xtmp, ninv_addr)
        ld1r {ninv.8h}, [xtmp]
        ASM_LOAD(xtmp, ninv_tw_addr)
        ld1r {ninv_tw.8h}, [xtmp]

        mov count, #4
        ASM_LOAD(r_ptr0, roots_l012)
        load_roots_123

        .p2align 2

                                          // Instructions:    12
                                          // Expected cycles: 19
                                          // Expected IPC:    0.63
                                          //
                                          // Cycle bound:     19.0
                                          // IPC bound:       0.63
                                          //
                                          // Wall time:     0.01s
                                          // User time:     0.01s
                                          //
                                          // ----- cycle (expected) ------>
                                          // 0                        25
                                          // |------------------------|----
        ldr q12, [x0, #128]               // *.............................
        ldr q22, [x0, #256]               // ..*...........................
        ldr q16, [x0, #320]               // ....*.........................
        ldr q2, [x0, #384]                // ......*.......................
        add v14.8H, v22.8H, v16.8H        // ........*.....................
        ldr q20, [x0, #448]               // .........*....................
        ldr q5, [x0, #192]                // ...........*..................
        add v3.8H, v2.8H, v20.8H          // .............*................
        ldr q9, [x0, #0]                  // ..............*...............
        add v8.8H, v12.8H, v5.8H          // ................*.............
        add v11.8H, v14.8H, v3.8H         // .................*............
        ldr q21, [x0, #64]                // ..................*...........

                                           // ------ cycle (expected) ------>
                                           // 0                        25
                                           // |------------------------|-----
        // ldr q9, [x0, #0]                // ..............*................
        // ldr q21, [x0, #64]              // ..................*............
        // ldr q12, [x0, #128]             // *..............................
        // ldr q22, [x0, #256]             // ..*............................
        // ldr q16, [x0, #320]             // ....*..........................
        // ldr q2, [x0, #384]              // ......*........................
        // add v14.8H, v22.8H, v16.8H      // ........*......................
        // ldr q20, [x0, #448]             // .........*.....................
        // ldr q5, [x0, #192]              // ...........*...................
        // add v3.8H, v2.8H, v20.8H        // .............*.................
        // add v8.8H, v12.8H, v5.8H        // ................*..............
        // add v11.8H, v14.8H, v3.8H       // .................*.............

        sub count, count, #1
layer123_start:
                                                // Instructions:    88
                                                // Expected cycles: 96
                                                // Expected IPC:    0.92
                                                //
                                                // Cycle bound:     96.0
                                                // IPC bound:       0.92
                                                //
                                                // Wall time:     3.68s
                                                // User time:     3.68s
                                                //
                                                // -------------------------------------- cycle (expected) --------------------------------------->
                                                // 0                        25                       50                       75
                                                // |------------------------|------------------------|------------------------|--------------------
        sub v23.8H, v9.8H, v21.8H               // *...............................................................................................
        add v9.8H, v9.8H, v21.8H                // .*..............................................................................................
        sub v12.8H, v12.8H, v5.8H               // ..*.............................................................................................
        sqrdmulh v21.8H, v23.8H, v0.H[7]        // ...*............................................................................................
        mul v23.8H, v23.8H, v0.H[6]             // ....*...........................................................................................
        sub v5.8H, v9.8H, v8.8H                 // .....*..........................................................................................
        add v9.8H, v9.8H, v8.8H                 // ......*.........................................................................................
        sqrdmulh v8.8H, v12.8H, v1.H[1]         // .......*........................................................................................
        mul v12.8H, v12.8H, v1.H[0]             // ........*.......................................................................................
        mls v23.8H, v21.8H, v7.H[0]             // .........*......................................................................................
        sub v21.8H, v22.8H, v16.8H              // ..........*.....................................................................................
        sqrdmulh v22.8H, v5.8H, v0.H[3]         // ...........*....................................................................................
        mul v5.8H, v5.8H, v0.H[2]               // ............*...................................................................................
        sub v16.8H, v9.8H, v11.8H               // .............*..................................................................................
        add v9.8H, v9.8H, v11.8H                // ..............*.................................................................................
        mls v12.8H, v8.8H, v7.H[0]              // ...............*................................................................................
        sqrdmulh v8.8H, v21.8H, v1.H[3]         // ................*...............................................................................
        mul v21.8H, v21.8H, v1.H[2]             // .................*..............................................................................
        sub v2.8H, v2.8H, v20.8H                // ..................*.............................................................................
        sub v20.8H, v23.8H, v12.8H              // ...................*............................................................................
        add v23.8H, v23.8H, v12.8H              // ....................*...........................................................................
        mls v21.8H, v8.8H, v7.H[0]              // .....................*..........................................................................
        sqrdmulh v12.8H, v2.8H, v1.H[5]         // ......................*.........................................................................
        mls v5.8H, v22.8H, v7.H[0]              // .......................*........................................................................
        mul v8.8H, v2.8H, v1.H[4]               // ........................*.......................................................................
        sqrdmulh v22.8H, v20.8H, v0.H[3]        // .........................*......................................................................
        mul v2.8H, v20.8H, v0.H[2]              // ..........................*.....................................................................
        sqrdmulh v20.8H, v16.8H, v0.H[1]        // ...........................*....................................................................
        mul v16.8H, v16.8H, v0.H[0]             // ............................*...................................................................
        sqrdmulh v11.8H, v9.8H, v30.8H          // .............................*..................................................................
        mul v9.8H, v9.8H, v29.8H                // ..............................*.................................................................
        mls v8.8H, v12.8H, v7.H[0]              // ...............................*................................................................
        mls v2.8H, v22.8H, v7.H[0]              // ................................*...............................................................
        sub v12.8H, v14.8H, v3.8H               // .................................*..............................................................
        mls v16.8H, v20.8H, v7.H[0]             // ..................................*.............................................................
        sub v22.8H, v21.8H, v8.8H               // ...................................*............................................................
        sqrdmulh v20.8H, v12.8H, v0.H[5]        // ....................................*...........................................................
        mul v12.8H, v12.8H, v0.H[4]             // .....................................*..........................................................
        add v21.8H, v21.8H, v8.8H               // ......................................*.........................................................
        sqrdmulh v8.8H, v22.8H, v0.H[5]         // .......................................*........................................................
        mul v22.8H, v22.8H, v0.H[4]             // ........................................*.......................................................
        sub v14.8H, v23.8H, v21.8H              // .........................................*......................................................
        add v23.8H, v23.8H, v21.8H              // ..........................................*.....................................................
        mls v12.8H, v20.8H, v7.H[0]             // ...........................................*....................................................
        mls v22.8H, v8.8H, v7.H[0]              // ............................................*...................................................
        sqrdmulh v21.8H, v14.8H, v0.H[1]        // .............................................*..................................................
        mul v8.8H, v14.8H, v0.H[0]              // ..............................................*.................................................
        sub v20.8H, v5.8H, v12.8H               // ...............................................*................................................
        add v12.8H, v5.8H, v12.8H               // ................................................*...............................................
        sub v5.8H, v2.8H, v22.8H                // .................................................*..............................................
        mls v8.8H, v21.8H, v7.H[0]              // ..................................................*.............................................
        sqrdmulh v21.8H, v20.8H, v0.H[1]        // ...................................................*............................................
        mul v20.8H, v20.8H, v0.H[0]             // ....................................................*...........................................
        add v22.8H, v2.8H, v22.8H               // .....................................................*..........................................
        sqrdmulh v2.8H, v5.8H, v0.H[1]          // ......................................................*.........................................
        mul v5.8H, v5.8H, v0.H[0]               // .......................................................*........................................
        mls v20.8H, v21.8H, v7.H[0]             // ........................................................*.......................................
        str q16, [x0, #256]                     // .........................................................*......................................
        mls v9.8H, v11.8H, v7.H[0]              // ..........................................................*.....................................
        mls v5.8H, v2.8H, v7.H[0]               // ...........................................................*....................................
        str q8, [x0, #320]                      // ............................................................*...................................
        sqrdmulh v21.8H, v23.8H, v30.8H         // .............................................................*..................................
        str q20, [x0, #384]                     // ..............................................................*.................................
        mul v23.8H, v23.8H, v29.8H              // ...............................................................*................................
        str q5, [x0, #448]                      // ................................................................*...............................
        sqrdmulh v5.8H, v12.8H, v30.8H          // .................................................................*..............................
        mul v12.8H, v12.8H, v29.8H              // ..................................................................*.............................
        mls v23.8H, v21.8H, v7.H[0]             // ...................................................................*............................
        sqrdmulh v21.8H, v22.8H, v30.8H         // ....................................................................*...........................
        mul v8.8H, v22.8H, v29.8H               // .....................................................................*..........................
        mls v12.8H, v5.8H, v7.H[0]              // ......................................................................*.........................
        str q9, [x0], #(16)                     // .......................................................................*........................
        ldr q9, [x0, #0]                        // ........................................................................e.......................
        mls v8.8H, v21.8H, v7.H[0]              // ..........................................................................*.....................
        str q23, [x0, #48]                      // ...........................................................................*....................
        ldr q21, [x0, #64]                      // ............................................................................e...................
        str q12, [x0, #112]                     // ..............................................................................*.................
        ldr q12, [x0, #128]                     // ...............................................................................e................
        ldr q22, [x0, #256]                     // .................................................................................e..............
        ldr q16, [x0, #320]                     // ...................................................................................e............
        ldr q2, [x0, #384]                      // .....................................................................................e..........
        add v14.8H, v22.8H, v16.8H              // .......................................................................................e........
        ldr q20, [x0, #448]                     // ........................................................................................e.......
        ldr q5, [x0, #192]                      // ..........................................................................................e.....
        add v3.8H, v2.8H, v20.8H                // ............................................................................................e...
        str q8, [x0, #176]                      // .............................................................................................*..
        add v8.8H, v12.8H, v5.8H                // ..............................................................................................e.
        add v11.8H, v14.8H, v3.8H               // ...............................................................................................e

                                                      // ------------------------------------------------- cycle (expected) -------------------------------------------------->
                                                      // 0                        25                       50                       75                       100
                                                      // |------------------------|------------------------|------------------------|------------------------|-----------------
        // ldr q8, [x0, #0]                           // e.......................'.......................................................................~.....................
        // ldr q9, [x0, #(1*(512/8))]                 // ....e...................'...........................................................................~.................
        // ldr q10, [x0, #(2*(512/8))]                // .......e................'..............................................................................~..............
        // ldr q11, [x0, #(3*(512/8))]                // ..................e.....'.........................................................................................~...
        // ldr q12, [x0, #(4*(512/8))]                // .........e..............'................................................................................~............
        // ldr q13, [x0, #(5*(512/8))]                // ...........e............'..................................................................................~..........
        // ldr q14, [x0, #(6*(512/8))]                // .............e..........'....................................................................................~........
        // ldr q15, [x0, #(7*(512/8))]                // ................e.......'.......................................................................................~.....
        // sub v24.8h,   v8.8h, v9.8h                 // ........................*.............................................................................................
        // add v8.8h, v8.8h, v9.8h                    // ........................'*............................................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[7]      // ........................'..*..........................................................................................
        // mul      v9.8h, v24.8h, v0.h[6]            // ........................'...*.........................................................................................
        // mls      v9.8h, v27.8h,      v7.h[0]       // ........................'........*....................................................................................
        // sub v24.8h,   v10.8h, v11.8h               // ........................'.*...........................................................................................
        // add v10.8h, v10.8h, v11.8h                 // ......................e.'.............................................................................................
        // sqrdmulh v27.8h,      v24.8h, v1.h[1]      // ........................'......*......................................................................................
        // mul      v11.8h, v24.8h, v1.h[0]           // ........................'.......*.....................................................................................
        // mls      v11.8h, v27.8h,      v7.h[0]      // ........................'..............*..............................................................................
        // sub v24.8h,   v12.8h, v13.8h               // ........................'.........*...................................................................................
        // add v12.8h, v12.8h, v13.8h                 // ...............e........'......................................................................................~......
        // sqrdmulh v27.8h,      v24.8h, v1.h[3]      // ........................'...............*.............................................................................
        // mul      v13.8h, v24.8h, v1.h[2]           // ........................'................*............................................................................
        // mls      v13.8h, v27.8h,      v7.h[0]      // ........................'....................*........................................................................
        // sub v24.8h,   v14.8h, v15.8h               // ........................'.................*...........................................................................
        // add v14.8h, v14.8h, v15.8h                 // ....................e...'...........................................................................................~.
        // sqrdmulh v27.8h,      v24.8h, v1.h[5]      // ........................'.....................*.......................................................................
        // mul      v15.8h, v24.8h, v1.h[4]           // ........................'.......................*.....................................................................
        // mls      v15.8h, v27.8h,      v7.h[0]      // ........................'..............................*..............................................................
        // sub v24.8h,   v8.8h, v10.8h                // ........................'....*........................................................................................
        // add v8.8h, v8.8h, v10.8h                   // ........................'.....*.......................................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[3]      // ........................'..........*..................................................................................
        // mul      v10.8h, v24.8h, v0.h[2]           // ........................'...........*.................................................................................
        // mls      v10.8h, v27.8h,      v7.h[0]      // ........................'......................*......................................................................
        // sub v24.8h,   v9.8h, v11.8h                // ........................'..................*..........................................................................
        // add v9.8h, v9.8h, v11.8h                   // ........................'...................*.........................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[3]      // ........................'........................*....................................................................
        // mul      v11.8h, v24.8h, v0.h[2]           // ........................'.........................*...................................................................
        // mls      v11.8h, v27.8h,      v7.h[0]      // ........................'...............................*.............................................................
        // sub v24.8h,   v12.8h, v14.8h               // ........................'................................*............................................................
        // add v12.8h, v12.8h, v14.8h                 // .......................e'.............................................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[5]      // ........................'...................................*.........................................................
        // mul      v14.8h, v24.8h, v0.h[4]           // ........................'....................................*........................................................
        // mls      v14.8h, v27.8h,      v7.h[0]      // ........................'..........................................*..................................................
        // sub v24.8h,   v13.8h, v15.8h               // ........................'..................................*..........................................................
        // add v13.8h, v13.8h, v15.8h                 // ........................'.....................................*.......................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[5]      // ........................'......................................*......................................................
        // mul      v15.8h, v24.8h, v0.h[4]           // ........................'.......................................*.....................................................
        // mls      v15.8h, v27.8h,      v7.h[0]      // ........................'...........................................*.................................................
        // sub v24.8h,   v8.8h, v12.8h                // ........................'............*................................................................................
        // add v8.8h, v8.8h, v12.8h                   // ........................'.............*...............................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ........................'..........................*..................................................................
        // mul      v12.8h, v24.8h, v0.h[0]           // ........................'...........................*.................................................................
        // mls      v12.8h, v27.8h,      v7.h[0]      // ........................'.................................*...........................................................
        // sub v24.8h,   v9.8h, v13.8h                // ........................'........................................*....................................................
        // add v9.8h, v9.8h, v13.8h                   // ........................'.........................................*...................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ........................'............................................*................................................
        // mul      v13.8h, v24.8h, v0.h[0]           // ........................'.............................................*...............................................
        // mls      v13.8h, v27.8h,      v7.h[0]      // ........................'.................................................*...........................................
        // sub v24.8h,   v10.8h, v14.8h               // ........................'..............................................*..............................................
        // add v10.8h, v10.8h, v14.8h                 // ........................'...............................................*.............................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ........................'..................................................*..........................................
        // mul      v14.8h, v24.8h, v0.h[0]           // ........................'...................................................*.........................................
        // mls      v14.8h, v27.8h,      v7.h[0]      // ........................'.......................................................*.....................................
        // sub v24.8h,   v11.8h, v15.8h               // ........................'................................................*............................................
        // add v11.8h, v11.8h, v15.8h                 // ........................'....................................................*........................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ........................'.....................................................*.......................................
        // mul      v15.8h, v24.8h, v0.h[0]           // ........................'......................................................*......................................
        // mls      v15.8h, v27.8h,      v7.h[0]      // ........................'..........................................................*..................................
        // str q12, [x0, #(4*(512/8))]                // ........................'........................................................*....................................
        // str q13, [x0, #(5*(512/8))]                // ........................'...........................................................*.................................
        // str q14, [x0, #(6*(512/8))]                // ........................'.............................................................*...............................
        // str q15, [x0, #(7*(512/8))]                // ........................'...............................................................*.............................
        // sqrdmulh v27.8h,      v8.8h, v30.8h        // ........................'............................*................................................................
        // mul      v8.8h, v8.8h, v29.8h              // ........................'.............................*...............................................................
        // mls      v8.8h, v27.8h,      v7.h[0]       // ........................'.........................................................*...................................
        // sqrdmulh v27.8h,      v9.8h, v30.8h        // ........................'............................................................*................................
        // mul      v9.8h, v9.8h, v29.8h              // ........................'..............................................................*..............................
        // mls      v9.8h, v27.8h,      v7.h[0]       // ........................'..................................................................*..........................
        // sqrdmulh v27.8h,      v10.8h, v30.8h       // ........................'................................................................*............................
        // mul      v10.8h, v10.8h, v29.8h            // ........................'.................................................................*...........................
        // mls      v10.8h, v27.8h,      v7.h[0]      // ........................'.....................................................................*.......................
        // sqrdmulh v27.8h,      v11.8h, v30.8h       // ........................'...................................................................*.........................
        // mul      v11.8h, v11.8h, v29.8h            // ........................'....................................................................*........................
        // mls      v11.8h, v27.8h,      v7.h[0]      // ..~.....................'.........................................................................*...................
        // str q8, [x0], #(16)                        // ........................'......................................................................*......................
        // str q9, [x0, #(-16 + 1*(512/8))]           // ...~....................'..........................................................................*..................
        // str q10, [x0, #(-16 + 2*(512/8))]          // ......~.................'.............................................................................*...............
        // str q11, [x0, #(-16 + 3*(512/8))]          // .....................~..'............................................................................................*

        sub count, count, #1
        cbnz count, layer123_start
                                                // Instructions:    76
                                                // Expected cycles: 78
                                                // Expected IPC:    0.97
                                                //
                                                // Cycle bound:     78.0
                                                // IPC bound:       0.97
                                                //
                                                // Wall time:     7.96s
                                                // User time:     7.96s
                                                //
                                                // ----------------------------- cycle (expected) ------------------------------>
                                                // 0                        25                       50                       75
                                                // |------------------------|------------------------|------------------------|--
        sub v24.8H, v2.8H, v20.8H               // *.............................................................................
        sub v2.8H, v9.8H, v21.8H                // .*............................................................................
        sub v26.8H, v12.8H, v5.8H               // ..*...........................................................................
        mul v23.8H, v24.8H, v1.H[4]             // ...*..........................................................................
        sqrdmulh v18.8H, v24.8H, v1.H[5]        // ....*.........................................................................
        sqrdmulh v12.8H, v26.8H, v1.H[1]        // .....*........................................................................
        mul v20.8H, v26.8H, v1.H[0]             // ......*.......................................................................
        sub v22.8H, v22.8H, v16.8H              // .......*......................................................................
        mul v31.8H, v2.8H, v0.H[6]              // ........*.....................................................................
        sqrdmulh v27.8H, v2.8H, v0.H[7]         // .........*....................................................................
        mul v6.8H, v22.8H, v1.H[2]              // ..........*...................................................................
        sqrdmulh v5.8H, v22.8H, v1.H[3]         // ...........*..................................................................
        sub v19.8H, v14.8H, v3.8H               // ............*.................................................................
        mls v31.8H, v27.8H, v7.H[0]             // .............*................................................................
        mls v23.8H, v18.8H, v7.H[0]             // ..............*...............................................................
        mls v6.8H, v5.8H, v7.H[0]               // ...............*..............................................................
        mls v20.8H, v12.8H, v7.H[0]             // ................*.............................................................
        sqrdmulh v17.8H, v19.8H, v0.H[5]        // .................*............................................................
        mul v2.8H, v19.8H, v0.H[4]              // ..................*...........................................................
        add v12.8H, v6.8H, v23.8H               // ...................*..........................................................
        add v28.8H, v31.8H, v20.8H              // ....................*.........................................................
        add v10.8H, v9.8H, v21.8H               // .....................*........................................................
        mls v2.8H, v17.8H, v7.H[0]              // ......................*.......................................................
        sub v22.8H, v28.8H, v12.8H              // .......................*......................................................
        add v12.8H, v28.8H, v12.8H              // ........................*.....................................................
        add v9.8H, v10.8H, v8.8H                // .........................*....................................................
        sqrdmulh v14.8H, v22.8H, v0.H[1]        // ..........................*...................................................
        mul v21.8H, v12.8H, v29.8H              // ...........................*..................................................
        sqrdmulh v12.8H, v12.8H, v30.8H         // ............................*.................................................
        sub v16.8H, v9.8H, v11.8H               // .............................*................................................
        sub v23.8H, v6.8H, v23.8H               // ..............................*...............................................
        sub v27.8H, v10.8H, v8.8H               // ...............................*..............................................
        sqrdmulh v5.8H, v16.8H, v0.H[1]         // ................................*.............................................
        mul v3.8H, v23.8H, v0.H[4]              // .................................*............................................
        sqrdmulh v17.8H, v23.8H, v0.H[5]        // ..................................*...........................................
        mul v13.8H, v16.8H, v0.H[0]             // ...................................*..........................................
        mls v21.8H, v12.8H, v7.H[0]             // ....................................*.........................................
        mul v8.8H, v27.8H, v0.H[2]              // .....................................*........................................
        sqrdmulh v12.8H, v27.8H, v0.H[3]        // ......................................*.......................................
        mls v3.8H, v17.8H, v7.H[0]              // .......................................*......................................
        sub v23.8H, v31.8H, v20.8H              // ........................................*.....................................
        add v18.8H, v9.8H, v11.8H               // .........................................*....................................
        mls v8.8H, v12.8H, v7.H[0]              // ..........................................*...................................
        mul v16.8H, v23.8H, v0.H[2]             // ...........................................*..................................
        sqrdmulh v6.8H, v23.8H, v0.H[3]         // ............................................*.................................
        sqrdmulh v4.8H, v18.8H, v30.8H          // .............................................*................................
        sub v26.8H, v8.8H, v2.8H                // ..............................................*...............................
        add v20.8H, v8.8H, v2.8H                // ...............................................*..............................
        mls v16.8H, v6.8H, v7.H[0]              // ................................................*.............................
        mul v18.8H, v18.8H, v29.8H              // .................................................*............................
        mul v2.8H, v22.8H, v0.H[0]              // ..................................................*...........................
        str q21, [x0, #64]                      // ...................................................*..........................
        sub v22.8H, v16.8H, v3.8H               // ....................................................*.........................
        mls v18.8H, v4.8H, v7.H[0]              // .....................................................*........................
        mls v2.8H, v14.8H, v7.H[0]              // ......................................................*.......................
        sqrdmulh v9.8H, v22.8H, v0.H[1]         // .......................................................*......................
        mul v22.8H, v22.8H, v0.H[0]             // ........................................................*.....................
        str q18, [x0], #(16)                    // .........................................................*....................
        add v15.8H, v16.8H, v3.8H               // ..........................................................*...................
        mul v12.8H, v26.8H, v0.H[0]             // ...........................................................*..................
        mls v22.8H, v9.8H, v7.H[0]              // ............................................................*.................
        sqrdmulh v9.8H, v15.8H, v30.8H          // .............................................................*................
        mul v23.8H, v15.8H, v29.8H              // ..............................................................*...............
        mls v13.8H, v5.8H, v7.H[0]              // ...............................................................*..............
        str q22, [x0, #432]                     // ................................................................*.............
        sqrdmulh v8.8H, v26.8H, v0.H[1]         // .................................................................*............
        mls v23.8H, v9.8H, v7.H[0]              // ..................................................................*...........
        str q13, [x0, #240]                     // ...................................................................*..........
        sqrdmulh v21.8H, v20.8H, v30.8H         // ....................................................................*.........
        mul v17.8H, v20.8H, v29.8H              // .....................................................................*........
        str q23, [x0, #176]                     // ......................................................................*.......
        mls v12.8H, v8.8H, v7.H[0]              // .......................................................................*......
        str q2, [x0, #304]                      // ........................................................................*.....
        mls v17.8H, v21.8H, v7.H[0]             // .........................................................................*....
        str q12, [x0, #368]                     // ...........................................................................*..
        str q17, [x0, #112]                     // .............................................................................*

                                                 // ----------------------------- cycle (expected) ------------------------------>
                                                 // 0                        25                       50                       75
                                                 // |------------------------|------------------------|------------------------|--
        // sub v23.8H, v9.8H, v21.8H             // .*............................................................................
        // add v9.8H, v9.8H, v21.8H              // .....................*........................................................
        // sub v12.8H, v12.8H, v5.8H             // ..*...........................................................................
        // sqrdmulh v21.8H, v23.8H, v0.H[7]      // .........*....................................................................
        // mul v23.8H, v23.8H, v0.H[6]           // ........*.....................................................................
        // sub v5.8H, v9.8H, v8.8H               // ...............................*..............................................
        // add v9.8H, v9.8H, v8.8H               // .........................*....................................................
        // sqrdmulh v8.8H, v12.8H, v1.H[1]       // .....*........................................................................
        // mul v12.8H, v12.8H, v1.H[0]           // ......*.......................................................................
        // mls v23.8H, v21.8H, v7.H[0]           // .............*................................................................
        // sub v21.8H, v22.8H, v16.8H            // .......*......................................................................
        // sqrdmulh v22.8H, v5.8H, v0.H[3]       // ......................................*.......................................
        // mul v5.8H, v5.8H, v0.H[2]             // .....................................*........................................
        // sub v16.8H, v9.8H, v11.8H             // .............................*................................................
        // add v9.8H, v9.8H, v11.8H              // .........................................*....................................
        // mls v12.8H, v8.8H, v7.H[0]            // ................*.............................................................
        // sqrdmulh v8.8H, v21.8H, v1.H[3]       // ...........*..................................................................
        // mul v21.8H, v21.8H, v1.H[2]           // ..........*...................................................................
        // sub v2.8H, v2.8H, v20.8H              // *.............................................................................
        // sub v20.8H, v23.8H, v12.8H            // ........................................*.....................................
        // add v23.8H, v23.8H, v12.8H            // ....................*.........................................................
        // mls v21.8H, v8.8H, v7.H[0]            // ...............*..............................................................
        // sqrdmulh v12.8H, v2.8H, v1.H[5]       // ....*.........................................................................
        // mls v5.8H, v22.8H, v7.H[0]            // ..........................................*...................................
        // mul v8.8H, v2.8H, v1.H[4]             // ...*..........................................................................
        // sqrdmulh v22.8H, v20.8H, v0.H[3]      // ............................................*.................................
        // mul v2.8H, v20.8H, v0.H[2]            // ...........................................*..................................
        // sqrdmulh v20.8H, v16.8H, v0.H[1]      // ................................*.............................................
        // mul v16.8H, v16.8H, v0.H[0]           // ...................................*..........................................
        // sqrdmulh v11.8H, v9.8H, v30.8H        // .............................................*................................
        // mul v9.8H, v9.8H, v29.8H              // .................................................*............................
        // mls v8.8H, v12.8H, v7.H[0]            // ..............*...............................................................
        // mls v2.8H, v22.8H, v7.H[0]            // ................................................*.............................
        // sub v12.8H, v14.8H, v3.8H             // ............*.................................................................
        // mls v16.8H, v20.8H, v7.H[0]           // ...............................................................*..............
        // sub v22.8H, v21.8H, v8.8H             // ..............................*...............................................
        // sqrdmulh v20.8H, v12.8H, v0.H[5]      // .................*............................................................
        // mul v12.8H, v12.8H, v0.H[4]           // ..................*...........................................................
        // add v21.8H, v21.8H, v8.8H             // ...................*..........................................................
        // sqrdmulh v8.8H, v22.8H, v0.H[5]       // ..................................*...........................................
        // mul v22.8H, v22.8H, v0.H[4]           // .................................*............................................
        // sub v14.8H, v23.8H, v21.8H            // .......................*......................................................
        // add v23.8H, v23.8H, v21.8H            // ........................*.....................................................
        // mls v12.8H, v20.8H, v7.H[0]           // ......................*.......................................................
        // mls v22.8H, v8.8H, v7.H[0]            // .......................................*......................................
        // sqrdmulh v21.8H, v14.8H, v0.H[1]      // ..........................*...................................................
        // mul v8.8H, v14.8H, v0.H[0]            // ..................................................*...........................
        // sub v20.8H, v5.8H, v12.8H             // ..............................................*...............................
        // add v12.8H, v5.8H, v12.8H             // ...............................................*..............................
        // sub v5.8H, v2.8H, v22.8H              // ....................................................*.........................
        // mls v8.8H, v21.8H, v7.H[0]            // ......................................................*.......................
        // sqrdmulh v21.8H, v20.8H, v0.H[1]      // .................................................................*............
        // mul v20.8H, v20.8H, v0.H[0]           // ...........................................................*..................
        // add v22.8H, v2.8H, v22.8H             // ..........................................................*...................
        // sqrdmulh v2.8H, v5.8H, v0.H[1]        // .......................................................*......................
        // mul v5.8H, v5.8H, v0.H[0]             // ........................................................*.....................
        // mls v20.8H, v21.8H, v7.H[0]           // .......................................................................*......
        // str q16, [x0, #256]                   // ...................................................................*..........
        // mls v9.8H, v11.8H, v7.H[0]            // .....................................................*........................
        // mls v5.8H, v2.8H, v7.H[0]             // ............................................................*.................
        // str q8, [x0, #320]                    // ........................................................................*.....
        // sqrdmulh v21.8H, v23.8H, v30.8H       // ............................*.................................................
        // str q20, [x0, #384]                   // ...........................................................................*..
        // mul v23.8H, v23.8H, v29.8H            // ...........................*..................................................
        // str q5, [x0, #448]                    // ................................................................*.............
        // sqrdmulh v5.8H, v12.8H, v30.8H        // ....................................................................*.........
        // mul v12.8H, v12.8H, v29.8H            // .....................................................................*........
        // mls v23.8H, v21.8H, v7.H[0]           // ....................................*.........................................
        // sqrdmulh v21.8H, v22.8H, v30.8H       // .............................................................*................
        // mul v8.8H, v22.8H, v29.8H             // ..............................................................*...............
        // mls v12.8H, v5.8H, v7.H[0]            // .........................................................................*....
        // str q9, [x0], #(16)                   // .........................................................*....................
        // mls v8.8H, v21.8H, v7.H[0]            // ..................................................................*...........
        // str q23, [x0, #48]                    // ...................................................*..........................
        // str q12, [x0, #112]                   // .............................................................................*
        // str q8, [x0, #176]                    // ......................................................................*.......


        pop_stack
        ret
