///
/// Copyright (c) 2022 Arm Limited
/// Copyright (c) 2022 Hanno Becker
/// Copyright (c) 2023 Amin Abdulrahman, Matthias Kannwischer
/// SPDX-License-Identifier: MIT
///
/// Permission is hereby granted, free of charge, to any person obtaining a copy
/// of this software and associated documentation files (the "Software"), to deal
/// in the Software without restriction, including without limitation the rights
/// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
/// copies of the Software, and to permit persons to whom the Software is
/// furnished to do so, subject to the following conditions:
///
/// The above copyright notice and this permission notice shall be included in all
/// copies or substantial portions of the Software.
///
/// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
/// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
/// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
/// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
/// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
/// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
/// SOFTWARE.
///

// Needed to provide ASM_LOAD directive
#include <hal_env.h>

// NOTE
// We use a lot of trivial macros to simplify the parsing burden for Slothy
// The macros are not unfolded by Slothy and thus interpreted as instructions,
// which are easier to parse due to e.g. the lack of size specifiers and simpler
// syntax for pre and post increment for loads and stores.
//
// Eventually, NeLight should include a proper parser for AArch64,
// but for initial investigations, the below is enough.

.macro ldr_vo vec, base, offset                    // slothy:no-unfold
       ldr qform_\vec, [\base, #\offset]
.endm

.macro ldr_vi vec, base, inc                        // slothy:no-unfold
        ldr qform_\vec, [\base], #\inc
.endm

.macro str_vo vec, base, offset                     // slothy:no-unfold
        str qform_\vec, [\base, #\offset]
.endm
.macro str_vi vec, base, inc                        // slothy:no-unfold
        str qform_\vec, [\base], #\inc
.endm

.macro vqrdmulh d,a,b
        sqrdmulh \d\().8h, \a\().8h, \b\().8h
.endm
.macro vmlsq d,a,b,i
        mls \d\().8h, \a\().8h, \b\().h[\i]
.endm
.macro vqrdmulhq d,a,b,i
        sqrdmulh \d\().8h, \a\().8h, \b\().h[\i]
.endm
.macro vqdmulhq d,a,b,i
        sqdmulh \d\().8h, \a\().8h, \b\().h[\i]
.endm
.macro vmulq d,a,b,i
        mul \d\().8h, \a\().8h, \b\().h[\i]
.endm

.macro mulmodq dst, src, const, idx0, idx1
        vmulq       \dst,  \src, \const, \idx0
        vqrdmulhq   \src,  \src, \const, \idx1
        vmlsq       \dst,  \src, consts, 0
.endm

.macro mulmod dst, src, const, const_twisted
        mul        \dst\().8h,  \src\().8h, \const\().8h
        vqrdmulh   \src,  \src, \const_twisted
        vmlsq      \dst,  \src, consts, 0
.endm

.macro ct_butterfly a, b, root, idx0, idx1
        mulmodq  tmp, \b, \root, \idx0, \idx1
        sub     \b\().8h,    \a\().8h, tmp.8h
        add     \a\().8h,    \a\().8h, tmp.8h
.endm

.macro mulmod_v dst, src, const, const_twisted
        mul         \dst\().8h,  \src\().8h, \const\().8h
        vqrdmulh    \src,  \src, \const_twisted
        vmlsq       \dst,  \src, consts, 0
.endm

.macro ct_butterfly_v a, b, root, root_twisted
        mulmod  tmp, \b, \root, \root_twisted
        sub    \b\().8h,    \a\().8h, tmp.8h
        add    \a\().8h,    \a\().8h, tmp.8h
.endm

.macro barrett_reduce a
        vqdmulhq t0, \a, consts, 1
        srshr    t0.8H, t0.8H, #11
        vmlsq    \a, t0, consts, 0
.endm

.macro load_roots_123
        ldr_vi root0, r_ptr0, 32
        ldr_vo root1, r_ptr0, -16
.endm

.macro load_next_roots_45
        ldr_vi root0, r_ptr0, 16
.endm

.macro load_next_roots_67
        ldr_vi root0,    r_ptr1, (6*16)
        ldr_vo root0_tw, r_ptr1, (-6*16 + 1*16)
        ldr_vo root1,    r_ptr1, (-6*16 + 2*16)
        ldr_vo root1_tw, r_ptr1, (-6*16 + 3*16)
        ldr_vo root2,    r_ptr1, (-6*16 + 4*16)
        ldr_vo root2_tw, r_ptr1, (-6*16 + 5*16)
.endm

.macro transpose4 data
        trn1 t0.4s, \data\()0\().4s, \data\()1\().4s
        trn2 t1.4s, \data\()0\().4s, \data\()1\().4s
        trn1 t2.4s, \data\()2\().4s, \data\()3\().4s
        trn2 t3.4s, \data\()2\().4s, \data\()3\().4s

        trn2 \data\()2\().2d, t0.2d, t2.2d
        trn2 \data\()3\().2d, t1.2d, t3.2d
        trn1 \data\()0\().2d, t0.2d, t2.2d
        trn1 \data\()1\().2d, t1.2d, t3.2d
.endm

.macro transpose_single data_out, data_in
        trn1 \data_out\()0\().4s, \data_in\()0\().4s, \data_in\()1\().4s
        trn2 \data_out\()1\().4s, \data_in\()0\().4s, \data_in\()1\().4s
        trn1 \data_out\()2\().4s, \data_in\()2\().4s, \data_in\()3\().4s
        trn2 \data_out\()3\().4s, \data_in\()2\().4s, \data_in\()3\().4s
.endm

.macro save_gprs // slothy:no-unfold
        sub sp, sp, #(16*6)
        stp x19, x20, [sp, #16*0]
        stp x19, x20, [sp, #16*0]
        stp x21, x22, [sp, #16*1]
        stp x23, x24, [sp, #16*2]
        stp x25, x26, [sp, #16*3]
        stp x27, x28, [sp, #16*4]
        str x29, [sp, #16*5]
.endm

.macro restore_gprs // slothy:no-unfold
        ldp x19, x20, [sp, #16*0]
        ldp x21, x22, [sp, #16*1]
        ldp x23, x24, [sp, #16*2]
        ldp x25, x26, [sp, #16*3]
        ldp x27, x28, [sp, #16*4]
        ldr x29, [sp, #16*5]
        add sp, sp, #(16*6)
.endm

.macro save_vregs // slothy:no-unfold
        sub sp, sp, #(16*4)
        stp  d8,  d9, [sp, #16*0]
        stp d10, d11, [sp, #16*1]
        stp d12, d13, [sp, #16*2]
        stp d14, d15, [sp, #16*3]
.endm

.macro restore_vregs // slothy:no-unfold
        ldp  d8,  d9, [sp, #16*0]
        ldp d10, d11, [sp, #16*1]
        ldp d12, d13, [sp, #16*2]
        ldp d14, d15, [sp, #16*3]
        add sp, sp, #(16*4)
.endm

#define STACK_SIZE 16
#define STACK0 0

.macro restore a, loc     // slothy:no-unfold
        ldr \a, [sp, #\loc\()]
.endm
.macro save loc, a        // slothy:no-unfold
        str \a, [sp, #\loc\()]
.endm
.macro push_stack // slothy:no-unfold
        save_gprs
        save_vregs
        sub sp, sp, #STACK_SIZE
.endm

.macro pop_stack // slothy:no-unfold
        add sp, sp, #STACK_SIZE
        restore_vregs
        restore_gprs
.endm

.data
.p2align 4
roots:
#include "ntt_kyber_123_45_67_twiddles.s"
.text

        .global ntt_kyber_123_4567_opt_x1
        .global _ntt_kyber_123_4567_opt_x1

.p2align 4
const_addr:       .short 3329
                  .short 20159
                  .short 0
                  .short 0
                  .short 0
                  .short 0
                  .short 0
                  .short 0
ntt_kyber_123_4567_opt_x1:
_ntt_kyber_123_4567_opt_x1:
        push_stack

        in      .req x0
        inp     .req x1
        count   .req x2
        r_ptr0  .req x3
        r_ptr1  .req x4
        xtmp    .req x5

        qform_v0  .req q0
        qform_v1  .req q1
        qform_v2  .req q2
        qform_v3  .req q3
        qform_v4  .req q4
        qform_v5  .req q5
        qform_v6  .req q6
        qform_v7  .req q7
        qform_v8  .req q8
        qform_v9  .req q9
        qform_v10 .req q10
        qform_v11 .req q11
        qform_v12 .req q12
        qform_v13 .req q13
        qform_v14 .req q14
        qform_v15 .req q15
        qform_v16 .req q16
        qform_v17 .req q17
        qform_v18 .req q18
        qform_v19 .req q19
        qform_v20 .req q20
        qform_v21 .req q21
        qform_v22 .req q22
        qform_v23 .req q23
        qform_v24 .req q24
        qform_v25 .req q25
        qform_v26 .req q26
        qform_v27 .req q27
        qform_v28 .req q28
        qform_v29 .req q29
        qform_v30 .req q30
        qform_v31 .req q31

        data0  .req v8
        data1  .req v9
        data2  .req v10
        data3  .req v11
        data4  .req v12
        data5  .req v13
        data6  .req v14
        data7  .req v15

        x_00 .req x10
        x_01 .req x11
        x_10 .req x12
        x_11 .req x13
        x_20 .req x14
        x_21 .req x15
        x_30 .req x16
        x_31 .req x17

        xt_00 .req x_00
        xt_01 .req x_20
        xt_10 .req x_10
        xt_11 .req x_30
        xt_20 .req x_01
        xt_21 .req x_21
        xt_30 .req x_11
        xt_31 .req x_31

        qform_data0  .req q8
        qform_data1  .req q9
        qform_data2  .req q10
        qform_data3  .req q11
        qform_data4  .req q12
        qform_data5  .req q13
        qform_data6  .req q14
        qform_data7  .req q15

        root0    .req v0
        root1    .req v1
        root2    .req v2
        root0_tw .req v4
        root1_tw .req v5
        root2_tw .req v6

        consts         .req v7
        qform_consts   .req q7

        qform_root0    .req q0
        qform_root1    .req q1
        qform_root2    .req q2
        qform_root0_tw .req q4
        qform_root1_tw .req q5
        qform_root2_tw .req q6

        tmp .req v24
        t0  .req v25
        t1  .req v26
        t2  .req v27
        t3  .req v28

        ASM_LOAD(r_ptr0, roots)
        ASM_LOAD(r_ptr1, roots_l56)

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]

        save STACK0, in
        mov count, #4

        load_roots_123

        .p2align 2
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        ldr_vo v14, x0, 448                      // .*..................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        ldr_vo v30, x0, 384                      // ..*.................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        ldr_vo v16, x0, 256                      // *...................................................
        mul v8.8H, v14.8H, v0.H[0]               // .......*............................................
        // gap                                   // ....................................................
        sqrdmulh v23.8H, v14.8H, v0.H[1]         // ......*.............................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        ldr_vo v25, x0, 320                      // .....*..............................................
        mul v2.8H, v30.8H, v0.H[0]               // ..........*.........................................
        // gap                                   // ....................................................
        sqrdmulh v30.8H, v30.8H, v0.H[1]         // .........*..........................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        ldr_vo v4, x0, 192                       // ...........*........................................
        mls v8.8H, v23.8H, v7.H[0]               // .............*......................................
        // gap                                   // ....................................................
        mul v21.8H, v16.8H, v0.H[0]              // ...*................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        ldr_vo v11, x0, 128                      // ..............*.....................................
        sqrdmulh v22.8H, v25.8H, v0.H[1]         // ...............*....................................
        // gap                                   // ....................................................
        mls v2.8H, v30.8H, v7.H[0]               // ................*...................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        ldr_vo v3, x0, 0                         // ........*...........................................
        sqrdmulh v18.8H, v16.8H, v0.H[1]         // ....*...............................................
        add v30.8H, v4.8H, v8.8H                 // ....................*...............................
        mul v16.8H, v25.8H, v0.H[0]              // ............*.......................................
        sub v25.8H, v4.8H, v8.8H                 // ...................*................................
        // gap                                   // ....................................................
        ldr_vo v10, x0, 64                       // .................*..................................
        mul v14.8H, v25.8H, v0.H[4]              // .......................*............................
        add v19.8H, v11.8H, v2.8H                // ......................*.............................
        sqrdmulh v26.8H, v25.8H, v0.H[5]         // .....................*..............................
        sub v23.8H, v11.8H, v2.8H                // ........................*...........................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        mls v16.8H, v22.8H, v7.H[0]              // ...........................*........................
        // gap                                   // ....................................................
        sqrdmulh v24.8H, v23.8H, v0.H[5]         // ............................*.......................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        mul v29.8H, v23.8H, v0.H[4]              // .........................*..........................
        // gap                                   // ....................................................
        mls v14.8H, v26.8H, v7.H[0]              // .............................*......................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        mls v21.8H, v18.8H, v7.H[0]              // ..................*.................................
        sub v27.8H, v10.8H, v16.8H               // ................................*...................
        sqrdmulh v31.8H, v30.8H, v0.H[3]         // .................................*..................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        mls v29.8H, v24.8H, v7.H[0]              // ....................................*...............
        add v23.8H, v27.8H, v14.8H               // ...................................*................
        mul v20.8H, v30.8H, v0.H[2]              // ..................................*.................
        sub v5.8H, v27.8H, v14.8H                // .....................................*..............
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        sqrdmulh v30.8H, v5.8H, v1.H[5]          // .......................................*............
        // gap                                   // ....................................................
        mul v27.8H, v5.8H, v1.H[4]               // ......................................*.............
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        mls v20.8H, v31.8H, v7.H[0]              // ..........................................*.........
        // gap                                   // ....................................................
        mul v15.8H, v19.8H, v0.H[2]              // ........................................*...........
        sub v24.8H, v3.8H, v21.8H                // ..........................*.........................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        sqrdmulh v13.8H, v19.8H, v0.H[3]         // ...........................................*........
        sub v22.8H, v24.8H, v29.8H               // .........................................*..........
        mls v27.8H, v30.8H, v7.H[0]              // ............................................*.......
        add v5.8H, v10.8H, v16.8H                // ...............................*....................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        mul v8.8H, v23.8H, v1.H[2]               // ...............................................*....
        add v16.8H, v5.8H, v20.8H                // ..............................................*.....
        sqrdmulh v31.8H, v23.8H, v1.H[3]         // .............................................*......
        add v17.8H, v3.8H, v21.8H                // ..............................*.....................
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        sqrdmulh v25.8H, v16.8H, v0.H[7]         // ..................................................*.
        sub v19.8H, v22.8H, v27.8H               // ...................................................*
        mul v21.8H, v16.8H, v0.H[6]              // ................................................*...
        add v9.8H, v22.8H, v27.8H                // .................................................*..
        // gap                                   // ....................................................
        // gap                                   // ....................................................
        
        // original source code
        // ldr_vo v16, x0, 256                   // ..*................................................. || ..*...............
        // ldr_vo v4, x0, 448                    // *................................................... || *.................
        // ldr_vo v31, x0, 384                   // .*.................................................. || .*................
        // mul v23.8H, v16.8H, v0.H[0]           // ..........*......................................... || .....*............
        // sqrdmulh v29.8H, v16.8H, v0.H[1]      // ...............*.................................... || .......*..........
        // ldr_vo v26, x0, 320                   // .....*.............................................. || ...*..............
        // sqrdmulh v22.8H, v4.8H, v0.H[1]       // ....*............................................... || ...*..............
        // mul v20.8H, v4.8H, v0.H[0]            // ...*................................................ || ...*..............
        // ldr_vo v5, x0, 0                      // ..............*..................................... || ......*...........
        // sqrdmulh v12.8H, v31.8H, v0.H[1]      // .......*............................................ || ....*.............
        // mul v8.8H, v31.8H, v0.H[0]            // ......*............................................. || ....*.............
        // ldr_vo v27, x0, 192                   // ........*........................................... || ....*.............
        // mul v30.8H, v26.8H, v0.H[0]           // .................*.................................. || .......*..........
        // mls v20.8H, v22.8H, v7.H[0]           // .........*.......................................... || .....*............
        // ldr_vo v28, x0, 128                   // ...........*........................................ || .....*............
        // sqrdmulh v4.8H, v26.8H, v0.H[1]       // ............*....................................... || ......*...........
        // mls v8.8H, v12.8H, v7.H[0]            // .............*...................................... || ......*...........
        // ldr_vo v12, x0, 64                    // ...................*................................ || .......*..........
        // mls v23.8H, v29.8H, v7.H[0]           // ............................*....................... || ...........*......
        // sub v10.8H, v27.8H, v20.8H            // ..................*................................. || .......*..........
        // add v18.8H, v27.8H, v20.8H            // ................*................................... || .......*..........
        // sqrdmulh v25.8H, v10.8H, v0.H[5]      // ......................*............................. || ........*.........
        // add v21.8H, v28.8H, v8.8H             // .....................*.............................. || ........*.........
        // mul v22.8H, v10.8H, v0.H[4]           // ....................*............................... || ........*.........
        // sub v10.8H, v28.8H, v8.8H             // .......................*............................ || ........*.........
        // mul v29.8H, v10.8H, v0.H[4]           // ..........................*......................... || ..........*.......
        // sub v24.8H, v5.8H, v23.8H             // .......................................*............ || ..............*...
        // mls v30.8H, v4.8H, v7.H[0]            // ........................*........................... || .........*........
        // sqrdmulh v16.8H, v10.8H, v0.H[5]      // .........................*.......................... || .........*........
        // mls v22.8H, v25.8H, v7.H[0]           // ...........................*........................ || ..........*.......
        // add v17.8H, v5.8H, v23.8H             // ...............................................*.... || ................*.
        // add v5.8H, v12.8H, v30.8H             // ...........................................*........ || ...............*..
        // sub v11.8H, v12.8H, v30.8H            // .............................*...................... || ...........*......
        // sqrdmulh v4.8H, v18.8H, v0.H[3]       // ..............................*..................... || ...........*......
        // mul v20.8H, v18.8H, v0.H[2]           // .................................*.................. || ............*.....
        // add v30.8H, v11.8H, v22.8H            // ................................*................... || ............*.....
        // mls v29.8H, v16.8H, v7.H[0]           // ...............................*.................... || ............*.....
        // sub v25.8H, v11.8H, v22.8H            // ..................................*................. || ............*.....
        // mul v16.8H, v25.8H, v1.H[4]           // ....................................*............... || .............*....
        // sqrdmulh v9.8H, v25.8H, v1.H[5]       // ...................................*................ || .............*....
        // mul v15.8H, v21.8H, v0.H[2]           // ......................................*............. || ..............*...
        // sub v10.8H, v24.8H, v29.8H            // .........................................*.......... || ...............*..
        // mls v20.8H, v4.8H, v7.H[0]            // .....................................*.............. || ..............*...
        // sqrdmulh v13.8H, v21.8H, v0.H[3]      // ........................................*........... || ...............*..
        // mls v16.8H, v9.8H, v7.H[0]            // ..........................................*......... || ...............*..
        // sqrdmulh v31.8H, v30.8H, v1.H[3]      // ..............................................*..... || ................*.
        // add v19.8H, v5.8H, v20.8H             // .............................................*...... || ................*.
        // mul v8.8H, v30.8H, v1.H[2]            // ............................................*....... || ................*.
        // mul v21.8H, v19.8H, v0.H[6]           // ..................................................*. || .................*
        // add v9.8H, v10.8H, v16.8H             // ...................................................* || .................*
        // sqrdmulh v25.8H, v19.8H, v0.H[7]      // ................................................*... || .................*
        // sub v19.8H, v10.8H, v16.8H            // .................................................*.. || .................*
        
        sub count, count, #1
.p2align 2
layer123_start:
        str_vo v9, x0, 384                       // ..........................................................................*.
        str_vo v19, x0, 448                      // ...........................................................................*
        mls v15.8H, v13.8H, v7.H[0]              // ..............................*.............................................
        sub v20.8H, v5.8H, v20.8H                // ....................................*.......................................
        // gap                                   // ............................................................................
        ldr_vo v16, x0, 272                      // ....e.......................................................................
        mul v9.8H, v20.8H, v1.H[0]               // .....................................................*......................
        add v10.8H, v24.8H, v29.8H               // ..........................................*.................................
        sqrdmulh v11.8H, v20.8H, v1.H[1]         // ......................................................*.....................
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        ldr_vo v4, x0, 464                       // .......e....................................................................
        mls v8.8H, v31.8H, v7.H[0]               // ............................................................*...............
        sub v13.8H, v17.8H, v15.8H               // ...............................*............................................
        mls v21.8H, v25.8H, v7.H[0]              // ..................................................*.........................
        add v24.8H, v17.8H, v15.8H               // ................................*...........................................
        // gap                                   // ............................................................................
        ldr_vo v31, x0, 400                      // ......e.....................................................................
        mul v23.8H, v16.8H, v0.H[0]              // ........e...................................................................
        // gap                                   // ............................................................................
        sqrdmulh v29.8H, v16.8H, v0.H[1]         // .........e..................................................................
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        ldr_vo v26, x0, 336                      // .....e......................................................................
        sqrdmulh v22.8H, v4.8H, v0.H[1]          // ........................e...................................................
        sub v19.8H, v10.8H, v8.8H                // .............................................................*..............
        mul v20.8H, v4.8H, v0.H[0]               // .......................e....................................................
        add v16.8H, v10.8H, v8.8H                // ..............................................................*.............
        // gap                                   // ............................................................................
        ldr_vo v5, x0, 16                        // e...........................................................................
        sqrdmulh v12.8H, v31.8H, v0.H[1]         // ...................e........................................................
        str_vo v19, x0, 320                      // .........................................................................*..
        mul v8.8H, v31.8H, v0.H[0]               // ..................e.........................................................
        sub v19.8H, v24.8H, v21.8H               // ...................................................*........................
        // gap                                   // ............................................................................
        ldr_vo v27, x0, 208                      // ...e........................................................................
        mul v30.8H, v26.8H, v0.H[0]              // .............e..............................................................
        str_vo v16, x0, 256                      // ........................................................................*...
        mls v20.8H, v22.8H, v7.H[0]              // .........................e..................................................
        add v16.8H, v24.8H, v21.8H               // ....................................................*.......................
        // gap                                   // ............................................................................
        ldr_vo v28, x0, 144                      // ..e.........................................................................
        sqrdmulh v4.8H, v26.8H, v0.H[1]          // ..............e.............................................................
        str_vi v16, x0, 16                       // ....................................................................*.......
        mls v8.8H, v12.8H, v7.H[0]               // ....................e.......................................................
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        ldr_vo v12, x0, 64                       // .e..........................................................................
        mls v23.8H, v29.8H, v7.H[0]              // ..........e.................................................................
        sub v10.8H, v27.8H, v20.8H               // ..........................e.................................................
        mls v9.8H, v11.8H, v7.H[0]               // .......................................................*....................
        add v18.8H, v27.8H, v20.8H               // ...........................e................................................
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        sqrdmulh v25.8H, v10.8H, v0.H[5]         // ............................................e...............................
        add v21.8H, v28.8H, v8.8H                // ......................e.....................................................
        mul v22.8H, v10.8H, v0.H[4]              // ...........................................e................................
        sub v10.8H, v28.8H, v8.8H                // .....................e......................................................
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        mul v29.8H, v10.8H, v0.H[4]              // ......................................e.....................................
        sub v24.8H, v5.8H, v23.8H                // ...........e................................................................
        mls v30.8H, v4.8H, v7.H[0]               // ...............e............................................................
        sub v31.8H, v13.8H, v9.8H                // ........................................................*...................
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        sqrdmulh v16.8H, v10.8H, v0.H[5]         // .......................................e....................................
        str_vo v31, x0, 176                      // .......................................................................*....
        mls v22.8H, v25.8H, v7.H[0]              // .............................................e..............................
        add v17.8H, v5.8H, v23.8H                // ............e...............................................................
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        add v5.8H, v12.8H, v30.8H                // .................e..........................................................
        sub v11.8H, v12.8H, v30.8H               // ................e...........................................................
        sqrdmulh v4.8H, v18.8H, v0.H[3]          // ..................................e.........................................
        add v31.8H, v13.8H, v9.8H                // .........................................................*..................
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        mul v20.8H, v18.8H, v0.H[2]              // .................................e..........................................
        add v30.8H, v11.8H, v22.8H               // ...............................................e............................
        mls v29.8H, v16.8H, v7.H[0]              // ........................................e...................................
        sub v25.8H, v11.8H, v22.8H               // ..............................................e.............................
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        mul v16.8H, v25.8H, v1.H[4]              // ...............................................................e............
        str_vo v31, x0, 112                      // ......................................................................*.....
        sqrdmulh v9.8H, v25.8H, v1.H[5]          // ................................................................e...........
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        mul v15.8H, v21.8H, v0.H[2]              // ............................e...............................................
        sub v10.8H, v24.8H, v29.8H               // .........................................e..................................
        mls v20.8H, v4.8H, v7.H[0]               // ...................................e........................................
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        sqrdmulh v13.8H, v21.8H, v0.H[3]         // .............................e..............................................
        str_vo v19, x0, 48                       // .....................................................................*......
        mls v16.8H, v9.8H, v7.H[0]               // .................................................................e..........
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        sqrdmulh v31.8H, v30.8H, v1.H[3]         // ...........................................................e................
        add v19.8H, v5.8H, v20.8H                // .....................................e......................................
        mul v8.8H, v30.8H, v1.H[2]               // ..........................................................e.................
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        mul v21.8H, v19.8H, v0.H[6]              // ................................................e...........................
        add v9.8H, v10.8H, v16.8H                // ...................................................................e........
        sqrdmulh v25.8H, v19.8H, v0.H[7]         // .................................................e..........................
        sub v19.8H, v10.8H, v16.8H               // ..................................................................e.........
        // gap                                   // ............................................................................
        // gap                                   // ............................................................................
        
        // original source code
        // ldr_vo v8, x0, 0                      // .................e.......................................................................................................................... || ....e...............................
        // ldr_vo v9, x0, 64                     // ...............................e............................................................................................................ || .......e............................
        // ldr_vo v10, x0, 128                   // ...........................e................................................................................................................ || ......e.............................
        // ldr_vo v11, x0, 192                   // ......................e..................................................................................................................... || .....e..............................
        // ldr_vo v12, x0, 256                   // e........................................................................................................................................... || e...................................
        // ldr_vo v13, x0, 320                   // ............e............................................................................................................................... || ...e................................
        // ldr_vo v14, x0, 384                   // .........e.................................................................................................................................. || ..e.................................
        // ldr_vo v15, x0, 448                   // ....e....................................................................................................................................... || .e..................................
        // mul v24.8H, v12.8H, v0.H[0]           // ..........e................................................................................................................................. || ...e................................
        // sqrdmulh v12.8H, v12.8H, v0.H[1]      // ...........e................................................................................................................................ || ...e................................
        // mls v24.8H, v12.8H, v7.H[0]           // ................................e........................................................................................................... || ........e...........................
        // sub v12.8H, v8.8H, v24.8H             // .........................................e.................................................................................................. || ..........e.........................
        // add v8.8H, v8.8H, v24.8H              // ...............................................e............................................................................................ || ...........e........................
        // mul v24.8H, v13.8H, v0.H[0]           // .......................e.................................................................................................................... || ......e.............................
        // sqrdmulh v13.8H, v13.8H, v0.H[1]      // ............................e............................................................................................................... || .......e............................
        // mls v24.8H, v13.8H, v7.H[0]           // ..........................................e................................................................................................. || ..........e.........................
        // sub v13.8H, v9.8H, v24.8H             // .................................................e.......................................................................................... || ............e.......................
        // add v9.8H, v9.8H, v24.8H              // ................................................e........................................................................................... || ............e.......................
        // mul v24.8H, v14.8H, v0.H[0]           // ....................e....................................................................................................................... || .....e..............................
        // sqrdmulh v14.8H, v14.8H, v0.H[1]      // ..................e......................................................................................................................... || .....e..............................
        // mls v24.8H, v14.8H, v7.H[0]           // ..............................e............................................................................................................. || .......e............................
        // sub v14.8H, v10.8H, v24.8H            // .......................................e.................................................................................................... || .........e..........................
        // add v10.8H, v10.8H, v24.8H            // .....................................e...................................................................................................... || .........e..........................
        // mul v24.8H, v15.8H, v0.H[0]           // ...............e............................................................................................................................ || ....e...............................
        // sqrdmulh v15.8H, v15.8H, v0.H[1]      // .............e.............................................................................................................................. || ....e...............................
        // mls v24.8H, v15.8H, v7.H[0]           // .........................e.................................................................................................................. || ......e.............................
        // sub v15.8H, v11.8H, v24.8H            // .................................e.......................................................................................................... || ........e...........................
        // add v11.8H, v11.8H, v24.8H            // ...................................e........................................................................................................ || ........e...........................
        // mul v24.8H, v10.8H, v0.H[2]           // ...........................................................e................................................................................ || ...............e....................
        // sqrdmulh v10.8H, v10.8H, v0.H[3]      // ..............................................................e............................................................................. || ................e...................
        // mls v24.8H, v10.8H, v7.H[0]           // ..........................................................................*................................................................. || ...................*................
        // sub v10.8H, v8.8H, v24.8H             // ..................................................................................*......................................................... || .....................*..............
        // add v8.8H, v8.8H, v24.8H              // ....................................................................................*....................................................... || .....................*..............
        // mul v24.8H, v11.8H, v0.H[2]           // ....................................................e....................................................................................... || .............e......................
        // sqrdmulh v11.8H, v11.8H, v0.H[3]      // ..................................................e......................................................................................... || ............e.......................
        // mls v24.8H, v11.8H, v7.H[0]           // .............................................................e.............................................................................. || ...............e....................
        // sub v11.8H, v9.8H, v24.8H             // ...........................................................................*................................................................ || ...................*................
        // add v9.8H, v9.8H, v24.8H              // ..................................................................e......................................................................... || .................e..................
        // mul v24.8H, v14.8H, v0.H[4]           // ........................................e................................................................................................... || ..........e.........................
        // sqrdmulh v14.8H, v14.8H, v0.H[5]      // ............................................e............................................................................................... || ...........e........................
        // mls v24.8H, v14.8H, v7.H[0]           // ......................................................e..................................................................................... || .............e......................
        // sub v14.8H, v12.8H, v24.8H            // ............................................................e............................................................................... || ...............e....................
        // add v12.8H, v12.8H, v24.8H            // ..............................................................................*............................................................. || ....................*...............
        // mul v24.8H, v15.8H, v0.H[4]           // ......................................e..................................................................................................... || .........e..........................
        // sqrdmulh v15.8H, v15.8H, v0.H[5]      // ....................................e....................................................................................................... || .........e..........................
        // mls v24.8H, v15.8H, v7.H[0]           // ..............................................e............................................................................................. || ...........e........................
        // sub v15.8H, v13.8H, v24.8H            // .......................................................e.................................................................................... || .............e......................
        // add v13.8H, v13.8H, v24.8H            // .....................................................e...................................................................................... || .............e......................
        // mul v24.8H, v9.8H, v0.H[6]            // ....................................................................e....................................................................... || ..................e.................
        // sqrdmulh v9.8H, v9.8H, v0.H[7]        // ......................................................................e..................................................................... || ..................e.................
        // mls v24.8H, v9.8H, v7.H[0]            // ...................................................................................*........................................................ || .....................*..............
        // sub v9.8H, v8.8H, v24.8H              // .................................................................................................*.......................................... || ........................*...........
        // add v8.8H, v8.8H, v24.8H              // ......................................................................................................*..................................... || .........................*..........
        // mul v24.8H, v11.8H, v1.H[0]           // .............................................................................*.............................................................. || ....................*...............
        // sqrdmulh v11.8H, v11.8H, v1.H[1]      // ...............................................................................*............................................................ || ....................*...............
        // mls v24.8H, v11.8H, v7.H[0]           // ..............................................................................................................*............................. || ...........................*........
        // sub v11.8H, v10.8H, v24.8H            // .......................................................................................................................*.................... || .............................*......
        // add v10.8H, v10.8H, v24.8H            // ...............................................................................................................................*............ || ...............................*....
        // mul v24.8H, v13.8H, v1.H[2]           // ...................................................................e........................................................................ || .................e..................
        // sqrdmulh v13.8H, v13.8H, v1.H[3]      // .................................................................e.......................................................................... || .................e..................
        // mls v24.8H, v13.8H, v7.H[0]           // .................................................................................*.......................................................... || .....................*..............
        // sub v13.8H, v12.8H, v24.8H            // ..........................................................................................*................................................. || .......................*............
        // add v12.8H, v12.8H, v24.8H            // ............................................................................................*............................................... || .......................*............
        // mul v24.8H, v15.8H, v1.H[4]           // ........................................................e................................................................................... || ..............e.....................
        // sqrdmulh v15.8H, v15.8H, v1.H[5]      // ..........................................................e................................................................................. || ..............e.....................
        // mls v24.8H, v15.8H, v7.H[0]           // ................................................................e........................................................................... || ................e...................
        // sub v15.8H, v14.8H, v24.8H            // .......................................................................e.................................................................... || ..................e.................
        // add v14.8H, v14.8H, v24.8H            // .....................................................................e...................................................................... || ..................e.................
        // str_vi v8, x0, 16                     // .........................................................................................................*.................................. || ..........................*.........
        // str_vo v9, x0, 48                     // ...........................................................................................................................................* || ...................................*
        // str_vo v10, x0, 112                   // .....................................................................................................................................*...... || .................................*..
        // str_vo v11, x0, 176                   // .........................................................................................................................*.................. || ..............................*.....
        // str_vo v12, x0, 240                   // ....................................................................................................*....................................... || .........................*..........
        // str_vo v13, x0, 304                   // ...............................................................................................*............................................ || ........................*...........
        // str_vo v14, x0, 368                   // ........................................................................*................................................................... || ...................*................
        // str_vo v15, x0, 432                   // .........................................................................*.................................................................. || ...................*................
        
        subs count, count, #1
        cbnz count, layer123_start
        mls v15.8H, v13.8H, v7.H[0]              // ..*.....................
        add v10.8H, v24.8H, v29.8H               // .....*..................
        mls v8.8H, v31.8H, v7.H[0]               // .......*................
        sub v16.8H, v5.8H, v20.8H                // ...*....................
        // gap                                   // ........................
        // gap                                   // ........................
        sqrdmulh v24.8H, v16.8H, v1.H[1]         // ......*.................
        str_vo v9, x0, 384                       // *.......................
        mul v9.8H, v16.8H, v1.H[0]               // ....*...................
        // gap                                   // ........................
        // gap                                   // ........................
        // gap                                   // ........................
        sub v16.8H, v10.8H, v8.8H                // ...........*............
        str_vo v19, x0, 448                      // .*......................
        mls v21.8H, v25.8H, v7.H[0]              // .........*..............
        add v31.8H, v17.8H, v15.8H               // ..........*.............
        // gap                                   // ........................
        // gap                                   // ........................
        add v19.8H, v10.8H, v8.8H                // ............*...........
        str_vo v16, x0, 320                      // .............*..........
        mls v9.8H, v24.8H, v7.H[0]               // ..................*.....
        sub v24.8H, v17.8H, v15.8H               // ........*...............
        // gap                                   // ........................
        // gap                                   // ........................
        sub v16.8H, v31.8H, v21.8H               // ..............*.........
        str_vo v19, x0, 256                      // ...............*........
        add v19.8H, v31.8H, v21.8H               // ................*.......
        // gap                                   // ........................
        // gap                                   // ........................
        // gap                                   // ........................
        str_vi v19, x0, 16                       // .................*......
        str_vo v16, x0, 48                       // .......................*
        add v19.8H, v24.8H, v9.8H                // .....................*..
        sub v16.8H, v24.8H, v9.8H                // ...................*....
        // gap                                   // ........................
        // gap                                   // ........................
        str_vo v19, x0, 112                      // ......................*.
        str_vo v16, x0, 176                      // ....................*...
        // gap                                   // ........................
        // gap                                   // ........................
        // gap                                   // ........................
        // gap                                   // ........................
        
        // original source code
        // str_vo v9, x0, 384                    // .....*.................. || .*.....
        // str_vo v19, x0, 448                   // ........*............... || ..*....
        // mls v15.8H, v13.8H, v7.H[0]           // *....................... || *......
        // sub v20.8H, v5.8H, v20.8H             // ...*.................... || *......
        // mul v9.8H, v20.8H, v1.H[0]            // ......*................. || .*.....
        // add v10.8H, v24.8H, v29.8H            // .*...................... || *......
        // sqrdmulh v11.8H, v20.8H, v1.H[1]      // ....*................... || .*.....
        // mls v8.8H, v31.8H, v7.H[0]            // ..*..................... || *......
        // sub v13.8H, v17.8H, v15.8H            // ..............*......... || ...*...
        // mls v21.8H, v25.8H, v7.H[0]           // .........*.............. || ..*....
        // add v24.8H, v17.8H, v15.8H            // ..........*............. || ..*....
        // sub v19.8H, v10.8H, v8.8H             // .......*................ || ..*....
        // add v16.8H, v10.8H, v8.8H             // ...........*............ || ...*...
        // str_vo v19, x0, 320                   // ............*........... || ...*...
        // sub v19.8H, v24.8H, v21.8H            // ...............*........ || ....*..
        // str_vo v16, x0, 256                   // ................*....... || ....*..
        // add v16.8H, v24.8H, v21.8H            // .................*...... || ....*..
        // str_vi v16, x0, 16                    // ..................*..... || .....*.
        // mls v9.8H, v11.8H, v7.H[0]            // .............*.......... || ...*...
        // sub v31.8H, v13.8H, v9.8H             // .....................*.. || .....*.
        // str_vo v31, x0, 176                   // .......................* || ......*
        // add v31.8H, v13.8H, v9.8H             // ....................*... || .....*.
        // str_vo v31, x0, 112                   // ......................*. || ......*
        // str_vo v19, x0, 48                    // ...................*.... || .....*.
        

        restore inp, STACK0
        mov count, #8

        .p2align 2
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        ldr_vo v0, x1, 48                         // .*..................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        ldr_vi v10, x3, 16                        // *...................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        ldr_vo v31, x1, 32                        // ..*.................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        ldr_vo v17, x4, 48                        // ......*.............................
        mul v30.8H, v0.8H, v10.H[0]               // ....*...............................
        // gap                                    // ....................................
        sqrdmulh v19.8H, v0.8H, v10.H[1]          // .....*..............................
        // gap                                    // ....................................
        // gap                                    // ....................................
        ldr_vo v0, x1, 16                         // ...*................................
        mul v16.8H, v31.8H, v10.H[0]              // ..........*.........................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        ldr_vo v21, x4, 64                        // .............*......................
        mls v30.8H, v19.8H, v7.H[0]               // .......*............................
        // gap                                    // ....................................
        sqrdmulh v19.8H, v31.8H, v10.H[1]         // ............*.......................
        // gap                                    // ....................................
        // gap                                    // ....................................
        ldr_vo v31, x1, 0                         // ........*...........................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        ldr_vi v4, x4, 96                         // ...................*................
        mls v16.8H, v19.8H, v7.H[0]               // ................*...................
        sub v19.8H, v0.8H, v30.8H                 // ...........*........................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        ldr_vo v6, x4, -80                        // .....................*..............
        sqrdmulh v28.8H, v19.8H, v10.H[5]         // ..............*.....................
        // gap                                    // ....................................
        mul v25.8H, v19.8H, v10.H[4]              // ....................*...............
        add v19.8H, v0.8H, v30.8H                 // ...............*....................
        // gap                                    // ....................................
        ldr_vo v2, x4, -64                        // ................................*...
        mul v14.8H, v19.8H, v10.H[2]              // .................*..................
        // gap                                    // ....................................
        sqrdmulh v19.8H, v19.8H, v10.H[3]         // ..................*.................
        sub v24.8H, v31.8H, v16.8H                // ........................*...........
        // gap                                    // ....................................
        ldr_vo v10, x4, -16                       // .........*..........................
        mls v25.8H, v28.8H, v7.H[0]               // .........................*..........
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        mls v14.8H, v19.8H, v7.H[0]               // ......................*.............
        // gap                                    // ....................................
        // gap                                    // ....................................
        add v19.8H, v31.8H, v16.8H                // .......................*............
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        add v0.8H, v24.8H, v25.8H                 // ............................*.......
        // gap                                    // ....................................
        // gap                                    // ....................................
        add v31.8H, v19.8H, v14.8H                // ..........................*.........
        sub v16.8H, v19.8H, v14.8H                // ...........................*........
        // gap                                    // ....................................
        sub v19.8H, v24.8H, v25.8H                // .............................*......
        // gap                                    // ....................................
        // gap                                    // ....................................
        trn2 v12.4S, v31.4S, v16.4S               // ..............................*.....
        trn1 v3.4S, v31.4S, v16.4S                // ..................................*.
        trn2 v16.4S, v0.4S, v19.4S                // ...............................*....
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        trn1 v8.4S, v0.4S, v19.4S                 // ...................................*
        trn2 v5.2D, v12.2D, v16.2D                // .................................*..
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        // gap                                    // ....................................
        
        // original source code
        // ldr_vi v9, x3, 16                     // .*.................................. || .*...............
        // ldr_vo v6, x1, 48                     // *................................... || *................
        // ldr_vo v25, x1, 32                    // ..*................................. || ..*..............
        // ldr_vo v4, x1, 16                     // ......*............................. || ....*............
        // mul v28.8H, v6.8H, v9.H[0]            // ....*............................... || ....*............
        // sqrdmulh v12.8H, v6.8H, v9.H[1]       // .....*.............................. || ....*............
        // ldr_vo v17, x4, 48                    // ...*................................ || ...*.............
        // mls v28.8H, v12.8H, v7.H[0]           // .........*.......................... || ......*..........
        // ldr_vo v2, x1, 0                      // ...........*........................ || ......*..........
        // ldr_vo v10, x4, 80                    // .......................*............ || ..........*......
        // mul v30.8H, v25.8H, v9.H[0]           // .......*............................ || .....*...........
        // sub v12.8H, v4.8H, v28.8H             // ..............*..................... || ........*........
        // sqrdmulh v13.8H, v25.8H, v9.H[1]      // ..........*......................... || ......*..........
        // ldr_vo v21, x4, 64                    // ........*........................... || .....*...........
        // sqrdmulh v8.8H, v12.8H, v9.H[5]       // ................*................... || .........*.......
        // add v4.8H, v4.8H, v28.8H              // ..................*................. || .........*.......
        // mls v30.8H, v13.8H, v7.H[0]           // .............*...................... || ........*........
        // mul v22.8H, v4.8H, v9.H[2]            // ....................*............... || ..........*......
        // sqrdmulh v15.8H, v4.8H, v9.H[3]       // .....................*.............. || ..........*......
        // ldr_vi v4, x4, 96                     // ............*....................... || .......*.........
        // mul v31.8H, v12.8H, v9.H[4]           // .................*.................. || .........*.......
        // ldr_vo v6, x4, -80                    // ...............*.................... || ........*........
        // mls v22.8H, v15.8H, v7.H[0]           // .........................*.......... || ............*....
        // add v28.8H, v2.8H, v30.8H             // ..........................*......... || ............*....
        // sub v18.8H, v2.8H, v30.8H             // ......................*............. || ..........*......
        // mls v31.8H, v8.8H, v7.H[0]            // ........................*........... || ...........*.....
        // add v0.8H, v28.8H, v22.8H             // ............................*....... || ..............*..
        // sub v29.8H, v28.8H, v22.8H            // .............................*...... || ..............*..
        // add v14.8H, v18.8H, v31.8H            // ...........................*........ || .............*...
        // sub v19.8H, v18.8H, v31.8H            // ..............................*..... || ..............*..
        // trn2 v12.4S, v0.4S, v29.4S            // ...............................*.... || ...............*.
        // trn2 v16.4S, v14.4S, v19.4S           // .................................*.. || ...............*.
        // ldr_vo v2, x4, -64                    // ...................*................ || .........*.......
        // trn2 v5.2D, v12.2D, v16.2D            // ...................................* || ................*
        // trn1 v3.4S, v0.4S, v29.4S             // ................................*... || ...............*.
        // trn1 v8.4S, v14.4S, v19.4S            // ..................................*. || ................*
        
        sub count, count, #1
.p2align 2
layer4567_start:
        mul v19.8H, v5.8H, v4.8H                             // ............................................*...........................
        // gap                                               // ........................................................................
        sqrdmulh v30.8H, v5.8H, v6.8H                        // .............................................*..........................
        // gap                                               // ........................................................................
        trn2 v29.2D, v3.2D, v8.2D                            // .............................*..........................................
        ldr_vi v9, x3, 16                                    // ....e...................................................................
        mul v5.8H, v29.8H, v4.8H                             // .......................................*................................
        // gap                                               // ........................................................................
        sqrdmulh v23.8H, v29.8H, v6.8H                       // ........................................*...............................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        ldr_vo v6, x1, 112                                   // ...e....................................................................
        trn1 v0.2D, v12.2D, v16.2D                           // ................................*.......................................
        // gap                                               // ........................................................................
        mls v19.8H, v30.8H, v7.H[0]                          // ..............................................*.........................
        trn1 v3.2D, v3.2D, v8.2D                             // ...............................*........................................
        // gap                                               // ........................................................................
        ldr_vo v25, x1, 96                                   // ..e.....................................................................
        mls v5.8H, v23.8H, v7.H[0]                           // .........................................*..............................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        ldr_vo v4, x1, 80                                    // .e......................................................................
        mul v28.8H, v6.8H, v9.H[0]                           // ..........e.............................................................
        add v1.8H, v0.8H, v19.8H                             // ................................................*.......................
        sqrdmulh v12.8H, v6.8H, v9.H[1]                      // ...........e............................................................
        sub v22.8H, v0.8H, v19.8H                            // ...............................................*........................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        mul v20.8H, v1.8H, v2.8H                             // .................................................*......................
        // gap                                               // ........................................................................
        sqrdmulh v8.8H, v1.8H, v17.8H                        // ..................................................*.....................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        ldr_vo v17, x4, 48                                   // ....................................e...................................
        mul v31.8H, v22.8H, v21.8H                           // ......................................................*.................
        // gap                                               // ........................................................................
        mls v28.8H, v12.8H, v7.H[0]                          // ............e...........................................................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        ldr_vo v2, x1, 64                                    // e.......................................................................
        mls v20.8H, v8.8H, v7.H[0]                           // ...................................................*....................
        // gap                                               // ........................................................................
        sqrdmulh v19.8H, v22.8H, v10.8H                      // .......................................................*................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        ldr_vo v10, x4, 80                                   // ......................................e.................................
        mul v30.8H, v25.8H, v9.H[0]                          // .....e..................................................................
        sub v12.8H, v4.8H, v28.8H                            // .............e..........................................................
        sqrdmulh v13.8H, v25.8H, v9.H[1]                     // ......e.................................................................
        add v11.8H, v3.8H, v5.8H                             // ...........................................*............................
        // gap                                               // ........................................................................
        ldr_vo v21, x4, 64                                   // .....................................e..................................
        sqrdmulh v8.8H, v12.8H, v9.H[5]                      // .....................e..................................................
        sub v24.8H, v11.8H, v20.8H                           // ....................................................*...................
        mls v31.8H, v19.8H, v7.H[0]                          // ........................................................*...............
        add v23.8H, v11.8H, v20.8H                           // .....................................................*..................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        sqdmulh v0.8H, v24.8H, v7.H[1]                       // ..............................................................*.........
        sub v6.8H, v3.8H, v5.8H                              // ..........................................*.............................
        sqdmulh v16.8H, v23.8H, v7.H[1]                      // ...........................................................*............
        add v4.8H, v4.8H, v28.8H                             // ..............e.........................................................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        mls v30.8H, v13.8H, v7.H[0]                          // .......e................................................................
        add v25.8H, v6.8H, v31.8H                            // ..........................................................*.............
        mul v22.8H, v4.8H, v9.H[2]                           // ...............e........................................................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        sqdmulh v19.8H, v25.8H, v7.H[1]                      // .................................................................*......
        // gap                                               // ........................................................................
        sqrdmulh v15.8H, v4.8H, v9.H[3]                      // ................e.......................................................
        sub v26.8H, v6.8H, v31.8H                            // .........................................................*..............
        srshr v0.8H, v0.8H, #11                              // ...............................................................*........
        ldr_vi v4, x4, 96                                    // .................................e......................................
        mul v31.8H, v12.8H, v9.H[4]                          // ....................e...................................................
        // gap                                               // ........................................................................
        sqdmulh v5.8H, v26.8H, v7.H[1]                       // ....................................................................*...
        srshr v16.8H, v16.8H, #11                            // ............................................................*...........
        // gap                                               // ........................................................................
        ldr_vo v6, x4, -80                                   // ..................................e.....................................
        mls v24.8H, v0.8H, v7.H[0]                           // ................................................................*.......
        srshr v19.8H, v19.8H, #11                            // ..................................................................*.....
        mls v22.8H, v15.8H, v7.H[0]                          // .................e......................................................
        add v28.8H, v2.8H, v30.8H                            // .........e..............................................................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        mls v23.8H, v16.8H, v7.H[0]                          // .............................................................*..........
        sub v18.8H, v2.8H, v30.8H                            // ........e...............................................................
        mls v31.8H, v8.8H, v7.H[0]                           // ......................e.................................................
        // gap                                               // ........................................................................
        srshr v9.8H, v5.8H, #11                              // .....................................................................*..
        // gap                                               // ........................................................................
        mls v25.8H, v19.8H, v7.H[0]                          // ...................................................................*....
        // gap                                               // ........................................................................
        add v0.8H, v28.8H, v22.8H                            // ...................e....................................................
        sub v29.8H, v28.8H, v22.8H                           // ..................e.....................................................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        add v14.8H, v18.8H, v31.8H                           // ........................e...............................................
        sub v19.8H, v18.8H, v31.8H                           // .......................e................................................
        mls v26.8H, v9.8H, v7.H[0]                           // ......................................................................*.
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        trn2 v12.4S, v0.4S, v29.4S                           // ..........................e.............................................
        trn2 v16.4S, v14.4S, v19.4S                          // ............................e...........................................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        ldr_vo v2, x4, -64                                   // ...................................e....................................
        trn2 v5.2D, v12.2D, v16.2D                           // ..............................e.........................................
        st4 {v23.4S,v24.4S,v25.4S,v26.4S}, [x1], #64         // .......................................................................*
        trn1 v3.4S, v0.4S, v29.4S                            // .........................e..............................................
        // gap                                               // ........................................................................
        // gap                                               // ........................................................................
        trn1 v8.4S, v14.4S, v19.4S                           // ...........................e............................................
        
        // original source code
        // ldr_vo v8, x1, 0                                // ...................e....................................................................................................................... || ......e.................................
        // ldr_vo v9, x1, 16                               // .........e................................................................................................................................. || ...e....................................
        // ldr_vo v10, x1, 32                              // .......e................................................................................................................................... || ..e.....................................
        // ldr_vo v11, x1, 48                              // ...e....................................................................................................................................... || .e......................................
        // ldr_vi v0, x3, 16                               // e.......................................................................................................................................... || e.......................................
        // mul v24.8H, v10.8H, v0.H[0]                     // .......................e................................................................................................................... || ........e...............................
        // sqrdmulh v10.8H, v10.8H, v0.H[1]                // .........................e................................................................................................................. || ........e...............................
        // mls v24.8H, v10.8H, v7.H[0]                     // ....................................e...................................................................................................... || ...........e............................
        // sub v10.8H, v8.8H, v24.8H                       // .....................................................e..................................................................................... || ...............e........................
        // add v8.8H, v8.8H, v24.8H                        // ...................................................e....................................................................................... || ..............e.........................
        // mul v24.8H, v11.8H, v0.H[0]                     // ..........e................................................................................................................................ || ....e...................................
        // sqrdmulh v11.8H, v11.8H, v0.H[1]                // ............e.............................................................................................................................. || ....e...................................
        // mls v24.8H, v11.8H, v7.H[0]                     // ..................e........................................................................................................................ || ......e.................................
        // sub v11.8H, v9.8H, v24.8H                       // ........................e.................................................................................................................. || ........e...............................
        // add v9.8H, v9.8H, v24.8H                        // ...................................e....................................................................................................... || ..........e.............................
        // mul v24.8H, v9.8H, v0.H[2]                      // ......................................e.................................................................................................... || ...........e............................
        // sqrdmulh v9.8H, v9.8H, v0.H[3]                  // ........................................e.................................................................................................. || ............e...........................
        // mls v24.8H, v9.8H, v7.H[0]                      // ..................................................e........................................................................................ || ..............e.........................
        // sub v9.8H, v8.8H, v24.8H                        // ..........................................................e................................................................................ || ................e.......................
        // add v8.8H, v8.8H, v24.8H                        // .........................................................e................................................................................. || ................e.......................
        // mul v24.8H, v11.8H, v0.H[4]                     // ............................................e.............................................................................................. || .............e..........................
        // sqrdmulh v11.8H, v11.8H, v0.H[5]                // ............................e.............................................................................................................. || .........e..............................
        // mls v24.8H, v11.8H, v7.H[0]                     // ......................................................e.................................................................................... || ...............e........................
        // sub v11.8H, v10.8H, v24.8H                      // ............................................................e.............................................................................. || .................e......................
        // add v10.8H, v10.8H, v24.8H                      // ...........................................................e............................................................................... || .................e......................
        // trn1 v25.4S, v8.4S, v9.4S                       // ...................................................................e....................................................................... || ...................e....................
        // trn2 v26.4S, v8.4S, v9.4S                       // ..............................................................e............................................................................ || .................e......................
        // trn1 v27.4S, v10.4S, v11.4S                     // ....................................................................e...................................................................... || ...................e....................
        // trn2 v28.4S, v10.4S, v11.4S                     // ...............................................................e........................................................................... || ..................e.....................
        // trn2 v10.2D, v25.2D, v27.2D                     // .......................................................................*................................................................... || ....................*...................
        // trn2 v11.2D, v26.2D, v28.2D                     // .................................................................e......................................................................... || ...................e....................
        // trn1 v8.2D, v25.2D, v27.2D                      // ..............................................................................*............................................................ || ......................*.................
        // trn1 v9.2D, v26.2D, v28.2D                      // ............................................................................*.............................................................. || ......................*.................
        // ldr_vi v0, x4, 96                               // ...........................................e............................................................................................... || ............e...........................
        // ldr_vo v4, x4, -80                              // ...............................................e........................................................................................... || .............e..........................
        // ldr_vo v1, x4, -64                              // ................................................................e.......................................................................... || ..................e.....................
        // ldr_vo v5, x4, -48                              // ................e.......................................................................................................................... || .....e..................................
        // ldr_vo v2, x4, -32                              // ...........................e............................................................................................................... || ........e...............................
        // ldr_vo v6, x4, -16                              // ......................e.................................................................................................................... || .......e................................
        // mul v24.8H, v10.8H, v0.8H                       // .........................................................................*................................................................. || .....................*..................
        // sqrdmulh v10.8H, v10.8H, v4.8H                  // ..........................................................................*................................................................ || .....................*..................
        // mls v24.8H, v10.8H, v7.H[0]                     // ................................................................................*.......................................................... || .......................*................
        // sub v10.8H, v8.8H, v24.8H                       // .........................................................................................................*................................. || ..............................*.........
        // add v8.8H, v8.8H, v24.8H                        // ..................................................................................................*........................................ || ............................*...........
        // mul v24.8H, v11.8H, v0.8H                       // .....................................................................*..................................................................... || ....................*...................
        // sqrdmulh v11.8H, v11.8H, v4.8H                  // ......................................................................*.................................................................... || ....................*...................
        // mls v24.8H, v11.8H, v7.H[0]                     // .............................................................................*............................................................. || ......................*.................
        // sub v11.8H, v9.8H, v24.8H                       // .....................................................................................*..................................................... || ........................*...............
        // add v9.8H, v9.8H, v24.8H                        // ...................................................................................*....................................................... || ........................*...............
        // mul v24.8H, v9.8H, v1.8H                        // ......................................................................................*.................................................... || .........................*..............
        // sqrdmulh v9.8H, v9.8H, v5.8H                    // .......................................................................................*................................................... || .........................*..............
        // mls v24.8H, v9.8H, v7.H[0]                      // ............................................................................................*.............................................. || ...........................*............
        // sub v9.8H, v8.8H, v24.8H                        // .....................................................................................................*..................................... || .............................*..........
        // add v8.8H, v8.8H, v24.8H                        // .......................................................................................................*................................... || .............................*..........
        // mul v24.8H, v11.8H, v2.8H                       // .........................................................................................*................................................. || ..........................*.............
        // sqrdmulh v11.8H, v11.8H, v6.8H                  // .............................................................................................*............................................. || ...........................*............
        // mls v24.8H, v11.8H, v7.H[0]                     // ......................................................................................................*.................................... || .............................*..........
        // sub v11.8H, v10.8H, v24.8H                      // .................................................................................................................*......................... || ................................*.......
        // add v10.8H, v10.8H, v24.8H                      // .............................................................................................................*............................. || ...............................*........
        // sqdmulh v25.8H, v8.8H, v7.H[1]                  // ..........................................................................................................*................................ || ..............................*.........
        // srshr v25.8H, v25.8H, #11                       // ......................................................................................................................*.................... || .................................*......
        // mls v8.8H, v25.8H, v7.H[0]                      // ............................................................................................................................*.............. || ...................................*....
        // sqdmulh v25.8H, v9.8H, v7.H[1]                  // ........................................................................................................*.................................. || ..............................*.........
        // srshr v25.8H, v25.8H, #11                       // ..................................................................................................................*........................ || ................................*.......
        // mls v9.8H, v25.8H, v7.H[0]                      // ........................................................................................................................*.................. || ..................................*.....
        // sqdmulh v25.8H, v10.8H, v7.H[1]                 // ...............................................................................................................*........................... || ................................*.......
        // srshr v25.8H, v25.8H, #11                       // .........................................................................................................................*................. || ..................................*.....
        // mls v10.8H, v25.8H, v7.H[0]                     // ................................................................................................................................*.......... || ....................................*...
        // sqdmulh v25.8H, v11.8H, v7.H[1]                 // .....................................................................................................................*..................... || .................................*......
        // srshr v25.8H, v25.8H, #11                       // ...............................................................................................................................*........... || ...................................*....
        // mls v11.8H, v25.8H, v7.H[0]                     // .....................................................................................................................................*..... || .....................................*..
        // st4 {v8.4S,v9.4S,v10.4S,v11.4S}, [x1], #64      // ..........................................................................................................................................* || .......................................*
        
        subs count, count, #1
        cbnz count, layer4567_start
        mul v23.8H, v5.8H, v4.8H                             // *...................................
        trn1 v20.2D, v12.2D, v16.2D                          // .....*..............................
        sqrdmulh v25.8H, v5.8H, v6.8H                        // .*..................................
        trn2 v13.2D, v3.2D, v8.2D                            // ..*.................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        sqrdmulh v31.8H, v13.8H, v6.8H                       // ....*...............................
        trn1 v24.2D, v3.2D, v8.2D                            // .......*............................
        mul v13.8H, v13.8H, v4.8H                            // ...*................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        mls v23.8H, v25.8H, v7.H[0]                          // ......*.............................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        mls v13.8H, v31.8H, v7.H[0]                          // ........*...........................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        sub v9.8H, v20.8H, v23.8H                            // ..........*.........................
        // gap                                               // ....................................
        add v18.8H, v20.8H, v23.8H                           // .........*..........................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        mul v30.8H, v9.8H, v21.8H                            // .............*......................
        // gap                                               // ....................................
        sqrdmulh v14.8H, v9.8H, v10.8H                       // ...............*....................
        add v10.8H, v24.8H, v13.8H                           // ................*...................
        // gap                                               // ....................................
        // gap                                               // ....................................
        mul v25.8H, v18.8H, v2.8H                            // ...........*........................
        // gap                                               // ....................................
        sqrdmulh v1.8H, v18.8H, v17.8H                       // ............*.......................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        mls v30.8H, v14.8H, v7.H[0]                          // ..................*.................
        sub v14.8H, v24.8H, v13.8H                           // .....................*..............
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        mls v25.8H, v1.8H, v7.H[0]                           // ..............*.....................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        add v22.8H, v14.8H, v30.8H                           // .......................*............
        sub v23.8H, v14.8H, v30.8H                           // .........................*..........
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        sqdmulh v8.8H, v22.8H, v7.H[1]                       // ........................*...........
        add v20.8H, v10.8H, v25.8H                           // ...................*................
        sqdmulh v1.8H, v23.8H, v7.H[1]                       // ...........................*........
        sub v21.8H, v10.8H, v25.8H                           // .................*..................
        // gap                                               // ....................................
        // gap                                               // ....................................
        sqdmulh v12.8H, v21.8H, v7.H[1]                      // ....................*...............
        // gap                                               // ....................................
        sqdmulh v30.8H, v20.8H, v7.H[1]                      // ......................*.............
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        srshr v28.8H, v8.8H, #11                             // ..............................*.....
        srshr v31.8H, v1.8H, #11                             // ................................*...
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        srshr v12.8H, v12.8H, #11                            // ..........................*.........
        srshr v13.8H, v30.8H, #11                            // ............................*.......
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        mls v22.8H, v28.8H, v7.H[0]                          // .................................*..
        // gap                                               // ....................................
        mls v23.8H, v31.8H, v7.H[0]                          // ..................................*.
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        mls v20.8H, v13.8H, v7.H[0]                          // ...............................*....
        // gap                                               // ....................................
        mls v21.8H, v12.8H, v7.H[0]                          // .............................*......
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        st4 {v20.4S,v21.4S,v22.4S,v23.4S}, [x1], #64         // ...................................*
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        // gap                                               // ....................................
        
        // original source code
        // mul v19.8H, v5.8H, v4.8H                          // *................................... || *.................
        // sqrdmulh v30.8H, v5.8H, v6.8H                     // ..*................................. || *.................
        // trn2 v29.2D, v3.2D, v8.2D                         // ...*................................ || *.................
        // mul v5.8H, v29.8H, v4.8H                          // ......*............................. || .*................
        // sqrdmulh v23.8H, v29.8H, v6.8H                    // ....*............................... || .*................
        // trn1 v0.2D, v12.2D, v16.2D                        // .*.................................. || *.................
        // mls v19.8H, v30.8H, v7.H[0]                       // .......*............................ || ..*...............
        // trn1 v3.2D, v3.2D, v8.2D                          // .....*.............................. || .*................
        // mls v5.8H, v23.8H, v7.H[0]                        // ........*........................... || ...*..............
        // add v1.8H, v0.8H, v19.8H                          // ..........*......................... || ....*.............
        // sub v22.8H, v0.8H, v19.8H                         // .........*.......................... || ....*.............
        // mul v20.8H, v1.8H, v2.8H                          // ..............*..................... || ......*...........
        // sqrdmulh v8.8H, v1.8H, v17.8H                     // ...............*.................... || ......*...........
        // mul v31.8H, v22.8H, v21.8H                        // ...........*........................ || .....*............
        // mls v20.8H, v8.8H, v7.H[0]                        // ..................*................. || ........*.........
        // sqrdmulh v19.8H, v22.8H, v10.8H                   // ............*....................... || .....*............
        // add v11.8H, v3.8H, v5.8H                          // .............*...................... || .....*............
        // sub v24.8H, v11.8H, v20.8H                        // ........................*........... || ..........*.......
        // mls v31.8H, v19.8H, v7.H[0]                       // ................*................... || .......*..........
        // add v23.8H, v11.8H, v20.8H                        // ......................*............. || ..........*.......
        // sqdmulh v0.8H, v24.8H, v7.H[1]                    // .........................*.......... || ...........*......
        // sub v6.8H, v3.8H, v5.8H                           // .................*.................. || .......*..........
        // sqdmulh v16.8H, v23.8H, v7.H[1]                   // ..........................*......... || ...........*......
        // add v25.8H, v6.8H, v31.8H                         // ...................*................ || .........*........
        // sqdmulh v19.8H, v25.8H, v7.H[1]                   // .....................*.............. || ..........*.......
        // sub v26.8H, v6.8H, v31.8H                         // ....................*............... || .........*........
        // srshr v0.8H, v0.8H, #11                           // .............................*...... || .............*....
        // sqdmulh v5.8H, v26.8H, v7.H[1]                    // .......................*............ || ..........*.......
        // srshr v16.8H, v16.8H, #11                         // ..............................*..... || .............*....
        // mls v24.8H, v0.8H, v7.H[0]                        // ..................................*. || ...............*..
        // srshr v19.8H, v19.8H, #11                         // ...........................*........ || ............*.....
        // mls v23.8H, v16.8H, v7.H[0]                       // .................................*.. || ...............*..
        // srshr v9.8H, v5.8H, #11                           // ............................*....... || ............*.....
        // mls v25.8H, v19.8H, v7.H[0]                       // ...............................*.... || ..............*...
        // mls v26.8H, v9.8H, v7.H[0]                        // ................................*... || ..............*...
        // st4 {v23.4S,v24.4S,v25.4S,v26.4S}, [x1], #64      // ...................................* || .................*
        

       pop_stack
       ret