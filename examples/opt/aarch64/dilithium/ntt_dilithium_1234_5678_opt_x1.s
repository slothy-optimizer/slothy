///
/// Copyright (c) 2022 Arm Limited
/// Copyright (c) 2022 Hanno Becker
/// Copyright (c) 2023 Amin Abdulrahman, Matthias Kannwischer
/// SPDX-License-Identifier: MIT
///
/// Permission is hereby granted, free of charge, to any person obtaining a copy
/// of this software and associated documentation files (the "Software"), to deal
/// in the Software without restriction, including without limitation the rights
/// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
/// copies of the Software, and to permit persons to whom the Software is
/// furnished to do so, subject to the following conditions:
///
/// The above copyright notice and this permission notice shall be included in all
/// copies or substantial portions of the Software.
///
/// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
/// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
/// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
/// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
/// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
/// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
/// SOFTWARE.
///

// Needed to provide ASM_LOAD directive
#include <hal_env.h>

// NOTE
// We use a lot of trivial macros to simplify the parsing burden for Slothy
// The macros are not unfolded by Slothy and thus interpreted as instructions,
// which are easier to parse due to e.g. the lack of size specifiers and simpler
// syntax for pre and post increment for loads and stores.
//
// Eventually, NeLight should include a proper parser for AArch64,
// but for initial investigations, the below is enough.

.macro ldr_vo vec, base, offset                    // slothy:no-unfold
        ldr qform_\vec, [\base, \offset]
.endm
.macro ldr_vi vec, base, inc                        // slothy:no-unfold
        ldr qform_\vec, [\base], \inc
.endm
.macro str_vo vec, base, offset                     // slothy:no-unfold
        str qform_\vec, [\base, \offset]
.endm
.macro str_vi vec, base, inc                        // slothy:no-unfold
        str qform_\vec, [\base], \inc
.endm
.macro vqrdmulh d,a,b
        sqrdmulh \d\().4s, \a\().4s, \b\().4s
.endm
.macro vmla d,a,b
        mla \d\().4s, \a\().4s, \b\().4s
.endm
.macro vqrdmulhq d,a,b,i
        sqrdmulh \d\().4s, \a\().4s, \b\().s[\i]
.endm
.macro vmulq d,a,b,i
        mul \d\().4s, \a\().4s, \b\().s[\i]
.endm
.macro vmlaq d,a,b,i
        mla \d\().4s, \a\().4s, \b\().s[\i]
        .endm
.macro vmlsq d,a,b,i
        mls \d\().4s, \a\().4s, \b\().s[\i]
        .endm


.macro mulmodq dst, src, const, idx0, idx1
        vmulq       \dst,  \src, \const, \idx0
        vqrdmulhq   \src,  \src, \const, \idx1
        vmla        \dst,  \src, modulus
.endm

.macro mulmod dst, src, const, const_twisted
        mul        \dst\().4s,  \src\().4s, \const\().4s
        vqrdmulh   \src,  \src, \const_twisted
        vmla       \dst,  \src, modulus
.endm

.macro ct_butterfly a, b, root, idx0, idx1
        mulmodq  tmp, \b, \root, \idx0, \idx1
        sub     \b\().4s,    \a\().4s, tmp.4s
        add     \a\().4s,    \a\().4s, tmp.4s
.endm

.macro mulmod_v dst, src, const, const_twisted
        mul        \dst\().4s,  \src\().4s, \const\().4s
        vqrdmulh    \src,  \src, \const_twisted
        vmla        \dst,  \src, modulus
.endm

.macro ct_butterfly_v a, b, root, root_twisted
        mulmod  tmp, \b, \root, \root_twisted
        sub    \b\().4s,    \a\().4s, tmp.4s
        add    \a\().4s,    \a\().4s, tmp.4s
.endm

.macro load_roots_1234
        ldr_vi root0, r_ptr0, (8*16)
        ldr_vo root1, r_ptr0, (-8*16 + 1*16)
        ldr_vo root2, r_ptr0, (-8*16 + 2*16)
        ldr_vo root3, r_ptr0, (-8*16 + 3*16)
        ldr_vo root4, r_ptr0, (-8*16 + 4*16)
        ldr_vo root5, r_ptr0, (-8*16 + 5*16)
        ldr_vo root6, r_ptr0, (-8*16 + 6*16)
        ldr_vo root7, r_ptr0, (-8*16 + 7*16)
.endm

.macro load_next_roots_56 root0, r_ptr0
        ldr_vi \root0, \r_ptr0, 16
.endm

.macro load_next_roots_6 root0, r_ptr0
        ldr_vi \root0, \r_ptr0, 8
.endm

.macro load_next_roots_78 root0, root0_tw, root1, root1_tw, root2, root2_tw, r_ptr1
        ldr_vi \root0,    \r_ptr1, (6*16)
        ldr_vo \root0_tw, \r_ptr1, (-6*16 + 1*16)
        ldr_vo \root1,    \r_ptr1, (-6*16 + 2*16)
        ldr_vo \root1_tw, \r_ptr1, (-6*16 + 3*16)
        ldr_vo \root2,    \r_ptr1, (-6*16 + 4*16)
        ldr_vo \root2_tw, \r_ptr1, (-6*16 + 5*16)
.endm

.macro transpose4 data
        trn1 t0.4s, \data\()0\().4s, \data\()1\().4s
        trn2 t1.4s, \data\()0\().4s, \data\()1\().4s
        trn1 t2.4s, \data\()2\().4s, \data\()3\().4s
        trn2 t3.4s, \data\()2\().4s, \data\()3\().4s

        trn2 \data\()2\().2d, t0.2d, t2.2d
        trn2 \data\()3\().2d, t1.2d, t3.2d
        trn1 \data\()0\().2d, t0.2d, t2.2d
        trn1 \data\()1\().2d, t1.2d, t3.2d
.endm

.macro save_gprs // slothy:no-unfold
        sub sp, sp, #(16*6)
        stp x19, x20, [sp, #16*0]
        stp x19, x20, [sp, #16*0]
        stp x21, x22, [sp, #16*1]
        stp x23, x24, [sp, #16*2]
        stp x25, x26, [sp, #16*3]
        stp x27, x28, [sp, #16*4]
        str x29, [sp, #16*5]
.endm

.macro restore_gprs // slothy:no-unfold
        ldp x19, x20, [sp, #16*0]
        ldp x21, x22, [sp, #16*1]
        ldp x23, x24, [sp, #16*2]
        ldp x25, x26, [sp, #16*3]
        ldp x27, x28, [sp, #16*4]
        ldr x29, [sp, #16*5]
        add sp, sp, #(16*6)
.endm

.macro save_vregs // slothy:no-unfold
        sub sp, sp, #(16*4)
        stp  d8,  d9, [sp, #16*0]
        stp d10, d11, [sp, #16*1]
        stp d12, d13, [sp, #16*2]
        stp d14, d15, [sp, #16*3]
.endm

.macro restore_vregs // slothy:no-unfold
        ldp  d8,  d9, [sp, #16*0]
        ldp d10, d11, [sp, #16*1]
        ldp d12, d13, [sp, #16*2]
        ldp d14, d15, [sp, #16*3]
        add sp, sp, #(16*4)
.endm

#define STACK_SIZE 16
#define STACK0 0

.macro restore a, loc     // slothy:no-unfold
        ldr \a, [sp, #\loc\()]
.endm
.macro save loc, a        // slothy:no-unfold
        str \a, [sp, #\loc\()]
.endm
.macro push_stack // slothy:no-unfold
        save_gprs
        save_vregs
        sub sp, sp, #STACK_SIZE
.endm

.macro pop_stack // slothy:no-unfold
        add sp, sp, #STACK_SIZE
        restore_vregs
        restore_gprs
.endm

.data
.p2align 4
roots:
#include "ntt_dilithium_1234_5678_twiddles.s"
.text

        .global ntt_dilithium_1234_5678_opt_x1
        .global _ntt_dilithium_1234_5678_opt_x1

.p2align 4
modulus_addr:   .quad -8380417
ntt_dilithium_1234_5678_opt_x1:
_ntt_dilithium_1234_5678_opt_x1:
        push_stack

        in      .req x0
        inp     .req x1
        count   .req x2
        r_ptr0  .req x3
        r_ptr1  .req x4
        xtmp    .req x5

        data0  .req v8
        data1  .req v9
        data2  .req v10
        data3  .req v11
        data4  .req v12
        data5  .req v13
        data6  .req v14
        data7  .req v15
        data8  .req v16
        data9  .req v17
        data10 .req v18
        data11 .req v19
        data12 .req v20
        data13 .req v21
        data14 .req v22
        data15 .req v23

        qform_data0  .req q8
        qform_data1  .req q9
        qform_data2  .req q10
        qform_data3  .req q11
        qform_data4  .req q12
        qform_data5  .req q13
        qform_data6  .req q14
        qform_data7  .req q15
        qform_data8  .req q16
        qform_data9  .req q17
        qform_data10 .req q18
        qform_data11 .req q19
        qform_data12 .req q20
        qform_data13 .req q21
        qform_data14 .req q22
        qform_data15 .req q23

        qform_v0  .req q0
        qform_v1  .req q1
        qform_v2  .req q2
        qform_v3  .req q3
        qform_v4  .req q4
        qform_v5  .req q5
        qform_v6  .req q6
        qform_v7  .req q7
        qform_v8  .req q8
        qform_v9  .req q9
        qform_v10 .req q10
        qform_v11 .req q11
        qform_v12 .req q12
        qform_v13 .req q13
        qform_v14 .req q14
        qform_v15 .req q15
        qform_v16 .req q16
        qform_v17 .req q17
        qform_v18 .req q18
        qform_v19 .req q19
        qform_v20 .req q20
        qform_v21 .req q21
        qform_v22 .req q22
        qform_v23 .req q23
        qform_v24 .req q24
        qform_v25 .req q25
        qform_v26 .req q26
        qform_v27 .req q27
        qform_v28 .req q28
        qform_v29 .req q29
        qform_v30 .req q30
        qform_v31 .req q31

        root0    .req v0
        root1    .req v1
        root2    .req v2
        root3    .req v3
        root4 .req v4
        root5 .req v5
        root6 .req v6
        root7 .req v7

        qform_root0    .req q0
        qform_root1    .req q1
        qform_root2    .req q2
        qform_root3    .req q3
        qform_root4    .req q4
        qform_root5    .req q5
        qform_root6    .req q6
        qform_root7    .req q7


        tmp .req v24
        t0  .req v25
        t1  .req v26
        t2  .req v27
        t3  .req v28

        modulus .req v29

        ASM_LOAD(r_ptr0, roots)
        ASM_LOAD(r_ptr1, roots_l67)

        ASM_LOAD(xtmp, modulus_addr)
        ld1r {modulus.4s}, [xtmp]

        save STACK0, in
        mov count, #4

        load_roots_1234

        .p2align 2
        ldr_vo v22, x0, 896
        ldr_vo v21, x0, 576
        ldr_vo v18, x0, 768
        mul v26.4S, v22.4S, v0.S[0]
        sqrdmulh v23.4S, v22.4S, v0.S[1]
        ldr_vo v13, x0, 704
        mul v31.4S, v21.4S, v0.S[0]
        sqrdmulh v20.4S, v21.4S, v0.S[1]
        ldr_vo v8, x0, 512
        sqrdmulh v28.4S, v18.4S, v0.S[1]
        mul v15.4S, v18.4S, v0.S[0]
        ldr_vo v11, x0, 960
        sqrdmulh v25.4S, v13.4S, v0.S[1]
        mla v26.4S, v23.4S, v29.4S
        ldr_vo v16, x0, 256
        mla v15.4S, v28.4S, v29.4S
        sqrdmulh v30.4S, v8.4S, v0.S[1]
        ldr_vo v18, x0, 64
        mul v27.4S, v13.4S, v0.S[0]
        sqrdmulh v24.4S, v11.4S, v0.S[1]
        ldr_vo v10, x0, 640
        mla v31.4S, v20.4S, v29.4S
        sub v28.4S, v16.4S, v15.4S
        mla v27.4S, v25.4S, v29.4S
        add v21.4S, v16.4S, v15.4S
        ldr_vo v12, x0, 384
        sqrdmulh v20.4S, v28.4S, v1.S[1]
        sqrdmulh v15.4S, v21.4S, v0.S[3]
        ldr_vo v19, x0, 832
        mul v9.4S, v11.4S, v0.S[0]
        add v17.4S, v18.4S, v31.4S
        mul v16.4S, v28.4S, v1.S[0]
        sub v25.4S, v18.4S, v31.4S
        ldr_vo v22, x0, 320
        mla v16.4S, v20.4S, v29.4S
        mul v31.4S, v10.4S, v0.S[0]
        sub v28.4S, v12.4S, v26.4S
        ldr_vo v14, x0, 128
        mul v23.4S, v19.4S, v0.S[0]
        add v12.4S, v12.4S, v26.4S
        sqrdmulh v20.4S, v19.4S, v0.S[1]
        ldr_vo v19, x0, 192
        mul v13.4S, v8.4S, v0.S[0]
        mul v8.4S, v21.4S, v0.S[2]
        ldr_vo v21, x0, 0
        mla v13.4S, v30.4S, v29.4S
        sqrdmulh v10.4S, v10.4S, v0.S[1]
        mla v23.4S, v20.4S, v29.4S
        sqrdmulh v20.4S, v28.4S, v1.S[1]
        sub v26.4S, v22.4S, v23.4S
        mla v9.4S, v24.4S, v29.4S
        sub v11.4S, v21.4S, v13.4S
        ldr_vo v30, x0, 448
        sqrdmulh v24.4S, v26.4S, v1.S[1]
        add v18.4S, v21.4S, v13.4S
        mul v26.4S, v26.4S, v1.S[0]
        add v21.4S, v22.4S, v23.4S
        mla v8.4S, v15.4S, v29.4S
        sqrdmulh v13.4S, v21.4S, v0.S[3]
        mla v26.4S, v24.4S, v29.4S
        add v23.4S, v30.4S, v9.4S
        mla v31.4S, v10.4S, v29.4S
        sub v15.4S, v30.4S, v9.4S
        mul v10.4S, v28.4S, v1.S[0]
        sub v22.4S, v18.4S, v8.4S
        sqrdmulh v28.4S, v15.4S, v1.S[1]
        mla v10.4S, v20.4S, v29.4S
        add v20.4S, v18.4S, v8.4S
        mul v15.4S, v15.4S, v1.S[0]
        sub v18.4S, v14.4S, v31.4S
        mul v8.4S, v21.4S, v0.S[2]
        sub v30.4S, v25.4S, v26.4S
        mla v15.4S, v28.4S, v29.4S
        add v26.4S, v25.4S, v26.4S
        mla v8.4S, v13.4S, v29.4S
        sub v9.4S, v19.4S, v27.4S
        mul v13.4S, v23.4S, v0.S[2]
        add v21.4S, v18.4S, v10.4S
        sqrdmulh v28.4S, v21.4S, v2.S[3]
        sub v24.4S, v18.4S, v10.4S
        mul v10.4S, v21.4S, v2.S[2]
        add v21.4S, v9.4S, v15.4S
        sqrdmulh v23.4S, v23.4S, v0.S[3]
        add v25.4S, v14.4S, v31.4S
        mul v18.4S, v21.4S, v2.S[2]
        sub v14.4S, v17.4S, v8.4S
        mla v10.4S, v28.4S, v29.4S
        add v28.4S, v17.4S, v8.4S
        mul v8.4S, v24.4S, v3.S[0]
        add v31.4S, v19.4S, v27.4S
        mla v13.4S, v23.4S, v29.4S
        sub v23.4S, v9.4S, v15.4S
        mul v27.4S, v12.4S, v0.S[2]
        sqrdmulh v21.4S, v21.4S, v2.S[3]
        sqrdmulh v9.4S, v23.4S, v3.S[1]
        sub v15.4S, v31.4S, v13.4S
        sub count, count, #1
.p2align 2
layer1234_start:
        sqrdmulh v17.4S, v12.4S, v0.S[3]
        add v13.4S, v31.4S, v13.4S
        mul v23.4S, v23.4S, v3.S[0]
        add v19.4S, v11.4S, v16.4S               // gap(s) to follow
        mla v23.4S, v9.4S, v29.4S
        sub v9.4S, v19.4S, v10.4S
        sqrdmulh v24.4S, v24.4S, v3.S[1]
        add v12.4S, v19.4S, v10.4S               // gap(s) to follow
        mla v27.4S, v17.4S, v29.4S
        sub v17.4S, v11.4S, v16.4S
        sqrdmulh v10.4S, v13.4S, v1.S[3]         // gap(s) to follow
        mla v8.4S, v24.4S, v29.4S
        sub v31.4S, v30.4S, v23.4S
        mul v16.4S, v13.4S, v1.S[2]
        add v24.4S, v30.4S, v23.4S               // gap(s) to follow
        mla v16.4S, v10.4S, v29.4S
        sub v13.4S, v25.4S, v27.4S
        sqrdmulh v11.4S, v24.4S, v6.S[3]
        add v27.4S, v25.4S, v27.4S               // gap(s) to follow
        mul v24.4S, v24.4S, v6.S[2]
        add v25.4S, v17.4S, v8.4S
        sqrdmulh v23.4S, v13.4S, v2.S[1]
        sub v17.4S, v17.4S, v8.4S                // gap(s) to follow
        mla v24.4S, v11.4S, v29.4S
        add v30.4S, v28.4S, v16.4S
        sqrdmulh v10.4S, v27.4S, v1.S[3]
        sub v11.4S, v28.4S, v16.4S               // gap(s) to follow
        mul v28.4S, v27.4S, v1.S[2]              // gap(s) to follow
        sqrdmulh v8.4S, v30.4S, v3.S[3]          // gap(s) to follow
        mla v28.4S, v10.4S, v29.4S
        add v10.4S, v25.4S, v24.4S
        mul v16.4S, v30.4S, v3.S[2]
        sub v24.4S, v25.4S, v24.4S               // gap(s) to follow
        mla v18.4S, v21.4S, v29.4S
        str_vo v10, x0, 768
        mla v16.4S, v8.4S, v29.4S                // gap(s) to follow
        sqrdmulh v27.4S, v15.4S, v2.S[1]
        sub v25.4S, v20.4S, v28.4S
        mul v10.4S, v31.4S, v7.S[0]
        add v20.4S, v20.4S, v28.4S               // gap(s) to follow
        mul v30.4S, v15.4S, v2.S[0]
        sub v15.4S, v20.4S, v16.4S
        mul v8.4S, v13.4S, v2.S[0]
        sub v21.4S, v26.4S, v18.4S               // gap(s) to follow
        mla v30.4S, v27.4S, v29.4S
        str_vo v15, x0, 64
        mul v28.4S, v21.4S, v6.S[0]
        add v13.4S, v26.4S, v18.4S               // gap(s) to follow
        sqrdmulh v18.4S, v31.4S, v7.S[1]
        add v31.4S, v14.4S, v30.4S
        mla v8.4S, v23.4S, v29.4S
        sub v15.4S, v14.4S, v30.4S               // gap(s) to follow
        ldr_vo v19, x0, 592
        sqrdmulh v27.4S, v15.4S, v5.S[1]
        str_vo v24, x0, 832
        sqrdmulh v26.4S, v13.4S, v5.S[3]
        add v30.4S, v20.4S, v16.4S               // gap(s) to follow
        ldr_vo v14, x0, 784
        sqrdmulh v20.4S, v31.4S, v4.S[3]
        sub v23.4S, v22.4S, v8.4S
        mul v15.4S, v15.4S, v5.S[0]
        add v8.4S, v22.4S, v8.4S                 // gap(s) to follow
        ldr_vo v24, x0, 720
        mla v15.4S, v27.4S, v29.4S
        str_vi v30, x0, 16
        mul v22.4S, v19.4S, v0.S[0]              // gap(s) to follow
        ldr_vo v30, x0, 960
        mul v27.4S, v13.4S, v5.S[2]              // gap(s) to follow
        mul v16.4S, v14.4S, v0.S[0]              // gap(s) to follow
        mla v27.4S, v26.4S, v29.4S
        add v26.4S, v23.4S, v15.4S
        mul v31.4S, v31.4S, v4.S[2]              // gap(s) to follow
        mla v31.4S, v20.4S, v29.4S
        str_vo v26, x0, 368
        sqrdmulh v20.4S, v14.4S, v0.S[1]
        sub v23.4S, v23.4S, v15.4S               // gap(s) to follow
        ldr_vo v13, x0, 640
        sqrdmulh v15.4S, v21.4S, v6.S[1]
        sub v21.4S, v12.4S, v27.4S
        sqrdmulh v14.4S, v24.4S, v0.S[1]
        add v27.4S, v12.4S, v27.4S               // gap(s) to follow
        ldr_vo v26, x0, 256
        mla v16.4S, v20.4S, v29.4S
        str_vo v27, x0, 496
        mul v20.4S, v11.4S, v4.S[0]
        sub v12.4S, v8.4S, v31.4S                // gap(s) to follow
        mul v27.4S, v24.4S, v0.S[0]
        str_vo v12, x0, 304
        mla v28.4S, v15.4S, v29.4S
        add v31.4S, v8.4S, v31.4S                // gap(s) to follow
        ldr_vo v12, x0, 832
        mla v10.4S, v18.4S, v29.4S
        str_vo v23, x0, 432
        mla v27.4S, v14.4S, v29.4S
        sub v14.4S, v26.4S, v16.4S               // gap(s) to follow
        sqrdmulh v8.4S, v19.4S, v0.S[1]
        mul v24.4S, v13.4S, v0.S[0]
        add v15.4S, v17.4S, v10.4S
        sqrdmulh v18.4S, v12.4S, v0.S[1]
        sub v10.4S, v17.4S, v10.4S               // gap(s) to follow
        ldr_vo v23, x0, 448
        mul v19.4S, v12.4S, v0.S[0]
        str_vo v15, x0, 880
        sqrdmulh v12.4S, v11.4S, v4.S[1]
        add v15.4S, v26.4S, v16.4S               // gap(s) to follow
        ldr_vo v26, x0, 320
        sqrdmulh v13.4S, v13.4S, v0.S[1]
        add v16.4S, v9.4S, v28.4S
        mla v19.4S, v18.4S, v29.4S               // gap(s) to follow
        ldr_vo v17, x0, 896
        sqrdmulh v18.4S, v30.4S, v0.S[1]
        str_vo v31, x0, 240
        mla v20.4S, v12.4S, v29.4S
        sub v28.4S, v9.4S, v28.4S                // gap(s) to follow
        ldr_vo v31, x0, 512
        mla v22.4S, v8.4S, v29.4S
        str_vo v21, x0, 560
        mul v30.4S, v30.4S, v0.S[0]
        add v11.4S, v26.4S, v19.4S               // gap(s) to follow
        ldr_vo v21, x0, 64
        mla v30.4S, v18.4S, v29.4S
        str_vo v28, x0, 688
        sqrdmulh v12.4S, v14.4S, v1.S[1]
        add v28.4S, v25.4S, v20.4S               // gap(s) to follow
        mul v18.4S, v17.4S, v0.S[0]
        sub v9.4S, v25.4S, v20.4S
        mla v24.4S, v13.4S, v29.4S
        sub v20.4S, v26.4S, v19.4S               // gap(s) to follow
        sqrdmulh v25.4S, v20.4S, v1.S[1]
        sub v26.4S, v23.4S, v30.4S
        mul v8.4S, v20.4S, v1.S[0]
        sub v19.4S, v21.4S, v22.4S               // gap(s) to follow
        sqrdmulh v13.4S, v26.4S, v1.S[1]
        add v20.4S, v21.4S, v22.4S
        sqrdmulh v22.4S, v17.4S, v0.S[1]         // gap(s) to follow
        mla v8.4S, v25.4S, v29.4S
        str_vo v16, x0, 624
        mul v16.4S, v14.4S, v1.S[0]              // gap(s) to follow
        ldr_vo v21, x0, 384
        mla v16.4S, v12.4S, v29.4S
        str_vo v28, x0, 112
        mul v14.4S, v26.4S, v1.S[0]              // gap(s) to follow
        ldr_vo v28, x0, 128
        mla v14.4S, v13.4S, v29.4S
        str_vo v9, x0, 176
        sqrdmulh v12.4S, v11.4S, v0.S[3]
        add v13.4S, v23.4S, v30.4S               // gap(s) to follow
        mla v18.4S, v22.4S, v29.4S
        sub v30.4S, v19.4S, v8.4S
        sqrdmulh v23.4S, v31.4S, v0.S[1]         // gap(s) to follow
        mul v17.4S, v31.4S, v0.S[0]
        str_vo v10, x0, 944
        mul v22.4S, v11.4S, v0.S[2]
        add v25.4S, v28.4S, v24.4S               // gap(s) to follow
        ldr_vo v31, x0, 192
        mla v22.4S, v12.4S, v29.4S               // gap(s) to follow
        sqrdmulh v12.4S, v13.4S, v0.S[3]
        sub v10.4S, v21.4S, v18.4S               // gap(s) to follow
        mla v17.4S, v23.4S, v29.4S               // gap(s) to follow
        sqrdmulh v23.4S, v10.4S, v1.S[1]         // gap(s) to follow
        mul v13.4S, v13.4S, v0.S[2]
        sub v26.4S, v31.4S, v27.4S
        mul v11.4S, v10.4S, v1.S[0]
        add v31.4S, v31.4S, v27.4S               // gap(s) to follow
        ldr_vo v10, x0, 0
        mla v13.4S, v12.4S, v29.4S
        add v12.4S, v21.4S, v18.4S
        mla v11.4S, v23.4S, v29.4S
        add v18.4S, v26.4S, v14.4S               // gap(s) to follow
        sqrdmulh v21.4S, v18.4S, v2.S[3]
        sub v23.4S, v26.4S, v14.4S
        sqrdmulh v14.4S, v15.4S, v0.S[3]
        sub v27.4S, v28.4S, v24.4S               // gap(s) to follow
        sub v24.4S, v27.4S, v11.4S
        add v9.4S, v27.4S, v11.4S
        mul v27.4S, v12.4S, v0.S[2]
        add v26.4S, v19.4S, v8.4S                // gap(s) to follow
        mul v19.4S, v15.4S, v0.S[2]
        add v28.4S, v20.4S, v22.4S
        sqrdmulh v8.4S, v9.4S, v2.S[3]
        sub v11.4S, v10.4S, v17.4S               // gap(s) to follow
        mla v19.4S, v14.4S, v29.4S
        add v17.4S, v10.4S, v17.4S
        mul v10.4S, v9.4S, v2.S[2]
        sub v14.4S, v20.4S, v22.4S               // gap(s) to follow
        mul v18.4S, v18.4S, v2.S[2]
        sub v15.4S, v31.4S, v13.4S
        mla v10.4S, v8.4S, v29.4S                // gap(s) to follow
        mul v8.4S, v24.4S, v3.S[0]
        add v20.4S, v17.4S, v19.4S
        sqrdmulh v9.4S, v23.4S, v3.S[1]
        sub v22.4S, v17.4S, v19.4S               // gap(s) to follow
        subs count, count, #1
        cbnz count, layer1234_start
        sqrdmulh v19.4S, v12.4S, v0.S[3]
        add v12.4S, v31.4S, v13.4S
        mul v31.4S, v23.4S, v3.S[0]
        add v13.4S, v11.4S, v16.4S
        mla v18.4S, v21.4S, v29.4S
        add v17.4S, v13.4S, v10.4S
        sqrdmulh v23.4S, v12.4S, v1.S[3]
        sub v16.4S, v11.4S, v16.4S
        mul v12.4S, v12.4S, v1.S[2]
        sub v13.4S, v13.4S, v10.4S
        mla v27.4S, v19.4S, v29.4S
        mla v31.4S, v9.4S, v29.4S
        sub v19.4S, v26.4S, v18.4S
        mla v12.4S, v23.4S, v29.4S
        add v26.4S, v26.4S, v18.4S
        sqrdmulh v18.4S, v19.4S, v6.S[1]
        sub v23.4S, v25.4S, v27.4S
        mul v19.4S, v19.4S, v6.S[0]
        add v27.4S, v25.4S, v27.4S
        add v21.4S, v28.4S, v12.4S
        sub v12.4S, v28.4S, v12.4S
        sqrdmulh v25.4S, v27.4S, v1.S[3]
        add v11.4S, v30.4S, v31.4S
        mla v19.4S, v18.4S, v29.4S
        sub v10.4S, v30.4S, v31.4S
        mul v9.4S, v27.4S, v1.S[2]
        mla v9.4S, v25.4S, v29.4S
        sqrdmulh v28.4S, v23.4S, v2.S[1]
        mul v30.4S, v23.4S, v2.S[0]
        sqrdmulh v23.4S, v24.4S, v3.S[1]
        add v27.4S, v13.4S, v19.4S
        mul v24.4S, v11.4S, v6.S[2]
        add v25.4S, v20.4S, v9.4S
        sqrdmulh v18.4S, v11.4S, v6.S[3]
        sub v31.4S, v20.4S, v9.4S
        mla v8.4S, v23.4S, v29.4S
        str_vo v27, x0, 640
        sqrdmulh v11.4S, v12.4S, v4.S[1]
        sub v23.4S, v13.4S, v19.4S
        mul v9.4S, v12.4S, v4.S[0]
        str_vo v23, x0, 704
        mla v24.4S, v18.4S, v29.4S
        mla v9.4S, v11.4S, v29.4S
        sub v23.4S, v16.4S, v8.4S
        sqrdmulh v18.4S, v15.4S, v2.S[1]
        add v8.4S, v16.4S, v8.4S
        mul v27.4S, v15.4S, v2.S[0]
        add v15.4S, v8.4S, v24.4S
        sqrdmulh v11.4S, v10.4S, v7.S[1]
        sub v16.4S, v8.4S, v24.4S
        mla v27.4S, v18.4S, v29.4S
        str_vo v16, x0, 832
        sqrdmulh v13.4S, v21.4S, v3.S[3]
        sub v16.4S, v31.4S, v9.4S
        mla v30.4S, v28.4S, v29.4S
        str_vo v16, x0, 192
        mul v18.4S, v10.4S, v7.S[0]
        add v9.4S, v31.4S, v9.4S
        mla v18.4S, v11.4S, v29.4S
        str_vo v15, x0, 768
        mul v15.4S, v21.4S, v3.S[2]
        sub v28.4S, v14.4S, v27.4S
        mla v15.4S, v13.4S, v29.4S
        add v21.4S, v14.4S, v27.4S
        sqrdmulh v16.4S, v28.4S, v5.S[1]
        add v10.4S, v22.4S, v30.4S
        mul v20.4S, v28.4S, v5.S[0]
        str_vo v9, x0, 128
        sqrdmulh v14.4S, v21.4S, v4.S[3]
        add v11.4S, v23.4S, v18.4S
        mul v13.4S, v21.4S, v4.S[2]
        sub v30.4S, v22.4S, v30.4S
        mla v20.4S, v16.4S, v29.4S
        add v19.4S, v25.4S, v15.4S
        mla v13.4S, v14.4S, v29.4S
        str_vi v19, x0, 16
        sqrdmulh v12.4S, v26.4S, v5.S[3]
        sub v28.4S, v23.4S, v18.4S
        str_vo v11, x0, 880
        add v24.4S, v30.4S, v20.4S
        mul v27.4S, v26.4S, v5.S[2]
        sub v14.4S, v30.4S, v20.4S
        str_vo v28, x0, 944
        str_vo v24, x0, 368
        mla v27.4S, v12.4S, v29.4S
        add v20.4S, v10.4S, v13.4S
        str_vo v14, x0, 432
        str_vo v20, x0, 240
        sub v12.4S, v10.4S, v13.4S
        sub v21.4S, v25.4S, v15.4S
        str_vo v12, x0, 304
        str_vo v21, x0, 48
        add v26.4S, v17.4S, v27.4S
        sub v23.4S, v17.4S, v27.4S
        str_vo v26, x0, 496
        str_vo v23, x0, 560

        restore inp, STACK0
        mov count, #16

        .unreq root4
        .unreq root5
        .unreq root6
        .unreq root7
        .unreq qform_root4
        .unreq qform_root5
        .unreq qform_root6
        .unreq qform_root7
        root0_tw .req v4
        root1_tw .req v5
        root2_tw .req v6
        root3_tw .req v7
        qform_root0_tw .req q4
        qform_root1_tw .req q5
        qform_root2_tw .req q6
        qform_root3_tw .req q7

        .p2align 2
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        ldr_vo v17, x1, 48                        // .*................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        ldr_vi v25, x3, 16                        // *.................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        ldr_vo v14, x1, 32                        // ....*.............
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        sqrdmulh v0.4S, v17.4S, v25.S[1]          // ...*..............
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        mul v11.4S, v17.4S, v25.S[0]              // ..*...............
        // gap                                    // ..................
        sqrdmulh v12.4S, v14.4S, v25.S[1]         // ......*...........
        // gap                                    // ..................
        // gap                                    // ..................
        ldr_vo v24, x1, 16                        // .........*........
        mla v11.4S, v0.4S, v29.4S                 // .....*............
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        mul v18.4S, v14.4S, v25.S[0]              // .......*..........
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        ldr_vi v5, x3, 8                          // ..........*.......
        add v30.4S, v24.4S, v11.4S                // .............*....
        // gap                                    // ..................
        mla v18.4S, v12.4S, v29.4S                // ........*.........
        // gap                                    // ..................
        // gap                                    // ..................
        ldr_vo v6, x1, 0                          // ...........*......
        sqrdmulh v17.4S, v30.4S, v25.S[3]         // ..............*...
        // gap                                    // ..................
        mul v21.4S, v30.4S, v25.S[2]              // ................*.
        sub v8.4S, v24.4S, v11.4S                 // ............*.....
        // gap                                    // ..................
        // gap                                    // ..................
        mul v24.4S, v8.4S, v5.S[0]                // .................*
        // gap                                    // ..................
        sqrdmulh v5.4S, v8.4S, v5.S[1]            // ...............*..
        // gap                                    // ..................
        // gap                                    // ..................
        // gap                                    // ..................
        
        // original source code
        // ldr_vi v20, x3, 16                     // .*................ || .*.........
        // ldr_vo v17, x1, 48                     // *................. || *..........
        // mul v27.4S, v17.4S, v20.S[0]           // ....*............. || .....*.....
        // sqrdmulh v23.4S, v17.4S, v20.S[1]      // ...*.............. || ....*......
        // ldr_vo v11, x1, 32                     // ..*............... || ..*........
        // mla v27.4S, v23.4S, v29.4S             // .......*.......... || ......*....
        // sqrdmulh v16.4S, v11.4S, v20.S[1]      // .....*............ || .....*.....
        // mul v18.4S, v11.4S, v20.S[0]           // ........*......... || .......*...
        // mla v18.4S, v16.4S, v29.4S             // ...........*...... || ........*..
        // ldr_vo v2, x1, 16                      // ......*........... || .....*.....
        // ldr_vi v3, x3, 8                       // .........*........ || .......*...
        // ldr_vo v6, x1, 0                       // ............*..... || ........*..
        // sub v28.4S, v2.4S, v27.4S              // ...............*.. || .........*.
        // add v11.4S, v2.4S, v27.4S              // ..........*....... || ........*..
        // sqrdmulh v17.4S, v11.4S, v20.S[3]      // .............*.... || .........*.
        // sqrdmulh v5.4S, v28.4S, v3.S[1]        // .................* || ..........*
        // mul v21.4S, v11.4S, v20.S[2]           // ..............*... || .........*.
        // mul v24.4S, v28.4S, v3.S[0]            // ................*. || ..........*
        
        sub count, count, #1
.p2align 2
layer5678_start:
        mla v21.4S, v17.4S, v29.4S                           // ..................*..........................................
        // gap                                               // .............................................................
        mla v24.4S, v5.4S, v29.4S                            // .......................*.....................................
        sub v4.4S, v6.4S, v18.4S                             // .........*...................................................
        // gap                                               // .............................................................
        ldr_vi v20, x3, 16                                   // ....e........................................................
        // gap                                               // .............................................................
        // gap                                               // .............................................................
        // gap                                               // .............................................................
        add v23.4S, v6.4S, v18.4S                            // ..........*..................................................
        // gap                                               // .............................................................
        ldr_vo v17, x1, 112                                  // ...e.........................................................
        sub v25.4S, v4.4S, v24.4S                            // ........................*....................................
        add v18.4S, v23.4S, v21.4S                           // ....................*........................................
        sub v16.4S, v23.4S, v21.4S                           // ...................*.........................................
        add v23.4S, v4.4S, v24.4S                            // .........................*...................................
        // gap                                               // .............................................................
        ldr_vo v15, x4, 16                                   // ...................................*.........................
        trn1 v1.4S, v23.4S, v25.4S                           // ............................*................................
        trn2 v19.4S, v18.4S, v16.4S                          // ...........................*.................................
        trn2 v21.4S, v23.4S, v25.4S                          // .............................*...............................
        trn1 v12.4S, v18.4S, v16.4S                          // ..........................*..................................
        // gap                                               // .............................................................
        ldr_vi v18, x4, 96                                   // ..................................*..........................
        mul v27.4S, v17.4S, v20.S[0]                         // ...........e.................................................
        trn2 v4.2D, v19.2D, v21.2D                           // ...............................*.............................
        sqrdmulh v23.4S, v17.4S, v20.S[1]                    // ............e................................................
        trn2 v25.2D, v12.2D, v1.2D                           // ..............................*..............................
        // gap                                               // .............................................................
        ldr_vo v11, x1, 96                                   // ..e..........................................................
        sqrdmulh v16.4S, v4.4S, v15.4S                       // ..............................................*..............
        trn1 v8.2D, v19.2D, v21.2D                           // .................................*...........................
        sqrdmulh v24.4S, v25.4S, v15.4S                      // .........................................*...................
        // gap                                               // .............................................................
        // gap                                               // .............................................................
        ldr_vo v19, x4, -16                                  // .......................................*.....................
        mul v21.4S, v4.4S, v18.4S                            // .............................................*...............
        // gap                                               // .............................................................
        mla v27.4S, v23.4S, v29.4S                           // .............e...............................................
        // gap                                               // .............................................................
        // gap                                               // .............................................................
        ldr_vo v23, x4, -32                                  // ......................................*......................
        mla v21.4S, v16.4S, v29.4S                           // ...............................................*.............
        // gap                                               // .............................................................
        sqrdmulh v16.4S, v11.4S, v20.S[1]                    // .......e.....................................................
        // gap                                               // .............................................................
        // gap                                               // .............................................................
        ldr_vo v6, x4, -48                                   // .....................................*.......................
        mul v25.4S, v25.4S, v18.4S                           // ........................................*....................
        // gap                                               // .............................................................
        mul v18.4S, v11.4S, v20.S[0]                         // ......e......................................................
        // gap                                               // .............................................................
        // gap                                               // .............................................................
        ldr_vo v10, x4, -64                                  // ....................................*........................
        mla v25.4S, v24.4S, v29.4S                           // ..........................................*..................
        sub v15.4S, v8.4S, v21.4S                            // ................................................*............
        mla v18.4S, v16.4S, v29.4S                           // ........e....................................................
        add v4.4S, v8.4S, v21.4S                             // .................................................*...........
        // gap                                               // .............................................................
        ldr_vo v2, x1, 80                                    // .e...........................................................
        sqrdmulh v24.4S, v15.4S, v19.4S                      // ........................................................*....
        // gap                                               // .............................................................
        sqrdmulh v21.4S, v4.4S, v6.4S                        // ...................................................*.........
        // gap                                               // .............................................................
        // gap                                               // .............................................................
        ldr_vi v3, x3, 8                                     // .....e.......................................................
        mul v15.4S, v15.4S, v23.4S                           // .......................................................*.....
        trn1 v23.2D, v12.2D, v1.2D                           // ................................*............................
        mul v19.4S, v4.4S, v10.4S                            // ..................................................*..........
        // gap                                               // .............................................................
        // gap                                               // .............................................................
        ldr_vo v6, x1, 64                                    // e............................................................
        mla v15.4S, v24.4S, v29.4S                           // .........................................................*...
        sub v28.4S, v2.4S, v27.4S                            // ..............e..............................................
        mla v19.4S, v21.4S, v29.4S                           // ....................................................*........
        add v11.4S, v2.4S, v27.4S                            // ...............e.............................................
        // gap                                               // .............................................................
        // gap                                               // .............................................................
        sqrdmulh v17.4S, v11.4S, v20.S[3]                    // .................e...........................................
        sub v21.4S, v23.4S, v25.4S                           // ...........................................*.................
        sqrdmulh v5.4S, v28.4S, v3.S[1]                      // ......................e......................................
        add v24.4S, v23.4S, v25.4S                           // ............................................*................
        // gap                                               // .............................................................
        // gap                                               // .............................................................
        sub v26.4S, v21.4S, v15.4S                           // ..........................................................*..
        add v23.4S, v24.4S, v19.4S                           // ......................................................*......
        sub v24.4S, v24.4S, v19.4S                           // .....................................................*.......
        add v25.4S, v21.4S, v15.4S                           // ...........................................................*.
        // gap                                               // .............................................................
        // gap                                               // .............................................................
        mul v21.4S, v11.4S, v20.S[2]                         // ................e............................................
        st4 {v23.4S,v24.4S,v25.4S,v26.4S}, [x1], #64         // ............................................................*
        mul v24.4S, v28.4S, v3.S[0]                          // .....................e.......................................
        // gap                                               // .............................................................
        // gap                                               // .............................................................
        // gap                                               // .............................................................
        
        // original source code
        // ldr_vo v8, x1, 0                                // ..........................................e........................................................................... || ...........e....................
        // ldr_vo v9, x1, 16                               // ...................................e.................................................................................. || .........e......................
        // ldr_vo v10, x1, 32                              // .................e.................................................................................................... || ....e...........................
        // ldr_vo v11, x1, 48                              // ..e................................................................................................................... || .e..............................
        // ldr_vi v0, x3, 16                               // e..................................................................................................................... || e...............................
        // ldr_vi v1, x3, 8                                // ......................................e............................................................................... || ..........e.....................
        // mul v24.4S, v10.4S, v0.S[0]                     // .............................e........................................................................................ || ........e.......................
        // sqrdmulh v10.4S, v10.4S, v0.S[1]                // ..........................e........................................................................................... || .......e........................
        // mla v24.4S, v10.4S, v29.4S                      // .................................e.................................................................................... || .........e......................
        // sub v10.4S, v8.4S, v24.4S                       // ............................................................*......................................................... || ................*...............
        // add v8.4S, v8.4S, v24.4S                        // ..............................................................*....................................................... || .................*..............
        // mul v24.4S, v11.4S, v0.S[0]                     // .............e........................................................................................................ || ....e...........................
        // sqrdmulh v11.4S, v11.4S, v0.S[1]                // ...............e...................................................................................................... || ....e...........................
        // mla v24.4S, v11.4S, v29.4S                      // .......................e.............................................................................................. || ......e.........................
        // sub v11.4S, v9.4S, v24.4S                       // ............................................e......................................................................... || ............e...................
        // add v9.4S, v9.4S, v24.4S                        // ..............................................e....................................................................... || ............e...................
        // mul v24.4S, v9.4S, v0.S[2]                      // .......................................................e.............................................................. || ...............e................
        // sqrdmulh v9.4S, v9.4S, v0.S[3]                  // ...............................................e...................................................................... || .............e..................
        // mla v24.4S, v9.4S, v29.4S                       // ..........................................................*........................................................... || ................*...............
        // sub v9.4S, v8.4S, v24.4S                        // ..................................................................*................................................... || ..................*.............
        // add v8.4S, v8.4S, v24.4S                        // .................................................................*.................................................... || ..................*.............
        // mul v24.4S, v11.4S, v1.S[0]                     // .........................................................e............................................................ || ...............e................
        // sqrdmulh v11.4S, v11.4S, v1.S[1]                // .................................................e.................................................................... || .............e..................
        // mla v24.4S, v11.4S, v29.4S                      // ...........................................................*.......................................................... || ................*...............
        // sub v11.4S, v10.4S, v24.4S                      // ................................................................*..................................................... || ..................*.............
        // add v10.4S, v10.4S, v24.4S                      // ...................................................................*.................................................. || ..................*.............
        // trn1 v25.4S, v8.4S, v9.4S                       // ........................................................................*............................................. || ...................*............
        // trn2 v26.4S, v8.4S, v9.4S                       // ......................................................................*............................................... || ...................*............
        // trn1 v27.4S, v10.4S, v11.4S                     // .....................................................................*................................................ || ...................*............
        // trn2 v28.4S, v10.4S, v11.4S                     // .......................................................................*.............................................. || ...................*............
        // trn2 v10.2D, v25.2D, v27.2D                     // .............................................................................*........................................ || ....................*...........
        // trn2 v11.2D, v26.2D, v28.2D                     // ...........................................................................*.......................................... || ....................*...........
        // trn1 v8.2D, v25.2D, v27.2D                      // .....................................................................................................*................ || ...........................*....
        // trn1 v9.2D, v26.2D, v28.2D                      // ................................................................................*..................................... || .....................*..........
        // ldr_vi v0, x4, 96                               // .........................................................................*............................................ || ...................*............
        // ldr_vo v4, x4, -80                              // ....................................................................*................................................. || ..................*.............
        // ldr_vo v1, x4, -64                              // ...........................................................................................*.......................... || ........................*.......
        // ldr_vo v5, x4, -48                              // ........................................................................................*............................. || .......................*........
        // ldr_vo v2, x4, -32                              // .....................................................................................*................................ || ......................*.........
        // ldr_vo v6, x4, -16                              // ..................................................................................*................................... || .....................*..........
        // mul v24.4S, v10.4S, v0.4S                       // .........................................................................................*............................ || ........................*.......
        // sqrdmulh v10.4S, v10.4S, v4.4S                  // .................................................................................*.................................... || .....................*..........
        // mla v24.4S, v10.4S, v29.4S                      // ............................................................................................*......................... || .........................*......
        // sub v10.4S, v8.4S, v24.4S                       // .............................................................................................................*........ || .............................*..
        // add v8.4S, v8.4S, v24.4S                        // ...............................................................................................................*...... || .............................*..
        // mul v24.4S, v11.4S, v0.4S                       // ...................................................................................*.................................. || ......................*.........
        // sqrdmulh v11.4S, v11.4S, v4.4S                  // ...............................................................................*...................................... || .....................*..........
        // mla v24.4S, v11.4S, v29.4S                      // ......................................................................................*............................... || .......................*........
        // sub v11.4S, v9.4S, v24.4S                       // .............................................................................................*........................ || .........................*......
        // add v9.4S, v9.4S, v24.4S                        // ...............................................................................................*...................... || .........................*......
        // mul v24.4S, v9.4S, v1.4S                        // ......................................................................................................*............... || ...........................*....
        // sqrdmulh v9.4S, v9.4S, v5.4S                    // ..................................................................................................*................... || ..........................*.....
        // mla v24.4S, v9.4S, v29.4S                       // ..........................................................................................................*........... || ............................*...
        // sub v9.4S, v8.4S, v24.4S                        // ..................................................................................................................*... || ..............................*.
        // add v8.4S, v8.4S, v24.4S                        // .................................................................................................................*.... || ..............................*.
        // mul v24.4S, v11.4S, v2.4S                       // ....................................................................................................*................. || ...........................*....
        // sqrdmulh v11.4S, v11.4S, v6.4S                  // .................................................................................................*.................... || ..........................*.....
        // mla v24.4S, v11.4S, v29.4S                      // ........................................................................................................*............. || ............................*...
        // sub v11.4S, v10.4S, v24.4S                      // ................................................................................................................*..... || ..............................*.
        // add v10.4S, v10.4S, v24.4S                      // ...................................................................................................................*.. || ..............................*.
        // st4 {v8.4S,v9.4S,v10.4S,v11.4S}, [x1], #64      // .....................................................................................................................* || ...............................*
        
        subs count, count, #1
        cbnz count, layer5678_start
        mla v24.4S, v5.4S, v29.4S                            // .*.........................................
        // gap                                               // ...........................................
        mla v21.4S, v17.4S, v29.4S                           // *..........................................
        sub v23.4S, v6.4S, v18.4S                            // ..*........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        add v15.4S, v6.4S, v18.4S                            // ...*.......................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        sub v19.4S, v15.4S, v21.4S                           // ......*....................................
        add v21.4S, v15.4S, v21.4S                           // .....*.....................................
        sub v28.4S, v23.4S, v24.4S                           // ....*......................................
        add v24.4S, v23.4S, v24.4S                           // .......*...................................
        // gap                                               // ...........................................
        ldr_vo v15, x4, 16                                   // ........*..................................
        trn2 v4.4S, v21.4S, v19.4S                           // ..........*................................
        trn1 v8.4S, v21.4S, v19.4S                           // ............*..............................
        trn2 v23.4S, v24.4S, v28.4S                          // ...........*...............................
        trn1 v28.4S, v24.4S, v28.4S                          // .........*.................................
        // gap                                               // ...........................................
        ldr_vi v6, x4, 96                                    // .............*.............................
        trn2 v21.2D, v4.2D, v23.2D                           // ..............*............................
        trn2 v24.2D, v8.2D, v28.2D                           // ...............*...........................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        sqrdmulh v19.4S, v21.4S, v15.4S                      // ................*..........................
        trn1 v18.2D, v4.2D, v23.2D                           // .................*.........................
        sqrdmulh v15.4S, v24.4S, v15.4S                      // ..................*........................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        ldr_vo v23, x4, -64                                  // .........................*.................
        mul v4.4S, v24.4S, v6.4S                             // ........................*..................
        // gap                                               // ...........................................
        mul v24.4S, v21.4S, v6.4S                            // ....................*......................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        ldr_vo v21, x4, -16                                  // ...................*.......................
        mla v24.4S, v19.4S, v29.4S                           // ......................*....................
        // gap                                               // ...........................................
        mla v4.4S, v15.4S, v29.4S                            // ..........................*................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        ldr_vo v15, x4, -48                                  // .......................*...................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        ldr_vo v6, x4, -32                                   // .....................*.....................
        sub v19.4S, v18.4S, v24.4S                           // ...........................*...............
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        add v24.4S, v18.4S, v24.4S                           // ............................*..............
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        sqrdmulh v15.4S, v24.4S, v15.4S                      // ..............................*............
        // gap                                               // ...........................................
        sqrdmulh v18.4S, v19.4S, v21.4S                      // .............................*.............
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        mul v21.4S, v24.4S, v23.4S                           // .................................*.........
        trn1 v24.2D, v8.2D, v28.2D                           // ................................*..........
        mul v19.4S, v19.4S, v6.4S                            // ...............................*...........
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        mla v21.4S, v15.4S, v29.4S                           // ...................................*.......
        // gap                                               // ...........................................
        mla v19.4S, v18.4S, v29.4S                           // ..................................*........
        sub v15.4S, v24.4S, v4.4S                            // ....................................*......
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        add v24.4S, v24.4S, v4.4S                            // .....................................*.....
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        sub v22.4S, v24.4S, v21.4S                           // ........................................*..
        add v21.4S, v24.4S, v21.4S                           // .......................................*...
        sub v24.4S, v15.4S, v19.4S                           // ......................................*....
        add v23.4S, v15.4S, v19.4S                           // .........................................*.
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        st4 {v21.4S,v22.4S,v23.4S,v24.4S}, [x1], #64         // ..........................................*
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        // gap                                               // ...........................................
        
        // original source code
        // mla v21.4S, v17.4S, v29.4S                        // .*......................................... || *...............
        // mla v24.4S, v5.4S, v29.4S                         // *.......................................... || *...............
        // sub v4.4S, v6.4S, v18.4S                          // ..*........................................ || *...............
        // add v23.4S, v6.4S, v18.4S                         // ...*....................................... || .*..............
        // sub v25.4S, v4.4S, v24.4S                         // ......*.................................... || ..*.............
        // add v18.4S, v23.4S, v21.4S                        // .....*..................................... || ..*.............
        // sub v16.4S, v23.4S, v21.4S                        // ....*...................................... || ..*.............
        // add v23.4S, v4.4S, v24.4S                         // .......*................................... || ..*.............
        // ldr_vo v15, x4, 16                                // ........*.................................. || ..*.............
        // trn1 v1.4S, v23.4S, v25.4S                        // ............*.............................. || ...*............
        // trn2 v19.4S, v18.4S, v16.4S                       // .........*................................. || ...*............
        // trn2 v21.4S, v23.4S, v25.4S                       // ...........*............................... || ...*............
        // trn1 v12.4S, v18.4S, v16.4S                       // ..........*................................ || ...*............
        // ldr_vi v18, x4, 96                                // .............*............................. || ...*............
        // trn2 v4.2D, v19.2D, v21.2D                        // ..............*............................ || ....*...........
        // trn2 v25.2D, v12.2D, v1.2D                        // ...............*........................... || ....*...........
        // sqrdmulh v16.4S, v4.4S, v15.4S                    // ................*.......................... || .....*..........
        // trn1 v8.2D, v19.2D, v21.2D                        // .................*......................... || .....*..........
        // sqrdmulh v24.4S, v25.4S, v15.4S                   // ..................*........................ || .....*..........
        // ldr_vo v19, x4, -16                               // ......................*.................... || ......*.........
        // mul v21.4S, v4.4S, v18.4S                         // .....................*..................... || ......*.........
        // ldr_vo v23, x4, -32                               // ..........................*................ || ........*.......
        // mla v21.4S, v16.4S, v29.4S                        // .......................*................... || .......*........
        // ldr_vo v6, x4, -48                                // .........................*................. || .......*........
        // mul v25.4S, v25.4S, v18.4S                        // ....................*...................... || ......*.........
        // ldr_vo v10, x4, -64                               // ...................*....................... || .....*..........
        // mla v25.4S, v24.4S, v29.4S                        // ........................*.................. || .......*........
        // sub v15.4S, v8.4S, v21.4S                         // ...........................*............... || .........*......
        // add v4.4S, v8.4S, v21.4S                          // ............................*.............. || .........*......
        // sqrdmulh v24.4S, v15.4S, v19.4S                   // ..............................*............ || ..........*.....
        // sqrdmulh v21.4S, v4.4S, v6.4S                     // .............................*............. || ..........*.....
        // mul v15.4S, v15.4S, v23.4S                        // .................................*......... || ...........*....
        // trn1 v23.2D, v12.2D, v1.2D                        // ................................*.......... || ...........*....
        // mul v19.4S, v4.4S, v10.4S                         // ...............................*........... || ...........*....
        // mla v15.4S, v24.4S, v29.4S                        // ...................................*....... || ............*...
        // mla v19.4S, v21.4S, v29.4S                        // ..................................*........ || ............*...
        // sub v21.4S, v23.4S, v25.4S                        // ....................................*...... || ............*...
        // add v24.4S, v23.4S, v25.4S                        // .....................................*..... || .............*..
        // sub v26.4S, v21.4S, v15.4S                        // ........................................*.. || ..............*.
        // add v23.4S, v24.4S, v19.4S                        // .......................................*... || ..............*.
        // sub v24.4S, v24.4S, v19.4S                        // ......................................*.... || ..............*.
        // add v25.4S, v21.4S, v15.4S                        // .........................................*. || ..............*.
        // st4 {v23.4S,v24.4S,v25.4S,v26.4S}, [x1], #64      // ..........................................* || ...............*
        

       pop_stack
       ret