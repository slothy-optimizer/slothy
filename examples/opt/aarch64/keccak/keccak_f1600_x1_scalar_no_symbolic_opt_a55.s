/*
 * Copyright (c) 2021-2022 Arm Limited
 * Copyright (c) 2022 Matthias Kannwischer
 * SPDX-License-Identifier: MIT
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */


// Author: Hanno Becker <hanno.becker@arm.com>
// Author: Matthias Kannwischer <matthias@kannwischer.eu>

#include <hal_env.h>
#include "macros.s"

/********************** CONSTANTS *************************/
    .data
    .balign 64
round_constants:
    .quad 0x0000000000000001
    .quad 0x0000000000008082
    .quad 0x800000000000808a
    .quad 0x8000000080008000
    .quad 0x000000000000808b
    .quad 0x0000000080000001
    .quad 0x8000000080008081
    .quad 0x8000000000008009
    .quad 0x000000000000008a
    .quad 0x0000000000000088
    .quad 0x0000000080008009
    .quad 0x000000008000000a
    .quad 0x000000008000808b
    .quad 0x800000000000008b
    .quad 0x8000000000008089
    .quad 0x8000000000008003
    .quad 0x8000000000008002
    .quad 0x8000000000000080
    .quad 0x000000000000800a
    .quad 0x800000008000000a
    .quad 0x8000000080008081
    .quad 0x8000000000008080
    .quad 0x0000000080000001
    .quad 0x8000000080008008

/****************** REGISTER ALLOCATIONS *******************/

    input_addr     .req x0
    const_addr     .req x26

    /* Mapping of Kecck-f1600 state to scalar registers
     * at the beginning and end of each round. */
    Aba     .req x1
    Abe     .req x6
    Abi     .req x11
    Abo     .req x16
    Abu     .req x21
    Aga     .req x2
    Age     .req x7
    Agi     .req x12
    Ago     .req x17
    Agu     .req x22
    Aka     .req x3
    Ake     .req x8
    Aki     .req x13
    Ako     .req x28
    Aku     .req x23
    Ama     .req x4
    Ame     .req x9
    Ami     .req x14
    Amo     .req x19
    Amu     .req x24
    Asa     .req x5
    Ase     .req x10
    Asi     .req x15
    Aso     .req x20
    Asu     .req x25

/************************ MACROS ****************************/

#define STACK_LOCS 40

#define STACK_SIZE (16*6 + 3*8 + 8 + (STACK_LOCS) * 8) // GPRs (16*6), count (8), const (8), input (8), padding (8)
#define STACK_BASE_GPRS (3*8+8)
#define STACK_OFFSET_INPUT (0*8)
#define STACK_OFFSET_CONST (1*8)
#define STACK_OFFSET_COUNT (2*8)

#define STACK_OFFSET_LOCS (16*6 + 4*8)
#define STACK_LOC_0 ((STACK_OFFSET_LOCS) + 0*8)
#define STACK_LOC_1 ((STACK_OFFSET_LOCS) + 1*8)
#define STACK_LOC_2 ((STACK_OFFSET_LOCS) + 2*8)
#define STACK_LOC_3 ((STACK_OFFSET_LOCS) + 3*8)
#define STACK_LOC_4 ((STACK_OFFSET_LOCS) + 4*8)
#define STACK_LOC_5 ((STACK_OFFSET_LOCS) + 5*8)
#define STACK_LOC_6 ((STACK_OFFSET_LOCS) + 6*8)
#define STACK_LOC_7 ((STACK_OFFSET_LOCS) + 7*8)
#define STACK_LOC_8 ((STACK_OFFSET_LOCS) + 8*8)
#define STACK_LOC_9 ((STACK_OFFSET_LOCS) + 9*8)
#define STACK_LOC_10 ((STACK_OFFSET_LOCS) + 10*8)
#define STACK_LOC_11 ((STACK_OFFSET_LOCS) + 11*8)
#define STACK_LOC_12 ((STACK_OFFSET_LOCS) + 12*8)
#define STACK_LOC_13 ((STACK_OFFSET_LOCS) + 13*8)
#define STACK_LOC_14 ((STACK_OFFSET_LOCS) + 14*8)
#define STACK_LOC_15 ((STACK_OFFSET_LOCS) + 15*8)
#define STACK_LOC_16 ((STACK_OFFSET_LOCS) + 16*8)
#define STACK_LOC_17 ((STACK_OFFSET_LOCS) + 17*8)
#define STACK_LOC_18 ((STACK_OFFSET_LOCS) + 18*8)
#define STACK_LOC_19 ((STACK_OFFSET_LOCS) + 19*8)
#define STACK_LOC_20 ((STACK_OFFSET_LOCS) + 20*8)
#define STACK_LOC_21 ((STACK_OFFSET_LOCS) + 21*8)
#define STACK_LOC_22 ((STACK_OFFSET_LOCS) + 22*8)
#define STACK_LOC_23 ((STACK_OFFSET_LOCS) + 23*8)
#define STACK_LOC_24 ((STACK_OFFSET_LOCS) + 24*8)
#define STACK_LOC_25 ((STACK_OFFSET_LOCS) + 25*8)
#define STACK_LOC_26 ((STACK_OFFSET_LOCS) + 26*8)
#define STACK_LOC_27 ((STACK_OFFSET_LOCS) + 27*8)
#define STACK_LOC_28 ((STACK_OFFSET_LOCS) + 28*8)
#define STACK_LOC_29 ((STACK_OFFSET_LOCS) + 29*8)
#define STACK_LOC_30 ((STACK_OFFSET_LOCS) + 30*8)
#define STACK_LOC_31 ((STACK_OFFSET_LOCS) + 31*8)
#define STACK_LOC_32 ((STACK_OFFSET_LOCS) + 32*8)
#define STACK_LOC_33 ((STACK_OFFSET_LOCS) + 33*8)
#define STACK_LOC_34 ((STACK_OFFSET_LOCS) + 34*8)
#define STACK_LOC_35 ((STACK_OFFSET_LOCS) + 35*8)
#define STACK_LOC_36 ((STACK_OFFSET_LOCS) + 36*8)
#define STACK_LOC_37 ((STACK_OFFSET_LOCS) + 37*8)
#define STACK_LOC_38 ((STACK_OFFSET_LOCS) + 38*8)
#define STACK_LOC_39 ((STACK_OFFSET_LOCS) + 39*8)

.macro alloc_stack
    sub sp, sp, #(STACK_SIZE)
.endm

.macro free_stack
    add sp, sp, #(STACK_SIZE)
.endm

.macro save_gprs
    stp x19, x20, [sp, #(STACK_BASE_GPRS + 16*0)]
    stp x21, x22, [sp, #(STACK_BASE_GPRS + 16*1)]
    stp x23, x24, [sp, #(STACK_BASE_GPRS + 16*2)]
    stp x25, x26, [sp, #(STACK_BASE_GPRS + 16*3)]
    stp x27, x28, [sp, #(STACK_BASE_GPRS + 16*4)]
    stp x29, x30, [sp, #(STACK_BASE_GPRS + 16*5)]
.endm

.macro restore_gprs
    ldp x19, x20, [sp, #(STACK_BASE_GPRS + 16*0)]
    ldp x21, x22, [sp, #(STACK_BASE_GPRS + 16*1)]
    ldp x23, x24, [sp, #(STACK_BASE_GPRS + 16*2)]
    ldp x25, x26, [sp, #(STACK_BASE_GPRS + 16*3)]
    ldp x27, x28, [sp, #(STACK_BASE_GPRS + 16*4)]
    ldp x29, x30, [sp, #(STACK_BASE_GPRS + 16*5)]
.endm

.macro eor5 dst, src0, src1, src2, src3, src4
    eor \dst, \src0, \src1
    eor \dst, \dst,  \src2
    eor \dst, \dst,  \src3
    eor \dst, \dst,  \src4
.endm

.macro  chi_step_ror out, a, b, c, r1, r2
    bic X<tmp>, \b\(), \c\(), ror #\r1
    eor \out\(), X<tmp>, \a\(), ror #\r2
.endm

.macro  chi_step_ror2 out, a, b, c, r1, r2
    bic X<tmp>, \b\(), \c\(), ror #\r1
    eor \out\(), \a\(), X<tmp>, ror #\r2
.endm

.macro keccak_f1600_round_initial
    eor5 X<C0>, Ama, Asa, Aba, Aga, Aka
    eor5 X<C1>, Ame, Ase, Abe, Age, Ake
    eor5 X<C2>, Ami, Asi, Abi, Agi, Aki
    eor5 X<C3>, Amo, Aso, Abo, Ago, Ako
    eor5 X<C4>, Amu, Asu, Abu, Agu, Aku

    eor X<E1>, X<C0>, X<C2>, ror #63
    eor X<E3>, X<C2>, X<C4>, ror #63
    eor X<E0>, X<C4>, X<C1>, ror #63
    eor X<E2>, X<C1>, X<C3>, ror #63
    eor X<E4>, X<C3>, X<C0>, ror #63

    eor X<Bba>, Aba, X<E0>
    eor X<Bsa>, Abi, X<E2>
    eor X<Bbi>, Aki, X<E2>
    eor X<Bki>, Ako, X<E3>
    eor X<Bko>, Amu, X<E4>
    eor X<Bmu>, Aso, X<E3>
    eor X<Bso>, Ama, X<E0>
    eor X<Bka>, Abe, X<E1>
    eor X<Bse>, Ago, X<E3>
    eor X<Bgo>, Ame, X<E1>
    eor X<Bke>, Agi, X<E2>
    eor X<Bgi>, Aka, X<E0>
    eor X<Bga>, Abo, X<E3>
    eor X<Bbo>, Amo, X<E3>
    eor X<Bmo>, Ami, X<E2>
    eor X<Bmi>, Ake, X<E1>
    eor X<Bge>, Agu, X<E4>
    eor X<Bgu>, Asi, X<E2>
    eor X<Bsi>, Aku, X<E4>
    eor X<Bku>, Asa, X<E0>
    eor X<Bma>, Abu, X<E4>
    eor X<Bbu>, Asu, X<E4>
    eor X<Bsu>, Ase, X<E1>
    eor X<Bme>, Aga, X<E0>
    eor X<Bbe>, Age, X<E1>

    ldr X<caddr>, [sp, #STACK_OFFSET_CONST]
    ldr X<cur_const>, [X<caddr>]
    mov X<count>, #1
    str X<count>, [sp, #STACK_OFFSET_COUNT] // @slothy:writes=STACK_OFFSET_COUNT

    chi_step_ror Aga, X<Bga>, X<Bgi>, X<Bge>, 47, 39
    chi_step_ror Age, X<Bge>, X<Bgo>, X<Bgi>, 42, 25
    chi_step_ror Agi, X<Bgi>, X<Bgu>, X<Bgo>, 16, 58
    chi_step_ror Ago, X<Bgo>, X<Bga>, X<Bgu>, 31, 47
    chi_step_ror Agu, X<Bgu>, X<Bge>, X<Bga>, 56, 23
    chi_step_ror Aka, X<Bka>, X<Bki>, X<Bke>, 19, 24
    chi_step_ror Ake, X<Bke>, X<Bko>, X<Bki>, 47, 2
    chi_step_ror Aki, X<Bki>, X<Bku>, X<Bko>, 10, 57
    chi_step_ror Ako, X<Bko>, X<Bka>, X<Bku>, 47, 57
    chi_step_ror Aku, X<Bku>, X<Bke>, X<Bka>, 5,  52
    chi_step_ror Ama, X<Bma>, X<Bmi>, X<Bme>, 38, 47
    chi_step_ror Ame, X<Bme>, X<Bmo>, X<Bmi>, 5,  43
    chi_step_ror Ami, X<Bmi>, X<Bmu>, X<Bmo>, 41, 46
    chi_step_ror Amo, X<Bmo>, X<Bma>, X<Bmu>, 35, 12
    chi_step_ror Amu, X<Bmu>, X<Bme>, X<Bma>, 9,  44
    chi_step_ror Asa, X<Bsa>, X<Bsi>, X<Bse>, 48, 41
    chi_step_ror Ase, X<Bse>, X<Bso>, X<Bsi>, 2,  50
    chi_step_ror Asi, X<Bsi>, X<Bsu>, X<Bso>, 25, 27
    chi_step_ror Aso, X<Bso>, X<Bsa>, X<Bsu>, 60, 21
    chi_step_ror Asu, X<Bsu>, X<Bse>, X<Bsa>, 57, 53
    chi_step_ror2 Aba, X<Bba>, X<Bbi>, X<Bbe>, 63, 21
    chi_step_ror Abe, X<Bbe>, X<Bbo>, X<Bbi>, 42, 41
    chi_step_ror Abi, X<Bbi>, X<Bbu>, X<Bbo>, 57, 35
    chi_step_ror Abo, X<Bbo>, X<Bba>, X<Bbu>, 50, 43
    chi_step_ror Abu, X<Bbu>, X<Bbe>, X<Bba>, 44, 30

    eor Aba, Aba, X<cur_const>

.endm

.macro keccak_f1600_round_noninitial

    eor X<C0>, Aba,   Aga, ror #61
    eor X<C0>, X<C0>, Ama, ror #54
    eor X<C0>, X<C0>, Aka, ror #39
    eor X<C0>, X<C0>, Asa, ror #25

    eor X<C1>, Ake,   Ame, ror #57
    eor X<C1>, X<C1>, Abe, ror #51
    eor X<C1>, X<C1>, Ase, ror #31
    eor X<C1>, X<C1>, Age, ror #27

    eor X<C2>, Asi,   Abi, ror #52
    eor X<C2>, X<C2>, Aki, ror #48
    eor X<C2>, X<C2>, Ami, ror #10
    eor X<C2>, X<C2>, Agi, ror #5

    eor X<C3>, Abo,   Ako, ror #63
    eor X<C3>, X<C3>, Amo, ror #37
    eor X<C3>, X<C3>, Ago, ror #36
    eor X<C3>, X<C3>, Aso, ror #2

    eor X<C4>, Aku,   Agu, ror #50
    eor X<C4>, X<C4>, Amu, ror #34
    eor X<C4>, X<C4>, Abu, ror #26
    eor X<C4>, X<C4>, Asu, ror #15

    eor X<E1>, X<C0>, X<C2>, ror #61
    ror X<C2>, X<C2>, #62
    eor X<E3>, X<C2>, X<C4>, ror #57
    ror X<C4>, X<C4>, #58
    eor X<E0>, X<C4>, X<C1>, ror #55
    ror X<C1>, X<C1>, #56
    eor X<E2>, X<C1>, X<C3>, ror #63
    eor X<E4>, X<C3>, X<C0>, ror #63

    eor X<Bba>, X<E0>, Aba
    eor X<Bsa>, X<E2>, Abi, ror #50
    eor X<Bbi>, X<E2>, Aki, ror #46
    eor X<Bki>, X<E3>, Ako, ror #63
    eor X<Bko>, X<E4>, Amu, ror #28
    eor X<Bmu>, X<E3>, Aso, ror #2
    eor X<Bso>, X<E0>, Ama, ror #54
    eor X<Bka>, X<E1>, Abe, ror #43
    eor X<Bse>, X<E3>, Ago, ror #36
    eor X<Bgo>, X<E1>, Ame, ror #49
    eor X<Bke>, X<E2>, Agi, ror #3
    eor X<Bgi>, X<E0>, Aka, ror #39
    eor X<Bga>, X<E3>, Abo
    eor X<Bbo>, X<E3>, Amo, ror #37
    eor X<Bmo>, X<E2>, Ami, ror #8
    eor X<Bmi>, X<E1>, Ake, ror #56
    eor X<Bge>, X<E4>, Agu, ror #44
    eor X<Bgu>, X<E2>, Asi, ror #62
    eor X<Bsi>, X<E4>, Aku, ror #58
    eor X<Bku>, X<E0>, Asa, ror #25
    eor X<Bma>, X<E4>, Abu, ror #20
    eor X<Bbu>, X<E4>, Asu, ror #9
    eor X<Bsu>, X<E1>, Ase, ror #23
    eor X<Bme>, X<E0>, Aga, ror #61
    eor X<Bbe>, X<E1>, Age, ror #19

    ldr X<caddr>, [sp, #STACK_OFFSET_CONST]
    ldr X<count>, [sp, #STACK_OFFSET_COUNT] // @slothy:reads=STACK_OFFSET_COUNT
    ldr X<cur_const>, [X<caddr>, W<count>, UXTW #3]
    add X<count>, X<count>, #1
    cmp X<count>, #(KECCAK_F1600_ROUNDS-1)
    str X<count>, [sp, #STACK_OFFSET_COUNT] // @slothy:writes=STACK_OFFSET_COUNT

    chi_step_ror Aga, X<Bga>, X<Bgi>, X<Bge>, 47, 39
    chi_step_ror Age, X<Bge>, X<Bgo>, X<Bgi>, 42, 25
    chi_step_ror Agi, X<Bgi>, X<Bgu>, X<Bgo>, 16, 58
    chi_step_ror Ago, X<Bgo>, X<Bga>, X<Bgu>, 31, 47
    chi_step_ror Agu, X<Bgu>, X<Bge>, X<Bga>, 56, 23
    chi_step_ror Aka, X<Bka>, X<Bki>, X<Bke>, 19, 24
    chi_step_ror Ake, X<Bke>, X<Bko>, X<Bki>, 47, 2
    chi_step_ror Aki, X<Bki>, X<Bku>, X<Bko>, 10, 57
    chi_step_ror Ako, X<Bko>, X<Bka>, X<Bku>, 47, 57
    chi_step_ror Aku, X<Bku>, X<Bke>, X<Bka>, 5,  52
    chi_step_ror Ama, X<Bma>, X<Bmi>, X<Bme>, 38, 47
    chi_step_ror Ame, X<Bme>, X<Bmo>, X<Bmi>, 5,  43
    chi_step_ror Ami, X<Bmi>, X<Bmu>, X<Bmo>, 41, 46
    chi_step_ror Amo, X<Bmo>, X<Bma>, X<Bmu>, 35, 12
    chi_step_ror Amu, X<Bmu>, X<Bme>, X<Bma>, 9,  44
    chi_step_ror Asa, X<Bsa>, X<Bsi>, X<Bse>, 48, 41
    chi_step_ror Ase, X<Bse>, X<Bso>, X<Bsi>, 2,  50
    chi_step_ror Asi, X<Bsi>, X<Bsu>, X<Bso>, 25, 27
    chi_step_ror Aso, X<Bso>, X<Bsa>, X<Bsu>, 60, 21
    chi_step_ror Asu, X<Bsu>, X<Bse>, X<Bsa>, 57, 53
    chi_step_ror2 Aba, X<Bba>, X<Bbi>, X<Bbe>, 63, 21
    chi_step_ror Abe, X<Bbe>, X<Bbo>, X<Bbi>, 42, 41
    chi_step_ror Abi, X<Bbi>, X<Bbu>, X<Bbo>, 57, 35
    chi_step_ror Abo, X<Bbo>, X<Bba>, X<Bbu>, 50, 43
    chi_step_ror Abu, X<Bbu>, X<Bbe>, X<Bba>, 44, 30

    eor Aba, Aba, X<cur_const>
.endm

.macro load_state
    ldp Aba, Abe, [input_addr, #(1*8*0)]
    ldp Abi, Abo, [input_addr, #(1*8*2)]
    ldp Abu, Aga, [input_addr, #(1*8*4)]
    ldp Age, Agi, [input_addr, #(1*8*6)]
    ldp Ago, Agu, [input_addr, #(1*8*8)]
    ldp Aka, Ake, [input_addr, #(1*8*10)]
    ldp Aki, Ako, [input_addr, #(1*8*12)]
    ldp Aku, Ama, [input_addr, #(1*8*14)]
    ldp Ame, Ami, [input_addr, #(1*8*16)]
    ldp Amo, Amu, [input_addr, #(1*8*18)]
    ldp Asa, Ase, [input_addr, #(1*8*20)]
    ldp Asi, Aso, [input_addr, #(1*8*22)]
    ldr Asu,      [input_addr, #(1*8*24)]
.endm

.macro store_state
    stp Aba, Abe, [input_addr, #(1*8*0)]
    stp Abi, Abo, [input_addr, #(1*8*2)]
    stp Abu, Aga, [input_addr, #(1*8*4)]
    stp Age, Agi, [input_addr, #(1*8*6)]
    stp Ago, Agu, [input_addr, #(1*8*8)]
    stp Aka, Ake, [input_addr, #(1*8*10)]
    stp Aki, Ako, [input_addr, #(1*8*12)]
    stp Aku, Ama, [input_addr, #(1*8*14)]
    stp Ame, Ami, [input_addr, #(1*8*16)]
    stp Amo, Amu, [input_addr, #(1*8*18)]
    stp Asa, Ase, [input_addr, #(1*8*20)]
    stp Asi, Aso, [input_addr, #(1*8*22)]
    str Asu,      [input_addr, #(1*8*24)]
.endm

.macro final_rotate
    ror Abe, Abe,#(64-21)
    ror Abi, Abi,#(64-14)
    ror Abu, Abu,#(64-44)
    ror Aga, Aga,#(64-3)
    ror Age, Age,#(64-45)
    ror Agi, Agi,#(64-61)
    ror Ago, Ago,#(64-28)
    ror Agu, Agu,#(64-20)
    ror Aka, Aka,#(64-25)
    ror Ake, Ake,#(64-8)
    ror Aki, Aki,#(64-18)
    ror Ako, Ako,#(64-1)
    ror Aku, Aku,#(64-6)
    ror Ama, Ama,#(64-10)
    ror Ame, Ame,#(64-15)
    ror Ami, Ami,#(64-56)
    ror Amo, Amo,#(64-27)
    ror Amu, Amu,#(64-36)
    ror Asa, Asa,#(64-39)
    ror Ase, Ase,#(64-41)
    ror Asi, Asi,#(64-2)
    ror Aso, Aso,#(64-62)
    ror Asu, Asu,#(64-55)
.endm

#define KECCAK_F1600_ROUNDS 24

.text
.balign 16
.global keccak_f1600_x1_scalar_slothy_opt_a55
.global _keccak_f1600_x1_scalar_slothy_opt_a55

keccak_f1600_x1_scalar_slothy_opt_a55:
_keccak_f1600_x1_scalar_slothy_opt_a55:
    alloc_stack
    save_gprs

initial:
    load_constant_ptr
    str const_addr, [sp, #STACK_OFFSET_CONST]
    load_state
    str input_addr, [sp, #STACK_OFFSET_INPUT] // @slothy:writes=STACK_OFFSET_INPUT

        initial_round_start:
                                                  // Instructions:    107
                                                  // Expected cycles: 54
                                                  // Expected IPC:    1.98
                                                  //
                                                  // ----------------- cycle (expected) ------------------>
                                                  // 0                        25                       50
                                                  // |------------------------|------------------------|---
        eor x30, x24, x25                         // *.....................................................
        eor x27, x9, x10                          // *.....................................................
        eor x0, x30, x21                          // .*....................................................
        eor x26, x27, x6                          // .*....................................................
        eor x27, x26, x7                          // ..*...................................................
        eor x29, x0, x22                          // ..*...................................................
        eor x26, x29, x23                         // ...*..................................................
        eor x29, x4, x5                           // ...*..................................................
        eor x30, x29, x1                          // ....*.................................................
        eor x0, x27, x8                           // ....*.................................................
        eor x29, x30, x2                          // .....*................................................
        eor x30, x19, x20                         // .....*................................................
        eor x30, x30, x16                         // ......*...............................................
        eor x27, x26, x0, ror #63                 // ......*...............................................
        eor x4, x4, x27                           // .......*..............................................
        eor x30, x30, x17                         // .......*..............................................
        eor x30, x30, x28                         // ........*.............................................
        eor x29, x29, x3                          // ........*.............................................
        eor x0, x0, x30, ror #63                  // .........*............................................
        eor x30, x30, x29, ror #63                // .........*............................................
        eor x22, x22, x30                         // ..........*...........................................
        eor x23, x23, x30                         // ..........*...........................................
        str x23, [sp, #STACK_LOC_0]               // ...........*.......................................... // @slothy:writes=stack_0
        eor x23, x14, x15                         // ...........*..........................................
        eor x14, x14, x0                          // ............*.........................................
        eor x23, x23, x11                         // ............*.........................................
        eor x15, x15, x0                          // .............*........................................
        eor x1, x1, x27                           // .............*........................................
        eor x23, x23, x12                         // ..............*.......................................
        eor x23, x23, x13                         // ...............*......................................
        eor x11, x11, x0                          // ...............*......................................
        eor x29, x29, x23, ror #63                // ................*.....................................
        eor x23, x23, x26, ror #63                // ................*.....................................
        eor x26, x13, x0                          // .................*....................................
        eor x13, x28, x23                         // .................*....................................
        eor x28, x24, x30                         // ..................*...................................
        eor x24, x16, x23                         // ..................*...................................
        eor x16, x21, x30                         // ...................*..................................
        eor x21, x25, x30                         // ...................*..................................
        eor x30, x19, x23                         // ....................*.................................
        eor x19, x20, x23                         // ....................*.................................
        eor x20, x17, x23                         // .....................*................................
        eor x17, x12, x0                          // .....................*................................
        eor x0, x2, x27                           // ......................*...............................
        eor x2, x6, x29                           // ......................*...............................
        eor x6, x8, x29                           // .......................*..............................
        bic x8, x28, x13, ror #47                 // .......................*..............................
        eor x12, x3, x27                          // ........................*.............................
        bic x3, x13, x17, ror #19                 // ........................*.............................
        eor x5, x5, x27                           // .........................*............................
        ldr x27, [sp, #STACK_LOC_0]               // .........................*............................ // @slothy:reads=stack_0
        bic x25, x17, x2, ror #5                  // ..........................*...........................
        eor x9, x9, x29                           // ..........................*...........................
        eor x23, x25, x5, ror #52                 // ...........................*..........................
        eor x3, x3, x2, ror #24                   // ...........................*..........................
        eor x8, x8, x17, ror #2                   // ............................*.........................
        eor x17, x10, x29                         // ............................*.........................
        bic x25, x12, x22, ror #47                // .............................*........................
        eor x29, x7, x29                          // .............................*........................
        bic x10, x4, x27, ror #2                  // ..............................*.......................
        bic x7, x5, x28, ror #10                  // ..............................*.......................
        eor x10, x10, x20, ror #50                // ...............................*......................
        eor x13, x7, x13, ror #57                 // ...............................*......................
        bic x7, x2, x5, ror #47                   // ................................*.....................
        eor x2, x25, x24, ror #39                 // ................................*.....................
        bic x25, x20, x11, ror #57                // .................................*....................
        bic x5, x17, x4, ror #25                  // .................................*....................
        eor x25, x25, x17, ror #53                // ..................................*...................
        bic x17, x11, x17, ror #60                // ..................................*...................
        eor x28, x7, x28, ror #57                 // ...................................*..................
        bic x7, x9, x12, ror #42                  // ...................................*..................
        eor x7, x7, x22, ror #25                  // ....................................*.................
        bic x22, x22, x24, ror #56                // ....................................*.................
        bic x24, x24, x15, ror #31                // .....................................*................
        eor x22, x22, x15, ror #23                // .....................................*................
        bic x20, x27, x20, ror #48                // ......................................*...............
        bic x15, x15, x9, ror #16                 // ......................................*...............
        eor x12, x15, x12, ror #58                // .......................................*..............
        eor x15, x5, x27, ror #27                 // .......................................*..............
        eor x5, x20, x11, ror #41                 // ........................................*.............
        ldr x11, [sp, #STACK_OFFSET_CONST]        // ........................................*.............
        eor x20, x17, x4, ror #21                 // .........................................*............
        eor x17, x24, x9, ror #47                 // .........................................*............
        mov x24, #1                               // ..........................................*...........
        bic x9, x0, x16, ror #9                   // ..........................................*...........
        str x24, [sp, #STACK_OFFSET_COUNT]        // ...........................................*.......... // @slothy:writes=STACK_OFFSET_COUNT
        bic x24, x29, x1, ror #44                 // ...........................................*..........
        bic x27, x1, x21, ror #50                 // ............................................*.........
        bic x4, x26, x29, ror #63                 // ............................................*.........
        eor x1, x1, x4, ror #21                   // .............................................*........
        ldr x11, [x11]                            // .............................................*........
        bic x4, x21, x30, ror #57                 // ..............................................*.......
        eor x21, x24, x21, ror #30                // ..............................................*.......
        eor x24, x9, x19, ror #44                 // ...............................................*......
        bic x9, x14, x6, ror #5                   // ...............................................*......
        eor x9, x9, x0, ror #43                   // ................................................*.....
        bic x0, x6, x0, ror #38                   // ................................................*.....
        eor x1, x1, x11                           // .................................................*....
        eor x11, x4, x26, ror #35                 // .................................................*....
        eor x4, x0, x16, ror #47                  // ..................................................*...
        bic x0, x16, x19, ror #35                 // ..................................................*...
        eor x16, x27, x30, ror #43                // ...................................................*..
        bic x27, x30, x26, ror #42                // ...................................................*..
        bic x26, x19, x14, ror #41                // ....................................................*.
        eor x19, x0, x14, ror #12                 // ....................................................*.
        eor x14, x26, x6, ror #46                 // .....................................................*
        eor x6, x27, x29, ror #41                 // .....................................................*

                                                          // ----------------- cycle (expected) ------------------>
                                                          // 0                        25                       50
                                                          // |------------------------|------------------------|---
        // eor x29, x4, x5                                // ...*..................................................
        // eor x30, x29, x1                               // ....*.................................................
        // eor x26, x30, x2                               // .....*................................................
        // eor x29, x26, x3                               // ........*.............................................
        // eor x26, x9, x10                               // *.....................................................
        // eor x30, x26, x6                               // .*....................................................
        // eor x26, x30, x7                               // ..*...................................................
        // eor x26, x26, x8                               // ....*.................................................
        // eor x30, x19, x20                              // .....*................................................
        // eor x27, x30, x16                              // ......*...............................................
        // eor x27, x27, x17                              // .......*..............................................
        // eor x30, x27, x28                              // ........*.............................................
        // eor x27, x26, x30, ror #63                     // .........*............................................
        // eor x30, x30, x29, ror #63                     // .........*............................................
        // eor x0, x23, x30                               // ..........*...........................................
        // str x0, [sp, #STACK_LOC_0]                     // ...........*..........................................
        // eor x0, x24, x25                               // *.....................................................
        // eor x0, x0, x21                                // .*....................................................
        // eor x0, x0, x22                                // ..*...................................................
        // eor x23, x0, x23                               // ...*..................................................
        // eor x0, x23, x26, ror #63                      // ......*...............................................
        // eor x26, x14, x15                              // ...........*..........................................
        // eor x26, x26, x11                              // ............*.........................................
        // eor x1, x1, x0                                 // .............*........................................
        // eor x26, x26, x12                              // ..............*.......................................
        // eor x26, x26, x13                              // ...............*......................................
        // eor x29, x29, x26, ror #63                     // ................*.....................................
        // eor x23, x26, x23, ror #63                     // ................*.....................................
        // eor x11, x11, x27                              // ...............*......................................
        // eor x26, x13, x27                              // .................*....................................
        // eor x9, x9, x29                                // ..........................*...........................
        // eor x13, x28, x23                              // .................*....................................
        // eor x28, x5, x0                                // .........................*............................
        // eor x5, x24, x30                               // ..................*...................................
        // eor x24, x16, x23                              // ..................*...................................
        // eor x16, x21, x30                              // ...................*..................................
        // eor x15, x15, x27                              // .............*........................................
        // eor x14, x14, x27                              // ............*.........................................
        // eor x4, x4, x0                                 // .......*..............................................
        // eor x21, x25, x30                              // ...................*..................................
        // eor x25, x6, x29                               // ......................*...............................
        // eor x6, x8, x29                                // .......................*..............................
        // eor x22, x22, x30                              // ..........*...........................................
        // eor x30, x19, x23                              // ....................*.................................
        // eor x8, x12, x27                               // .....................*................................
        // eor x19, x20, x23                              // ....................*.................................
        // eor x20, x17, x23                              // .....................*................................
        // eor x12, x3, x0                                // ........................*.............................
        // eor x27, x2, x0                                // ......................*...............................
        // bic x0, x13, x8, ror #19                       // ........................*.............................
        // bic x2, x5, x13, ror #47                       // .......................*..............................
        // eor x3, x0, x25, ror #24                       // ...........................*..........................
        // bic x23, x8, x25, ror #5                       // ..........................*...........................
        // bic x0, x12, x22, ror #47                      // .............................*........................
        // eor x23, x23, x28, ror #52                     // ...........................*..........................
        // eor x8, x2, x8, ror #2                         // ............................*.........................
        // bic x2, x25, x28, ror #47                      // ................................*.....................
        // eor x17, x10, x29                              // ............................*.........................
        // bic x25, x28, x5, ror #10                      // ..............................*.......................
        // eor x28, x2, x5, ror #57                       // ...................................*..................
        // eor x29, x7, x29                               // .............................*........................
        // eor x2, x0, x24, ror #39                       // ................................*.....................
        // ldr x0, [sp, #STACK_LOC_0]                     // .........................*............................
        // bic x7, x4, x0, ror #2                         // ..............................*.......................
        // eor x13, x25, x13, ror #57                     // ...............................*......................
        // bic x5, x0, x20, ror #48                       // ......................................*...............
        // eor x10, x7, x20, ror #50                      // ...............................*......................
        // bic x7, x9, x12, ror #42                       // ...................................*..................
        // bic x25, x20, x11, ror #57                     // .................................*....................
        // eor x7, x7, x22, ror #25                       // ....................................*.................
        // eor x25, x25, x17, ror #53                     // ..................................*...................
        // eor x5, x5, x11, ror #41                       // ........................................*.............
        // bic x22, x22, x24, ror #56                     // ....................................*.................
        // bic x11, x11, x17, ror #60                     // ..................................*...................
        // eor x20, x11, x4, ror #21                      // .........................................*............
        // bic x17, x17, x4, ror #25                      // .................................*....................
        // bic x4, x27, x16, ror #9                       // ..........................................*...........
        // bic x11, x15, x9, ror #16                      // ......................................*...............
        // eor x22, x22, x15, ror #23                     // .....................................*................
        // bic x24, x24, x15, ror #31                     // .....................................*................
        // eor x15, x17, x0, ror #27                      // .......................................*..............
        // eor x17, x24, x9, ror #47                      // .........................................*............
        // mov x9, #1                                     // ..........................................*...........
        // str x9, [sp, #STACK_OFFSET_COUNT]              // ...........................................*..........
        // eor x12, x11, x12, ror #58                     // .......................................*..............
        // eor x24, x4, x19, ror #44                      // ...............................................*......
        // bic x0, x16, x19, ror #35                      // ..................................................*...
        // bic x9, x14, x6, ror #5                        // ...............................................*......
        // bic x11, x6, x27, ror #38                      // ................................................*.....
        // eor x4, x11, x16, ror #47                      // ..................................................*...
        // bic x16, x19, x14, ror #41                     // ....................................................*.
        // bic x11, x26, x29, ror #63                     // ............................................*.........
        // eor x19, x0, x14, ror #12                      // ....................................................*.
        // eor x9, x9, x27, ror #43                       // ................................................*.....
        // eor x27, x1, x11, ror #21                      // .............................................*........
        // ldr x0, [sp, #STACK_OFFSET_CONST]              // ........................................*.............
        // bic x11, x21, x30, ror #57                     // ..............................................*.......
        // eor x11, x11, x26, ror #35                     // .................................................*....
        // bic x26, x30, x26, ror #42                     // ...................................................*..
        // eor x14, x16, x6, ror #46                      // .....................................................*
        // bic x16, x29, x1, ror #44                      // ...........................................*..........
        // eor x6, x26, x29, ror #41                      // .....................................................*
        // bic x26, x1, x21, ror #50                      // ............................................*.........
        // eor x21, x16, x21, ror #30                     // ..............................................*.......
        // ldr x0, [x0]                                   // .............................................*........
        // eor x1, x27, x0                                // .................................................*....
        // eor x16, x26, x30, ror #43                     // ...................................................*..

        initial_round_end:



        loop:
                                                  // Instructions:    112
                                                  // Expected cycles: 57
                                                  // Expected IPC:    1.96
                                                  //
                                                  // ------------------- cycle (expected) ------------------->
                                                  // 0                        25                       50
                                                  // |------------------------|------------------------|------
        eor x0, x15, x11, ror #52                 // *........................................................
        eor x0, x0, x13, ror #48                  // .*.......................................................
        eor x26, x8, x9, ror #57                  // .*.......................................................
        eor x27, x0, x14, ror #10                 // ..*......................................................
        eor x29, x16, x28, ror #63                // ..*......................................................
        eor x26, x26, x6, ror #51                 // ...*.....................................................
        eor x30, x23, x22, ror #50                // ...*.....................................................
        eor x0, x26, x10, ror #31                 // ....*....................................................
        eor x29, x29, x19, ror #37                // ....*....................................................
        eor x27, x27, x12, ror #5                 // .....*...................................................
        eor x30, x30, x24, ror #34                // .....*...................................................
        eor x0, x0, x7, ror #27                   // ......*..................................................
        eor x26, x30, x21, ror #26                // ......*..................................................
        eor x26, x26, x25, ror #15                // .......*.................................................
        ror x30, x27, #62                         // .......*.................................................
        eor x30, x30, x26, ror #57                // ........*................................................
        ror x26, x26, #58                         // ........*................................................
        eor x16, x30, x16                         // .........*...............................................
        eor x28, x30, x28, ror #63                // .........*...............................................
        str x28, [sp, #STACK_LOC_0]               // ..........*.............................................. // @slothy:writes=stack_0
        eor x29, x29, x17, ror #36                // ..........*..............................................
        eor x28, x1, x2, ror #61                  // ...........*.............................................
        eor x19, x30, x19, ror #37                // ...........*.............................................
        eor x29, x29, x20, ror #2                 // ............*............................................
        eor x28, x28, x4, ror #54                 // ............*............................................
        eor x26, x26, x0, ror #55                 // .............*...........................................
        eor x28, x28, x3, ror #39                 // .............*...........................................
        eor x28, x28, x5, ror #25                 // ..............*..........................................
        ror x0, x0, #56                           // ..............*..........................................
        eor x0, x0, x29, ror #63                  // ...............*.........................................
        eor x27, x28, x27, ror #61                // ...............*.........................................
        eor x13, x0, x13, ror #46                 // ................*........................................
        eor x28, x29, x28, ror #63                // ................*........................................
        eor x29, x30, x20, ror #2                 // .................*.......................................
        eor x20, x26, x3, ror #39                 // .................*.......................................
        eor x11, x0, x11, ror #50                 // ..................*......................................
        eor x25, x28, x25, ror #9                 // ..................*......................................
        eor x3, x28, x21, ror #20                 // ...................*.....................................
        eor x21, x26, x1                          // ...................*.....................................
        eor x9, x27, x9, ror #49                  // ....................*....................................
        eor x24, x28, x24, ror #28                // ....................*....................................
        eor x1, x30, x17, ror #36                 // .....................*...................................
        eor x14, x0, x14, ror #8                  // .....................*...................................
        eor x22, x28, x22, ror #44                // ......................*..................................
        eor x8, x27, x8, ror #56                  // ......................*..................................
        eor x17, x27, x7, ror #19                 // .......................*.................................
        eor x15, x0, x15, ror #62                 // .......................*.................................
        bic x7, x20, x22, ror #47                 // ........................*................................
        eor x4, x26, x4, ror #54                  // ........................*................................
        eor x0, x0, x12, ror #3                   // .........................*...............................
        eor x28, x28, x23, ror #58                // .........................*...............................
        eor x23, x26, x2, ror #61                 // ..........................*..............................
        eor x26, x26, x5, ror #25                 // ..........................*..............................
        eor x2, x7, x16, ror #39                  // ...........................*.............................
        bic x7, x9, x20, ror #42                  // ...........................*.............................
        bic x30, x15, x9, ror #16                 // ............................*............................
        eor x7, x7, x22, ror #25                  // ............................*............................
        eor x12, x30, x20, ror #58                // .............................*...........................
        bic x20, x22, x16, ror #56                // .............................*...........................
        eor x30, x27, x6, ror #43                 // ..............................*..........................
        eor x22, x20, x15, ror #23                // ..............................*..........................
        bic x6, x19, x13, ror #42                 // ...............................*.........................
        eor x6, x6, x17, ror #41                  // ................................*........................
        bic x5, x13, x17, ror #63                 // ................................*........................
        eor x5, x21, x5, ror #21                  // .................................*.......................
        bic x17, x17, x21, ror #44                // .................................*.......................
        eor x27, x27, x10, ror #23                // ..................................*......................
        bic x21, x21, x25, ror #50                // ..................................*......................
        bic x20, x27, x4, ror #25                 // ...................................*.....................
        bic x10, x16, x15, ror #31                // ...................................*.....................
        eor x16, x21, x19, ror #43                // ....................................*....................
        eor x21, x17, x25, ror #30                // ....................................*....................
        bic x19, x25, x19, ror #57                // .....................................*...................
        ldr x25, [sp, #STACK_OFFSET_COUNT]        // .....................................*................... // @slothy:reads=STACK_OFFSET_COUNT
        eor x17, x10, x9, ror #47                 // ......................................*..................
        ldr x9, [sp, #STACK_OFFSET_CONST]         // ......................................*..................
        eor x15, x20, x28, ror #27                // .......................................*.................
        bic x20, x4, x28, ror #2                  // .......................................*.................
        eor x10, x20, x1, ror #50                 // ........................................*................
        bic x20, x11, x27, ror #60                // ........................................*................
        eor x20, x20, x4, ror #21                 // .........................................*...............
        bic x4, x28, x1, ror #48                  // .........................................*...............
        bic x1, x1, x11, ror #57                  // ..........................................*..............
        ldr x28, [x9, w25, UXTW #3]               // ..........................................*..............
        ldr x9, [sp, #STACK_LOC_0]                // ...........................................*............. // @slothy:reads=stack_0
        add x25, x25, #1                          // ...........................................*.............
        str x25, [sp, #STACK_OFFSET_COUNT]        // ............................................*............ // @slothy:writes=STACK_OFFSET_COUNT
        cmp x25, #(KECCAK_F1600_ROUNDS-1)         // ............................................*............
        eor x25, x1, x27, ror #53                 // .............................................*...........
        bic x27, x30, x26, ror #47                // .............................................*...........
        eor x1, x5, x28                           // ..............................................*..........
        eor x5, x4, x11, ror #41                  // ..............................................*..........
        eor x11, x19, x13, ror #35                // ...............................................*.........
        bic x13, x26, x24, ror #10                // ...............................................*.........
        eor x28, x27, x24, ror #57                // ................................................*........
        bic x27, x24, x9, ror #47                 // ................................................*........
        bic x19, x23, x3, ror #9                  // .................................................*.......
        bic x4, x29, x14, ror #41                 // .................................................*.......
        eor x24, x19, x29, ror #44                // ..................................................*......
        bic x29, x3, x29, ror #35                 // ..................................................*......
        eor x13, x13, x9, ror #57                 // ...................................................*.....
        eor x19, x29, x14, ror #12                // ...................................................*.....
        bic x29, x9, x0, ror #19                  // ....................................................*....
        bic x14, x14, x8, ror #5                  // ....................................................*....
        eor x9, x14, x23, ror #43                 // .....................................................*...
        eor x14, x4, x8, ror #46                  // .....................................................*...
        bic x23, x8, x23, ror #38                 // ......................................................*..
        eor x8, x27, x0, ror #2                   // ......................................................*..
        eor x4, x23, x3, ror #47                  // .......................................................*.
        bic x3, x0, x30, ror #5                   // .......................................................*.
        eor x23, x3, x26, ror #52                 // ........................................................*
        eor x3, x29, x30, ror #24                 // ........................................................*

                                                           // ------------------- cycle (expected) ------------------->
                                                           // 0                        25                       50
                                                           // |------------------------|------------------------|------
        // eor x0, x8, x9, ror #57                         // .*.......................................................
        // eor x29, x15, x11, ror #52                      // *........................................................
        // eor x27, x29, x13, ror #48                      // .*.......................................................
        // eor x29, x27, x14, ror #10                      // ..*......................................................
        // eor x26, x16, x28, ror #63                      // ..*......................................................
        // eor x30, x0, x6, ror #51                        // ...*.....................................................
        // eor x27, x29, x12, ror #5                       // .....*...................................................
        // eor x29, x23, x22, ror #50                      // ...*.....................................................
        // eor x0, x30, x10, ror #31                       // ....*....................................................
        // eor x26, x26, x19, ror #37                      // ....*....................................................
        // eor x30, x29, x24, ror #34                      // .....*...................................................
        // eor x29, x30, x21, ror #26                      // ......*..................................................
        // ror x30, x27, #62                               // .......*.................................................
        // eor x29, x29, x25, ror #15                      // .......*.................................................
        // eor x30, x30, x29, ror #57                      // ........*................................................
        // eor x26, x26, x17, ror #36                      // ..........*..............................................
        // ror x29, x29, #58                               // ........*................................................
        // eor x0, x0, x7, ror #27                         // ......*..................................................
        // eor x28, x30, x28, ror #63                      // .........*...............................................
        // str x28, [sp, #STACK_LOC_0]                     // ..........*..............................................
        // eor x28, x26, x20, ror #2                       // ............*............................................
        // eor x26, x29, x0, ror #55                       // .............*...........................................
        // ror x29, x0, #56                                // ..............*..........................................
        // eor x0, x29, x28, ror #63                       // ...............*.........................................
        // eor x29, x1, x2, ror #61                        // ...........*.............................................
        // eor x29, x29, x4, ror #54                       // ............*............................................
        // eor x29, x29, x3, ror #39                       // .............*...........................................
        // eor x29, x29, x5, ror #25                       // ..............*..........................................
        // eor x27, x29, x27, ror #61                      // ...............*.........................................
        // eor x28, x28, x29, ror #63                      // ................*........................................
        // eor x13, x0, x13, ror #46                       // ................*........................................
        // eor x9, x27, x9, ror #49                        // ....................*....................................
        // eor x29, x30, x20, ror #2                       // .................*.......................................
        // eor x25, x28, x25, ror #9                       // ..................*......................................
        // eor x20, x26, x3, ror #39                       // .................*.......................................
        // eor x3, x28, x21, ror #20                       // ...................*.....................................
        // eor x11, x0, x11, ror #50                       // ..................*......................................
        // eor x8, x27, x8, ror #56                        // ......................*..................................
        // eor x21, x26, x1                                // ...................*.....................................
        // eor x15, x0, x15, ror #62                       // .......................*.................................
        // eor x1, x0, x14, ror #8                         // .....................*...................................
        // eor x24, x28, x24, ror #28                      // ....................*....................................
        // eor x14, x30, x17, ror #36                      // .....................*...................................
        // eor x22, x28, x22, ror #44                      // ......................*..................................
        // eor x17, x27, x7, ror #19                       // .......................*.................................
        // eor x23, x28, x23, ror #58                      // .........................*...............................
        // eor x4, x26, x4, ror #54                        // ........................*................................
        // eor x28, x26, x2, ror #61                       // ..........................*..............................
        // bic x7, x20, x22, ror #47                       // ........................*................................
        // eor x19, x30, x19, ror #37                      // ...........*.............................................
        // eor x16, x30, x16                               // .........*...............................................
        // eor x30, x27, x6, ror #43                       // ..............................*..........................
        // eor x2, x7, x16, ror #39                        // ...........................*.............................
        // bic x6, x15, x9, ror #16                        // ............................*............................
        // eor x26, x26, x5, ror #25                       // ..........................*..............................
        // bic x5, x9, x20, ror #42                        // ...........................*.............................
        // eor x7, x5, x22, ror #25                        // ............................*............................
        // bic x22, x22, x16, ror #56                      // .............................*...........................
        // eor x0, x0, x12, ror #3                         // .........................*...............................
        // bic x5, x19, x13, ror #42                       // ...............................*.........................
        // eor x12, x6, x20, ror #58                       // .............................*...........................
        // eor x27, x27, x10, ror #23                      // ..................................*......................
        // eor x6, x5, x17, ror #41                        // ................................*........................
        // bic x5, x17, x21, ror #44                       // .................................*.......................
        // bic x20, x16, x15, ror #31                      // ...................................*.....................
        // bic x10, x13, x17, ror #63                      // ................................*........................
        // eor x17, x20, x9, ror #47                       // ......................................*..................
        // eor x22, x22, x15, ror #23                      // ..............................*..........................
        // bic x15, x27, x4, ror #25                       // ...................................*.....................
        // eor x15, x15, x23, ror #27                      // .......................................*.................
        // eor x9, x21, x10, ror #21                       // .................................*.......................
        // bic x10, x4, x23, ror #2                        // .......................................*.................
        // bic x16, x21, x25, ror #50                      // ..................................*......................
        // bic x20, x23, x14, ror #48                      // .........................................*...............
        // eor x21, x5, x25, ror #30                       // ....................................*....................
        // bic x23, x11, x27, ror #60                      // ........................................*................
        // bic x25, x25, x19, ror #57                      // .....................................*...................
        // eor x5, x20, x11, ror #41                       // ..............................................*..........
        // eor x20, x23, x4, ror #21                       // .........................................*...............
        // eor x10, x10, x14, ror #50                      // ........................................*................
        // bic x4, x14, x11, ror #57                       // ..........................................*..............
        // eor x16, x16, x19, ror #43                      // ....................................*....................
        // bic x19, x3, x29, ror #35                       // ..................................................*......
        // ldr x23, [sp, #STACK_OFFSET_COUNT]              // .....................................*...................
        // eor x11, x25, x13, ror #35                      // ...............................................*.........
        // eor x25, x4, x27, ror #53                       // .............................................*...........
        // eor x19, x19, x1, ror #12                       // ...................................................*.....
        // bic x13, x1, x8, ror #5                         // ....................................................*....
        // bic x4, x8, x28, ror #38                        // ......................................................*..
        // eor x4, x4, x3, ror #47                         // .......................................................*.
        // bic x14, x29, x1, ror #41                       // .................................................*.......
        // ldr x1, [sp, #STACK_OFFSET_CONST]               // ......................................*..................
        // ldr x1, [x1, w23, UXTW #3]                      // ..........................................*..............
        // eor x14, x14, x8, ror #46                       // .....................................................*...
        // bic x8, x28, x3, ror #9                         // .................................................*.......
        // bic x27, x30, x26, ror #47                      // .............................................*...........
        // add x23, x23, #1                                // ...........................................*.............
        // cmp x23, #(KECCAK_F1600_ROUNDS-1)               // ............................................*............
        // str x23, [sp, #STACK_OFFSET_COUNT]              // ............................................*............
        // eor x1, x9, x1                                  // ..............................................*..........
        // eor x9, x13, x28, ror #43                       // .....................................................*...
        // ldr x28, [sp, #STACK_LOC_0]                     // ...........................................*.............
        // bic x23, x0, x30, ror #5                        // .......................................................*.
        // bic x13, x26, x24, ror #10                      // ...............................................*.........
        // bic x3, x28, x0, ror #19                        // ....................................................*....
        // eor x23, x23, x26, ror #52                      // ........................................................*
        // bic x26, x24, x28, ror #47                      // ................................................*........
        // eor x13, x13, x28, ror #57                      // ...................................................*.....
        // eor x3, x3, x30, ror #24                        // ........................................................*
        // eor x28, x27, x24, ror #57                      // ................................................*........
        // eor x24, x8, x29, ror #44                       // ..................................................*......
        // eor x8, x26, x0, ror #2                         // ......................................................*..

        end_loop:


    ble loop

final:
    final_rotate
    ldr input_addr, [sp, #STACK_OFFSET_INPUT] // @slothy:reads=STACK_OFFSET_INPUT
    store_state
end_final:

    restore_gprs
    free_stack
    ret
