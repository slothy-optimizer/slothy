///
/// Copyright (c) 2022 Arm Limited
/// Copyright (c) 2022 Hanno Becker
/// Copyright (c) 2023 Amin Abdulrahman, Matthias Kannwischer
/// SPDX-License-Identifier: MIT
///
/// Permission is hereby granted, free of charge, to any person obtaining a copy
/// of this software and associated documentation files (the "Software"), to deal
/// in the Software without restriction, including without limitation the rights
/// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
/// copies of the Software, and to permit persons to whom the Software is
/// furnished to do so, subject to the following conditions:
///
/// The above copyright notice and this permission notice shall be included in all
/// copies or substantial portions of the Software.
///
/// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
/// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
/// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
/// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
/// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
/// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
/// SOFTWARE.
///

// Needed to provide ASM_LOAD directive
#include <hal_env.h>

// NOTE
// We use a lot of trivial macros to simplify the parsing burden for Slothy
// The macros are not unfolded by Slothy and thus interpreted as instructions,
// which are easier to parse due to e.g. the lack of size specifiers and simpler
// syntax for pre and post increment for loads and stores.
//
// Eventually, NeLight should include a proper parser for AArch64,
// but for initial investigations, the below is enough.

.macro ldr_vo vec, base, offset
        ldr qform_\vec, [\base, #\offset]
.endm
.macro ldr_vi vec, base, inc
        ldr qform_\vec, [\base], #\inc
.endm
.macro str_vo vec, base, offset
        str qform_\vec, [\base, #\offset]
.endm
.macro str_vi vec, base, inc
        str qform_\vec, [\base], #\inc
.endm
.macro vqrdmulh d,a,b
        sqrdmulh \d\().4s, \a\().4s, \b\().4s
.endm
.macro vmla d,a,b
        mla \d\().4s, \a\().4s, \b\().4s
.endm
.macro vqrdmulhq d,a,b,i
        sqrdmulh \d\().4s, \a\().4s, \b\().s[\i]
.endm
.macro vmulq d,a,b,i
        mul \d\().4s, \a\().4s, \b\().s[\i]
.endm
.macro vmlaq d,a,b,i
        mla \d\().4s, \a\().4s, \b\().s[\i]
        .endm
.macro vmlsq d,a,b,i
        mls \d\().4s, \a\().4s, \b\().s[\i]
        .endm


.macro mulmodq dst, src, const, idx0, idx1
        vmulq       \dst,  \src, \const, \idx0
        vqrdmulhq   \src,  \src, \const, \idx1
        vmla        \dst,  \src, modulus
.endm

.macro mulmod dst, src, const, const_twisted
        mul        \dst\().4s,  \src\().4s, \const\().4s
        vqrdmulh   \src,  \src, \const_twisted
        vmla       \dst,  \src, modulus
.endm

.macro ct_butterfly a, b, root, idx0, idx1
        mulmodq  tmp, \b, \root, \idx0, \idx1
        sub     \b\().4s,    \a\().4s, tmp.4s
        add     \a\().4s,    \a\().4s, tmp.4s
.endm

.macro mulmod_v dst, src, const, const_twisted
        mul        \dst\().4s,  \src\().4s, \const\().4s
        vqrdmulh    \src,  \src, \const_twisted
        vmla        \dst,  \src, modulus
.endm

.macro ct_butterfly_v a, b, root, root_twisted
        mulmod  tmp, \b, \root, \root_twisted
        sub    \b\().4s,    \a\().4s, tmp.4s
        add    \a\().4s,    \a\().4s, tmp.4s
.endm

.macro load_roots_1234
        ldr_vi root0, r_ptr0, (8*16)
        ldr_vo root1, r_ptr0, (-8*16 + 1*16)
        ldr_vo root2, r_ptr0, (-8*16 + 2*16)
        ldr_vo root3, r_ptr0, (-8*16 + 3*16)
        ldr_vo root4, r_ptr0, (-8*16 + 4*16)
        ldr_vo root5, r_ptr0, (-8*16 + 5*16)
        ldr_vo root6, r_ptr0, (-8*16 + 6*16)
        ldr_vo root7, r_ptr0, (-8*16 + 7*16)
.endm

.macro load_next_roots_56 root0, r_ptr0
        ldr_vi \root0, \r_ptr0, 16
.endm

.macro load_next_roots_6 root0, r_ptr0
        ldr_vi \root0, \r_ptr0, 8
.endm

.macro load_next_roots_78 root0, root0_tw, root1, root1_tw, root2, root2_tw, r_ptr1
        ldr_vi \root0,    \r_ptr1, (6*16)
        ldr_vo \root0_tw, \r_ptr1, (-6*16 + 1*16)
        ldr_vo \root1,    \r_ptr1, (-6*16 + 2*16)
        ldr_vo \root1_tw, \r_ptr1, (-6*16 + 3*16)
        ldr_vo \root2,    \r_ptr1, (-6*16 + 4*16)
        ldr_vo \root2_tw, \r_ptr1, (-6*16 + 5*16)
.endm

.macro transpose4 data
        trn1 t0.4s, \data\()0\().4s, \data\()1\().4s
        trn2 t1.4s, \data\()0\().4s, \data\()1\().4s
        trn1 t2.4s, \data\()2\().4s, \data\()3\().4s
        trn2 t3.4s, \data\()2\().4s, \data\()3\().4s

        trn2 \data\()2\().2d, t0.2d, t2.2d
        trn2 \data\()3\().2d, t1.2d, t3.2d
        trn1 \data\()0\().2d, t0.2d, t2.2d
        trn1 \data\()1\().2d, t1.2d, t3.2d
.endm

.macro save_gprs // slothy:no-unfold
        sub sp, sp, #(16*6)
        stp x19, x20, [sp, #16*0]
        stp x19, x20, [sp, #16*0]
        stp x21, x22, [sp, #16*1]
        stp x23, x24, [sp, #16*2]
        stp x25, x26, [sp, #16*3]
        stp x27, x28, [sp, #16*4]
        str x29, [sp, #16*5]
.endm

.macro restore_gprs // slothy:no-unfold
        ldp x19, x20, [sp, #16*0]
        ldp x21, x22, [sp, #16*1]
        ldp x23, x24, [sp, #16*2]
        ldp x25, x26, [sp, #16*3]
        ldp x27, x28, [sp, #16*4]
        ldr x29, [sp, #16*5]
        add sp, sp, #(16*6)
.endm

.macro save_vregs // slothy:no-unfold
        sub sp, sp, #(16*4)
        stp  d8,  d9, [sp, #16*0]
        stp d10, d11, [sp, #16*1]
        stp d12, d13, [sp, #16*2]
        stp d14, d15, [sp, #16*3]
.endm

.macro restore_vregs // slothy:no-unfold
        ldp  d8,  d9, [sp, #16*0]
        ldp d10, d11, [sp, #16*1]
        ldp d12, d13, [sp, #16*2]
        ldp d14, d15, [sp, #16*3]
        add sp, sp, #(16*4)
.endm

#define STACK_SIZE 16
#define STACK0 0

.macro restore a, loc     // slothy:no-unfold
        ldr \a, [sp, #\loc\()]
.endm
.macro save loc, a        // slothy:no-unfold
        str \a, [sp, #\loc\()]
.endm
.macro push_stack // slothy:no-unfold
        save_gprs
        save_vregs
        sub sp, sp, #STACK_SIZE
.endm

.macro pop_stack // slothy:no-unfold
        add sp, sp, #STACK_SIZE
        restore_vregs
        restore_gprs
.endm

.data
.p2align 4
roots:
#include "ntt_dilithium_1234_5678_twiddles.s"
.text

        .global ntt_dilithium_1234_5678_opt0_a72
        .global _ntt_dilithium_1234_5678_opt0_a72

.p2align 4
modulus_addr:   .quad -8380417
ntt_dilithium_1234_5678_opt0_a72:
_ntt_dilithium_1234_5678_opt0_a72:
        push_stack

        in      .req x0
        inp     .req x1
        count   .req x2
        r_ptr0  .req x3
        r_ptr1  .req x4
        xtmp    .req x5

        data0  .req v8
        data1  .req v9
        data2  .req v10
        data3  .req v11
        data4  .req v12
        data5  .req v13
        data6  .req v14
        data7  .req v15
        data8  .req v16
        data9  .req v17
        data10 .req v18
        data11 .req v19
        data12 .req v20
        data13 .req v21
        data14 .req v22
        data15 .req v23

        qform_data0  .req q8
        qform_data1  .req q9
        qform_data2  .req q10
        qform_data3  .req q11
        qform_data4  .req q12
        qform_data5  .req q13
        qform_data6  .req q14
        qform_data7  .req q15
        qform_data8  .req q16
        qform_data9  .req q17
        qform_data10 .req q18
        qform_data11 .req q19
        qform_data12 .req q20
        qform_data13 .req q21
        qform_data14 .req q22
        qform_data15 .req q23

        qform_v0  .req q0
        qform_v1  .req q1
        qform_v2  .req q2
        qform_v3  .req q3
        qform_v4  .req q4
        qform_v5  .req q5
        qform_v6  .req q6
        qform_v7  .req q7
        qform_v8  .req q8
        qform_v9  .req q9
        qform_v10 .req q10
        qform_v11 .req q11
        qform_v12 .req q12
        qform_v13 .req q13
        qform_v14 .req q14
        qform_v15 .req q15
        qform_v16 .req q16
        qform_v17 .req q17
        qform_v18 .req q18
        qform_v19 .req q19
        qform_v20 .req q20
        qform_v21 .req q21
        qform_v22 .req q22
        qform_v23 .req q23
        qform_v24 .req q24
        qform_v25 .req q25
        qform_v26 .req q26
        qform_v27 .req q27
        qform_v28 .req q28
        qform_v29 .req q29
        qform_v30 .req q30
        qform_v31 .req q31

        root0    .req v0
        root1    .req v1
        root2    .req v2
        root3    .req v3
        root4 .req v4
        root5 .req v5
        root6 .req v6
        root7 .req v7

        qform_root0    .req q0
        qform_root1    .req q1
        qform_root2    .req q2
        qform_root3    .req q3
        qform_root4    .req q4
        qform_root5    .req q5
        qform_root6    .req q6
        qform_root7    .req q7


        tmp .req v24
        t0  .req v25
        t1  .req v26
        t2  .req v27
        t3  .req v28

        modulus .req v29

        ASM_LOAD(r_ptr0, roots)
        ASM_LOAD(r_ptr1, roots_l67)

        ASM_LOAD(xtmp, modulus_addr)
        ld1r {modulus.4s}, [xtmp]

        save STACK0, in
        mov count, #4

        load_roots_1234

        .p2align 2
        ldr q13, [x0, #768]
        ldr q22, [x0, #0]
        ldr q28, [x0, #64]
        ldr q21, [x0, #128]
        ldr q31, [x0, #256]
        ldr q9, [x0, #192]
        ldr q11, [x0, #320]
        ldr q15, [x0, #384]
        ldr q30, [x0, #512]
        mul v23.4S, v13.4S, v0.S[0]
        ldr q12, [x0, #448]
        ldr q19, [x0, #640]
        ldr q18, [x0, #576]
        sqrdmulh v13.4S, v13.4S, v0.S[1]
        ldr q24, [x0, #704]
        ldr q27, [x0, #832]
        ldr q8, [x0, #896]
        sqrdmulh v26.4S, v30.4S, v0.S[1]
        mul v30.4S, v30.4S, v0.S[0]
        mla v30.4S, v26.4S, v29.4S
        ldr q26, [x0, #960]
        mla v23.4S, v13.4S, v29.4S
        sqrdmulh v13.4S, v26.4S, v0.S[1]
        add v16.4S, v22.4S, v30.4S
        sub v10.4S, v22.4S, v30.4S
        mul v20.4S, v26.4S, v0.S[0]
        add v14.4S, v31.4S, v23.4S
        sub v23.4S, v31.4S, v23.4S
        mul v17.4S, v24.4S, v0.S[0]
        mla v20.4S, v13.4S, v29.4S
        sqrdmulh v31.4S, v24.4S, v0.S[1]
        sqrdmulh v22.4S, v19.4S, v0.S[1]
        sqrdmulh v25.4S, v27.4S, v0.S[1]
        mla v17.4S, v31.4S, v29.4S
        mul v31.4S, v27.4S, v0.S[0]
        mla v31.4S, v25.4S, v29.4S
        sub v26.4S, v9.4S, v17.4S
        add v17.4S, v9.4S, v17.4S
        sqrdmulh v24.4S, v18.4S, v0.S[1]
        mul v13.4S, v18.4S, v0.S[0]
        mul v9.4S, v19.4S, v0.S[0]
        mla v13.4S, v24.4S, v29.4S
        add v18.4S, v11.4S, v31.4S
        mla v9.4S, v22.4S, v29.4S
        sub v25.4S, v12.4S, v20.4S
        add v20.4S, v12.4S, v20.4S
        sqrdmulh v30.4S, v14.4S, v0.S[3]
        sub v12.4S, v28.4S, v13.4S
        mul v27.4S, v14.4S, v0.S[2]
        add v14.4S, v28.4S, v13.4S
        add v28.4S, v21.4S, v9.4S
        sub v22.4S, v21.4S, v9.4S
        sqrdmulh v9.4S, v25.4S, v1.S[1]
        mul v25.4S, v25.4S, v1.S[0]
        mla v27.4S, v30.4S, v29.4S
        mla v25.4S, v9.4S, v29.4S
        sqrdmulh v30.4S, v20.4S, v0.S[3]
        sub v13.4S, v11.4S, v31.4S
        sub v24.4S, v16.4S, v27.4S
        mul v31.4S, v13.4S, v1.S[0]
        add v9.4S, v26.4S, v25.4S
        sqrdmulh v13.4S, v13.4S, v1.S[1]
        sub v19.4S, v26.4S, v25.4S
        add v25.4S, v16.4S, v27.4S
        mul v16.4S, v20.4S, v0.S[2]
        mla v16.4S, v30.4S, v29.4S
        sqrdmulh v30.4S, v8.4S, v0.S[1]
        mla v31.4S, v13.4S, v29.4S
        add v13.4S, v17.4S, v16.4S
        sub v17.4S, v17.4S, v16.4S
        mul v27.4S, v8.4S, v0.S[0]
        mla v27.4S, v30.4S, v29.4S
        sqrdmulh v16.4S, v23.4S, v1.S[1]
        sqrdmulh v11.4S, v9.4S, v2.S[3]
        add v8.4S, v15.4S, v27.4S
        sub v20.4S, v15.4S, v27.4S
        sqrdmulh v21.4S, v19.4S, v3.S[1]
        add v26.4S, v12.4S, v31.4S
        sqrdmulh v15.4S, v18.4S, v0.S[3]
        mul v18.4S, v18.4S, v0.S[2]
        sqrdmulh v27.4S, v20.4S, v1.S[1]
        mla v18.4S, v15.4S, v29.4S
        mul v30.4S, v19.4S, v3.S[0]
        mla v30.4S, v21.4S, v29.4S
        sub v21.4S, v12.4S, v31.4S
        mul v31.4S, v17.4S, v2.S[0]
        sqrdmulh v15.4S, v17.4S, v2.S[1]
        mul v17.4S, v9.4S, v2.S[2]
        mul v9.4S, v8.4S, v0.S[2]
        mul v23.4S, v23.4S, v1.S[0]
        mla v23.4S, v16.4S, v29.4S
        mla v31.4S, v15.4S, v29.4S
        sub v15.4S, v14.4S, v18.4S
        sqrdmulh v8.4S, v8.4S, v0.S[3]
        mul v20.4S, v20.4S, v1.S[0]
        sub v19.4S, v15.4S, v31.4S
        sub count, count, #1
layer1234_start:
        add v16.4S, v15.4S, v31.4S               // ..*.............................................................................................................................................................................................
        mla v20.4S, v27.4S, v29.4S               // ................*...............................................................................................................................................................................                                                                             // gap(s) to follow
        sub v15.4S, v21.4S, v30.4S               // .................*..............................................................................................................................................................................                                                                             // gap(s) to follow
        mla v9.4S, v8.4S, v29.4S                 // ...*............................................................................................................................................................................................                                                                             // gap(s) to follow
        sqrdmulh v12.4S, v15.4S, v7.S[1]         // ...........................................*....................................................................................................................................................                                                                             // gap(s) to follow
        sub v8.4S, v22.4S, v20.4S                // .....................*..........................................................................................................................................................................                                                                             // gap(s) to follow
        add v31.4S, v22.4S, v20.4S               // ......................*.........................................................................................................................................................................
        mul v22.4S, v15.4S, v7.S[0]              // ..............................................*.................................................................................................................................................                                                                             // gap(s) to follow
        add v20.4S, v28.4S, v9.4S                // .........*......................................................................................................................................................................................                                                                             // gap(s) to follow
        sub v27.4S, v28.4S, v9.4S                // ........*.......................................................................................................................................................................................
        sqrdmulh v28.4S, v8.4S, v3.S[1]          // ........................*.......................................................................................................................................................................                                                                             // gap(s) to follow
        add v15.4S, v10.4S, v23.4S               // .....*..........................................................................................................................................................................................                                                                             // gap(s) to follow
        mul v9.4S, v8.4S, v3.S[0]                // .........................*......................................................................................................................................................................
        add v8.4S, v14.4S, v18.4S                // *...............................................................................................................................................................................................                                                                             // gap(s) to follow
        sub v23.4S, v10.4S, v23.4S               // ....*...........................................................................................................................................................................................                                                                             // gap(s) to follow
        sqrdmulh v18.4S, v20.4S, v1.S[3]         // ................................................*...............................................................................................................................................                                                                             // gap(s) to follow
        mla v9.4S, v28.4S, v29.4S                // .............................*..................................................................................................................................................................                                                                             // gap(s) to follow
        mla v17.4S, v11.4S, v29.4S               // .......*........................................................................................................................................................................................                                                                             // gap(s) to follow
        mla v22.4S, v12.4S, v29.4S               // ...............................................*................................................................................................................................................                                                                             // gap(s) to follow
        sub v11.4S, v23.4S, v9.4S                // ....................................*...........................................................................................................................................................
        mul v12.4S, v13.4S, v1.S[2]              // ..............*.................................................................................................................................................................................
        ldr q10, [x0, #784]                      // ................................................................................................*...............................................................................................
        add v23.4S, v23.4S, v9.4S                // ..........................................*.....................................................................................................................................................                                                                             // gap(s) to follow
        add v14.4S, v21.4S, v30.4S               // ..................*.............................................................................................................................................................................
        sqrdmulh v21.4S, v13.4S, v1.S[3]         // ...............*................................................................................................................................................................................
        sub v28.4S, v11.4S, v22.4S               // ....................................................*...........................................................................................................................................                                                                             // gap(s) to follow
        add v11.4S, v11.4S, v22.4S               // ......................................................*.........................................................................................................................................
        ldr q22, [x0, #976]                      // ....................................................................................................................*...........................................................................
        mul v30.4S, v10.4S, v0.S[0]              // .........................................................................................................*......................................................................................                                                                             // gap(s) to follow
        str q28, [x0, #960]                      // ........................................................*.......................................................................................................................................
        mul v13.4S, v20.4S, v1.S[2]              // ..................................*.............................................................................................................................................................                                                                             // gap(s) to follow
        str q11, [x0, #896]                      // .........................................................*......................................................................................................................................                                                                             // gap(s) to follow
        mla v13.4S, v18.4S, v29.4S               // ...............................................................*................................................................................................................................                                                                             // gap(s) to follow
        mla v12.4S, v21.4S, v29.4S               // ....................*...........................................................................................................................................................................
        sub v20.4S, v26.4S, v17.4S               // .............*..................................................................................................................................................................................                                                                             // gap(s) to follow
        add v17.4S, v26.4S, v17.4S               // ............*...................................................................................................................................................................................
        sqrdmulh v9.4S, v31.4S, v2.S[3]          // .........................................*......................................................................................................................................................                                                                             // gap(s) to follow
        add v26.4S, v25.4S, v13.4S               // .................................................................................*..............................................................................................................                                                                             // gap(s) to follow
        sqrdmulh v21.4S, v19.4S, v5.S[1]         // .*..............................................................................................................................................................................................
        ldr q28, [x0, #592]                      // ............................................................................................................*...................................................................................
        sub v18.4S, v25.4S, v13.4S               // ............................................................................*...................................................................................................................
        add v11.4S, v8.4S, v12.4S                // ...........................*....................................................................................................................................................................                                                                             // gap(s) to follow
        sub v12.4S, v8.4S, v12.4S                // ..........................*.....................................................................................................................................................................
        mul v25.4S, v14.4S, v6.S[2]              // .............................................................*..................................................................................................................................                                                                             // gap(s) to follow
        sqrdmulh v13.4S, v11.4S, v3.S[3]         // .......................................*........................................................................................................................................................                                                                             // gap(s) to follow
        mul v11.4S, v11.4S, v3.S[2]              // .......................................................................*........................................................................................................................                                                                             // gap(s) to follow
        mul v8.4S, v31.4S, v2.S[2]               // ............................................*...................................................................................................................................................                                                                             // gap(s) to follow
        mla v8.4S, v9.4S, v29.4S                 // .............................................*..................................................................................................................................................                                                                             // gap(s) to follow
        sqrdmulh v31.4S, v22.4S, v0.S[1]         // ......................................................................................................................*.........................................................................                                                                             // gap(s) to follow
        mla v11.4S, v13.4S, v29.4S               // .............................................................................*..................................................................................................................                                                                             // gap(s) to follow
        mul v13.4S, v22.4S, v0.S[0]              // .........................................................................................................................*......................................................................                                                                             // gap(s) to follow
        sqrdmulh v9.4S, v27.4S, v2.S[1]          // ...........*....................................................................................................................................................................................                                                                             // gap(s) to follow
        sub v22.4S, v26.4S, v11.4S               // .........................................................................................*......................................................................................................                                                                             // gap(s) to follow
        add v26.4S, v26.4S, v11.4S               // ..........................................................................................*.....................................................................................................
        sqrdmulh v11.4S, v12.4S, v4.S[1]         // .................................*..............................................................................................................................................................                                                                             // gap(s) to follow
        str q22, [x0, #64]                       // ..............................................................................................*.................................................................................................
        mul v22.4S, v19.4S, v5.S[0]              // ..........*.....................................................................................................................................................................................                                                                             // gap(s) to follow
        str q26, [x0], #(16)                     // ...............................................................................................*................................................................................................                                                                             // gap(s) to follow
        mul v19.4S, v17.4S, v5.S[2]              // ..............................*.................................................................................................................................................................
        ldr q26, [x0, #896]                      // ................................................................................................................*...............................................................................                                                                             // gap(s) to follow
        mla v13.4S, v31.4S, v29.4S               // .............................................................................................................................*..................................................................
        sub v31.4S, v15.4S, v8.4S                // ..................................................*.............................................................................................................................................
        add v8.4S, v15.4S, v8.4S                 // .................................................*..............................................................................................................................................                                                                             // gap(s) to follow
        mul v15.4S, v26.4S, v0.S[0]              // ......................................................................................................................................................................*.........................                                                                             // gap(s) to follow
        mul v27.4S, v27.4S, v2.S[0]              // .......................*........................................................................................................................................................................                                                                             // gap(s) to follow
        mla v27.4S, v9.4S, v29.4S                // ...................................................*............................................................................................................................................                                                                             // gap(s) to follow
        sqrdmulh v17.4S, v17.4S, v5.S[3]         // ...................*............................................................................................................................................................................                                                                             // gap(s) to follow
        mla v22.4S, v21.4S, v29.4S               // ........................................*.......................................................................................................................................................                                                                             // gap(s) to follow
        sub v21.4S, v24.4S, v27.4S               // ..........................................................*.....................................................................................................................................
        add v9.4S, v24.4S, v27.4S                // ............................................................*...................................................................................................................................
        ldr q24, [x0, #832]                      // ...............................................................................................................*................................................................................
        sqrdmulh v27.4S, v10.4S, v0.S[1]         // .............................................................................................................*..................................................................................                                                                             // gap(s) to follow
        mla v19.4S, v17.4S, v29.4S               // ...............................*................................................................................................................................................................                                                                             // gap(s) to follow
        add v17.4S, v21.4S, v22.4S               // .................................................................*..............................................................................................................................                                                                             // gap(s) to follow
        sub v10.4S, v21.4S, v22.4S               // ..............................................................*.................................................................................................................................
        sqrdmulh v21.4S, v24.4S, v0.S[1]         // ................................................................................................................................*...............................................................                                                                             // gap(s) to follow
        str q17, [x0, #368]                      // ........................................................................*.......................................................................................................................
        mla v30.4S, v27.4S, v29.4S               // .....................................................................................................................*..........................................................................
        ldr q22, [x0, #512]                      // ........................................................................................................*.......................................................................................
        add v27.4S, v8.4S, v19.4S                // ....................................................................*...........................................................................................................................
        sub v19.4S, v8.4S, v19.4S                // .....................................................................*..........................................................................................................................
        str q10, [x0, #432]                      // ..................................................................*.............................................................................................................................
        ldr q17, [x0, #256]                      // ....................................................................................................*...........................................................................................
        mul v24.4S, v24.4S, v0.S[0]              // ..................................................................................................................................*.............................................................
        ldr q10, [x0, #320]                      // ......................................................................................................*.........................................................................................                                                                             // gap(s) to follow
        str q27, [x0, #496]                      // ................................................................................*...............................................................................................................                                                                             // gap(s) to follow
        mla v24.4S, v21.4S, v29.4S               // ...................................................................................................................................*............................................................
        str q19, [x0, #560]                      // ...........................................................................*....................................................................................................................                                                                             // gap(s) to follow
        add v8.4S, v17.4S, v30.4S                // ..........................................................................................................................*.....................................................................                                                                             // gap(s) to follow
        sub v19.4S, v17.4S, v30.4S               // ...........................................................................................................................*....................................................................
        mul v12.4S, v12.4S, v4.S[0]              // .....................................*..........................................................................................................................................................                                                                             // gap(s) to follow
        sqrdmulh v27.4S, v28.4S, v0.S[1]         // ......................................................................................................................................*.........................................................                                                                             // gap(s) to follow
        mla v12.4S, v11.4S, v29.4S               // ......................................*.........................................................................................................................................................                                                                             // gap(s) to follow
        mul v17.4S, v28.4S, v0.S[0]              // .......................................................................................................................................*........................................................
        add v28.4S, v10.4S, v24.4S               // ..........................................................................................................................................*.....................................................                                                                             // gap(s) to follow
        mla v17.4S, v27.4S, v29.4S               // .........................................................................................................................................*......................................................                                                                             // gap(s) to follow
        add v11.4S, v18.4S, v12.4S               // .....................................................................................*..........................................................................................................
        sqrdmulh v27.4S, v14.4S, v6.S[3]         // ...........................................................*....................................................................................................................................
        ldr q30, [x0, #64]                       // ..................................................................................................*.............................................................................................
        sub v14.4S, v18.4S, v12.4S               // ......................................................................................*.........................................................................................................                                                                             // gap(s) to follow
        sqrdmulh v21.4S, v26.4S, v0.S[1]         // ..................................................................................................................................................................*.............................                                                                             // gap(s) to follow
        str q11, [x0, #112]                      // .............................................................................................*..................................................................................................                                                                             // gap(s) to follow
        str q14, [x0, #176]                      // ............................................................................................*...................................................................................................
        add v14.4S, v30.4S, v17.4S               // .................................................................................................................................................*..............................................
        sqrdmulh v11.4S, v8.4S, v0.S[3]          // ..............................................................................................................................................*.................................................
        sub v26.4S, v30.4S, v17.4S               // ...............................................................................................................................................*................................................                                                                             // gap(s) to follow
        sub v30.4S, v10.4S, v24.4S               // .........................................................................................................................................................*......................................
        mla v25.4S, v27.4S, v29.4S               // ...................................................................*............................................................................................................................
        ldr q24, [x0, #640]                      // ...........................................................................................................*....................................................................................                                                                             // gap(s) to follow
        sqrdmulh v12.4S, v16.4S, v4.S[3]         // ......*.........................................................................................................................................................................................                                                                             // gap(s) to follow
        sqrdmulh v27.4S, v19.4S, v1.S[1]         // ........................................................................................................................................................................*.......................                                                                             // gap(s) to follow
        add v10.4S, v23.4S, v25.4S               // ...............................................................................*................................................................................................................                                                                             // gap(s) to follow
        sub v17.4S, v23.4S, v25.4S               // ..................................................................................*.............................................................................................................
        mul v18.4S, v28.4S, v0.S[2]              // ...............................................................................................................................................................................*................                                                                             // gap(s) to follow
        str q10, [x0, #752]                      // .......................................................................................*........................................................................................................
        mul v8.4S, v8.4S, v0.S[2]                // ................................................................................................................................................*...............................................                                                                             // gap(s) to follow
        str q17, [x0, #816]                      // ........................................................................................*.......................................................................................................                                                                             // gap(s) to follow
        sqrdmulh v17.4S, v22.4S, v0.S[1]         // .................................................................................................................*..............................................................................                                                                             // gap(s) to follow
        mla v8.4S, v11.4S, v29.4S                // ......................................................................................................................................................*.........................................                                                                             // gap(s) to follow
        mul v11.4S, v22.4S, v0.S[0]              // ..................................................................................................................*.............................................................................                                                                             // gap(s) to follow
        mla v11.4S, v17.4S, v29.4S               // ...................................................................................................................*............................................................................                                                                             // gap(s) to follow
        sqrdmulh v28.4S, v28.4S, v0.S[3]         // ..............................................................................................................................................................................*.................
        ldr q22, [x0, #704]                      // ..............................................................................................................*.................................................................................                                                                             // gap(s) to follow
        mul v17.4S, v16.4S, v4.S[2]              // .....................................................*..........................................................................................................................................                                                                             // gap(s) to follow
        mla v17.4S, v12.4S, v29.4S               // .......................................................*........................................................................................................................................                                                                             // gap(s) to follow
        mul v23.4S, v19.4S, v1.S[0]              // .........................................................................................................................................................................................*......                                                                             // gap(s) to follow
        mla v15.4S, v21.4S, v29.4S               // .......................................................................................................................................................................*........................                                                                             // gap(s) to follow
        ldr q21, [x0, #384]                      // .......................................................................................................*........................................................................................
        add v10.4S, v9.4S, v17.4S                // ..........................................................................*.....................................................................................................................                                                                             // gap(s) to follow
        sub v19.4S, v9.4S, v17.4S                // .........................................................................*......................................................................................................................
        mla v23.4S, v27.4S, v29.4S               // ..........................................................................................................................................................................................*.....                                                                             // gap(s) to follow
        mla v18.4S, v28.4S, v29.4S               // .................................................................................................................................................................................*..............
        str q10, [x0, #240]                      // ....................................................................................*...........................................................................................................                                                                             // gap(s) to follow
        str q19, [x0, #304]                      // ..............................................................................*.................................................................................................................
        add v10.4S, v21.4S, v15.4S               // ..........................................................................................................................................................................*.....................                                                                             // gap(s) to follow
        sub v28.4S, v21.4S, v15.4S               // ...........................................................................................................................................................................*....................
        mul v16.4S, v30.4S, v1.S[0]              // ...........................................................................................................................................................*....................................                                                                             // gap(s) to follow
        ldr q21, [x0, #448]                      // ..........................................................................................................*.....................................................................................                                                                             // gap(s) to follow
        sqrdmulh v12.4S, v22.4S, v0.S[1]         // ..............................................................................................................................*.................................................................                                                                             // gap(s) to follow
        mul v22.4S, v22.4S, v0.S[0]              // ............................................................................................................................*...................................................................                                                                             // gap(s) to follow
        sub v15.4S, v21.4S, v13.4S               // ............................................................................................................................................*...................................................                                                                             // gap(s) to follow
        add v13.4S, v21.4S, v13.4S               // .............................................................................................................................................*..................................................
        sqrdmulh v27.4S, v20.4S, v6.S[1]         // ................................*...............................................................................................................................................................                                                                             // gap(s) to follow
        mul v9.4S, v10.4S, v0.S[2]               // ........................................................................................................................................................................................*.......                                                                             // gap(s) to follow
        mla v22.4S, v12.4S, v29.4S               // .................................................................................................................................*..............................................................
        ldr q12, [x0, #0]                        // .................................................................................................*..............................................................................................                                                                             // gap(s) to follow
        mul v21.4S, v20.4S, v6.S[0]              // ............................*...................................................................................................................................................................                                                                             // gap(s) to follow
        sqrdmulh v19.4S, v13.4S, v0.S[3]         // ........................................................................................................................................................*.......................................                                                                             // gap(s) to follow
        sqrdmulh v25.4S, v15.4S, v1.S[1]         // ....................................................................................................................................................*...........................................                                                                             // gap(s) to follow
        mla v21.4S, v27.4S, v29.4S               // ...................................*............................................................................................................................................................
        add v27.4S, v12.4S, v11.4S               // .......................................................................................................................*........................................................................                                                                             // gap(s) to follow
        mul v17.4S, v13.4S, v0.S[2]              // ................................................................................................................................................................*...............................                                                                             // gap(s) to follow
        mul v13.4S, v15.4S, v1.S[0]              // .....................................................................................................................................................*..........................................                                                                             // gap(s) to follow
        sub v15.4S, v31.4S, v21.4S               // ...................................................................................*............................................................................................................                                                                             // gap(s) to follow
        add v31.4S, v31.4S, v21.4S               // ................................................................*...............................................................................................................................
        mla v17.4S, v19.4S, v29.4S               // .................................................................................................................................................................*..............................                                                                             // gap(s) to follow
        str q15, [x0, #688]                      // ...........................................................................................*....................................................................................................
        sqrdmulh v21.4S, v30.4S, v1.S[1]         // .............................................................................................................................................................*..................................                                                                             // gap(s) to follow
        str q31, [x0, #624]                      // ......................................................................*.........................................................................................................................                                                                             // gap(s) to follow
        mla v13.4S, v25.4S, v29.4S               // .......................................................................................................................................................*........................................
        ldr q20, [x0, #192]                      // .....................................................................................................*..........................................................................................                                                                             // gap(s) to follow
        sqrdmulh v31.4S, v24.4S, v0.S[1]         // ...............................................................................................................................*................................................................                                                                             // gap(s) to follow
        add v25.4S, v27.4S, v8.4S                // ...............................................................................................................................................................*................................                                                                             // gap(s) to follow
        mla v16.4S, v21.4S, v29.4S               // ...................................................................................................................................................................*............................                                                                             // gap(s) to follow
        add v30.4S, v20.4S, v22.4S               // .....................................................................................................................................*..........................................................                                                                             // gap(s) to follow
        mul v15.4S, v24.4S, v0.S[0]              // ........................................................................................................................................*.......................................................                                                                             // gap(s) to follow
        sub v24.4S, v27.4S, v8.4S                // ..........................................................................................................................................................*.....................................                                                                             // gap(s) to follow
        sub v22.4S, v20.4S, v22.4S               // ....................................................................................................................................*...........................................................
        mul v20.4S, v28.4S, v1.S[0]              // ..............................................................................................................................................................................................*.                                                                             // gap(s) to follow
        sqrdmulh v27.4S, v28.4S, v1.S[1]         // ................................................................................................................................................................................*...............                                                                             // gap(s) to follow
        sub v19.4S, v22.4S, v13.4S               // ..............................................................................................................................................................*.................................                                                                             // gap(s) to follow
        sub v28.4S, v30.4S, v17.4S               // .....................................................................................................................................................................*..........................
        sqrdmulh v8.4S, v10.4S, v0.S[3]          // .............................................................................................................................................................................................*..                                                                             // gap(s) to follow
        add v21.4S, v22.4S, v13.4S               // ............................................................................................................................................................*...................................                                                                             // gap(s) to follow
        add v13.4S, v30.4S, v17.4S               // ....................................................................................................................................................................*...........................
        mla v15.4S, v31.4S, v29.4S               // ...........................................................................................................................................*....................................................                                                                             // gap(s) to follow
        sub v10.4S, v12.4S, v11.4S               // ........................................................................................................................*.......................................................................                                                                             // gap(s) to follow
        mul v30.4S, v19.4S, v3.S[0]              // ..................................................................................................................................................................................*.............
        ldr q17, [x0, #128]                      // ...................................................................................................*............................................................................................                                                                             // gap(s) to follow
        sqrdmulh v12.4S, v28.4S, v2.S[1]         // ......................................................................................................................................................................................*.........                                                                             // gap(s) to follow
        sub v22.4S, v17.4S, v15.4S               // ...................................................................................................................................................*............................................
        mul v31.4S, v28.4S, v2.S[0]              // .....................................................................................................................................................................................*..........                                                                             // gap(s) to follow
        sqrdmulh v19.4S, v19.4S, v3.S[1]         // ............................................................................................................................................................................*...................                                                                             // gap(s) to follow
        add v28.4S, v17.4S, v15.4S               // ..................................................................................................................................................*.............................................                                                                             // gap(s) to follow
        sub v15.4S, v14.4S, v18.4S               // ............................................................................................................................................................................................*...
        mla v31.4S, v12.4S, v29.4S               // ...........................................................................................................................................................................................*....                                                                             // gap(s) to follow
        mul v17.4S, v21.4S, v2.S[2]              // .......................................................................................................................................................................................*........                                                                             // gap(s) to follow
        sqrdmulh v11.4S, v21.4S, v2.S[3]         // .........................................................................................................................................................................*......................
        sub v21.4S, v26.4S, v16.4S               // ....................................................................................................................................................................................*...........                                                                             // gap(s) to follow
        add v26.4S, v26.4S, v16.4S               // .............................................................................................................................................................................*..................                                                                             // gap(s) to follow
        mla v30.4S, v19.4S, v29.4S               // ...................................................................................................................................................................................*............
        sub v19.4S, v15.4S, v31.4S               // ...............................................................................................................................................................................................*                                                                             // gap(s) to follow
        
        // original source code
        // add v12.4S, v14.4S, v18.4S            // .............*.................................................................................................................................................................................. || ....*...........................................................
        // sqrdmulh v18.4S, v19.4S, v5.S[1]      // ......................................*......................................................................................................................................................... || ............*...................................................
        // add v16.4S, v15.4S, v31.4S            // *............................................................................................................................................................................................... || *...............................................................
        // mla v9.4S, v8.4S, v29.4S              // ...*............................................................................................................................................................................................ || .*..............................................................
        // sub v14.4S, v10.4S, v23.4S            // ..............*................................................................................................................................................................................. || ....*...........................................................
        // add v10.4S, v10.4S, v23.4S            // ...........*.................................................................................................................................................................................... || ...*............................................................
        // sqrdmulh v31.4S, v16.4S, v4.S[3]      // .............................................................................................................*.................................................................................. || ....................................*...........................
        // mla v17.4S, v11.4S, v29.4S            // .................*.............................................................................................................................................................................. || .....*..........................................................
        // sub v11.4S, v28.4S, v9.4S             // .........*...................................................................................................................................................................................... || ...*............................................................
        // add v23.4S, v28.4S, v9.4S             // ........*....................................................................................................................................................................................... || ..*.............................................................
        // mul v9.4S, v19.4S, v5.S[0]            // ........................................................*....................................................................................................................................... || ..................*.............................................
        // sqrdmulh v19.4S, v11.4S, v2.S[1]      // ...................................................*............................................................................................................................................ || .................*..............................................
        // add v8.4S, v26.4S, v17.4S             // ...................................*............................................................................................................................................................ || ...........*....................................................
        // sub v26.4S, v26.4S, v17.4S            // ..................................*............................................................................................................................................................. || ...........*....................................................
        // mul v15.4S, v13.4S, v1.S[2]           // ....................*........................................................................................................................................................................... || ......*.........................................................
        // sqrdmulh v13.4S, v13.4S, v1.S[3]      // ........................*....................................................................................................................................................................... || ........*.......................................................
        // mla v20.4S, v27.4S, v29.4S            // .*.............................................................................................................................................................................................. || *...............................................................
        // sub v27.4S, v21.4S, v30.4S            // ..*............................................................................................................................................................................................. || *...............................................................
        // add v21.4S, v21.4S, v30.4S            // .......................*........................................................................................................................................................................ || .......*........................................................
        // sqrdmulh v28.4S, v8.4S, v5.S[3]       // ..................................................................*............................................................................................................................. || ......................*.........................................
        // mla v15.4S, v13.4S, v29.4S            // .................................*.............................................................................................................................................................. || ...........*....................................................
        // sub v13.4S, v22.4S, v20.4S            // .....*.......................................................................................................................................................................................... || .*..............................................................
        // add v20.4S, v22.4S, v20.4S            // ......*......................................................................................................................................................................................... || ..*.............................................................
        // mul v17.4S, v11.4S, v2.S[0]           // ................................................................*............................................................................................................................... || .....................*..........................................
        // sqrdmulh v22.4S, v13.4S, v3.S[1]      // ..........*..................................................................................................................................................................................... || ...*............................................................
        // mul v30.4S, v13.4S, v3.S[0]           // ............*................................................................................................................................................................................... || ....*...........................................................
        // sub v13.4S, v12.4S, v15.4S            // ..........................................*..................................................................................................................................................... || ..............*.................................................
        // add v15.4S, v12.4S, v15.4S            // .........................................*...................................................................................................................................................... || .............*..................................................
        // mul v11.4S, v26.4S, v6.S[0]           // ..................................................................................................................................................*............................................. || ................................................*...............
        // mla v30.4S, v22.4S, v29.4S            // ................*............................................................................................................................................................................... || .....*..........................................................
        // mul v12.4S, v8.4S, v5.S[2]            // ..........................................................*..................................................................................................................................... || ...................*............................................
        // mla v12.4S, v28.4S, v29.4S            // ........................................................................*....................................................................................................................... || ........................*.......................................
        // sqrdmulh v28.4S, v26.4S, v6.S[1]      // ..............................................................................................................................................*................................................. || ...............................................*................
        // sqrdmulh v22.4S, v13.4S, v4.S[1]      // ......................................................*......................................................................................................................................... || ..................*.............................................
        // mul v26.4S, v23.4S, v1.S[2]           // ..............................*................................................................................................................................................................. || ..........*.....................................................
        // mla v11.4S, v28.4S, v29.4S            // .....................................................................................................................................................*.......................................... || .................................................*..............
        // sub v8.4S, v14.4S, v30.4S             // ...................*............................................................................................................................................................................ || ......*.........................................................
        // mul v13.4S, v13.4S, v4.S[0]           // ..........................................................................................*..................................................................................................... || ..............................*.................................
        // mla v13.4S, v22.4S, v29.4S            // ............................................................................................*................................................................................................... || ..............................*.................................
        // sqrdmulh v28.4S, v15.4S, v3.S[3]      // ............................................*................................................................................................................................................... || ..............*.................................................
        // mla v9.4S, v18.4S, v29.4S             // ...................................................................*............................................................................................................................ || ......................*.........................................
        // sqrdmulh v18.4S, v20.4S, v2.S[3]      // ....................................*........................................................................................................................................................... || ............*...................................................
        // add v22.4S, v14.4S, v30.4S            // ......................*......................................................................................................................................................................... || .......*........................................................
        // sqrdmulh v30.4S, v27.4S, v7.S[1]      // ....*........................................................................................................................................................................................... || .*..............................................................
        // mul v20.4S, v20.4S, v2.S[2]           // ..............................................*................................................................................................................................................. || ...............*................................................
        // mla v20.4S, v18.4S, v29.4S            // ...............................................*................................................................................................................................................ || ...............*................................................
        // mul v14.4S, v27.4S, v7.S[0]           // .......*........................................................................................................................................................................................ || ..*.............................................................
        // mla v14.4S, v30.4S, v29.4S            // ..................*............................................................................................................................................................................. || ......*.........................................................
        // sqrdmulh v18.4S, v23.4S, v1.S[3]      // ...............*................................................................................................................................................................................ || .....*..........................................................
        // add v23.4S, v10.4S, v20.4S            // ..............................................................*................................................................................................................................. || ....................*...........................................
        // sub v10.4S, v10.4S, v20.4S            // .............................................................*.................................................................................................................................. || ....................*...........................................
        // mla v17.4S, v19.4S, v29.4S            // .................................................................*.............................................................................................................................. || .....................*..........................................
        // sub v30.4S, v8.4S, v14.4S             // .........................*...................................................................................................................................................................... || ........*.......................................................
        // mul v16.4S, v16.4S, v4.S[2]           // ...........................................................................................................................*.................................................................... || .........................................*......................
        // add v19.4S, v8.4S, v14.4S             // ..........................*..................................................................................................................................................................... || ........*.......................................................
        // mla v16.4S, v31.4S, v29.4S            // ............................................................................................................................*................................................................... || .........................................*......................
        // str q30, [x0, #960]                   // .............................*.................................................................................................................................................................. || .........*......................................................
        // str q19, [x0, #896]                   // ...............................*................................................................................................................................................................ || ..........*.....................................................
        // sub v19.4S, v24.4S, v17.4S            // ....................................................................*........................................................................................................................... || ......................*.........................................
        // sqrdmulh v8.4S, v21.4S, v6.S[3]       // .................................................................................................*.............................................................................................. || ................................*...............................
        // add v24.4S, v24.4S, v17.4S            // .....................................................................*.......................................................................................................................... || .......................*........................................
        // mul v21.4S, v21.4S, v6.S[2]           // ...........................................*.................................................................................................................................................... || ..............*.................................................
        // sub v17.4S, v19.4S, v9.4S             // ..........................................................................*..................................................................................................................... || ........................*.......................................
        // mla v26.4S, v18.4S, v29.4S            // ................................*............................................................................................................................................................... || ..........*.....................................................
        // add v18.4S, v10.4S, v11.4S            // ..........................................................................................................................................................*..................................... || ...................................................*............
        // add v14.4S, v19.4S, v9.4S             // .........................................................................*...................................................................................................................... || ........................*.......................................
        // str q17, [x0, #448]                   // .................................................................................*.............................................................................................................. || ...........................*....................................
        // mla v21.4S, v8.4S, v29.4S             // ...........................................................................................................*.................................................................................... || ...................................*............................
        // add v27.4S, v23.4S, v12.4S            // ...............................................................................*................................................................................................................ || ..........................*.....................................
        // sub v20.4S, v23.4S, v12.4S            // ................................................................................*............................................................................................................... || ..........................*.....................................
        // str q18, [x0, #640]                   // ..............................................................................................................................................................*................................. || ....................................................*...........
        // mul v19.4S, v15.4S, v3.S[2]           // .............................................*.................................................................................................................................................. || ...............*................................................
        // str q14, [x0, #384]                   // ............................................................................*................................................................................................................... || .........................*......................................
        // sub v15.4S, v24.4S, v16.4S            // .................................................................................................................................*.............................................................. || ...........................................*....................
        // add v16.4S, v24.4S, v16.4S            // ................................................................................................................................*............................................................... || ..........................................*.....................
        // str q20, [x0, #576]                   // .......................................................................................*........................................................................................................ || .............................*..................................
        // sub v24.4S, v25.4S, v26.4S            // ........................................*....................................................................................................................................................... || .............*..................................................
        // mla v19.4S, v28.4S, v29.4S            // .................................................*.............................................................................................................................................. || ................*...............................................
        // str q15, [x0, #320]                   // .....................................................................................................................................*.......................................................... || ............................................*...................
        // add v30.4S, v22.4S, v21.4S            // ...............................................................................................................*................................................................................ || .....................................*..........................
        // str q27, [x0, #512]                   // .....................................................................................*.......................................................................................................... || ............................*...................................
        // add v8.4S, v25.4S, v26.4S             // .....................................*.......................................................................................................................................................... || ............*...................................................
        // sub v21.4S, v22.4S, v21.4S            // ................................................................................................................*............................................................................... || .....................................*..........................
        // sub v12.4S, v10.4S, v11.4S            // .........................................................................................................................................................*...................................... || ...................................................*............
        // str q16, [x0, #256]                   // ....................................................................................................................................*........................................................... || ............................................*...................
        // add v14.4S, v24.4S, v13.4S            // ................................................................................................*............................................................................................... || ................................*...............................
        // sub v26.4S, v24.4S, v13.4S            // ...................................................................................................*............................................................................................ || .................................*..............................
        // str q30, [x0, #768]                   // ..................................................................................................................*............................................................................. || ......................................*.........................
        // str q21, [x0, #832]                   // ....................................................................................................................*........................................................................... || ......................................*.........................
        // sub v23.4S, v8.4S, v19.4S             // ....................................................*........................................................................................................................................... || .................*..............................................
        // add v22.4S, v8.4S, v19.4S             // .....................................................*.......................................................................................................................................... || .................*..............................................
        // str q12, [x0, #704]                   // ............................................................................................................................................................*................................... || ....................................................*...........
        // str q26, [x0, #192]                   // ......................................................................................................*......................................................................................... || ..................................*.............................
        // str q14, [x0, #128]                   // .....................................................................................................*.......................................................................................... || .................................*..............................
        // str q23, [x0, #64]                    // .......................................................*........................................................................................................................................ || ..................*.............................................
        // str q22, [x0], #(16)                  // .........................................................*...................................................................................................................................... || ...................*............................................
        // ldr q13, [x0, #768]                   // .....................*.......................................................................................................................................................................... || .......*........................................................
        // ldr q22, [x0, #0]                     // .................................................................................................................................................*.............................................. || ................................................*...............
        // ldr q28, [x0, #64]                    // ..................................................................................................*............................................................................................. || ................................*...............................
        // ldr q21, [x0, #128]                   // ..................................................................................................................................................................................*............. || ...........................................................*....
        // ldr q31, [x0, #256]                   // ..................................................................................*............................................................................................................. || ...........................*....................................
        // ldr q9, [x0, #192]                    // ................................................................................................................................................................*............................... || .....................................................*..........
        // ldr q11, [x0, #320]                   // ....................................................................................*........................................................................................................... || ............................*...................................
        // ldr q15, [x0, #384]                   // ...............................................................................................................................*................................................................ || ..........................................*.....................
        // ldr q30, [x0, #512]                   // ..............................................................................*................................................................................................................. || ..........................*.....................................
        // mul v23.4S, v13.4S, v0.S[0]           // ............................*................................................................................................................................................................... || .........*......................................................
        // ldr q12, [x0, #448]                   // .........................................................................................................................................*...................................................... || .............................................*..................
        // ldr q19, [x0, #640]                   // ............................................................................................................*................................................................................... || ....................................*...........................
        // ldr q18, [x0, #576]                   // .......................................*........................................................................................................................................................ || .............*..................................................
        // sqrdmulh v13.4S, v13.4S, v0.S[1]      // .......................................................................*........................................................................................................................ || .......................*........................................
        // ldr q24, [x0, #704]                   // ..........................................................................................................................*..................................................................... || ........................................*.......................
        // ldr q27, [x0, #832]                   // ......................................................................*......................................................................................................................... || .......................*........................................
        // ldr q8, [x0, #896]                    // ...........................................................*.................................................................................................................................... || ...................*............................................
        // sqrdmulh v26.4S, v30.4S, v0.S[1]      // .....................................................................................................................*.......................................................................... || .......................................*........................
        // mul v30.4S, v30.4S, v0.S[0]           // .......................................................................................................................*........................................................................ || .......................................*........................
        // mla v30.4S, v26.4S, v29.4S            // ........................................................................................................................*....................................................................... || ........................................*.......................
        // ldr q26, [x0, #960]                   // ...........................*.................................................................................................................................................................... || .........*......................................................
        // mla v23.4S, v13.4S, v29.4S            // .............................................................................*.................................................................................................................. || .........................*......................................
        // sqrdmulh v13.4S, v26.4S, v0.S[1]      // ................................................*............................................................................................................................................... || ................*...............................................
        // add v16.4S, v22.4S, v30.4S            // ......................................................................................................................................................*......................................... || ..................................................*.............
        // sub v10.4S, v22.4S, v30.4S            // ................................................................................................................................................................................*............... || ..........................................................*.....
        // mul v20.4S, v26.4S, v0.S[0]           // ..................................................*............................................................................................................................................. || ................*...............................................
        // add v14.4S, v31.4S, v23.4S            // ........................................................................................*....................................................................................................... || .............................*..................................
        // sub v23.4S, v31.4S, v23.4S            // .........................................................................................*...................................................................................................... || .............................*..................................
        // mul v17.4S, v24.4S, v0.S[0]           // ...........................................................................................................................................*.................................................... || ..............................................*.................
        // mla v20.4S, v13.4S, v29.4S            // ............................................................*................................................................................................................................... || ....................*...........................................
        // sqrdmulh v31.4S, v24.4S, v0.S[1]      // ..........................................................................................................................................*..................................................... || ..............................................*.................
        // sqrdmulh v22.4S, v19.4S, v0.S[1]      // .................................................................................................................................................................*.............................. || .....................................................*..........
        // sqrdmulh v25.4S, v27.4S, v0.S[1]      // ...........................................................................*.................................................................................................................... || .........................*......................................
        // mla v17.4S, v31.4S, v29.4S            // ................................................................................................................................................*............................................... || ................................................*...............
        // mul v31.4S, v27.4S, v0.S[0]           // ...................................................................................*............................................................................................................ || ...........................*....................................
        // mla v31.4S, v25.4S, v29.4S            // ......................................................................................*......................................................................................................... || ............................*...................................
        // sub v26.4S, v9.4S, v17.4S             // .......................................................................................................................................................................*........................ || .......................................................*........
        // add v17.4S, v9.4S, v17.4S             // ....................................................................................................................................................................*........................... || ......................................................*.........
        // sqrdmulh v24.4S, v18.4S, v0.S[1]      // ...........................................................................................*.................................................................................................... || ..............................*.................................
        // mul v13.4S, v18.4S, v0.S[0]           // .............................................................................................*.................................................................................................. || ...............................*................................
        // mul v9.4S, v19.4S, v0.S[0]            // .....................................................................................................................................................................*.......................... || .......................................................*........
        // mla v13.4S, v24.4S, v29.4S            // ...............................................................................................*................................................................................................ || ...............................*................................
        // add v18.4S, v11.4S, v31.4S            // ..............................................................................................*................................................................................................. || ...............................*................................
        // mla v9.4S, v22.4S, v29.4S             // ...............................................................................................................................................................................*................ || ..........................................................*.....
        // sub v25.4S, v12.4S, v20.4S            // ............................................................................................................................................*................................................... || ..............................................*.................
        // add v20.4S, v12.4S, v20.4S            // .............................................................................................................................................*.................................................. || ...............................................*................
        // sqrdmulh v30.4S, v14.4S, v0.S[3]      // ........................................................................................................*....................................................................................... || ..................................*.............................
        // sub v12.4S, v28.4S, v13.4S            // .........................................................................................................*...................................................................................... || ...................................*............................
        // mul v27.4S, v14.4S, v0.S[2]           // ...................................................................................................................*............................................................................ || ......................................*.........................
        // add v14.4S, v28.4S, v13.4S            // .......................................................................................................*........................................................................................ || ..................................*.............................
        // add v28.4S, v21.4S, v9.4S             // .......................................................................................................................................................................................*........ || .............................................................*..
        // sub v22.4S, v21.4S, v9.4S             // ....................................................................................................................................................................................*........... || ............................................................*...
        // sqrdmulh v9.4S, v25.4S, v1.S[1]       // ....................................................................................................................................................*........................................... || .................................................*..............
        // mul v25.4S, v25.4S, v1.S[0]           // ........................................................................................................................................................*....................................... || ..................................................*.............
        // mla v27.4S, v30.4S, v29.4S            // ......................................................................................................................*......................................................................... || .......................................*........................
        // mla v25.4S, v9.4S, v29.4S             // ...............................................................................................................................................................*................................ || .....................................................*..........
        // sqrdmulh v30.4S, v20.4S, v0.S[3]      // ...................................................................................................................................................*............................................ || .................................................*..............
        // sub v13.4S, v11.4S, v31.4S            // ..........................................................................................................*..................................................................................... || ...................................*............................
        // sub v24.4S, v16.4S, v27.4S            // ......................................................................................................................................................................*......................... || .......................................................*........
        // mul v31.4S, v13.4S, v1.S[0]           // ........................................................................................................................................*....................................................... || .............................................*..................
        // add v9.4S, v26.4S, v25.4S             // .............................................................................................................................................................................*.................. || .........................................................*......
        // sqrdmulh v13.4S, v13.4S, v1.S[1]      // .............................................................................................................................................................*.................................. || ....................................................*...........
        // sub v19.4S, v26.4S, v25.4S            // ..........................................................................................................................................................................*..................... || ........................................................*.......
        // add v25.4S, v16.4S, v27.4S            // ..................................................................................................................................................................*............................. || ......................................................*.........
        // mul v16.4S, v20.4S, v0.S[2]           // .......................................................................................................................................................*........................................ || ..................................................*.............
        // mla v16.4S, v30.4S, v29.4S            // ...........................................................................................................................................................*.................................... || ...................................................*............
        // sqrdmulh v30.4S, v8.4S, v0.S[1]       // ....................................................................................................*........................................................................................... || .................................*..............................
        // mla v31.4S, v13.4S, v29.4S            // ...................................................................................................................................................................*............................ || ......................................................*.........
        // add v13.4S, v17.4S, v16.4S            // ..............................................................................................................................................................................*................. || ..........................................................*.....
        // sub v17.4S, v17.4S, v16.4S            // ...........................................................................................................................................................................*.................... || .........................................................*......
        // mul v27.4S, v8.4S, v0.S[0]            // ...............................................................*................................................................................................................................ || .....................*..........................................
        // mla v27.4S, v30.4S, v29.4S            // ..............................................................................................................................*................................................................. || ..........................................*.....................
        // sqrdmulh v16.4S, v23.4S, v1.S[1]      // ..............................................................................................................*................................................................................. || ....................................*...........................
        // sqrdmulh v11.4S, v9.4S, v2.S[3]       // ...........................................................................................................................................................................................*.... || ..............................................................*.
        // add v8.4S, v15.4S, v27.4S             // ......................................................................................................................................*......................................................... || ............................................*...................
        // sub v20.4S, v15.4S, v27.4S            // .......................................................................................................................................*........................................................ || .............................................*..................
        // sqrdmulh v21.4S, v19.4S, v3.S[1]      // ......................................................................................................................................................................................*......... || ............................................................*...
        // add v26.4S, v12.4S, v31.4S            // .............................................................................................................................................................................................*.. || ...............................................................*
        // sqrdmulh v15.4S, v18.4S, v0.S[3]      // .........................................................................................................................*...................................................................... || ........................................*.......................
        // mul v18.4S, v18.4S, v0.S[2]           // .................................................................................................................*.............................................................................. || .....................................*..........................
        // sqrdmulh v27.4S, v20.4S, v1.S[1]      // .........................................................................................................................................................................*...................... || ........................................................*.......
        // mla v18.4S, v15.4S, v29.4S            // ...................................................................................................................................*............................................................ || ...........................................*....................
        // mul v30.4S, v19.4S, v3.S[0]           // .................................................................................................................................................................................*.............. || ...........................................................*....
        // mla v30.4S, v21.4S, v29.4S            // ..............................................................................................................................................................................................*. || ...............................................................*
        // sub v21.4S, v12.4S, v31.4S            // ............................................................................................................................................................................................*... || ..............................................................*.
        // mul v31.4S, v17.4S, v2.S[0]           // .....................................................................................................................................................................................*.......... || ............................................................*...
        // sqrdmulh v15.4S, v17.4S, v2.S[1]      // ...................................................................................................................................................................................*............ || ...........................................................*....
        // mul v17.4S, v9.4S, v2.S[2]            // ..........................................................................................................................................................................................*..... || ..............................................................*.
        // mul v9.4S, v8.4S, v0.S[2]             // ...............................................................................................................................................*................................................ || ...............................................*................
        // mul v23.4S, v23.4S, v1.S[0]           // .............................................................................................................................*.................................................................. || .........................................*......................
        // mla v23.4S, v16.4S, v29.4S            // ..................................................................................................................................*............................................................. || ...........................................*....................
        // mla v31.4S, v15.4S, v29.4S            // .........................................................................................................................................................................................*...... || .............................................................*..
        // sub v15.4S, v14.4S, v18.4S            // ........................................................................................................................................................................................*....... || .............................................................*..
        // sqrdmulh v8.4S, v8.4S, v0.S[3]        // ............................................................................................................................................................................*................... || .........................................................*......
        // mul v20.4S, v20.4S, v1.S[0]           // ........................................................................................................................................................................*....................... || ........................................................*.......
        // sub v19.4S, v15.4S, v31.4S            // ...............................................................................................................................................................................................* || ...............................................................*
        
        sub count, count, #1
        cbnz count, layer1234_start
        add v12.4S, v14.4S, v18.4S
        sqrdmulh v18.4S, v19.4S, v5.S[1]
        add v16.4S, v15.4S, v31.4S
        mla v9.4S, v8.4S, v29.4S
        sub v14.4S, v10.4S, v23.4S
        add v10.4S, v10.4S, v23.4S
        sqrdmulh v31.4S, v16.4S, v4.S[3]
        mla v17.4S, v11.4S, v29.4S
        sub v11.4S, v28.4S, v9.4S
        add v23.4S, v28.4S, v9.4S
        mul v9.4S, v19.4S, v5.S[0]
        sqrdmulh v19.4S, v11.4S, v2.S[1]
        add v8.4S, v26.4S, v17.4S
        sub v26.4S, v26.4S, v17.4S
        mul v15.4S, v13.4S, v1.S[2]
        sqrdmulh v13.4S, v13.4S, v1.S[3]
        mla v20.4S, v27.4S, v29.4S
        sub v27.4S, v21.4S, v30.4S
        add v21.4S, v21.4S, v30.4S
        sqrdmulh v28.4S, v8.4S, v5.S[3]
        mla v15.4S, v13.4S, v29.4S
        sub v13.4S, v22.4S, v20.4S
        add v20.4S, v22.4S, v20.4S
        mul v17.4S, v11.4S, v2.S[0]
        sqrdmulh v22.4S, v13.4S, v3.S[1]
        mul v30.4S, v13.4S, v3.S[0]
        sub v13.4S, v12.4S, v15.4S
        add v15.4S, v12.4S, v15.4S
        mul v11.4S, v26.4S, v6.S[0]
        mla v30.4S, v22.4S, v29.4S
        mul v12.4S, v8.4S, v5.S[2]
        mla v12.4S, v28.4S, v29.4S
        sqrdmulh v28.4S, v26.4S, v6.S[1]
        sqrdmulh v22.4S, v13.4S, v4.S[1]
        mul v26.4S, v23.4S, v1.S[2]
        mla v11.4S, v28.4S, v29.4S
        sub v8.4S, v14.4S, v30.4S
        mul v13.4S, v13.4S, v4.S[0]
        mla v13.4S, v22.4S, v29.4S
        sqrdmulh v28.4S, v15.4S, v3.S[3]
        mla v9.4S, v18.4S, v29.4S
        sqrdmulh v18.4S, v20.4S, v2.S[3]
        add v22.4S, v14.4S, v30.4S
        sqrdmulh v30.4S, v27.4S, v7.S[1]
        mul v20.4S, v20.4S, v2.S[2]
        mla v20.4S, v18.4S, v29.4S
        mul v14.4S, v27.4S, v7.S[0]
        mla v14.4S, v30.4S, v29.4S
        sqrdmulh v18.4S, v23.4S, v1.S[3]
        add v23.4S, v10.4S, v20.4S
        sub v10.4S, v10.4S, v20.4S
        mla v17.4S, v19.4S, v29.4S
        sub v30.4S, v8.4S, v14.4S
        mul v16.4S, v16.4S, v4.S[2]
        add v19.4S, v8.4S, v14.4S
        mla v16.4S, v31.4S, v29.4S
        str q30, [x0, #960]
        str q19, [x0, #896]
        sub v19.4S, v24.4S, v17.4S
        sqrdmulh v8.4S, v21.4S, v6.S[3]
        add v24.4S, v24.4S, v17.4S
        mul v21.4S, v21.4S, v6.S[2]
        sub v17.4S, v19.4S, v9.4S
        mla v26.4S, v18.4S, v29.4S
        add v18.4S, v10.4S, v11.4S
        add v14.4S, v19.4S, v9.4S
        str q17, [x0, #448]
        mla v21.4S, v8.4S, v29.4S
        add v27.4S, v23.4S, v12.4S
        sub v20.4S, v23.4S, v12.4S
        str q18, [x0, #640]
        mul v19.4S, v15.4S, v3.S[2]
        str q14, [x0, #384]
        sub v15.4S, v24.4S, v16.4S
        add v16.4S, v24.4S, v16.4S
        str q20, [x0, #576]
        sub v24.4S, v25.4S, v26.4S
        mla v19.4S, v28.4S, v29.4S
        str q15, [x0, #320]
        add v30.4S, v22.4S, v21.4S
        str q27, [x0, #512]
        add v8.4S, v25.4S, v26.4S
        sub v21.4S, v22.4S, v21.4S
        sub v12.4S, v10.4S, v11.4S
        str q16, [x0, #256]
        add v14.4S, v24.4S, v13.4S
        sub v26.4S, v24.4S, v13.4S
        str q30, [x0, #768]
        str q21, [x0, #832]
        sub v23.4S, v8.4S, v19.4S
        add v22.4S, v8.4S, v19.4S
        str q12, [x0, #704]
        str q26, [x0, #192]
        str q14, [x0, #128]
        str q23, [x0, #64]
        str q22, [x0], #(16)

        restore inp, STACK0
        mov count, #16

        .unreq root4
        .unreq root5
        .unreq root6
        .unreq root7
        .unreq qform_root4
        .unreq qform_root5
        .unreq qform_root6
        .unreq qform_root7
        root0_tw .req v4
        root1_tw .req v5
        root2_tw .req v6
        root3_tw .req v7
        qform_root0_tw .req q4
        qform_root1_tw .req q5
        qform_root2_tw .req q6
        qform_root3_tw .req q7

        .p2align 2
layer5678_start:
        ldr_vo data0, inp, (16*0)
        ldr_vo data1, inp, (16*1)
        ldr_vo data2, inp, (16*2)
        ldr_vo data3, inp, (16*3)

        load_next_roots_56 root0, r_ptr0
        load_next_roots_6  root1, r_ptr0

        ct_butterfly data0, data2, root0, 0, 1
        ct_butterfly data1, data3, root0, 0, 1
        ct_butterfly data0, data1, root0, 2, 3
        ct_butterfly data2, data3, root1, 0, 1

        transpose4 data
        load_next_roots_78 root0, root0_tw, root1, root1_tw, root2, root2_tw, r_ptr1

        ct_butterfly_v data0, data2, root0, root0_tw
        ct_butterfly_v data1, data3, root0, root0_tw
        ct_butterfly_v data0, data1, root1, root1_tw
        ct_butterfly_v data2, data3, root2, root2_tw

        st4 {data0.4S, data1.4S, data2.4S, data3.4S}, [inp], #64
// layer5678_end:
        subs count, count, #1
        cbnz count, layer5678_start

       pop_stack
       ret